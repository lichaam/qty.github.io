<!DOCTYPE html>
<html lang="zh-CN" data-theme="light" data-color-theme="black-white">
<head>
   <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

    <title>ä¼ è®¯</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="icon" type="image/png" sizes="192x192" href="https://file.youtochat.com/images/20260216/1771224856844_qdqqd.jpeg">
<link rel="apple-touch-icon" href="https://file.youtochat.com/images/20260216/1771224856844_qdqqd.jpeg">
<meta name="apple-mobile-web-app-title" content="Êšð‘³ð‘¶ð‘½ð‘¬Éž">
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            display: none;
            width: 0;
        }
        html {
            max-width: 100vw;
        }

:root {
            --primary-bg: #f9f9f9;
            --secondary-bg: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #7a7a7a;
            --border-color: #ebebeb;
            --message-sent-bg: var(--accent-color);
            --message-sent-text: #ffffff;
            --message-received-bg: #f0f0f0;
            --message-received-text: #1a1a1a; 
            --header-bg: #ffffff;
            --input-area-bg: #ffffff; 
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.06);
            --radius: 16px;
            --font-family: 'Noto Serif SC', serif;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --font-size: 16px;
            --favorite-color: #ffc107;
            --primary-bg-rgb: 249, 249, 249;
            --secondary-bg-rgb: 255, 255, 255;
            --bubble-style: 'standard';
            --message-font-family: 'Noto Serif SC', serif;
            --message-font-weight: 400;
            --message-line-height: 1.5;
            --in-chat-avatar-size: 36px;
        }

:root[data-color-theme="gold"] {
            --accent-color: #c5a47e;
            --accent-color-dark: #d4af37;
            --accent-color-rgb: 197, 164, 126;
        }
:root[data-color-theme="blue"] {
            --accent-color: #7FA6CD;
            --accent-color-dark: #7FA6CD;
            --accent-color-rgb: 127, 166, 205;
        }
:root[data-color-theme="purple"] {
            --accent-color: #BB9EC7;
            --accent-color-dark: #BB9EC7;
            --accent-color-rgb: 187, 158, 199;
        }
:root[data-color-theme="green"] {
            --accent-color: #7BC8A4;
            --accent-color-dark: #7BC8A4;
            --accent-color-rgb: 123, 200, 164;
        }
:root[data-color-theme="pink"] {
            --accent-color: #F4A6B3;
            --accent-color-dark: #F4A6B3;
            --accent-color-rgb: 244, 166, 179;
        }
:root[data-color-theme="black-white"] {
            --accent-color: #333333;
            --accent-color-dark: #D6D6D6;
            --accent-color-rgb: 51, 51, 51;
        }
:root[data-color-theme="pastel"] {
            --accent-color: #A8D8EA;
            --accent-color-dark: #AA96DA;
            --accent-color-rgb: 168, 216, 234;
        }
:root[data-color-theme="sunset"] {
            --accent-color: #FF9A8B;
            --accent-color-dark: #FF6B6B;
            --accent-color-rgb: 255, 154, 139;
        }
:root[data-color-theme="forest"] {
            --accent-color: #7BA05B;
            --accent-color-dark: #556B2F;
            --accent-color-rgb: 123, 160, 91;
        }
:root[data-color-theme="ocean"] {
            --accent-color: #4A90E2;
            --accent-color-dark: #2E5B9A;
            --accent-color-rgb: 74, 144, 226;
        }

        html[data-theme="dark"] {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --text-primary: #e5e5e5;
            --text-secondary: #8c8c8c;
            --border-color: #2f2f2f;
            --message-sent-bg: var(--accent-color);
            --message-sent-text: #ffffff;
            --message-received-bg: #2a2a2a;
            --message-received-text: #e5e5e5; 
            --header-bg: #1e1e1e; 
            --input-area-bg: #1e1e1e; 
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            --favorite-color: #ffd700;

            --primary-bg-rgb: 18, 18, 18;
            --secondary-bg-rgb: 30, 30, 30;
        }

        html[data-theme="dark"][data-color-theme="black-white"] .message-sent {
            color: var(--message-sent-text, #1a1a1a);
        }

        html[data-theme="dark"][data-color-theme="gold"] .message-sent,
        html[data-theme="dark"][data-color-theme="blue"] .message-sent,
        html[data-theme="dark"][data-color-theme="purple"] .message-sent,
        html[data-theme="dark"][data-color-theme="green"] .message-sent,
        html[data-theme="dark"][data-color-theme="pink"] .message-sent,
        html[data-theme="dark"][data-color-theme="pastel"] .message-sent,
        html[data-theme="dark"][data-color-theme="sunset"] .message-sent,
        html[data-theme="dark"][data-color-theme="forest"] .message-sent,
        html[data-theme="dark"][data-color-theme="ocean"] .message-sent {
            color: var(--message-sent-text, #ffffff);
        }

        .message.rounded {
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .message.rounded-large {
            border-radius: 24px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.1);
        }
        .message.square {
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }
        .message.rounded-sent {
            border-radius: var(--radius) var(--radius) 6px var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .message.rounded-received {
            border-radius: var(--radius) var(--radius) var(--radius) 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .message-sent { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .message-received { box-shadow: 0 2px 8px rgba(0,0,0,0.07); }

        html, body {
            width: 100vw;
            max-width: 100vw;
            overflow-x: hidden !important;
            overscroll-behavior-x: none;
            margin: 0;
            padding: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            transition: background-color 0.5s ease, color 0.5s ease;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            font-family: var(--font-family);
            font-weight: 400;
            position: absolute; 
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            font-size: var(--font-size);
            opacity: 0;
            animation: delayedShow 0.8s ease 0.2s forwards;
        }
@keyframes delayedShow {
            to {
                opacity: 1;
            }
        }
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background-color: var(--primary-bg);
            background-image: var(--chat-bg-image);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-color 0.5s ease;
            will-change: transform;
        }

        .header {
            padding: 0;
            padding-top: env(safe-area-inset-top, 0px);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
            box-shadow: var(--shadow);
            z-index: 10;
            flex-shrink: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: background-color 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
        }

        body.immersive-mode .header {
            transform: translateY(-110%);
            opacity: 0;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            transition: transform 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.4s ease;
        }
        body.immersive-mode .chat-container {
            padding-top: calc(12px + env(safe-area-inset-top, 0px));
        }
        #immersive-exit-btn {
            display: none;
            position: fixed;
            bottom: calc(env(safe-area-inset-bottom, 0px) + 100px);
            right: 20px;
            left: auto;
            top: auto;
            transform: none;
            z-index: 9999;
            background: rgba(var(--accent-color-rgb), 0.18);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(var(--accent-color-rgb), 0.3);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            padding: 0;
            font-size: 16px;
            color: var(--accent-color);
            cursor: grab;
            letter-spacing: 0;
            transition: background 0.22s ease, box-shadow 0.22s ease;
            font-family: var(--font-family);
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            touch-action: none;
        }
        #immersive-exit-btn:hover {
            background: rgba(var(--accent-color-rgb), 0.32);
        }
        #immersive-exit-btn.dragging {
            cursor: grabbing;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
            transition: none;
        }
        body.immersive-mode #immersive-exit-btn {
            display: flex;
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 650px;
            margin: 0 auto;
            padding: 6px 5px 6px;
            width: 100%;
        }

        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            background-color: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border: 2px solid transparent;
            transition: var(--transition);
            order: 2;
        }
      .header-motto {
position: relative;
top: auto;
left: auto;
transform: none;
display: flex;
align-items: center;
justify-content: center;
width: 100%;
padding: 4px 24px 6px;
margin: 0 auto;
max-width: 100%;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
font-size: 12px;
font-family: 'Inter', 'Noto Serif SC', 'Cormorant Garamond', serif, -apple-system, BlinkMacSystemFont, sans-serif;
font-weight: 350;
letter-spacing: 3px;
font-style: normal;
text-transform: uppercase;
color: var(--accent-color);
background: transparent;
border: none;
border-radius: 0;
box-shadow: none;
transition: all 0.6s cubic-bezier(0.25, 0.1, 0.15, 1);
gap: 14px;
opacity: 0.8;
mix-blend-mode: normal;
backdrop-filter: none;
-webkit-backdrop-filter: none;
text-rendering: optimizeLegibility;
-webkit-font-smoothing: antialiased;
-moz-osx-font-smoothing: grayscale;
animation: mottoFadeIn 1.2s ease 0.6s both;
z-index: 1;
}
@keyframes mottoFadeIn {
    from { opacity: 0; letter-spacing: 6px; }
    to { opacity: 0.8; letter-spacing: 3px; }
}

.header-motto::before,
.header-motto::after {
content: "";
width: 28px;
height: 1px;
background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
opacity: 0.4;
transition: all 0.6s cubic-bezier(0.25, 0.1, 0.15, 1);
}

.header-motto:hover {
letter-spacing: 4.5px;
opacity: 1;
cursor: default;
transform: scale(1.01);
}

.header-motto:hover::before,
.header-motto:hover::after {
width: 48px;
opacity: 0.75;
}

html[data-theme="dark"] .header-motto {
color: var(--accent-color);
opacity: 0.88;
text-shadow: 0 0 18px rgba(var(--accent-color-rgb), 0.25);
font-weight: 300;
}

html[data-theme="dark"] .header-motto::before,
html[data-theme="dark"] .header-motto::after {
background: linear-gradient(90deg, transparent, var(--accent-color), transparent);
opacity: 0.28;
}

html[data-theme="dark"] .header-motto:hover {
text-shadow: 0 0 32px rgba(var(--accent-color-rgb), 0.5);
}

@media (max-width: 480px) {
.header-motto {
padding: 2px 14px 4px;
font-size: 10.5px;
letter-spacing: 2.5px;
gap: 10px;
}
.header-motto::before,
.header-motto::after {
    width: 16px;
}
}
        

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            min-width: 60px;
        }

        .avatar:hover {
            border-color: var(--accent-color);
            transform: scale(1.05);
        }
        html[data-theme="dark"] .avatar:hover {
            border-color: var(--accent-color-dark);
        }
        .avatar > img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .username {
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            order: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 72px;
            visibility: visible !important;
            opacity: 1 !important;
            color: var(--text-primary);
            text-align: center;
        }
        .username:hover {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .username:hover {
            color: var(--accent-color-dark);
        }
        .status {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            order: 3;
            padding: 2px 6px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }
        .status:hover {
            background-color: var(--message-received-bg);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            transition: var(--transition);
        }
        .action-btn:hover {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            transform: rotate(15deg) scale(1.1);
        }

        .main-chat-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overflow-x: hidden;
            padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px));
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            transition: background-color 0.5s ease;
            background-color: transparent;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            width: 100%;
            box-sizing: border-box;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
            width: 0;
        }

        
        .message-wrapper {
            display: flex;
            max-width: 85%;
            margin-bottom: 12px;
            animation: messageAppear 0.4s ease-out forwards;
            opacity: 0;
            position: relative;
            gap: 10px;
            align-items: var(--avatar-align, flex-end);
            flex-shrink: 0;
        }
        .message-avatar {
            width: var(--in-chat-avatar-size);
            height: var(--in-chat-avatar-size);
            border-radius: 50%;
            flex-shrink: 0;
            background-color: var(--border-color);
            transition: all 0.3s ease;
        }
        .message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .message-avatar.hidden {
            visibility: hidden;
        }
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 100%;
        }

@keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(0) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-wrapper.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .message-wrapper.sent .message-content-wrapper {
            align-items: flex-end;
        }
        .message-wrapper.received {
            align-self: flex-start;
            flex-direction: row;
        }
        .message-wrapper.received .message-content-wrapper {
            align-items: flex-start;
        }

        .message {
            padding: 12px 18px;
            border-radius: var(--radius);
            word-wrap: break-word;
            line-height: var(--message-line-height);
            box-shadow: var(--shadow);
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
            position: relative;
            overflow: hidden;
            min-width: 50px;
            font-family: var(--message-font-family);
            font-weight: var(--message-font-weight);
        }

        .message-sent {
            background-color: var(--message-sent-bg, var(--accent-color));
            color: var(--message-sent-text);
            border-bottom-right-radius: 6px;
        }
        html[data-theme="dark"] .message-sent {
            background-color: var(--message-sent-bg, var(--accent-color-dark));
        }

        .message-received {
            background-color: var(--message-received-bg);
            color: var(--message-received-text, var(--text-primary));
            border-bottom-left-radius: 6px;
        }

        .message-meta {
            display: flex;
            align-items: center; 
            gap: 8px;
            margin: 6px 10px 0 10px;
            opacity: 0.7;
            font-size: 11px;
            color: var(--text-secondary);
            position: relative;
            height: 20px; 
        }
        .message-meta-actions {
            position: absolute;
            top: -12px;
            background-color: var(--secondary-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            display: flex;
            padding: 4px 6px;
            opacity: 0;
            transform: translateY(5px);
            transition: var(--transition);
            z-index: 2;
        }
        .message-content-wrapper:hover .message-meta-actions {
            opacity: 1;
            transform: translateY(0);
        }
        .message-wrapper.sent .message-meta-actions {
            left: 0;
        }
        .message-wrapper.received .message-meta-actions {
            right: 0;
        }

        .meta-action-btn {
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 6px 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none; 
            border: none;   
        }
        
        .meta-action-btn:hover {
            transform: scale(1.2);
            color: var(--text-primary);
            background-color: var(--border-color);
        }
.meta-action-btn.delete-btn:hover {
    color: #ff4757 !important; 
    background-color: rgba(255, 71, 87, 0.1);
}

        .meta-action-btn.favorited {
            color: #ffc107 !important; 
        }
        

        .timestamp {
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .read-receipt {
            font-size: 12px;
        }
        .read-receipt.read {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .read-receipt.read {
            color: var(--accent-color-dark);
        }

        .input-area-wrapper {
            flex-shrink: 0;
            background-color: var(--input-area-bg);
            transition: background-color 0.5s ease;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            padding-bottom: env(safe-area-inset-bottom, 0px);
            padding-left: env(safe-area-inset-left, 0px);
            padding-right: env(safe-area-inset-right, 0px);
        }

        body.immersive-mode .input-area-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        body.immersive-mode .main-chat-area {
            padding-bottom: 80px;
        }
        .input-area {
            display: flex;
            padding: 12px 15px;
            gap: 10px;
            border-top: 1px solid var(--border-color);
            align-items: flex-end;
            transition: border-color 0.5s ease;
        }
        .message-input {
            flex: 1;
            border: 1px solid transparent;
            border-radius: 24px;
            padding: 12px 18px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            resize: none;
            outline: none;
            max-height: 120px;
            min-height: 46px;
            transition: var(--transition);
            font-weight: 500;
            font-family: var(--font-family);
            font-size: inherit;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .message-input:focus {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }
        html[data-theme="dark"] .message-input:focus {
            border-color: var(--accent-color-dark);
        }

        .input-buttons {
            display: flex;
            gap: 8px;
            position: relative;
        }
        .input-btn {
            border: none;
            border-radius: 50%;
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .input-btn:hover {
            transform: scale(1.08) rotate(5deg);
            filter: brightness(1.1);
        }

        .send-btn, .batch-btn.active {
            background-color: var(--message-sent-bg, var(--accent-color));
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .send-btn, html[data-theme="dark"] .batch-btn.active {
            background-color: var(--message-sent-bg, var(--accent-color-dark));
        }

        .coin-btn, .batch-btn, .continue-btn, .attachment-btn, .poke-btn {
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
        }
        .attachment-btn:hover, .continue-btn:hover, .batch-btn:hover, .coin-btn:hover, .poke-btn:hover {
            color: var(--text-primary);
        }

        #reply-preview-container {
            padding: 0 15px;
        }
        .reply-preview {
            background-color: rgba(var(--primary-bg-rgb), 0.9);
            border-left: 3px solid var(--accent-color);
            padding: 6px 12px 6px 10px;
            margin-top: 6px;
            border-radius: 0 8px 8px 0;
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: fadeIn 0.2s ease;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
@keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .reply-preview-content {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .reply-preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .reply-preview-remove:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .reply-indicator {
            display: flex;
            flex-direction: column;
            border-left: 3px solid var(--accent-color);
            padding: 5px 10px 5px 9px;
            margin-bottom: 7px;
            background-color: rgba(var(--primary-bg-rgb), 0.55);
            border-radius: 0 8px 8px 0;
            cursor: default;
            overflow: hidden;
            max-width: 100%;
        }
        .reply-indicator-sender {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-color);
            opacity: 1;
            margin-bottom: 2px;
            letter-spacing: 0.3px;
        }
        .reply-indicator-text {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-style: italic;
            opacity: 0.85;
            max-width: 200px;
        }

        .message-wrapper.sent .reply-indicator {
            background-color: rgba(255, 255, 255, 0.18);
            border-left-color: rgba(255, 255, 255, 0.7);
        }
        .message-wrapper.sent .reply-indicator-sender {
            color: rgba(255, 255, 255, 0.9);
        }
        .message-wrapper.sent .reply-indicator-text {
            color: rgba(255, 255, 255, 0.75);
        }
        html[data-theme="dark"] .message-wrapper.sent .reply-indicator {
            background-color: rgba(0, 0, 0, 0.18);
            border-left-color: rgba(255,255,255,0.35);
        }
        .time-fmt-opt.active {
            border: 1.5px solid var(--accent-color) !important;
            background: rgba(var(--accent-color-rgb), 0.08);
            color: var(--accent-color);
        }
        .time-fmt-opt.active i, .time-fmt-opt.active span { color: var(--accent-color); }
        .modal-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }

        .modal {
            z-index: 2000 !important;
        }

        .modal-content {
            z-index: 2001 !important;
        }

        .group-sender-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 2px;
            opacity: 0.85;
            padding: 0 2px;
        }

        .message-note {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 10px 14px;
            font-size: 13px;
            color: var(--text-primary);
            margin-top: 10px;
            border-radius: 8px;
            font-style: italic;
            opacity: 0.9;
        }
        html[data-theme="dark"] .message-note {
            color: var(--text-primary);
        }

        .system-message {
            align-self: center;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            padding: 5px 20px;
            border-radius: 0;
            margin: 12px auto;
            box-shadow: none;
            border: none;
            letter-spacing: 1.5px;
            max-width: 80%;
            text-align: center;
            animation: systemMsgPop 0.45s cubic-bezier(0.34,1.56,0.64,1) forwards;
            opacity: 0;
            transform: scale(0.88) translateY(6px);
            position: relative;
        }
        .system-message::before,
        .system-message::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 24px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(var(--accent-color-rgb),0.35));
        }
        .system-message::before { right: 100%; transform: translateX(8px); }
        .system-message::after { left: 100%; transform: translateX(-8px) scaleX(-1); }
        @keyframes systemMsgPop {
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .setting-pill-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 11px 14px;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.18s, border-color 0.18s, box-shadow 0.18s;
            user-select: none;
        }
        .setting-pill-row:hover {
            border-color: var(--accent-color);
            box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.12);
        }
        .setting-pill-row:active { transform: scale(0.98); }
        .setting-pill-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: rgba(var(--accent-color-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
            font-size: 13px;
            flex-shrink: 0;
            transition: background 0.2s;
        }
        .setting-pill-row.active .setting-pill-icon {
            background: rgba(var(--accent-color-rgb), 0.2);
        }
        .setting-pill-label {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .setting-pill-switch {
            width: 42px;
            height: 23px;
            border-radius: 23px;
            background: var(--border-color);
            position: relative;
            flex-shrink: 0;
            transition: background 0.25s cubic-bezier(0.4,0,0.2,1);
        }
        .setting-pill-row.active .setting-pill-switch {
            background: var(--accent-color);
        }
        .setting-pill-knob {
            position: absolute;
            width: 17px;
            height: 17px;
            border-radius: 50%;
            background: #fff;
            top: 3px;
            left: 3px;
            transition: left 0.25s cubic-bezier(0.4,0,0.2,1), box-shadow 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        .setting-pill-row.active .setting-pill-knob {
            left: 22px;
        }

        body.with-background .header,
        body.with-background .input-area-wrapper {
            background-color: rgba(var(--secondary-bg-rgb), 0.3);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }
        body.with-background .input-area {
            border-top-color: transparent;
        }
        body.with-background .message-received {
            background-color: rgba(var(--secondary-bg-rgb), 0.95);
        }
        body.with-background .message-input {
            background-color: rgba(var(--primary-bg-rgb), 0.8);
        }
        body.with-background .message-input:focus {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
        }
        body.with-background .batch-preview {
            background-color: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        body.with-background .message-meta {
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: modalBgFadeIn 0.3s ease;
        }
@keyframes modalBgFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
        .modal-content {
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 24px 24px 0;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalContentSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transition: background-color 0.5s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            display: flex;
            flex-direction: column;
        }
        .modal-content::-webkit-scrollbar {
            display: none;
            width: 0;
        }
@keyframes modalContentSlideIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.5s ease;
            flex-shrink: 0;
        }
        .modal-title i {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .modal-title i {
            color: var(--accent-color-dark);
        }
        .modal-input, .modal-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            margin-bottom: 16px;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .modal-textarea {
            resize: vertical;
            min-height: 80px;
        }
        .modal-input:focus, .modal-textarea:focus {
            border-color: var(--accent-color);
            transform: translateY(-1px);
        }
        html[data-theme="dark"] .modal-input:focus, html[data-theme="dark"] .modal-textarea:focus {
            border-color: var(--accent-color-dark);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            flex-shrink: 0;
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .modal-btn-primary {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .modal-btn-primary {
            background-color: var(--accent-color-dark);
        }
        .modal-btn-primary:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }
        .modal-btn-secondary {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
        }
        .modal-btn-secondary:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-1px);
        }

        .notif-toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--border-color); border-radius: 24px; transition: 0.3s;
        }
        .notif-toggle-slider::before {
            content: ''; position: absolute; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background: white; border-radius: 50%;
            transition: 0.3s; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        #notif-permission-toggle:checked + .notif-toggle-slider {
            background: var(--accent-color);
        }
        #notif-permission-toggle:checked + .notif-toggle-slider::before {
            transform: translateX(20px);
        }

        #daily-greeting-modal {
            position: fixed; inset: 0; z-index: 9998;
            background: rgba(0,0,0,0.65); backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.35s ease;
        }
        #daily-greeting-modal.hidden { display: none; }
        .daily-greeting-card {
            background: var(--secondary-bg);
            border-radius: 24px;
            max-width: 350px; width: 92%;
            box-shadow: 0 32px 80px rgba(0,0,0,0.32), 0 0 0 1px rgba(var(--accent-color-rgb),0.18), inset 0 1px 0 rgba(255,255,255,0.08);
            position: relative;
            animation: slideUpBounce 0.5s cubic-bezier(0.34,1.56,0.64,1);
            overflow: hidden;
        }
        @keyframes slideUpBounce {
            from { opacity:0; transform: translateY(30px) scale(0.92); }
            to { opacity:1; transform: translateY(0) scale(1); }
        }
        .dg-header-band {
            background: linear-gradient(135deg, var(--accent-color) 0%, rgba(var(--accent-color-rgb),0.75) 100%);
            padding: 22px 22px 20px;
            position: relative;
            overflow: hidden;
            border-radius: 24px 24px 0 0;
        }
        .dg-header-band::before {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.04) 10px, rgba(255,255,255,0.04) 20px);
        }
        .dg-header-band::after {
            content: 'å…¬å‘Š';
            position: absolute; top: 10px; right: 14px;
            font-size: 9px; letter-spacing: 2.5px; opacity: 0.45;
            color: #fff; font-weight: 700; text-transform: uppercase;
        }
        .dg-header-band-shimmer {
            position: absolute; inset: 0;
            background: linear-gradient(105deg, transparent 40%, rgba(255,255,255,0.08) 50%, transparent 60%);
            animation: shimmerSlide 3s ease-in-out infinite;
        }
        @keyframes shimmerSlide {
            0% { transform: translateX(-100%); }
            60%,100% { transform: translateX(200%); }
        }
        .dg-header-top {
            display: flex; align-items: center; gap: 14px;
            position: relative; z-index: 2;
        }
        .dg-emoji-circle {
            width: 56px; height: 56px; border-radius: 50%;
            background: rgba(255,255,255,0.22);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.38);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.25);
            animation: floatEmoji 2.8s ease-in-out infinite;
        }
        @keyframes floatEmoji {
            0%,100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(3deg); }
        }
        .dg-header-text { flex: 1; }
        .dg-festival-label {
            font-size: 10px; letter-spacing: 3px; text-transform: uppercase;
            color: rgba(255,255,255,0.72); margin-bottom: 4px;
        }
        .dg-main-title {
            font-size: 22px; font-weight: 700; color: #fff;
            text-shadow: 0 2px 8px rgba(0,0,0,0.18);
            letter-spacing: 0.5px;
        }
        .dg-date-stamp {
            position: relative; z-index: 2;
            margin-top: 12px; font-size: 11px;
            color: rgba(255,255,255,0.6); letter-spacing: 1px;
            display: flex; align-items: center; gap: 6px;
        }
        .dg-date-stamp::before {
            content: '';
            flex: 1; height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35));
            max-width: 30px;
        }
        .dg-date-stamp::after {
            content: '';
            flex: 1; height: 1px;
            background: linear-gradient(270deg, transparent, rgba(255,255,255,0.35));
            max-width: 30px;
        }
        .dg-body { padding: 18px 20px 20px; }
        .dg-section-label {
            font-size: 10px; letter-spacing: 2.5px; text-transform: uppercase;
            color: var(--accent-color); font-weight: 700;
            margin-bottom: 9px; opacity: 0.85;
            display: flex; align-items: center; gap: 6px;
        }
        .dg-section-label::after {
            content: ''; flex: 1; height: 1px;
            background: linear-gradient(90deg, rgba(var(--accent-color-rgb),0.3), transparent);
        }
        .dg-info-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 9px; margin-bottom: 13px;
        }
        .dg-info-cell {
            background: linear-gradient(135deg, var(--primary-bg), rgba(var(--accent-color-rgb),0.04));
            border-radius: 14px; padding: 12px 14px;
            border: 1px solid rgba(var(--accent-color-rgb),0.12);
            transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), box-shadow 0.22s ease;
        }
        .dg-info-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(var(--accent-color-rgb), 0.12);
        }
        .dg-info-cell-icon { font-size: 0; margin-bottom: 0; height: 28px; display: flex; align-items: center; }
        .dg-info-cell-icon svg { display: block; }
        .dg-info-cell-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 3px; margin-top: 5px; letter-spacing: 0.3px; }
        .dg-info-cell-val { font-size: 13px; font-weight: 700; color: var(--text-primary); }
        .dg-mood-panel {
            background: linear-gradient(135deg, var(--primary-bg), rgba(var(--accent-color-rgb),0.04));
            border-radius: 14px; padding: 13px 16px;
            border: 1px solid rgba(var(--accent-color-rgb),0.12);
            margin-bottom: 13px;
            display: flex; align-items: center; gap: 12px;
            transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), box-shadow 0.22s ease;
        }
        .dg-mood-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(var(--accent-color-rgb), 0.1);
        }
        .dg-mood-icon-big { font-size: 32px; }
        .dg-mood-info { flex: 1; }
        .dg-mood-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .dg-mood-sub { font-size: 11px; color: var(--text-secondary); margin-top: 3px; line-height: 1.45; }
        .dg-note-box {
            font-size: 13px; color: var(--text-secondary); line-height: 1.75;
            padding: 14px 16px; border-radius: 14px;
            margin-bottom: 15px;
            position: relative; overflow: hidden;
            background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.08), rgba(var(--accent-color-rgb),0.03));
            border: 1px solid rgba(var(--accent-color-rgb),0.15);
        }
        .dg-note-box::before {
            content: '\275D';
            position: absolute; top: 6px; left: 10px;
            font-size: 28px; color: var(--accent-color); opacity: 0.18;
            font-family: Georgia, serif; line-height: 1;
        }
        .dg-note-box::after {
            content: '\275E';
            position: absolute; bottom: 2px; right: 10px;
            font-size: 28px; color: var(--accent-color); opacity: 0.18;
            font-family: Georgia, serif; line-height: 1;
        }
        .dg-note-inner {
            position: relative; z-index: 1;
            text-align: center; letter-spacing: 0.3px;
        }
        .dg-note-weather-badge {
            display: inline-flex; align-items: center; gap: 5px;
            background: rgba(var(--accent-color-rgb),0.12);
            border-radius: 20px; padding: 3px 10px;
            font-size: 11px; color: var(--accent-color);
            font-weight: 600; margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        .dg-footer { display: flex; gap: 8px; }
        .daily-greeting-close-btn {
            flex: 2; padding: 12px;
            background: linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb),0.82));
            color: white; border: none; border-radius: 14px; font-size: 13px;
            font-weight: 600; font-family: var(--font-family);
            cursor: pointer; transition: all 0.25s ease;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 12px rgba(var(--accent-color-rgb),0.28);
        }
        .daily-greeting-close-btn:hover {
            opacity: 0.9; transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(var(--accent-color-rgb),0.35);
        }
        .daily-greeting-close-btn:active { transform: translateY(0); }
        .dg-header-band-bg {
            position: absolute; inset: 0;
            background-size: cover; background-position: center;
            background-repeat: no-repeat;
            z-index: 0;
        }
        .dg-header-band-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(135deg, var(--accent-color) 0%, rgba(var(--accent-color-rgb),0.75) 100%);
            z-index: 1;
            transition: opacity 0.3s;
        }
        .dg-header-band-bg.has-img + .dg-header-band-overlay {
            opacity: 0.55;
        }
        .daily-greeting-emoji { display: none; }
        .daily-greeting-festival { display: none; }
        .daily-greeting-title { display: none; }
        .daily-greeting-divider { display: none; }
        .daily-greeting-row { display: none; }
        .daily-greeting-note { display: none; }

        .action-btn, .input-btn, .modal-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
        }
        .action-btn:active, .input-btn:active {
            transform: scale(0.92) !important;
        }
        .modal-btn:active { transform: scale(0.96) !important; }
        .poke-quick-item:active { transform: scale(0.97) !important; }
        .settings-item:active { transform: scale(0.98) !important; }
        .sidebar-btn:active { transform: scale(0.95) !important; }

        .message {
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }
        .message:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12) !important;
        }
        .modal-content {
            animation: modalSlideUp 0.32s cubic-bezier(0.34, 1.3, 0.64, 1) !important;
        }
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(24px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .ann-item-card, .env-letter-item, .dg-info-cell, .dg-mood-panel {
            transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), box-shadow 0.22s ease !important;
        }
        .dg-info-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(var(--accent-color-rgb), 0.1) !important;
        }
        .calendar-day:not(.empty) {
            transition: all 0.2s cubic-bezier(0.4,0,0.2,1) !important;
        }
        .calendar-day:not(.empty):hover {
            transform: scale(1.06) !important;
            z-index: 2;
        }
        .mood-selector-card {
            border-radius: 22px !important;
            box-shadow: 0 16px 48px rgba(0,0,0,0.22) !important;
        }
        .message-input:focus {
            box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.12) !important;
        }
        .setting-pill-row {
            border-radius: 14px !important;
        }
        .notification-toast {
            border-radius: 14px !important;
            backdrop-filter: blur(12px) !important;
        }

        .ann-item-card {
            padding: 12px 14px 12px 16px !important;
        }
        .ann-item-name {
            font-size: 14px !important;
            letter-spacing: 0.2px;
        }
        .ann-item-days {
            font-size: 28px !important;
        }

        .stats-card {
            border-radius: 18px !important;
            border: none !important;
            background: linear-gradient(135deg, var(--secondary-bg), rgba(var(--accent-color-rgb),0.03)) !important;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04) !important;
            padding: 18px !important;
        }
        .overview-item {
            border-radius: 14px !important;
            background: var(--primary-bg) !important;
            border: 1px solid rgba(var(--accent-color-rgb),0.1) !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
        }
        .overview-item:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 14px rgba(var(--accent-color-rgb),0.1) !important;
        }
        .overview-value {
            font-size: 24px !important;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stats-toggle-btn {
            border-radius: 12px !important;
        }
        .rank-item {
            border-radius: 10px !important;
        }
        .rank-item:hover {
            background: rgba(var(--accent-color-rgb), 0.04) !important;
        }
        .stats-card-title {
            font-size: 12px !important;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        #envelope-modal .modal-content {
            padding: 0 !important;
            overflow: hidden !important;
            border-radius: 20px;
            background: transparent !important;
        }
        .env-wrapper {
            background: var(--secondary-bg);
            border-radius: 20px;
            overflow: hidden;
            display: flex; flex-direction: column;
            max-height: 88vh;
        }
        .env-header-flap {
            position: relative;
            background: var(--accent-color);
            padding: 22px 24px 42px;
            clip-path: polygon(0 0, 100% 0, 100% 60%, 50% 100%, 0 60%);
            text-align: center; color: white;
        }
        .env-header-flap::before {
            content: '';
            position: absolute; inset: 0;
            background: linear-gradient(160deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.04) 55%, transparent 100%);
            pointer-events: none;
        }
        .env-header-flap::after {
            content: '';
            position: absolute;
            bottom: 38px; left: 0; right: 0;
            height: 1px;
            background: rgba(255,255,255,0.2);
            pointer-events: none;
        }
        .env-header-icon {
            display: block; margin: 0 auto 8px;
            opacity: 0.95;
        }
        .env-header-title {
            font-size: 15px; font-weight: 700; letter-spacing: 3px;
            text-shadow: 0 1px 6px rgba(0,0,0,0.25);
        }
        .env-header-subtitle {
            font-size: 10px; opacity: 0.7; letter-spacing: 2px; margin-top: 3px;
            text-transform: uppercase; font-style: italic;
        }
        .env-body {
            padding: 14px 18px 4px;
            flex: 1; overflow-y: auto;
            min-height: 0;
        }
        .env-tab-bar {
            display: flex; gap: 6px; margin-bottom: 14px;
        }
        .env-tab-btn {
            flex: 1; padding: 9px 6px;
            background: var(--primary-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 8px; cursor: pointer;
            font-size: 12px; font-family: var(--font-family);
            color: var(--text-secondary); position: relative;
            transition: all 0.25s; letter-spacing: 0.5px;
        }
        .env-tab-btn.active {
            background: rgba(var(--accent-color-rgb), 0.08);
            border: 1.5px solid var(--accent-color);
            color: var(--accent-color); font-weight: 600;
        }
        .env-badge {
            position: absolute; top: -6px; right: -6px;
            background: #ff4757; color: #fff; border-radius: 8px;
            font-size: 10px; padding: 1px 5px; min-width: 16px; text-align: center;
            border: 2px solid var(--secondary-bg);
        }
        .env-letter-item {
            background: var(--primary-bg);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px; cursor: pointer;
            transition: all 0.25s cubic-bezier(0.25,0.8,0.25,1);
            position: relative; overflow: hidden;
        }
        .env-letter-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-color-rgb), 0.12);
            border-color: rgba(var(--accent-color-rgb), 0.35);
        }
        .env-letter-item.env-letter-new {
            border-color: rgba(var(--accent-color-rgb), 0.4);
        }
        .env-letter-header {
            background: linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb), 0.7));
            padding: 8px 12px 7px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .env-letter-header-from {
            font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.95);
            letter-spacing: 0.5px;
        }
        .env-letter-header-date {
            font-size: 10px; color: rgba(255,255,255,0.75);
        }
        .env-stamp {
            width: 32px; height: 38px;
            border: 2px solid rgba(255,255,255,0.7);
            border-radius: 3px;
            background: rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            position: relative;
            box-shadow:
              0 0 0 3px rgba(255,255,255,0.12),
              2px 2px 0 3px rgba(255,255,255,0.12),
              -2px 2px 0 3px rgba(255,255,255,0.12),
              2px -2px 0 3px rgba(255,255,255,0.12),
              -2px -2px 0 3px rgba(255,255,255,0.12);
        }
        .env-letter-body {
            padding: 10px 12px 10px;
        }
        .env-letter-meta { font-size: 10px; color: var(--text-secondary); margin-bottom: 5px; display:flex; justify-content:space-between; }
        .env-letter-preview { font-size: 13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width: 86%; font-style: italic; color: var(--text-primary); }
        .env-letter-status { font-size: 10px; color: var(--accent-color); margin-top: 5px; display: flex; align-items: center; gap: 4px; }
        .env-letter-delete-btn {
            position: absolute; bottom: 10px; right: 10px;
            background: none; border: none; color: var(--text-secondary);
            cursor: pointer; font-size: 12px; opacity: 0.35;
            padding: 4px; border-radius: 4px; transition: all 0.2s;
        }
        .env-letter-delete-btn:hover { color: #ff4757; opacity: 1; }
        .env-letter-item.reply .env-letter-status::before {
            content: 'å·²å›žä¿¡';
            font-size: 9px; color: #6BCB77; border: 1px solid #6BCB77;
            border-radius: 4px; padding: 1px 5px; letter-spacing: 0.5px;
            margin-right: 4px;
        }
        .env-compose-paper {
            background: var(--primary-bg);
            border-radius: 12px;
            border: 1px solid rgba(var(--accent-color-rgb), 0.2);
            padding: 16px 16px 12px;
            margin-bottom: 10px;
            position: relative; overflow: hidden;
        }
        .env-compose-paper::before {
            content: '';
            position: absolute; left: 38px; top: 0; bottom: 0;
            width: 1px; background: rgba(220, 80, 80, 0.25);
            pointer-events: none;
        }
        .env-compose-paper::after {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(
                transparent,
                transparent 28px,
                rgba(var(--accent-color-rgb), 0.07) 28px,
                rgba(var(--accent-color-rgb), 0.07) 29px
            );
            pointer-events: none; border-radius: 12px;
        }
        .env-compose-heading {
            font-size: 11px; color: var(--accent-color); letter-spacing: 2px;
            text-transform: uppercase; margin-bottom: 10px; opacity: 0.8;
            position: relative; z-index: 1;
            display: flex; align-items: center; gap: 6px;
        }
        #envelope-input {
            background: transparent !important;
            border: none !important;
            outline: none !important;
            font-family: var(--font-family) !important;
            font-size: 14px !important;
            line-height: 2 !important;
            color: var(--text-primary) !important;
            width: 100%; resize: none;
            padding-left: 16px;
            min-height: 160px;
            position: relative; z-index: 1;
        }
        .env-letter-paper {
            background: var(--primary-bg);
            background-image:
                repeating-linear-gradient(
                    transparent,
                    transparent 30px,
                    rgba(var(--accent-color-rgb), 0.07) 30px,
                    rgba(var(--accent-color-rgb), 0.07) 31px
                );
            border-radius: 10px;
            padding: 16px 20px 16px 52px;
            font-size: 14px; line-height: 31px;
            white-space: pre-wrap; word-break: break-word;
            min-height: 120px; position: relative;
            border: 1px solid var(--border-color);
        }
        .env-letter-paper::before {
            content: '';
            position: absolute; left: 40px; top: 0; bottom: 0;
            width: 1px; background: rgba(220, 80, 80, 0.2);
        }
        .env-empty {
            text-align:center; padding: 36px 20px;
            color: var(--text-secondary); font-size: 13px; opacity: 0.65;
        }
        .env-empty svg { display: block; margin: 0 auto 12px; opacity: 0.4; }
        .env-send-area {
            padding: 12px 18px 16px;
        }
        .env-send-info {
            display: flex; align-items: center; gap: 6px;
            font-size: 11px; color: var(--text-secondary);
            margin-bottom: 10px; padding: 7px 10px;
            background: var(--primary-bg); border-radius: 8px;
        }
        .env-write-btn {
            width: 100%;
            padding: 13px;
            background: var(--accent-color);
            color: white;
            border: none; border-radius: 14px;
            font-size: 14px; font-weight: 600;
            font-family: var(--font-family);
            cursor: pointer; letter-spacing: 1px;
            transition: all 0.25s;
            box-shadow: 0 4px 16px rgba(var(--accent-color-rgb), 0.35);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .env-write-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .env-close-btn {
            width: 100%; padding: 10px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 14px; font-size: 13px;
            color: var(--text-secondary); cursor: pointer;
            font-family: var(--font-family);
            margin-top: 8px; transition: all 0.2s;
        }
        .env-close-btn:hover { background: var(--primary-bg); }
        .env-postmark {
            display: inline-flex; flex-direction: column; align-items: center;
            border: 2px solid rgba(var(--accent-color-rgb), 0.4);
            border-radius: 50%; width: 56px; height: 56px;
            justify-content: center; font-size: 8px; line-height: 1.3;
            text-align: center; color: var(--accent-color);
            opacity: 0.6; letter-spacing: 0.5px;
        }

        .file-input {
            display: none;
        }
        .empty-state {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
            width: 100%;
            transition: color 0.5s ease;
            pointer-events: none;
        }
        .empty-state i {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.4;
        }
        .empty-state p {
            font-size: 16px;
            font-weight: 500;
        }

        #typing-indicator-wrapper {
            display: none;
            position: fixed;
            bottom: 0;          
            left: 16px;
            z-index: 49;        
            pointer-events: auto;
            padding-bottom: 8px;
            background: transparent !important; 
        }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 9px;
            background: rgba(var(--secondary-bg-rgb), 0.92);
            backdrop-filter: blur(28px) saturate(2);
            -webkit-backdrop-filter: blur(28px) saturate(2);
            border: 1px solid rgba(var(--accent-color-rgb), 0.22);
            padding: 8px 16px 8px 8px;
            border-radius: 26px;
            box-shadow:
                0 8px 32px rgba(0,0,0,0.12),
                0 2px 8px rgba(0,0,0,0.07),
                0 0 0 0px rgba(var(--accent-color-rgb), 0),
                inset 0 1px 0 rgba(255,255,255,0.55),
                inset 0 -1px 0 rgba(0,0,0,0.04);
            animation: typingIndicatorIn 0.45s cubic-bezier(0.34,1.56,0.64,1) both;
            transition: background 0.4s ease, box-shadow 0.3s ease, transform 0.25s ease, border-color 0.3s ease;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
        }
        .typing-indicator:hover {
            transform: translateY(-2px) scale(1.02);
            border-color: rgba(var(--accent-color-rgb), 0.40);
            box-shadow:
                0 12px 40px rgba(0,0,0,0.16),
                0 4px 14px rgba(0,0,0,0.10),
                0 0 0 4px rgba(var(--accent-color-rgb), 0.10),
                inset 0 1px 0 rgba(255,255,255,0.60),
                inset 0 -1px 0 rgba(0,0,0,0.04);
        }
        .typing-indicator:active {
            transform: translateY(0) scale(0.97);
            box-shadow:
                0 4px 16px rgba(0,0,0,0.10),
                0 1px 4px rgba(0,0,0,0.07),
                inset 0 1px 0 rgba(255,255,255,0.40);
        }
        .typing-indicator-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.25), rgba(var(--accent-color-rgb),0.10));
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid rgba(var(--accent-color-rgb), 0.30);
            box-shadow: 0 2px 10px rgba(var(--accent-color-rgb),0.22);
            animation: avatarPulse 3s ease-in-out infinite;
            transition: transform 0.3s ease;
        }
        .typing-indicator:hover .typing-indicator-avatar {
            transform: scale(1.08);
        }
        @keyframes avatarPulse {
            0%, 100% { box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.20); }
            50%       { box-shadow: 0 2px 16px rgba(var(--accent-color-rgb),0.45), 0 0 0 3px rgba(var(--accent-color-rgb),0.12); }
        }
        .typing-indicator-avatar img {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
        }
        .typing-indicator-avatar i {
            font-size: 12px;
            color: var(--accent-color);
        }
        .typing-indicator-label {
            font-size: 11.5px;
            font-weight: 600;
            color: var(--accent-color);
            opacity: 0.88;
            letter-spacing: 0.4px;
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .typing-indicator-settings-hint {
            font-size: 9px;
            color: var(--text-secondary);
            opacity: 0.5;
            margin-left: -2px;
            font-weight: 400;
            letter-spacing: 0;
        }
        @keyframes typingIndicatorIn {
            from { opacity: 0; transform: translateY(14px) scale(0.82); }
            to   { opacity: 1; transform: translateY(0)   scale(1); }
        }
        @keyframes typingIndicatorOut {
            from { opacity: 1; transform: translateY(0)   scale(1); }
            to   { opacity: 0; transform: translateY(8px)  scale(0.90); }
        }
        .typing-indicator.hiding {
            animation: typingIndicatorOut 0.25s ease forwards;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-color);
            animation: typingBounce 1.3s infinite ease-in-out both;
            opacity: 0.55;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.18s; }
        .typing-dot:nth-child(3) { animation-delay: 0.36s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0) scale(1);     opacity: 0.40; }
            30%            { transform: translateY(-7px) scale(1.4); opacity: 1; }
        }

        #ti-settings-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 99200;
            background: rgba(0,0,0,0.50);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            align-items: flex-end;
            justify-content: center;
            padding: 0;
        }
        #ti-settings-modal.open {
            display: flex;
            animation: tiModalOverlayIn 0.25s ease both;
        }
        @keyframes tiModalOverlayIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        #ti-settings-panel {
            background: var(--secondary-bg);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 520px;
            padding: 0 0 env(safe-area-inset-bottom, 16px);
            box-shadow: 0 -8px 48px rgba(0,0,0,0.18);
            animation: tiPanelSlideUp 0.35s cubic-bezier(0.34,1.15,0.64,1) both;
            overflow: hidden;
        }
        @keyframes tiPanelSlideUp {
            from { transform: translateY(100%); }
            to   { transform: translateY(0); }
        }
        .ti-settings-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 20px 16px;
            border-bottom: 1px solid var(--border-color);
        }
        .ti-settings-icon {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: rgba(var(--accent-color-rgb), 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .ti-settings-title {
            flex: 1;
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .ti-settings-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .ti-settings-close:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        .ti-settings-body {
            padding: 18px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .ti-settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .ti-settings-row-label {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ti-settings-row-icon {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            background: rgba(var(--accent-color-rgb), 0.10);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            flex-shrink: 0;
        }
        .ti-settings-row-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .ti-settings-row-sub {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 1px;
        }
        .ti-text-edit-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .ti-text-edit-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        .ti-text-input-wrap {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .ti-text-input {
            flex: 1;
            background: var(--primary-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 14px;
            color: var(--text-primary);
            font-family: var(--font-family);
            outline: none;
            transition: border-color 0.2s;
        }
        .ti-text-input:focus {
            border-color: rgba(var(--accent-color-rgb), 0.60);
        }
        .ti-text-save-btn {
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            font-family: var(--font-family);
            transition: opacity 0.2s;
        }
        .ti-text-save-btn:hover { opacity: 0.85; }
        .ti-text-reset-btn {
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
            text-decoration: underline;
            background: none;
            border: none;
            padding: 0;
            font-family: var(--font-family);
            transition: color 0.2s;
        }
        .ti-text-reset-btn:hover { color: var(--accent-color); }
        .ti-preview-box {
            background: var(--primary-bg);
            border-radius: 16px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 9px;
            border: 1px dashed rgba(var(--accent-color-rgb),0.25);
        }
        .ti-preview-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .ti-preview-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-color);
            animation: typingBounce 1.3s infinite ease-in-out both;
            opacity: 0.55;
        }
        .ti-preview-dot:nth-child(1) { animation-delay: 0s; }
        .ti-preview-dot:nth-child(2) { animation-delay: 0.18s; }
        .ti-preview-dot:nth-child(3) { animation-delay: 0.36s; }

        .settings-item-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

#appearance-modal .settings-item-list {
    display: grid;
    grid-template-columns: 1fr 1fr; 
    gap: 12px; 
}

#appearance-modal .settings-item {
    display: flex;
    align-items: center;
    justify-content: center; 
    padding: 15px;
    width: 100%;
    margin-bottom: 0; 
    flex-direction: column; 
    gap: 8px;
    text-align: center;
}

#appearance-modal .settings-item i {
    font-size: 20px;
    width: auto;
    height: auto;
    background: none;
    margin: 0;
}

#appearance-modal .settings-item::after {
    display: none;
}

        .settings-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 16px;
            background-color: var(--primary-bg);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid transparent;
            position: relative;
        }


        .settings-item:hover {
            background-color: var(--secondary-bg);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }


        .settings-item i {
            font-size: 18px;
            color: var(--accent-color);
            width: 40px;
            height: 40px;
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .settings-item:hover i {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: scale(1.1);
        }


        .settings-item span {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }


        .settings-item::after {
            content: "\f054";
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--text-secondary);
            font-size: 12px;
            opacity: 0.5;
            transition: transform 0.3s ease;
        }

        .settings-item:hover::after {
            transform: translateX(3px);
            opacity: 0.8;
            color: var(--accent-color);
        }


        #advanced-modal .settings-item-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        #advanced-modal .settings-item {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px 10px;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            gap: 10px;
        }

        #advanced-modal .settings-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            z-index: 1;
        }


        #advanced-modal .settings-item i {
            width: 56px;
            height: 56px;
            font-size: 24px;
            border-radius: 20px;
            margin-bottom: 4px;
        }


        #advanced-modal .settings-item::after {
            display: none;
        }

        #appearance-modal .settings-item-list {
            gap: 8px;
        }


        .import-export-buttons {
            display: flex;
            gap: 12px;
            margin-top: 5px;
        }
        .import-export-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid transparent;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .import-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .import-export-btn.export {
            background-color: rgba(var(--accent-color-rgb), 0.1);
            color: var(--accent-color);
            border-color: rgba(var(--accent-color-rgb), 0.2);
        }
        .import-export-btn.export:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }

        .settings-item:hover {
            background-color: var(--primary-bg);
            transform: translateX(5px);
        }

        #my-status-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            font-family: var(--font-family);
            text-align: center;
            padding: 2px 6px;
            width: 100px;
        }


:root {
            --welcome-bg: #f0f2f5;
            --welcome-text-main: #2c3e50;
            --welcome-text-sub: #7f8c8d;
            --welcome-star: #bdc3c7;
            --welcome-circle-outer: rgba(0, 0, 0, 0.1);
            --welcome-loader-bg: rgba(0, 0, 0, 0.1);
        }

        html[data-theme="dark"] {

            --welcome-bg: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
            --welcome-text-main: #ffffff;
            --welcome-text-sub: var(--accent-color);
            --welcome-star: #ffffff;
            --welcome-circle-outer: rgba(255, 255, 255, 0.1);
            --welcome-loader-bg: rgba(255, 255, 255, 0.1);
        }

        .welcome-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--welcome-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            overflow: hidden;
            transition: all 1s cubic-bezier(0.7, 0, 0.3, 1);
        }
        .welcome-animation.hidden {
            opacity: 0;
            transform: scale(1.08);
            filter: blur(24px);
            pointer-events: none;
        }
        .welcome-bg-gradient {
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 30% 40%, rgba(var(--accent-color-rgb), 0.18) 0%, transparent 60%),
                        radial-gradient(ellipse at 70% 60%, rgba(var(--accent-color-rgb), 0.12) 0%, transparent 55%);
            animation: bgPulse 6s ease-in-out infinite;
        }
        @keyframes bgPulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        .welcome-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }
        .wp {
            position: absolute;
            pointer-events: none;
            animation: petalFloat var(--pDur, 10s) ease-in-out infinite var(--pDel, 0s);
            opacity: 0;
        }
        .wp.petal {
            width: var(--pSz, 8px);
            height: calc(var(--pSz, 8px) * 1.5);
            background: radial-gradient(ellipse at 40% 30%, rgba(var(--accent-color-rgb), 0.9), rgba(var(--accent-color-rgb), 0.3));
            border-radius: 50% 0 50% 0;
            filter: blur(0.3px);
        }
        .wp.sparkle {
            width: var(--pSz, 4px);
            height: var(--pSz, 4px);
            background: rgba(var(--accent-color-rgb), 0.7);
            border-radius: 50%;
            box-shadow: 0 0 calc(var(--pSz, 4px) * 2) rgba(var(--accent-color-rgb), 0.5);
        }
        @keyframes petalFloat {
            0%   { transform: translateY(105vh) translateX(0) rotate(0deg) scale(0.6); opacity: 0; }
            8%   { opacity: 0.85; transform: translateY(88vh) translateX(var(--pX1, 15px)) rotate(30deg) scale(1); }
            50%  { opacity: 0.7; transform: translateY(45vh) translateX(var(--pX2, -20px)) rotate(140deg) scale(0.9); }
            90%  { opacity: 0.3; }
            100% { transform: translateY(-8vh) translateX(var(--pX3, 10px)) rotate(280deg) scale(0.5); opacity: 0; }
        }


        .stars-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: var(--welcome-star);
            border-radius: 50%;
            animation: twinkle var(--duration) ease-in-out infinite;
            opacity: 0;
        }

@keyframes twinkle {
            0%, 100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        .welcome-content-wrapper {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }


        .logo-tech-container {
            position: relative;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon-main {
            font-size: 52px;
            color: var(--accent-color);
            z-index: 5;
            filter: drop-shadow(0 0 20px rgba(var(--accent-color-rgb), 0.7));
            animation: floatIcon 3s ease-in-out infinite, iconGlow 2s ease-in-out infinite;
        }
        @keyframes iconGlow {
            0%, 100% { filter: drop-shadow(0 0 15px rgba(var(--accent-color-rgb), 0.5)); }
            50% { filter: drop-shadow(0 0 30px rgba(var(--accent-color-rgb), 0.9)); }
        }
        .logo-circle-outer {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1.5px solid rgba(var(--accent-color-rgb), 0.25);
            border-radius: 50%;
            animation: pulseRing 2.5s ease-in-out infinite;
        }
        .logo-circle-outer::before {
            content: '';
            position: absolute;
            inset: -12px;
            border-radius: 50%;
            border: 1px solid rgba(var(--accent-color-rgb), 0.1);
            animation: pulseRing 2.5s ease-in-out infinite 0.5s;
        }
        .logo-circle-inner {
            position: absolute;
            width: 70%;
            height: 70%;
            border: 1px dashed rgba(var(--accent-color-rgb), 0.5);
            border-radius: 50%;
            animation: rotateCircle 8s linear infinite;
        }
        .orbit-dot {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: rotateCircle 3s linear infinite;
        }
        .orbit-dot::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 14px var(--accent-color), 0 0 4px rgba(255,255,255,0.5);
        }
        .orbit-dot-2 {
            position: absolute;
            width: 70%;
            height: 70%;
            border-radius: 50%;
            animation: rotateCircle 5s linear infinite reverse;
            top: 15%;
            left: 15%;
        }
        .orbit-dot-2::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(var(--accent-color-rgb), 0.7);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px var(--accent-color);
        }


        .text-tech-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 80px;
        }


        .welcome-title-glitch {
            font-family: 'Noto Serif SC', serif;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 4px;
            position: relative;


            opacity: 1;


            transition: color 0.5s ease;
        }


        .welcome-title-glitch.playing {
            opacity: 0;
            animation: cinematicFadeIn 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }


        html[data-theme="light"] .welcome-title-glitch {
            color: #2c3e50;
            text-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }


        html[data-theme="dark"] .welcome-title-glitch,
        .welcome-title-glitch {
            color: #ffffff;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
        }


@keyframes cinematicFadeIn {
            0% {
                opacity: 0;
                transform: scale(0.95);
                filter: blur(8px);
                letter-spacing: 0px;
            }
            100% {
                opacity: 1;
                transform: scale(1);
                filter: blur(0);
                letter-spacing: 6px;
            }
        }

        .title-cinematic-enter {
            animation: cinematicIn 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

@keyframes cinematicIn {
            0% {
                opacity: 0;
                letter-spacing: 15px;
                filter: blur(12px);
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                letter-spacing: 4px;
                filter: blur(0);
                transform: scale(1);
            }
        }


        .welcome-subtitle-scramble {
            font-family: monospace;
            font-size: 12px;
            color: var(--welcome-text-sub);
            letter-spacing: 2px;
            opacity: 0.8;
            text-transform: uppercase;
            min-height: 18px;
        }


        .loader-tech {
            width: 160px;
            height: 2px;
            background: var(--welcome-loader-bg);
            position: relative;
            overflow: hidden;
            border-radius: 2px;
        }

        .loader-tech-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            height: 100%;
            background: var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            transition: width 0.2s linear;
        }

        .meteor {
            position: absolute;
            width: 2px;
            height: 80px;
            background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(var(--accent-color-rgb),0.9) 40%, rgba(255,255,255,0.6) 70%, rgba(255,255,255,0) 100%);
            border-radius: 2px;
            animation: meteorFall var(--mDur,1.5s) ease-in var(--mDel,0s) forwards;
            transform-origin: top center;
            will-change: transform, opacity;
        }
        @keyframes meteorFall {
            0% { opacity:0; transform: rotate(var(--mRot,35deg)) translateY(-100px); }
            10% { opacity:1; }
            80% { opacity:0.7; }
            100% { opacity:0; transform: rotate(var(--mRot,35deg)) translateY(600px); }
        }
        .orbit-dot-3 {
            position: absolute;
            width: 130%;
            height: 130%;
            border-radius: 50%;
            animation: rotateCircle 7s linear infinite 1s;
            top: -15%; left: -15%;
            opacity: 0.5;
        }
        .orbit-dot-3::after {
            content: '';
            position: absolute;
            top: 50%; left: 100%;
            width: 4px; height: 4px;
            background: rgba(var(--accent-color-rgb), 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 6px var(--accent-color);
        }

        .logo-tech-container {
            animation: logoAppear 1.2s cubic-bezier(0.22,1,0.36,1) forwards;
        }
        @keyframes logoAppear {
            0% { opacity:0; transform:scale(0.6) translateY(20px); filter:blur(12px); }
            100% { opacity:1; transform:scale(1) translateY(0); filter:blur(0); }
        }

        @keyframes barPulse {
            0%,100% { box-shadow: 0 0 10px var(--accent-color); }
            50% { box-shadow: 0 0 25px var(--accent-color), 0 0 5px rgba(255,255,255,0.4); }
        }
        .loader-tech-bar.pulsing {
            animation: barPulse 0.8s ease-in-out infinite;
        }

@keyframes floatIcon {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }

@keyframes rotateCircle {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

@keyframes pulseRing {
            0% {
                transform: scale(0.8);
                opacity: 0.1;
                border-color: rgba(var(--accent-color-rgb), 0.2);
            }
            50% {
                transform: scale(1.1);
                opacity: 0.3;
                border-color: rgba(var(--accent-color-rgb), 0.5);
            }
            100% {
                transform: scale(0.8);
                opacity: 0.1;
                border-color: rgba(var(--accent-color-rgb), 0.2);
            }
        }

@keyframes breath {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.2;
            }
        }
@keyframes iconFloat {
            0%, 100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }
@keyframes ripple {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }

            100% {
                width: 150px;
                height: 150px;
                opacity: 0;
            }
        }
@keyframes blink-caret {
            from, to {
                border-color: transparent;
            }

            50% {
                border-color: var(--accent-color);
            }
        }

        .batch-preview {
            position: absolute;
            bottom: 100%;
            left: 15px;
            right: 15px;
            margin-bottom: 4px;
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 12px;
            box-shadow: var(--shadow);
            display: none;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            z-index: 5;
            transition: all 0.5s ease;
            scrollbar-width: none;
            -ms-overflow-style: none;
            animation: batchPreviewSlideUp 0.3s ease;
        }
        .batch-preview::-webkit-scrollbar {
            display: none;
            width: 0;
        }
@keyframes batchPreviewSlideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .batch-preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--primary-bg);
            border-radius: 8px;
            font-size: 14px;
            transition: background-color 0.5s ease, opacity 0.3s ease;
            user-select: none;
            animation: batchItemAppear 0.2s ease;
        }
@keyframes batchItemAppear {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        .batch-preview-text {
            flex-grow: 1;
            cursor: text;
            margin-right: 10px;
        }
        .batch-preview-input {
            flex-grow: 1;
            border: none;
            background-color: transparent;
            border-bottom: 1px solid var(--accent-color);
            color: var(--text-primary);
            font-family: var(--font-family);
            font-size: 14px;
            outline: none;
        }
        .batch-preview-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: var(--transition);
        }
        .batch-preview-remove:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
            transform: scale(1.1);
        }
        .batch-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
        }
        .batch-action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            font-family: var(--font-family);
        }
        .batch-send-btn {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .batch-send-btn {
            background-color: var(--accent-color-dark);
        }
        .batch-cancel-btn {
            background-color: var(--message-received-bg);
            color: var(--text-primary);
        }
.appearance-group {
    display: flex;
    gap: 15px;
    align-items: stretch; 
    margin-bottom: 20px;
}

.theme-editor-entry-btn {
    flex: 1;
    background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
    border-radius: 16px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--message-sent-text);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
    border: none;
    text-align: center;
}

.theme-editor-entry-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(var(--accent-color-rgb), 0.4);
}

.theme-editor-entry-btn i {
    font-size: 24px;
    margin-bottom: 8px;
}

.theme-editor-entry-btn span {
    font-size: 13px;
    font-weight: 600;
}

.preset-colors-container {
    flex: 2;
    background-color: var(--primary-bg);
    border-radius: 16px;
    padding: 15px;
    border: 1px solid var(--border-color);
}

.preset-colors-title {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 5px;
}

        .theme-picker {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(28px, 1fr)); 
    gap: 8px;
    margin-bottom: 0; 
}


@media (max-width: 480px) {
    .appearance-group {
        flex-direction: column; 
    }
    .theme-editor-entry-btn {
        flex-direction: row;
        gap: 10px;
        padding: 12px;
    }
    .theme-editor-entry-btn i {
        font-size: 18px;
        margin-bottom: 0;
    }
}
        .theme-picker-label {
            font-weight: 500;
            font-size: 14px;
        }
        .theme-color-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .theme-color-btn:hover {
            transform: scale(1.1);
        }
        .theme-color-btn.active {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }
        #theme-gold {
            background-color: #c5a47e;
        }
        #theme-blue {
            background-color: #7FA6CD;
        }
        #theme-purple {
            background-color: #BB9EC7;
        }
        #theme-green {
            background-color: #7BC8A4;
        }
        #theme-pink {
            background-color: #F4A6B3;
        }
        #theme-black-white {
            background: linear-gradient(135deg, #000000 50%, #ffffff 50%);
        }
        #theme-pastel {
            background: linear-gradient(135deg, #A8D8EA, #AA96DA);
        }
        #theme-sunset {
            background: linear-gradient(135deg, #FF9A8B, #FF6B6B);
        }
        #theme-forest {
            background: linear-gradient(135deg, #7BA05B, #556B2F);
        }
        #theme-ocean {
            background: linear-gradient(135deg, #4A90E2, #2E5B9A);
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .font-size-label {
            font-weight: 500;
            font-size: 14px;
        }
        .font-size-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--message-received-bg);
            outline: none;
        }
        .font-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: var(--transition);
        }
        .font-size-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        .font-size-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }
        .font-size-value {
            font-size: 14px;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: center;
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        html[data-theme="dark"] .settings-section-title {
            color: var(--accent-color-dark);
        }

        .notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 10001 !important;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            animation: notificationSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-left: 4px solid var(--accent-color);
        }
@keyframes notificationSlideIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        .notification.hiding {
            animation: notificationSlideOut 0.4s ease-in forwards;
        }
@keyframes notificationSlideOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }
        .notification i {
            color: var(--accent-color);
        }
        html[data-theme="dark"] .notification i {
            color: var(--accent-color-dark);
        }

        .import-export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .import-export-btn {
            flex: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background-color: var(--message-received-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: var(--font-family);
        }
        .import-export-btn:hover {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }
        .import-export-btn.export {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
        }
        html[data-theme="dark"] .import-export-btn.export {
            background-color: var(--accent-color-dark);
        }

        .date-divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
        }
        .date-divider::before, .date-divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background-color: var(--border-color);
        }
        .date-divider span {
            padding: 0 12px;
        }


        .coin-toss-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .coin-toss-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .coin-container {
            perspective: 1200px;
            margin-bottom: 40px;
            filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.2));
        }

        .coin {
            width: 180px;
            height: 180px;
            position: relative;
            transform-style: preserve-3d;
            border-radius: 50%;
        }

        .coin.flipping-heads {
            animation: flip-coin-heads 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        .coin.flipping-tails {
            animation: flip-coin-tails 3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Serif SC', serif;
            border: 8px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        .coin-front {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            color: #333;
            transform: rotateY(0deg);
        }
        .coin-front::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #bdc3c7;
            border-radius: 50%;
        }

        .coin-back {
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            color: #fdfbfb;
            transform: rotateY(180deg);
        }
        .coin-back::after {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px dashed #7f8c8d;
            border-radius: 50%;
        }

        .coin-text-main {
            font-size: 48px;
            font-weight: 400;
            letter-spacing: 4px;
            margin-bottom: 5px;
        }
        .coin-text-sub {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.6;
            font-family: sans-serif;
        }


        .coin-result-container {
            min-height: 60px;
            display: flex;
            justify-content: center;
        }

        .coin-result-text {
            font-family: 'Noto Serif SC', serif;
            font-size: 15px;
            color: #fff;
            font-weight: 300;
            opacity: 0.8;
            letter-spacing: 3px;
            transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            margin-top: 20px;
            text-align: center;
        }


        .coin-toss-overlay.finished .coin-result-text {
            font-size: 28px;
            opacity: 1;
            font-weight: 500;
            letter-spacing: 2px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }


        .coin-confirm-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;

            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;


            transition: opacity 0.3s ease, transform 0.3s ease;
        }


        .coin-toss-overlay.finished .coin-confirm-buttons {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;

            transition-delay: 0.3s;
        }

        .coin-btn-action {
            padding: 10px 24px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
            backdrop-filter: blur(5px);
        }
        .coin-btn-action:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
            transform: translateY(-2px);
        }

        .coin-btn-primary {
            background: #fff;
            color: #000;
            border-color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .coin-btn-primary:hover {
            background: #f0f0f0;
            box-shadow: 0 6px 20px rgba(255,255,255,0.3);
            transform: translateY(-2px) scale(1.02);
        }

@keyframes flip-coin-heads {
            0% {
                transform: rotateY(0) scale(1);
                animation-timing-function: ease-in;
            }
            40% {
                transform: rotateY(1080deg) scale(1.4);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotateY(2160deg) scale(1);
            }
        }

@keyframes flip-coin-tails {
            0% {
                transform: rotateY(0) scale(1);
                animation-timing-function: ease-in;
            }
            40% {
                transform: rotateY(1080deg) scale(1.4);
                animation-timing-function: ease-out;
            }
            100% {
                transform: rotateY(2340deg) scale(1);
            }
        }

        .settings-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .settings-footer a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .settings-footer a:hover {
            text-decoration: underline;
        }

        #session-modal .modal-content {
            max-width: 500px;
        }
        .session-list {
            flex: 1;
            overflow-y: auto;
            margin: 0 -10px;
            padding: 0 10px;
            max-height: 50vh;
        }
        .session-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            transition: var(--transition);
        }
        .session-item:hover {
            background-color: var(--primary-bg);
            transform: translateX(5px);
        }
        .session-item.active {
            border-color: var(--accent-color);
            background-color: rgba(var(--accent-color-rgb), 0.1);
            font-weight: 600;
        }
        .session-info {
            cursor: pointer;
            flex-grow: 1;
        }
        .session-name {
            font-size: 15px;
        }
        .session-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .session-actions {
            display: flex;
            gap: 8px;
        }
        .session-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .session-action-btn:hover {
            color: var(--text-primary);
            background-color: var(--border-color);
            transform: scale(1.1);
        }
        .session-action-btn.delete:hover {
            color: #e53935;
        }


        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            gap: 10px;
        }

        .pagination-btn {
            background-color: var(--message-received-bg);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: var(--border-color);
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
        }


        .fortune-card.tarot-style {
            background-color: var(--secondary-bg);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            overflow: hidden;
            text-align: center;
            position: relative;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }


        .fortune-card.tarot-style::before {
            content: "";
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            pointer-events: none;
        }


        .tarot-header {
            padding: 20px 0 10px;
            font-size: 12px;
            letter-spacing: 3px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
        }


        .tarot-visual {
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            position: relative;
        }


        .tarot-icon-vector {
            font-size: 64px;
            color: var(--text-primary);
            opacity: 0.8;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }


        .tarot-visual.reversed .tarot-icon-vector {
            transform: rotate(180deg);
            opacity: 0.6;
        }


        .tarot-card-name {
            font-family: var(--font-family);
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-primary);
            letter-spacing: 1px;
        }


        .tarot-position-badge {
            display: inline-block;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            font-weight: 500;
        }

        .tarot-position-badge.reversed {
            color: #e57373;
            background-color: rgba(229, 115, 115, 0.1);
            border-color: rgba(229, 115, 115, 0.2);
        }


        .tarot-details {
            padding: 0 30px 30px;
            position: relative;
            z-index: 2;
        }

        .tarot-divider {
            height: 1px;
            width: 40px;
            background-color: var(--accent-color);
            margin: 0 auto 15px;
        }

        .tarot-keyword {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .fortune-desc {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
            font-style: italic;
        }

        .fortune-tip {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.7;
            border-top: 1px dashed var(--border-color);
            padding-top: 10px;
        }


        .fortune-card {
            animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
@keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .batch-favorite-mode .message-wrapper {
            cursor: pointer;
        }

        .batch-favorite-mode .message-wrapper:hover .message {
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        .batch-favorite-mode .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px var(--favorite-color);
        }


        
        .fav-card {
            background-color: var(--primary-bg);
            border-radius: 12px;
            padding: 14px;
            border: 1px solid var(--border-color);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .fav-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }
        .fav-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .fav-content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .fav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .fav-sender-name {
            font-weight: 600;
            color: var(--accent-color);
        }
        .fav-bubble {
            background-color: var(--secondary-bg);
            padding: 8px 12px;
            border-radius: 8px;
            border-top-left-radius: 2px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-primary);
            border: 1px solid rgba(0,0,0,0.03);
            word-break: break-all;
        }
        .fav-bubble img {
            max-width: 100%;
            border-radius: 6px;
            display: block;
            margin-top: 5px;
        }
        .fav-action-btn {
            align-self: flex-end;
            font-size: 11px;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 4px;
            opacity: 0.6;
            transition: 0.2s;
        }
        .fav-action-btn:hover {
            color: #e53935;
            opacity: 1;
            text-decoration: underline;
        }

        .no-favorites {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            color: var(--text-secondary);
            opacity: 0.6;
        }
        .no-favorites i {
            font-size: 36px;
            margin-bottom: 10px;
            color: var(--border-color);
        }


        .batch-favorite-checkbox {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%) scale(0);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            background-color: var(--secondary-bg);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }
        .batch-favorite-checkbox.checked {
            background-color: #ffc107;
            border-color: #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
        }
        .batch-favorite-checkbox.checked::after {
            content: "âœ“";
            font-weight: 900;
            color: #fff;
            font-size: 12px;
        }

        .batch-favorite-mode .message-wrapper {
            transform: translateX(30px);
            transition: transform 0.3s ease;
        }

        .batch-favorite-mode .message-wrapper .batch-favorite-checkbox {
            transform: translateY(-50%) scale(1);
            opacity: 1;
        }

        .message-wrapper.selected .message {
            box-shadow: 0 0 0 2px #ffc107, 0 4px 12px rgba(255, 193, 7, 0.2);
            transform: scale(1.02);
        }

        .batch-favorite-actions {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(128,128,128,0.2);
            border-radius: 50px;
            padding: 8px 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 10px;
            z-index: 2002;
            animation: floatUpAction 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
@keyframes floatUpAction {
            to {
                transform: translateX(-50%) translateY(0);
            }
        }

        .batch-action-btn-pill {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: var(--font-family);
        }
        .batch-btn-confirm {
            background-color: #ffc107;
            color: #fff;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.3);
        }
        .batch-btn-confirm:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }
        .batch-btn-cancel {
            background-color: transparent;
            color: var(--text-primary);
        }
        .batch-btn-cancel:hover {
            background-color: var(--border-color);
        }



        #custom-replies-modal .modal-content {
            background-color: var(--primary-bg);
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            padding: 0;
            height: 90vh; 
            max-height: 90vh; 
        }


        #custom-replies-modal .modal-title {
            padding: 20px 24px 10px;
            background-color: var(--secondary-bg);
            margin-bottom: 0;
            font-size: 18px;
            border-bottom: none;
            flex-shrink: 0; 
        }


        .reply-tabs {
            display: flex;
            padding: 0 20px 15px;
            background-color: var(--secondary-bg);
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; 
        }

        .reply-tab-btn {
            flex: 1;
            padding: 10px 0;
            border-radius: 20px;

            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .reply-tab-btn:hover {
            background-color: var(--border-color);
            color: var(--text-primary);
        }

        .reply-tab-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.3);
            transform: translateY(-1px);
        }


        .reply-toolbar {
            padding: 15px 20px;
            display: flex;
            gap: 12px;
            align-items: center;
            background-color: var(--primary-bg);
            flex-shrink: 0; 
        }

        .reply-search {
            flex: 1;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .reply-search:focus {
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
            box-shadow: 0 4px 12px rgba(var(--accent-color-rgb), 0.15);
            transform: translateY(-1px);
        }

        .reply-tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--secondary-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .reply-tool-btn:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.2);
        }

        .custom-replies-list {
            padding: 10px 20px;
            gap: 12px;
            background-color: var(--primary-bg);
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .reply-list-with-buttons {
            padding-bottom: 90px !important; 
        }

        .custom-reply-item {
            background-color: var(--secondary-bg);
            border-radius: 16px;

            padding: 16px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }

        .custom-reply-item:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            border-color: rgba(var(--accent-color-rgb), 0.3);
        }
.custom-reply-text {
    flex: 1;
    white-space: normal; 
    word-break: break-all; 
    line-height: 1.4;
    padding-right: 10px;
    font-size: 14px;
}


        .custom-reply-item.disabled {
            background-color: rgba(var(--primary-bg-rgb), 0.5);
            border-style: dashed;
            opacity: 0.7;
        }
        .custom-reply-item.disabled .custom-reply-text {
            text-decoration: line-through;
            color: var(--text-secondary);
        }


        .custom-reply-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .reply-action-mini {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: none;
            background-color: var(--primary-bg);

            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 14px;
        }


        .reply-action-mini.edit-reply:hover,
        .reply-action-mini.modify-default:hover {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: rotate(10deg);
        }


        .reply-action-mini.delete-reply:hover {
            background-color: #ff4757;
            color: white;
            transform: rotate(-10deg);
        }


        .reply-action-mini.toggle-default:hover {
            background-color: var(--text-secondary);
            color: var(--secondary-bg);
        }

        #custom-replies-modal .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    background-color: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
    padding: 15px 20px;
    border-top: 1px solid var(--border-color);
    z-index: 100;
    margin-top: 0;
    flex-shrink: 0;
}

        #add-custom-reply {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            color: var(--message-sent-text);
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(var(--accent-color-rgb), 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        #add-custom-reply:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-color-rgb), 0.4);
        }


        html[data-theme="dark"] .custom-reply-item {
            background-color: rgba(255,255,255,0.03);
        }
        html[data-theme="dark"] .reply-action-mini {
            background-color: rgba(255,255,255,0.08);
        }


        .stats-dashboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 5px 0;
        }


        .stats-card {
            background-color: var(--primary-bg);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            margin-bottom: 5px;
        }


        .stats-overview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .overview-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background-color: var(--secondary-bg);
            border-radius: 12px;
            text-align: center;
            border: 1px solid transparent;
        }

        .overview-item:hover {
            border-color: var(--border-color);
            background-color: var(--primary-bg);
        }

        .overview-value {
            font-family: 'Georgia', serif;
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1.2;
        }

        .overview-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }


        .stats-card-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 8px;
        }

        .stats-rank-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stats-toggle-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1.5px solid var(--border-color);
            border-radius: 20px;
            background: var(--secondary-bg);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.25s ease;
            font-family: var(--font-family);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .stats-toggle-btn.active {
            background: var(--accent-color);
            color: #fff;
            border-color: var(--accent-color);
            box-shadow: 0 2px 8px rgba(var(--accent-color-rgb), 0.3);
        }
        .stats-toggle-btn:not(.active):hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .rank-item {
            position: relative;
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: transparent;
            border-radius: 8px;
            overflow: hidden;
            min-height: 44px;
        }


        .rank-progress-bg {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            background-color: rgba(var(--accent-color-rgb), 0.12);
            z-index: 0;
            border-radius: 8px;
            transition: width 0.6s ease;
        }


        .rank-info {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
        }

        .rank-number {
            width: 24px;
            font-weight: 800;
            font-style: italic;
            color: var(--text-secondary);
            opacity: 0.5;
            flex-shrink: 0;
            text-align: center;
            font-size: 14px;
        }

        .rank-item:nth-child(1) .rank-number {
            color: #FFD700;
            opacity: 1;
            text-shadow: 0 1px 0 rgba(0,0,0,0.1);
            font-size: 16px;
        }
        .rank-item:nth-child(2) .rank-number {
            color: #9EA1A3;
            opacity: 1;
            font-size: 15px;
        }
        .rank-item:nth-child(3) .rank-number {
            color: #CD7F32;
            opacity: 1;
            font-size: 15px;
        }


        .rank-text {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            line-height: 1.4;
            white-space: normal;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .rank-count {
            flex-shrink: 0;
            font-size: 12px;
            color: var(--accent-color);
            font-weight: 700;
            background-color: var(--secondary-bg);
            padding: 4px 8px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            min-width: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .rank-count small {
            font-size: 9px;
            opacity: 0.7;
            font-weight: normal;
            margin-top: 2px;
        }

        .stats-empty-state {
            text-align: center;
            padding: 30px 10px;
            color: var(--text-secondary);
        }

        #stats-modal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            padding: 20px;
            overflow: hidden;
        }

        #stats-modal .modal-title {
            flex-shrink: 0;
            margin-bottom: 15px;
        }

        #stats-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding-right: 5px;
            margin-bottom: 15px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #stats-content::-webkit-scrollbar {
            display: none;
        }

        #stats-modal .modal-buttons {
            flex-shrink: 0;
            margin-top: 0;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }
        
        

#anniversary-modal .modal-content {
    padding: 0;
    background-color: var(--primary-bg);
    display: flex;
    flex-direction: column;
    height: 82vh; 
    max-height: 82vh;
    overflow: hidden;
    position: relative;
}

.ann-header-card {
    background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-color-dark, var(--accent-color)) 60%, rgba(var(--accent-color-rgb),0.7) 100%);
    color: #fff;
    padding: 0;
    text-align: center;
    flex-shrink: 0;
    box-shadow: 0 6px 24px rgba(var(--accent-color-rgb), 0.35);
    z-index: 5;
    position: relative;
    overflow: hidden;
    min-height: 180px;
    display: flex;
    align-items: stretch;
}

.ann-header-card-bg {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: opacity 0.4s;
}

.ann-header-card-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0.25) 0%, rgba(0,0,0,0.5) 100%);
    pointer-events: none;
}

.ann-header-card-inner {
    position: relative;
    z-index: 2;
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 24px 20px 18px;
    gap: 2px;
}

.ann-header-upload-btn {
    position: static;
    z-index: 5;
    background: rgba(255,255,255,0.22);
    border: 1px solid rgba(255,255,255,0.4);
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 11px;
    color: #fff;
    cursor: pointer;
    backdrop-filter: blur(6px);
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: background 0.2s;
}
.ann-header-upload-btn:hover { background: rgba(255,255,255,0.35); }

#ann-card-toolbar {
    display: none;
    padding: 8px 14px 4px;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 2px;
}

.ann-header-card::before {
    content: 'â¤ï¸Ž';
    position: absolute;
    font-size: 80px;
    right: -10px;
    top: -10px;
    opacity: 0.08;
    pointer-events: none;
    line-height: 1;
    z-index: 1;
}

.ann-header-icon {
    font-size: 22px;
    margin-bottom: 4px;
    display: block;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
}

.ann-header-label {
    font-size: 10px;
    letter-spacing: 3px;
    opacity: 0.75;
    text-transform: uppercase;
    margin-bottom: 4px;
    display: block;
}

.ann-header-title {
    font-size: 15px;
    font-weight: 600;
    opacity: 0.95;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
}

.ann-header-days {
    font-size: 68px;
    font-weight: 800;
    font-family: 'Georgia', serif;
    margin: 2px 0;
    line-height: 1;
    text-shadow: 0 3px 12px rgba(0,0,0,0.15);
    letter-spacing: -2px;
}

.ann-header-days-unit {
    font-size: 16px;
    font-weight: 500;
    opacity: 0.8;
    margin-left: 4px;
    letter-spacing: 0;
    vertical-align: baseline;
}

.ann-header-date {
    font-size: 12px;
    background: rgba(255,255,255,0.22);
    padding: 4px 14px;
    border-radius: 20px;
    display: inline-block;
    backdrop-filter: blur(5px);
    margin-top: 6px;
    letter-spacing: 0.5px;
}

.ann-header-milestones {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    gap: 6px;
    flex-wrap: wrap;
}

.ann-milestone-chip {
    background: rgba(255,255,255,0.22);
    border: 1px solid rgba(255,255,255,0.35);
    border-radius: 20px;
    padding: 3px 10px;
    font-size: 11px;
    backdrop-filter: blur(4px);
    white-space: nowrap;
}

.ann-list-container {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.ann-item-card {
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 14px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s;
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.ann-item-card.ann-item-active {
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.18);
}

.ann-item-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
    border-radius: 4px 0 0 4px;
}

.ann-item-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.ann-item-card.type-past {
    background: linear-gradient(135deg, rgba(255,154,158,0.06) 0%, var(--secondary-bg) 60%);
}
.ann-item-card.type-past::before { background: linear-gradient(180deg, #ff9a9e, #fecfef); }

.ann-item-card.type-future {
    background: linear-gradient(135deg, rgba(118,75,162,0.07) 0%, var(--secondary-bg) 60%);
}
.ann-item-card.type-future::before { background: linear-gradient(180deg, #764ba2, #a78bfa); }

.ann-item-left {
    display: flex;
    flex-direction: column;
    gap: 5px;
    flex: 1;
    min-width: 0;
    padding-left: 10px;
}

.ann-item-name {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.ann-item-date {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

.ann-tag {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 6px;
    font-weight: 500;
}
.ann-item-card.type-past .ann-tag {
    background: rgba(255,154,158,0.18);
    color: #d14d6e;
    border: 1px solid rgba(255,154,158,0.3);
}
.ann-item-card.type-future .ann-tag {
    background: rgba(118,75,162,0.13);
    color: #764ba2;
    border: 1px solid rgba(118,75,162,0.25);
}

html[data-theme="dark"] .ann-item-card.type-past .ann-tag { color: #ff9a9e; }
html[data-theme="dark"] .ann-item-card.type-future .ann-tag { color: #c4b5fd; }

.ann-item-right {
    text-align: right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
    flex-shrink: 0;
    margin-left: 12px;
}

.ann-item-days {
    font-size: 26px;
    font-weight: 800;
    font-family: 'Georgia', serif;
    line-height: 1;
    letter-spacing: -0.5px;
}
.ann-item-card.type-past .ann-item-days { color: #e07a8f; }
.ann-item-card.type-future .ann-item-days { color: #764ba2; }
html[data-theme="dark"] .ann-item-card.type-past .ann-item-days { color: #ffa0b0; }
html[data-theme="dark"] .ann-item-card.type-future .ann-item-days { color: #c4b5fd; }

.ann-item-days-unit {
    font-size: 10px;
    font-weight: 500;
    color: var(--text-secondary);
    font-family: var(--font-family);
    letter-spacing: 0;
}

.ann-item-days-label {
    font-size: 10px;
    color: var(--text-secondary);
    opacity: 0.75;
}

.ann-delete-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: rgba(0,0,0,0.04);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 11px;
    margin-left: 8px;
    transition: all 0.2s;
    flex-shrink: 0;
    border: 1px solid transparent;
}

.ann-delete-btn:hover {
    background: #ff4757;
    color: white;
    border-color: #ff4757;
    transform: scale(1.1);
}

.ann-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-secondary);
    gap: 12px;
    padding: 40px 20px;
}

.ann-empty-icon {
    font-size: 52px;
    opacity: 0.3;
}

.ann-empty p {
    font-size: 14px;
    opacity: 0.6;
    text-align: center;
    line-height: 1.6;
}

.ann-footer {
    padding: 14px 16px;
    background-color: var(--secondary-bg);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 10px;
    z-index: 10;
}

.ann-editor-slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--secondary-bg);
    z-index: 20;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}

.ann-editor-slide.active {
    transform: translateY(0);
}

.ann-editor-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    font-size: 16px;
    font-weight: 600;
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.08), transparent);
}

.ann-back-btn {
    background: none;
    border: none;
    font-size: 18px;
    margin-right: 15px;
    color: var(--accent-color);
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
}

.ann-back-btn:hover {
    background: rgba(var(--accent-color-rgb), 0.12);
}

.ann-editor-content {
    padding: 20px;
    flex: 1;
    overflow-y: auto;
}

.ann-form-group {
    margin-bottom: 22px;
}

.ann-label {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ann-label i {
    color: var(--accent-color);
    font-size: 13px;
}

.ann-type-selector {
    display: flex;
    gap: 10px;
}

.ann-type-btn {
    flex: 1;
    padding: 13px 10px;
    border: 2px solid var(--border-color);
    background: var(--primary-bg);
    color: var(--text-primary);
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
}

.ann-type-btn .ann-type-hint {
    font-size: 10px;
    opacity: 0.55;
    font-weight: 400;
}

.ann-type-btn.active {
    background: rgba(var(--accent-color-rgb), 0.1);
    color: var(--accent-color);
    border-color: var(--accent-color);
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.2);
}


@media (max-width: 768px) {
    .message-input, 
    .modal-input, 
    .modal-textarea,
    .reply-search,
    #my-status-input {
        font-size: 16px !important; 
    }
    .user-info {
        min-width: 45px;
    }
    .avatar {
        width: 48px;
        height: 48px;
    }
    .username {
        font-size: 12px;
        max-width: 55px;
    }
    .status {
        font-size: 10px;
    }
    .header-motto {
        font-size: 9px;
        top: 5px;
    }
    .header-actions {
        gap: 6px;
    }
    .action-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
    }
    .chat-container {
        padding: 20px 10px;
    }
    .message-wrapper {
        max-width: 90%;
    }
    .input-area {
        padding: 10px 12px;
        gap: 8px;
    }
    .input-btn {
        width: 42px;
        height: 42px;
    }
    .message-input {
        min-height: 42px;
        padding: 10px 16px;
    }
    .modal-content {
        width: 95%;
        max-width: none;
    }
    .batch-preview {
        left: 10px;
        right: 10px;
        bottom: 100%;
    }
    .stats-content {
        max-height: 300px;
    }
}

@media (max-width: 480px) {
    .header-inner {
        padding: 10px 6px;
    }
    .user-info {
        min-width: 40px;
    }
    .avatar {
        width: 40px;
        height: 40px;
    }
    .username {
        font-size: 11px;
        max-width: 45px;
    }
    .status {
        font-size: 9px;
        padding: 1px 4px;
    }
    .header-motto {
        font-size: 8px;
        top: 4px;
    }
    .header-actions {
        gap: 4px;
    }
    .action-btn {
        width: 30px;
        height: 30px;
        font-size: 14px;
    }
    .chat-container {
        padding: 15px 8px;
    }
    .input-area {
        padding: 8px 10px;
        gap: 6px;
    }
    .input-btn {
        width: 38px;
        height: 38px;
    }
    .message-input {
        min-height: 38px;
        padding: 8px 14px;
        font-size: 14px;
    }
    .batch-preview {
        left: 8px;
        right: 8px;
        bottom: 100%;
        max-height: 130px;
    }
    .empty-state i {
        font-size: 48px;
    }
    .empty-state p {
        font-size: 14px;
    }
}

@media (min-width: 481px) and (max-width: 1024px) {
    .sticker-picker-popover {
        width: min(320px, calc(100vw - 40px));
        height: min(350px, calc(100svh - 200px));
        right: 0;
        bottom: calc(100% + 6px);
        max-height: calc(100svh - 180px);
    }
    .input-area {
        padding: 8px 10px;
    }
    .input-btn {
        width: 36px;
        height: 36px;
        font-size: 15px;
    }
}

@media (max-width: 1024px) {
    .sticker-picker-popover {
        max-height: calc(100svh - 160px);
        height: min(350px, calc(100svh - 160px));
        bottom: calc(100% + 6px);
    }
    .combo-content-area {
        overflow-y: auto;
        flex: 1;
        min-height: 0;
    }
}

@media (max-width: 360px) {
    .username {
        display: none;
    }
    .user-info {
        gap: 2px;
    }
    .header-inner {
        padding: 8px 5px;
    }
    .input-buttons {
        gap: 5px;
    }
    .input-btn {
        width: 36px;
        height: 36px;
    }
}

.report-card {
    background-color: rgba(255,255,255,0.5);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid rgba(255,255,255,0.2);
    animation: slideInUp 0.5s ease forwards;
    opacity: 0;
    transform: translateY(20px);
}

html[data-theme="dark"] .report-card {
    background-color: rgba(30,30,30,0.5);
    border: 1px solid rgba(255,255,255,0.05);
}

.report-card h3 {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 10px;
    font-weight: normal;
    display: flex;
    align-items: center;
    gap: 8px;
}

.report-card .highlight-text {
    font-size: 24px;
    font-weight: bold;
    color: var(--accent-color);
    margin: 5px 0;
}

.report-card .sub-text {
    font-size: 12px;
    opacity: 0.7;
    line-height: 1.5;
}

.report-tag {
    display: inline-block;
    background: var(--message-received-bg);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin: 2px;
}

@keyframes slideInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 10px 5px;
        }

        .settings-card {
            background-color: var(--primary-bg);
            border-radius: 20px;
            padding: 25px 15px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
            position: relative;
            overflow: hidden;
        }


        .settings-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
            background-color: var(--secondary-bg);
        }


        .settings-card i {
            font-size: 28px;
            color: var(--accent-color);
            width: 64px;
            height: 64px;
            background-color: rgba(var(--accent-color-rgb), 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            transition: all 0.4s ease;
        }

        html[data-theme="dark"] .settings-card i {
            background-color: rgba(var(--accent-color-rgb), 0.2);
        }


        .settings-card:hover i {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 5px 15px rgba(var(--accent-color-rgb), 0.4);
        }

        .settings-card span {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.5px;
        }


        .settings-footer {
            margin-top: 25px;
            padding: 20px;
            border-radius: 16px;
            background-color: rgba(var(--primary-bg-rgb), 0.5);
            border: 1px dashed var(--border-color);
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .settings-footer p {
            margin: 2px 0;
        }

@media (max-width: 480px) {
            .settings-grid {
                gap: 12px;
            }
            .settings-card {
                padding: 20px 10px;
            }
            .settings-card i {
                width: 50px;
                height: 50px;
                font-size: 22px;
            }
            .settings-card span {
                font-size: 13px;
            }
        }


        .anniversary-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        .anniversary-animation.active {
            opacity: 1;
            pointer-events: all;
        }

        .anniversary-animation-content {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-color-dark));
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            max-width: 80%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .anniversary-animation.active .anniversary-animation-content {
            transform: scale(1);
            opacity: 1;
        }

        .anniversary-animation-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .anniversary-animation-days {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .anniversary-animation-message {
            font-size: 16px;
            opacity: 0.9;
        }


        .anniversary-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .anniversary-type-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--primary-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .anniversary-type-btn.active {
            background-color: var(--accent-color);
            color: var(--message-sent-text);
            border-color: var(--accent-color);
        }

        .anniversary-type-btn:hover {
            transform: translateY(-2px);
        }
        .player-container {
            position: fixed;
            top: 100px;
            left: 20px;
            width: 300px;
            height: 148px;
            background: rgba(var(--secondary-bg-rgb), 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12), 0 1px 0 rgba(255,255,255,0.06) inset;
            transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
            height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
            border-radius 0.4s ease,
            opacity 0.3s ease, visibility 0.3s ease;
            z-index: 990;
            overflow: hidden;
            cursor: grab;
            border: 1px solid rgba(var(--accent-color-rgb), 0.12);
            display: none;
            touch-action: none;
        }

        .player-container.visible {
            display: block;
        }

        .player-container:active {
            cursor: grabbing;
        }

        .player-container.collapsed {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 0;
            border-color: rgba(var(--accent-color-rgb), 0.25);
            box-shadow: 0 4px 20px rgba(var(--accent-color-rgb), 0.2), 0 1px 0 rgba(255,255,255,0.06) inset;
        }

        .full-view {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease 0.1s;
            padding: 15px 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .player-container.collapsed .full-view {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-20px);
            position: absolute;
        }

        .mini-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-container.collapsed .mini-view {
            opacity: 1;
            pointer-events: auto;
        }


        .vinyl-record {
            width: 44px;
            height: 44px;
            background-color: #1a1a1a;

            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(0,0,0,0.25);
            animation: spin 4s linear infinite;
            animation-play-state: paused;

            border: 2.5px solid rgba(var(--accent-color-rgb), 0.5);

            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: border-color 0.5s ease, box-shadow 0.3s ease;
        }


        .player-container.collapsed.playing .vinyl-record {
            animation-play-state: running;
        }
@keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }


        .vinyl-record::after {
            content: '';
            width: 10px;
            height: 10px;
            background: var(--accent-color);

            border-radius: 50%;
            position: absolute;
            z-index: 1;
            transition: background-color 0.5s ease;
        }


        .vinyl-record svg {
            width: 14px;
            height: 14px;
            fill: var(--accent-color);

            z-index: 2;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .mini-view:hover .vinyl-record svg {
            opacity: 1;
        }


        .vinyl-record.has-cover::after {
            display: none !important;
            width: 0;
            height: 0;
            opacity: 0;
        }


        .vinyl-record.has-cover svg {
            display: none !important;
        }


        #upload-cover-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            transform: scale(1.1);
        }

        .minimize-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
            z-index: 10;
            color: var(--text-secondary);
        }
        .minimize-btn:hover {
            opacity: 1;
            color: var(--text-primary);
        }
        .minimize-btn svg {
            width: 100%;
            height: 100%;
            fill: currentColor;
        }

        .track-info {
            text-align: center;
            margin-top: 5px;
        }
        .track-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: 0.2px;
        }
        .track-sub {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.7;
            letter-spacing: 0.3px;
        }


        .progress-wrapper {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            cursor: pointer;
            margin: 10px 0;
            position: relative;
        }
        .progress-wrapper::before {
            content: '';
            position: absolute;
            top: -6px;
            bottom: -6px;
            left: 0;
            right: 0;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent-color);

            border-radius: 2px;
            position: relative;
            transition: background-color 0.3s ease;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            right: -4px;
            top: -3px;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .progress-wrapper:hover .progress-bar::after {
            opacity: 1;
        }


        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .btn:hover {
            background: var(--message-received-bg);
            color: var(--text-primary);
        }
        .btn-main {
            width: 44px;
            height: 44px;
            background: var(--accent-color);

            color: var(--message-sent-text);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        html[data-theme="dark"] .btn-main {
            background: var(--accent-color-dark);
        }
        .btn-main:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
            color: var(--message-sent-text);
        }
        .btn svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }


        .playlist-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 320px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 16px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
    pointer-events: none;
    transition: all 0.3s ease;
    z-index: 980;
    display: flex;
    flex-direction: column;
    height: 400px;
    max-height: 60vh;
    overflow: hidden;
    padding: 0;
}

.playlist-popup.active {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}

.playlist-header {
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(var(--secondary-bg-rgb), 0.98);
    z-index: 5;
}

.pl-header-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-family);
    letter-spacing: 1px;
}

.pl-header-actions {
    display: flex;
    gap: 8px;
}

.pl-icon-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 14px;
}

.pl-icon-btn:hover, .pl-icon-btn.active {
    background-color: var(--primary-bg);
    color: var(--accent-color);
}

.playlist-search-wrapper {
    flex-shrink: 0;
    padding: 0 15px;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    border-bottom: 1px solid var(--border-color);
    overflow: hidden;
    height: 0;
    opacity: 0;
    transition: all 0.3s ease;
}

.playlist-search-wrapper.active {
    height: 50px;
    opacity: 1;
    padding: 8px 15px;
}

.playlist-search-input {
    width: 100%;
    background-color: var(--primary-bg);
    border: 1px solid transparent;
    border-radius: 8px;
    padding: 6px 10px 6px 30px;
    font-size: 12px;
    color: var(--text-primary);
    outline: none;
    transition: all 0.3s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' fill='%23999'%3E%3Cpath d='M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-size: 12px;
    background-position: 10px center;
}

.playlist-search-input:focus {
    background-color: var(--secondary-bg);
    border-color: var(--accent-color);
    box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.1);
}

.playlist-content {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-bottom: 10px;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.playlist-content::-webkit-scrollbar {
    display: none;
}

.playlist-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 15px;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
    cursor: pointer;
    gap: 10px;
}

.playlist-item:hover {
    background-color: var(--primary-bg);
}

.playlist-item.playing {
    background-color: rgba(var(--accent-color-rgb), 0.08);
}

.song-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.song-title-row {
    font-size: 13px;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
    font-weight: 500;
}

.song-title-row .highlight {
    color: var(--accent-color);
    font-weight: bold;
}

.playlist-item.playing .song-title-row {
    color: var(--accent-color);
    font-weight: 700;
}

.song-sub-row {
    font-size: 11px;
    color: var(--text-secondary);
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.item-actions {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
}

.action-icon-btn.delete {
    font-size: 16px;
    color: var(--text-secondary);
    opacity: 0;
    transition: all 0.2s;
    cursor: pointer;
    display: flex;
    align-items: center;
    height: 100%;
}

.playlist-item:hover .action-icon-btn.delete {
    opacity: 0.6;
}

.action-icon-btn.delete:hover {
    opacity: 1 !important;
    color: #ff4757;
    transform: scale(1.1);
}

.custom-tag {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background-color: var(--accent-color);
    opacity: 0.8;
    box-shadow: 0 0 0 1px rgba(var(--accent-color-rgb), 0.3);
    cursor: pointer;
    position: relative;
}
.custom-tag::after {
    content: "â—";
    font-size: 10px;
    color: #fff;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}
.custom-tag:hover {
    transform: scale(1.2);
    opacity: 1;
}
.empty-search-result {
    text-align: center;
    padding: 30px 10px;
    color: var(--text-secondary);
    font-size: 12px;
    opacity: 0.8;
}

        .pagination {
            display: none !important;
        }


        .chat-container {
            padding-top: 20px;
        }


        .history-loader {
            position: absolute;
            top: 10px;
            left: 0;
            width: 100%;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;

        }


        .history-loader.visible {
            opacity: 1;
        }


        .history-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(var(--accent-color-rgb), 0.2);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: history-spin 0.8s linear infinite;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

@keyframes history-spin {
            to {
                transform: rotate(360deg);
            }
        }

        .input-btn:active,
        .action-btn:active,
        .modal-btn:active,
        .batch-action-btn:active,
        .reply-action-mini:active,
        .settings-item:active,
        .session-item:active,
        .coin-btn-action:active,
        .import-export-btn:active {
            transform: scale(0.92) !important;

            transition: transform 0.1s cubic-bezier(0.34, 1.56, 0.64, 1);

        }


        .ripple-effect {
            position: relative;
            overflow: hidden;

            transform: translate3d(0, 0, 0);

        }


        .ripple-wave {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-anim 0.6s linear;
            pointer-events: none;

            background: rgba(255, 255, 255, 0.4);

            z-index: 99;
        }


        .modal-btn-primary .ripple-wave,
        .send-btn .ripple-wave,
        .batch-send-btn .ripple-wave,
        .theme-color-btn .ripple-wave {
            background: rgba(255, 255, 255, 0.6);
        }


        .modal-btn-secondary .ripple-wave,
        .input-btn:not(.send-btn) .ripple-wave,
        .settings-item .ripple-wave {
            background: rgba(0, 0, 0, 0.1);

        }


@keyframes ripple-anim {
            to {
                transform: scale(4);

                opacity: 0;

            }
        }


        .send-btn:hover {
            box-shadow: 0 6px 15px rgba(var(--accent-color-rgb), 0.4);
            transform: translateY(-2px) scale(1.05);
        }


        .input-btn:not(.send-btn):hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            transform: translateY(-2px);
        }


        .settings-item {
            transition: all 0.2s ease;
        }
        .settings-item:hover {
            background-color: var(--secondary-bg);
            border-color: rgba(var(--accent-color-rgb), 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateX(5px) scale(1.01);

        }


        .modal-btn-secondary:hover {
            background-color: #f5f5f5;
            color: #333;
            border-color: #ddd;
        }
        html[data-theme="dark"] .modal-btn-secondary:hover {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }

        .bg-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
            gap: 15px;
            padding: 15px 5px;
            max-height: 400px;
            overflow-y: auto;
        }

        .bg-item {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1; 
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
        }

        .bg-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        .bg-item img, .bg-item div.bg-color-block {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .bg-item.active {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.3);
        }

        .bg-item.active::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: var(--accent-color);
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 2;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

@keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0); }
            to { transform: translate(-50%, -50%) scale(1); }
        }

        .bg-add-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--message-received-bg);
            color: var(--text-secondary);
            border-radius: 50%; 
            border: 2px dashed var(--border-color);
            gap: 8px;
        }
        
        .bg-add-btn i {
            font-size: 24px;
            opacity: 0.7;
        }
        
        .bg-add-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .bg-add-btn:hover {
            background-color: var(--border-color);
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .bg-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.2s;
            z-index: 5;
        }
        .bg-item:hover .bg-delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        .bg-delete-btn:hover {
            background: #ff4757;
            transform: scale(1.1);
        }
.tour-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    display: none; 
}
.tour-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.tour-highlight-box {
    position: absolute;
    border-radius: 8px;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 15px rgba(255, 255, 255, 0.5);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    z-index: 10001;
}

.tour-popover {
    position: absolute;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 16px 20px;
    width: 300px;
    max-width: 90vw;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    z-index: 10002;
    opacity: 0;
    transform: translateY(15px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid var(--border-color);
}
.tour-popover.visible {
    opacity: 1;
    transform: translateY(0);
}
.tour-popover-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}
.tour-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--accent-color);
}
html[data-theme="dark"] .tour-title {
    color: var(--accent-color-dark);
}
.tour-step-counter {
    font-size: 12px;
    color: var(--text-secondary);
    background-color: var(--primary-bg);
    padding: 2px 8px;
    border-radius: 10px;
}
.tour-popover-content {
    font-size: 14px;
    line-height: 1.7;
    color: var(--text-primary);
    margin-bottom: 16px;
}
.tour-popover-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.tour-navigation {
    display: flex;
    gap: 8px;
}
.tour-btn {
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    font-family: var(--font-family);
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.tour-btn:hover {
    transform: translateY(-1px);
}
.tour-btn:active {
    transform: scale(0.95) !important;
}
.tour-btn-skip {
    background-color: transparent;
    color: var(--text-secondary);
}
.tour-btn-skip:hover {
    background-color: var(--message-received-bg);
}
.tour-btn-primary {
    background-color: var(--accent-color);
    color: var(--message-sent-text);
}
html[data-theme="dark"] .tour-btn-primary {
    background-color: var(--accent-color-dark);
}
.tour-btn-primary:hover {
    filter: brightness(1.1);
}


        #custom-replies-modal .modal-title {
            flex-shrink: 0;
            padding: 20px 24px 10px;
            background-color: var(--secondary-bg);
            margin-bottom: 0;
            border-bottom: none;
        }

        #custom-replies-modal .reply-tabs {
            flex-shrink: 0;
            padding: 0 20px 15px;
            background-color: var(--secondary-bg);
            border-bottom: 1px solid var(--border-color);
        }

        #custom-replies-modal .reply-toolbar {
            flex-shrink: 0;
            padding: 15px 20px;
            background-color: var(--primary-bg);
            display: flex;
            gap: 12px;
            align-items: center;
        }

.modal-sidebar {
    width: 100%;
    height: auto;
    background-color: var(--primary-bg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    flex-direction: row;
    padding: 10px 20px;
    gap: 10px;
    flex-shrink: 0;
    justify-content: center;
}

.sidebar-btn {
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    font-size: 14px;
    font-weight: 500;
    min-width: 120px;
    justify-content: center;
}

.sidebar-btn i {
    font-size: 18px;
}

.sidebar-btn.active {
    background-color: var(--secondary-bg);
    color: var(--accent-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.modal-main-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    height: 100%;
    position: relative;
    overflow: hidden; 
}

.modal-main-view .reply-tabs {
    padding: 15px 20px 10px;
    background-color: var(--secondary-bg);
    white-space: nowrap;
    overflow-x: auto;
    flex-shrink: 0;
}

.modal-main-view .reply-toolbar {
    padding: 10px 20px;
    background-color: var(--secondary-bg);
    border-bottom: 1px solid var(--border-color);
}

.content-list-area {
    flex: 1;
    overflow-y: auto !important; 
    overflow-x: hidden;
    padding: 15px;
    padding-bottom: 80px !important; 
    background-color: var(--primary-bg);
    height: 0; 
    -webkit-overflow-scrolling: touch; 
}

.content-list-area.grid-mode {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)) !important; 
    gap: 12px !important;
    align-content: start; 
}

.content-list-area.list-mode .custom-reply-item {
    margin-bottom: 10px; 
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    height: auto; 
    min-height: 50px;
}

.content-list-area.grid-mode {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 15px;
    align-content: start;
}

.modal-main-view .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(var(--secondary-bg-rgb), 0.95);
    backdrop-filter: blur(10px);
}

.sticker-item {
    position: relative;
    width: 100%;
    aspect-ratio: 1 / 1; 
    border-radius: 12px;
    border: 2px solid var(--border-color);
    overflow: hidden;
    background-color: var(--secondary-bg);
    display: flex;
    align-items: center;
    justify-content: center;
}

.sticker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover; 
    display: block;
}

.sticker-item:hover {
    border-color: var(--accent-color);
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.sticker-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(2px);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    opacity: 0; 
    transform: scale(0.8);
    transition: all 0.2s ease;
    z-index: 2;
}

.sticker-item:hover .sticker-delete-btn {
    opacity: 1;
    transform: scale(1);
}

.sticker-delete-btn:hover {
    background: #ff4757;
    transform: scale(1.1);
}

        #custom-replies-modal .modal-buttons {
            position: static; 
            flex-shrink: 0; 
            width: 100%;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-top: 1px solid var(--border-color);
            margin-top: 0;
            z-index: 10;
        }
#custom-replies-modal .modal-buttons {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    z-index: 10;
    flex-shrink: 0;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 10px;
    padding: 15px;
}

.emoji-item {
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--secondary-bg);
    border-radius: 12px;
    aspect-ratio: 1 / 1;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
    position: relative;
}

.emoji-item:hover {
    background-color: var(--border-color);
    transform: scale(1.1);
}

.emoji-item.disabled {
    opacity: 0.4;
    background-color: var(--primary-bg);
    filter: grayscale(100%);
}

.emoji-item.disabled::after {
    content: '\f05e'; 
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    position: absolute;
    font-size: 14px;
    color: #ff4757;
}

#theme-editor-modal .modal-content {
    max-width: 580px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}
.theme-editor-toolbar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    align-items: center;
    flex-wrap: wrap;
}
.theme-editor-toolbar select {
    flex-grow: 1;
    min-width: 140px;
    padding: 9px 12px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
}
#theme-editor-grid {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
}
.theme-editor-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    padding: 4px 2px;
}
.color-picker-item {
    display: flex;
    align-items: center;
    gap: 10px;
    background: linear-gradient(135deg, var(--primary-bg), rgba(var(--accent-color-rgb),0.03));
    padding: 9px 10px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    transition: border-color 0.2s, box-shadow 0.2s;
}
.color-picker-item:hover {
    border-color: rgba(var(--accent-color-rgb),0.3);
    box-shadow: 0 2px 8px rgba(var(--accent-color-rgb),0.08);
}
.color-picker-item label {
    font-size: 12px;
    flex-grow: 1;
    color: var(--text-secondary);
}
.color-picker-item input[type="color"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 36px;
    height: 36px;
    background-color: transparent;
    border: none;
    cursor: pointer;
    border-radius: 8px;
    overflow: hidden;
    flex-shrink: 0;
}
.color-picker-item input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
.color-picker-item input[type="color"]::-webkit-color-swatch {
    border-radius: 8px;
    border: 2px solid var(--border-color);
}
.color-picker-item input[type="color"]::-moz-color-swatch {
    border-radius: 8px;
    border: 2px solid var(--border-color);
}
.avatar-container {
    position: relative;
    width: 56px;
    height: 56px;
    order: 2;
    flex-shrink: 0;
}

.avatar-shape-circle { border-radius: 50% !important; overflow: hidden !important; }
.avatar-shape-circle img, .avatar-shape-circle i { border-radius: 50% !important; clip-path: none !important; }
.avatar-shape-circle .avatar { border-radius: 50% !important; overflow: hidden; }
.avatar-shape-square { border-radius: var(--avatar-corner-radius, 8px) !important; overflow: hidden !important; }
.avatar-shape-square img, .avatar-shape-square i { border-radius: var(--avatar-corner-radius, 8px) !important; clip-path: none !important; }
.avatar-shape-square .avatar { border-radius: var(--avatar-corner-radius, 8px) !important; overflow: hidden; }

.message-avatar.shape-circle { border-radius: 50% !important; overflow: hidden !important; }
.message-avatar.shape-circle img, .message-avatar.shape-circle i { border-radius: 50% !important; clip-path: none !important;}
.message-avatar.shape-square { border-radius: var(--avatar-corner-radius, 8px) !important; overflow: hidden !important; }
.message-avatar.shape-square img, .message-avatar.shape-square i { border-radius: var(--avatar-corner-radius, 8px) !important; clip-path: none !important; }
.avatar {
    width: 100% !important;
    height: 100% !important;
    position: relative;
    z-index: 1;
}

.avatar-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
    pointer-events: none; 
}

.message-avatar {
    position: relative;
}

.message-avatar .avatar-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
    pointer-events: none;
}
.message-avatar img, .message-avatar i {
    position: absolute; 
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: calc(var(--in-chat-avatar-size) * 0.5); 
}


.frame-settings-container {
    display: flex;
    gap: 20px;
    align-items: flex-start;
    padding-top: 10px;
}
.frame-preview-wrapper {
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.frame-preview {
    width: 80px;
    height: 80px;
    position: relative;
flex-shrink: 0; 
}
.frame-preview .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
overflow: hidden;
position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    background-color: var(--secondary-bg);
    border: 2px dashed var(--border-color); 
    display: flex;
    align-items: center;
    justify-content: center;

}
.frame-preview .preview-bg-layer {
    width: 100%;
    height: 100%;
    border-radius: 50%; 
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    background-color: var(--secondary-bg);
    border: 2px dashed var(--border-color);
    box-sizing: border-box; 
    -webkit-mask-image: radial-gradient(white, black);
    mask-image: radial-gradient(white, black);
    overflow: hidden; 
}
.frame-preview .preview-bg-layer img {
    width: 100%;
    height: 100%;
    object-fit: cover; 
border-radius: 50%; 
    display: block;
    
}
.frame-preview .preview-bg-layer i {
    font-size: 32px;
    color: var(--text-secondary);
position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.frame-preview .preview-avatar-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: var(--text-secondary);
}
.frame-preview .preview-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    pointer-events: none;
    max-width: none; 
    max-height: none;
}
.frame-controls {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.frame-slider-group {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
}
.frame-slider-group label {
    width: 40px;
    flex-shrink: 0;
    color: var(--text-secondary);
}
.frame-slider-group input[type="range"] {
    flex-grow: 1;
}

@media (max-width: 768px) {
    .avatar-container {
        width: 46px;
        height: 46px;
    }
}
@media (max-width: 480px) {
    .avatar-container {
        width: 40px;
        height: 40px;
    }
}
#custom-bubble-css {
    background-color: #2b2b2b; 
    color: #f8f8f2; 
    border: 1px solid var(--border-color);
    padding: 10px;
    line-height: 1.4;
    border-radius: 8px;
    resize: vertical;
}

html[data-theme="light"] #custom-bubble-css {
    background-color: #f5f5f5;
    color: #333;
}
.content-list-area.grid-mode {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important;
    grid-auto-rows: max-content !important; 
    gap: 15px !important;
    align-content: start !important;
    padding-bottom: 120px !important; 
    overflow-y: auto !important;
    height: auto !important;
}

.sticker-item {
    position: relative !important;
    width: 100% !important;
    aspect-ratio: 1 / 1 !important;
    height: auto !important;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    background-color: var(--secondary-bg);
    overflow: hidden !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    margin: 0 !important; 
}

.sticker-item img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important; 
    display: block !important;
}

.emoji-grid {
    padding-bottom: 100px !important;
}
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    margin-bottom: 10px;
}
.current-month-label {
    font-size: 16px;
    font-weight: 600;
    font-family: var(--font-family);
}
.calendar-nav-btn {
    background: none;
    border: none;
    font-size: 16px;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 5px 10px;
}
.calendar-nav-btn:hover {
    color: var(--accent-color);
}
.calendar-weekdays, .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    gap: 2px;
}
.calendar-weekdays div {
    font-size: 12px;
    color: var(--text-secondary);
    padding-bottom: 5px;
}
.calendar-day {
    min-height: 50px; 
    padding: 2px;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
    align-items: center;
}

@media (max-width: 480px) {
    .calendar-weekdays div { font-size: 10px; }
    .calendar-day { 
        min-height: 45px; 
        font-size: 10px;
    }
.mood-detail-dot {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 20px !important; 
        height: 20px !important;
        border-radius: 50% !important; 
        padding: 0 !important;
        margin: 1px auto !important; 
        font-size: 12px !important;
        line-height: 1 !important;
        overflow: hidden;
    }
.mood-text-span {
        display: none;
    }
    
 .mood-kaomoji-span {
        display: block;
        transform: scale(0.9);
    }

    .mood-dots-container {
        flex-direction: row !important;
        justify-content: center;
        flex-wrap: wrap;
        gap: 2px;
    }
.mood-detail-dot {
    width: 100%;
    border-radius: 4px;
    padding: 2px;
    font-size: 10px;
    text-align: center;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
    transform: scale(0.9); 
}

.mood-detail-dot.partner-mood {
    opacity: 0.9;
    border: 1px dashed rgba(255,255,255,0.5); 
}
.calendar-day:hover {
    background-color: var(--message-received-bg);
}
.calendar-day.today {
    background-color: rgba(var(--accent-color-rgb), 0.1);
    color: var(--accent-color);
    font-weight: bold;
    border-color: var(--accent-color);
}
.calendar-day.empty {
    pointer-events: none;
}
.mood-dots {
    display: flex;
    gap: 2px;
    margin-top: 2px;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
}
.mood-marker {
    font-size: 10px;
    width: 16px; 
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background-color: var(--secondary-bg);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.mood-marker.me { color: var(--accent-color); border: 1px solid rgba(var(--accent-color-rgb), 0.3); }
.mood-marker.partner { color: #ff6b6b; border: 1px solid rgba(255, 107, 107, 0.3); }

.calendar-footer-legend {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 15px;
    font-size: 12px;
    color: var(--text-secondary);
}
.legend-item { display: flex; align-items: center; gap: 5px; }
.legend-item .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.legend-item .dot.me { background-color: var(--accent-color); }
.legend-item .dot.partner { background-color: #ff6b6b; }

.mood-selector-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 2100;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(2px);
}
.mood-selector-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
.mood-selector-card {
    background: var(--secondary-bg);
    padding: 20px;
    border-radius: 16px;
    width: 90%;
    max-width: 360px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.mood-options-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-top: 12px;
}
.mood-options-slider-wrapper {
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    max-height: 240px;
    padding-right: 2px;
}
.mood-options-slider-wrapper::-webkit-scrollbar { display:none; }
.mood-options-slider-wrapper .mood-options-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-top: 8px;
    width: 100%;
}

.theme-schemes-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
    max-height: 220px;
    overflow-y: auto;
    padding-right: 2px;
}
.theme-schemes-list::-webkit-scrollbar { display: none; }
.theme-scheme-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--primary-bg);
    border: 1.5px solid var(--border-color);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
}
.theme-scheme-item:hover {
    border-color: var(--accent-color);
    background: rgba(var(--accent-color-rgb), 0.06);
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(var(--accent-color-rgb), 0.15);
}
.theme-scheme-item.active-scheme {
    border-color: var(--accent-color);
    background: rgba(var(--accent-color-rgb), 0.1);
}
.scheme-preview-dots {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}
.scheme-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1.5px solid rgba(0,0,0,0.08);
    flex-shrink: 0;
}
.scheme-info {
    flex: 1;
    text-align: left;
    min-width: 0;
}
.scheme-name {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.scheme-meta {
    font-size: 10px;
    color: var(--text-secondary);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.scheme-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
}
.scheme-action-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s;
}
.scheme-action-btn:hover {
    background: var(--border-color);
    color: var(--text-primary);
}
.scheme-action-btn.delete:hover {
    background: rgba(255,71,87,0.1);
    color: #ff4757;
}
.theme-schemes-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 20px;
    color: var(--text-secondary);
    font-size: 12px;
    opacity: 0.7;
}
.theme-schemes-empty i {
    font-size: 24px;
    opacity: 0.4;
}

.mood-page-btn {
    background: var(--border-color);
    border: none;
    border-radius: 50%;
    width: 30px; height: 30px;
    font-size: 18px;
    color: var(--text-primary);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
    padding: 0 0 2px 0;
    flex-shrink: 0;
}
.mood-page-btn:hover { background: var(--accent-color); color: #fff; }
.mood-page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
.mood-tab-btn {
    background: var(--border-color);
    border: none;
    border-radius: 20px;
    padding: 6px 16px;
    font-size: 12px;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.2s;
    font-family: var(--font-family);
    font-weight: 500;
}
.mood-tab-btn.active {
    background: var(--accent-color);
    color: #fff;
    box-shadow: 0 2px 8px rgba(var(--accent-color-rgb), 0.35);
}
.mood-custom-add-btn {
    margin-top: 10px;
    width: 100%;
    background: none;
    border: 1px dashed var(--border-color);
    border-radius: 8px;
    padding: 6px;
    font-size: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    font-family: var(--font-family);
    transition: all 0.2s;
}
.mood-custom-add-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
.custom-mood-color-dot {
    width: 22px; height: 22px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s, border-color 0.2s;
}
.custom-mood-color-dot.selected { border-color: var(--text-primary); transform: scale(1.2); }
.mood-option-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 4px;
    border: 1.5px solid var(--border-color);
    border-radius: 12px;
    background: var(--primary-bg);
    cursor: pointer;
    transition: all 0.2s;
    min-height: 58px;
    position: relative;
}
.mood-option-btn:hover {
    transform: translateY(-2px);
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.3);
}
.mood-kaomoji { font-size: 20px; margin-bottom: 4px; white-space: nowrap; line-height: 1; }
.mood-label { font-size: 11px; opacity: 0.75; font-weight: 500; }

.mood-custom-actions {
    position: absolute;
    top: 2px; right: 2px;
    display: none;
    gap: 2px;
    background: rgba(var(--secondary-bg-rgb), 0.9);
    border-radius: 6px;
    padding: 2px;
}
.mood-option-custom:hover .mood-custom-actions { display: flex; }
.mood-custom-action-btn {
    border: none; background: none; cursor: pointer;
    font-size: 11px; padding: 2px 3px; border-radius: 4px;
    line-height: 1;
    transition: background 0.15s;
}
.mood-custom-action-btn:hover { background: var(--border-color); }

.stats-weather-tag {
    font-size: 11px;
    color: var(--text-secondary);
    margin-top: 4px;
    text-align: center;
    cursor: pointer;
    padding: 3px 8px;
    border-radius: 20px;
    border: 1px dashed var(--border-color);
    transition: all 0.2s;
    min-width: 60px;
}
.stats-weather-tag:hover {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background: rgba(var(--accent-color-rgb), 0.06);
}

@keyframes zoomIn {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
#fortune-lenormand-modal {
    z-index: 9999 !important; 
}

.tarot-container-3d {
    perspective: 1000px;
    width: 200px;
    height: 320px;
    margin: 0 auto 20px;
    cursor: pointer;
}

.tarot-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.8s;
    transform-style: preserve-3d;
}

.tarot-container-3d.flipped .tarot-card-inner {
    transform: rotateY(180deg);
}

.tarot-face {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 15px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.tarot-front {
    background: linear-gradient(135deg, #2c3e50, #000);
    color: #fff;
    border: 2px solid #bdc3c7;
}

.tarot-pattern {
    font-size: 40px;
    opacity: 0.3;
    animation: pulse 3s infinite;
}

.tarot-back {
    background-color: var(--secondary-bg);
    transform: rotateY(180deg);
    border: 1px solid var(--border-color);
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.fortune-result-area {
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.5s ease 0.5s; 
    padding: 0 20px;
    text-align: center;
}

.fortune-result-area.visible {
    opacity: 1;
    transform: translateY(0);
}

.lenormand-sys-btn, .lenormand-num-btn {
    padding: 8px 18px;
    border: 1.5px solid var(--border-color);
    border-radius: 20px;
    background: var(--secondary-bg);
    color: var(--text-primary);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-family);
}
.lenormand-sys-btn.active, .lenormand-num-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
}
.lenormand-sys-btn:hover:not(.active), .lenormand-num-btn:hover:not(.active) {
    border-color: var(--accent-color);
    color: var(--accent-color);
}
.lenormand-cards-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin: 14px 0;
}
.lenormand-card-item {
    background: var(--secondary-bg);
    border: 1.5px solid var(--border-color);
    border-radius: 14px;
    padding: 14px 10px;
    text-align: center;
    min-width: 80px;
    max-width: 110px;
    flex: 1;
    box-shadow: var(--shadow);
    transition: all 0.3s ease;
    animation: lenCardIn 0.4s ease forwards;
    opacity: 0;
    transform: translateY(12px);
}
@keyframes lenCardIn {
    to { opacity: 1; transform: translateY(0); }
}
.lenormand-card-icon {
    font-size: 28px;
    margin-bottom: 6px;
    display: block;
}
.lenormand-card-name {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
}
.lenormand-card-num {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 6px;
}
.lenormand-card-keyword {
    font-size: 12px;
    color: var(--accent-color);
    font-style: italic;
}
.lenormand-card-meaning {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-top: 6px;
    text-align: left;
    border-top: 1px dashed var(--border-color);
    padding-top: 6px;
}
.lenormand-question-show {
    text-align: center;
    font-size: 14px;
    color: var(--text-secondary);
    font-style: italic;
    margin-bottom: 12px;
    padding: 8px 12px;
    background: var(--primary-bg);
    border-radius: 10px;
    border-left: 3px solid var(--accent-color);
}
.lenormand-synthesis {
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.08), rgba(var(--accent-color-rgb),0.02));
    border: 1px solid rgba(var(--accent-color-rgb),0.2);
    border-radius: 14px;
    padding: 14px;
    margin-top: 12px;
    font-size: 13px;
    line-height: 1.7;
}
.lenormand-synthesis-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--accent-color);
    margin-bottom: 6px;
    letter-spacing: 1px;
}

#mood-modal .modal-content {
    background-color: var(--primary-bg);
    max-height: 90vh;
}

.mood-stats-bar {
    height: 12px !important; 
    border-radius: 6px !important;
    background: #eee !important;
    margin: 10px 0 20px 0 !important;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

html[data-theme="dark"] .mood-stats-bar {
    background: #333 !important;
}

#month-mood-summary {
    font-weight: bold;
    font-size: 13px;
}
.mood-stat-segment { height: 100%; transition: width 0.5s; }

.calendar-day {
    border-radius: 12px;
    background-color: var(--secondary-bg);
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    min-height: 60px; 
    justify-content: flex-start;
    padding: 4px;
    border: 1px solid transparent;
}
.calendar-day span { font-weight: 600; font-size: 12px; margin-bottom: 2px; }

.mood-detail-dot {
    width: 100%;
    border-radius: 6px;
    padding: 2px 4px;
    font-size: 10px;
    margin-top: 2px;
    text-align: center;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-shadow: 0 1px 1px rgba(0,0,0,0.2);
}

.mood-input-wrapper {
    width: 100%;
    margin-top: 15px;
    text-align: left;
}
.mood-note-input {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--primary-bg);
    color: var(--text-primary);
    resize: none;
    font-size: 13px;
    margin-top: 8px;
}

.day-detail-card {
    background: var(--secondary-bg);
    border-radius: 16px;
    padding: 20px;
    text-align: left;
    position: relative;
    border-left: 5px solid var(--accent-color);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
.day-detail-date { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
.day-detail-content { 
    background: var(--primary-bg); 
    padding: 15px; 
    border-radius: 8px; 
    font-size: 14px; 
    line-height: 1.6;
    min-height: 60px;
    white-space: pre-wrap;
}
.user-info .avatar,
.user-info .username {
    transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
}

.user-info.changing .avatar,
.user-info.changing .username {
    opacity: 0;
    transform: scale(0.9);
}
.message-sender-name {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 2px;
    margin-left: 4px;
    display: none; 
}

body.show-partner-name .message-wrapper.received .message-sender-name {
    display: block;
}

.mood-stats-card {
    background: var(--secondary-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.mood-stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
    color: var(--text-secondary);
    border-bottom: 1px dashed var(--border-color);
    padding-bottom: 10px;
}

.mood-circles-wrapper {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 10px 0;
}

.mood-circle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    position: relative;
}

.mood-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background: conic-gradient(var(--accent-color) var(--percent), var(--message-received-bg) 0);
    transition: all 0.5s ease;
}

.mood-circle::before {
    content: "";
    position: absolute;
    width: 52px;
    height: 52px;
    background-color: var(--secondary-bg);
    border-radius: 50%;
}

.mood-circle-text {
    position: absolute;
    z-index: 2;
    font-weight: 700;
    font-size: 14px;
    color: var(--text-primary);
}

.mood-circle-label {
    font-size: 12px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    gap: 4px;
}

.mood-bar-container {
    height: 8px;
    width: 100%;
    background-color: var(--message-received-bg);
    border-radius: 4px;
    overflow: hidden;
    display: flex;
    margin-top: 5px;
}

.mood-bar-segment {
    height: 100%;
    transition: width 0.6s ease;
}

.dominant-mood-tag {
    background-color: var(--primary-bg);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    border: 1px solid var(--border-color);
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.mood-view-section {
    display: block;
    animation: fadeIn 0.3s ease;
}
.mood-view-section.hidden-view {
    display: none;
}

.mood-header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.view-switch-btn {
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 6px;
}
.view-switch-btn:hover, .view-switch-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
}

.mood-stat-group {
    margin-bottom: 20px;
    background: var(--primary-bg);
    padding: 15px;
    border-radius: 12px;
}
.mood-stat-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.sticker-picker-popover {
    position: absolute;
    bottom: calc(100% + 10px);
    right: 0;
    width: 320px;
    height: 350px; 
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    z-index: 100;
    display: none;
    flex-direction: column;
    overflow: hidden;
    animation: fadeUp 0.2s ease;
}

.sticker-picker-popover.active {
    display: flex;
}

.combo-tabs-header {
    display: flex;
    background-color: var(--primary-bg);
    border-bottom: 1px solid var(--border-color);
    padding: 8px 12px;
    gap: 10px;
    flex-shrink: 0;
}

.combo-tab-btn {
    flex: 1;
    padding: 8px 0;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s;
}

.combo-tab-btn:hover {
    background-color: var(--border-color);
}

.combo-tab-btn.active {
    background-color: var(--accent-color);
    color: #fff;
    box-shadow: 0 2px 8px rgba(var(--accent-color-rgb), 0.3);
}

.combo-content-area {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    background-color: var(--secondary-bg);
}

.sticker-grid-view {
    display: grid;
    grid-template-columns: repeat(4, 1fr); 
    gap: 10px;
}

.sticker-grid-item {
    aspect-ratio: 1 / 1;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid var(--border-color);
    background-color: var(--primary-bg);
    transition: transform 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sticker-grid-item:hover {
    transform: scale(1.05);
    border-color: var(--accent-color);
}

.sticker-grid-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.poke-list-view {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.poke-quick-item {
    padding: 10px 14px;
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.13) 0%, rgba(var(--accent-color-rgb),0.04) 50%, rgba(var(--accent-color-rgb),0.09) 100%);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    text-align: left;
    font-size: 13px;
    transition: all 0.22s cubic-bezier(0.4,0,0.2,1);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 1px 5px rgba(var(--accent-color-rgb),0.1);
}
.poke-quick-item::before {
    content: 'âœ¦';
    font-size: 10px;
    color: var(--accent-color);
    opacity: 0.5;
    flex-shrink: 0;
}

.poke-quick-item:hover {
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.22) 0%, rgba(var(--accent-color-rgb),0.08) 50%, rgba(var(--accent-color-rgb),0.16) 100%);
    transform: translateX(4px);
    color: var(--text-primary);
    box-shadow: 0 3px 10px rgba(var(--accent-color-rgb),0.18);
}

.custom-poke-btn {
    width: 100%;
    padding: 11px 14px;
    margin-bottom: 10px;
    background: linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb),0.8));
    color: #fff;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.25);
    transition: all 0.22s ease;
    letter-spacing: 0.3px;
}

.custom-poke-btn:hover {
    filter: brightness(1.08);
    transform: translateY(-1px);
    box-shadow: 0 6px 18px rgba(var(--accent-color-rgb), 0.32);
}

.empty-sticker-tip {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
    font-size: 12px;
    line-height: 1.6;
}
.empty-sticker-tip i {
    font-size: 24px;
    margin-bottom: 10px;
    display: block;
    opacity: 0.5;
}
.sticker-picker-header {
    padding: 10px;
    border-bottom: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--text-secondary);
    background: var(--primary-bg);
}
.sticker-picker-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}
.picker-item {
    aspect-ratio: 1/1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.2s;
}
.picker-item:hover {
    background-color: var(--primary-bg);
}
.picker-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
}
.picker-item span {
    font-size: 24px;
}

.decision-menu-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 20px 0;
}
.decision-option-card {
    background: var(--primary-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}
.decision-option-card:hover {
    transform: translateY(-5px);
    border-color: var(--accent-color);
    box-shadow: 0 5px 15px rgba(var(--accent-color-rgb), 0.2);
}
.decision-option-card i {
    font-size: 40px;
    margin-bottom: 15px;
    color: var(--accent-color);
}
.decision-option-card h3 {
    font-size: 16px;
    margin-bottom: 5px;
}
.decision-option-card p {
    font-size: 12px;
    color: var(--text-secondary);
}

.fl-modal-content {
    max-height: 90vh;
    overflow-y: auto;
    padding: 0 !important;
    border-radius: 20px !important;
}
.fl-tab-bar {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    background: var(--secondary-bg);
    border-radius: 20px 20px 0 0;
    overflow: hidden;
    flex-shrink: 0;
}
.fl-tab {
    flex: 1;
    padding: 14px 6px;
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 500;
    font-family: var(--font-family);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: all 0.25s ease;
    position: relative;
}
.fl-tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 20%;
    width: 60%;
    height: 2px;
    background: var(--accent-color);
    border-radius: 2px 2px 0 0;
    opacity: 0;
    transform: scaleX(0);
    transition: all 0.25s ease;
}
.fl-tab.active {
    color: var(--accent-color);
    font-weight: 600;
    background: rgba(var(--accent-color-rgb), 0.04);
}
.fl-tab.active::after {
    opacity: 1;
    transform: scaleX(1);
}
.fl-panel {
    display: none;
    padding: 20px;
    min-height: 200px;
}
.fl-panel.fl-panel-active {
    display: block;
}
.leno-num-section {
    margin-bottom: 20px;
}
.leno-section-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.leno-num-btns {
    display: flex;
    gap: 12px;
}
.lenormand-num-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 14px 10px;
    border: 1.5px solid var(--border-color);
    border-radius: 14px;
    background: var(--secondary-bg);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-family);
    position: relative;
    overflow: hidden;
}
.leno-btn-num {
    font-size: 24px;
    font-weight: 700;
    line-height: 1;
}
.leno-btn-label {
    font-size: 11px;
    opacity: 0.6;
}
.lenormand-num-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.35);
    transform: translateY(-2px);
}
.lenormand-num-btn.active .leno-btn-label {
    opacity: 0.85;
}
.lenormand-num-btn:hover:not(.active) {
    border-color: var(--accent-color);
    color: var(--accent-color);
    transform: translateY(-2px);
}
.leno-num-desc {
    text-align: center;
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 10px;
    font-style: italic;
    opacity: 0.7;
    transition: all 0.2s;
}
.leno-question-section {
    margin-bottom: 18px;
}
.leno-question-input {
    width: 100%;
    border: 1.5px solid var(--border-color);
    border-radius: 12px;
    padding: 12px 14px;
    font-size: 13px;
    background: var(--primary-bg);
    color: var(--text-primary);
    resize: none;
    height: 70px;
    font-family: var(--font-family);
    line-height: 1.6;
    transition: border-color 0.2s;
    outline: none;
    margin-top: 10px;
}
.leno-question-input:focus {
    border-color: var(--accent-color);
}
.leno-draw-btn {
    width: 100%;
    margin-top: 4px;
    padding: 14px !important;
    font-size: 15px !important;
    border-radius: 12px !important;
    letter-spacing: 1px;
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.25);
}

/* ===== Horizontal Tarot Layout ===== */
.tarot-row {
    display: flex;
    gap: 8px;
    overflow-x: visible;
    padding: 4px 2px 8px;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
}
.tarot-row .fortune-card.tarot-style {
    flex: 1 1 0;
    min-width: 100px;
    max-width: 160px;
    scroll-snap-align: start;
    margin-bottom: 0 !important;
}
/* Compact card styles for 3-card spread */
.tarot-row:not(.single-card) .fortune-card.tarot-style .tarot-header {
    padding: 12px 0 6px;
    font-size: 10px;
    letter-spacing: 1px;
}
.tarot-row:not(.single-card) .fortune-card.tarot-style .tarot-card-name {
    font-size: 15px;
    margin-bottom: 3px;
}
.tarot-row:not(.single-card) .fortune-card.tarot-style .tarot-position-badge {
    font-size: 10px;
    padding: 2px 8px;
    margin-bottom: 10px;
}
.tarot-row:not(.single-card) .fortune-card.tarot-style .tarot-keyword {
    font-size: 11px;
    margin-bottom: 6px;
}
.tarot-row:not(.single-card) .fortune-card.tarot-style .tarot-details {
    padding: 0 12px 16px;
}
.tarot-row:not(.single-card) .fortune-card.tarot-style .tarot-details p {
    font-size: 11px !important;
    line-height: 1.5 !important;
}
.tarot-row:not(.single-card) .fortune-card.tarot-style .tarot-divider {
    margin-bottom: 8px;
}
.tarot-row:not(.single-card) .fortune-card.tarot-style i.fas {
    font-size: 20px !important;
}
/* For single card, center it */
.tarot-row.single-card {
    justify-content: center;
}
.tarot-row.single-card .fortune-card.tarot-style {
    flex: 0 0 80%;
    max-width: 280px;
}

/* ===== Minor Arcana Fortune Supplement ===== */
.minor-fortune-section {
    margin-top: 14px;
    padding: 14px 16px;
    background: var(--primary-bg);
    border-radius: 14px;
    border: 1px solid var(--border-color);
}
.minor-fortune-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.minor-fortune-cards {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.minor-card-chip {
    flex: 0 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 10px 14px;
    background: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    min-width: 80px;
    transition: box-shadow 0.2s;
}
.minor-card-chip:hover {
    box-shadow: 0 3px 10px rgba(var(--accent-color-rgb), 0.15);
}
.minor-card-chip-suit {
    font-size: 16px;
}
.minor-card-chip-name {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-primary);
    text-align: center;
}
.minor-card-chip-keyword {
    font-size: 10px;
    color: var(--accent-color);
    text-align: center;
}
.minor-card-chip-badge {
    font-size: 9px;
    padding: 1px 7px;
    border-radius: 20px;
    background: rgba(var(--accent-color-rgb), 0.1);
    color: var(--accent-color);
}
.minor-card-chip-badge.rev {
    background: rgba(229,115,115,0.1);
    color: #e07b6a;
}
.minor-fortune-insight {
    margin-top: 12px;
    font-size: 12px;
    line-height: 1.7;
    color: var(--text-secondary);
    font-style: italic;
}
.tarot-spread-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 14px 10px;
    border: 1.5px solid var(--border-color);
    border-radius: 14px;
    background: var(--secondary-bg);
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: var(--font-family);
    position: relative;
    overflow: hidden;
}
.tarot-spread-btn .leno-btn-num {
    font-size: 24px;
    font-weight: 700;
    line-height: 1;
}
.tarot-spread-btn .leno-btn-label {
    font-size: 11px;
    opacity: 0.6;
}
.tarot-spread-btn.active {
    background: var(--accent-color);
    color: #fff;
    border-color: var(--accent-color);
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.35);
    transform: translateY(-2px);
}
.tarot-spread-btn.active .leno-btn-label {
    opacity: 0.85;
}
.tarot-spread-btn:hover:not(.active) {
    border-color: var(--accent-color);
    color: var(--accent-color);
    transform: translateY(-2px);
}

/* ===== Fortune Card Entrance Animation ===== */
@keyframes cardReveal {
    from { opacity: 0; transform: translateY(16px) scale(0.96); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.fortune-card.tarot-style {
    animation: cardReveal 0.45s cubic-bezier(0.25, 0.8, 0.25, 1) both;
}
.fortune-card.tarot-style:nth-child(2) { animation-delay: 0.1s; }
.fortune-card.tarot-style:nth-child(3) { animation-delay: 0.2s; }
.fortune-card.tarot-style:nth-child(4) { animation-delay: 0.3s; }

/* ===== Divination History ===== */
.divi-history-item {
    background: var(--primary-bg);
    border: 1px solid var(--border-color);
    border-radius: 14px;
    padding: 14px 16px;
    transition: box-shadow 0.2s;
    cursor: default;
}
.divi-history-item:hover {
    box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.15);
}
.divi-history-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
}
.divi-history-type {
    font-size: 11px;
    font-weight: 600;
    color: var(--accent-color);
    background: rgba(var(--accent-color-rgb), 0.1);
    border-radius: 20px;
    padding: 2px 10px;
    letter-spacing: 0.5px;
}
.divi-history-time {
    font-size: 11px;
    color: var(--text-secondary);
    opacity: 0.7;
}
.divi-history-question {
    font-size: 13px;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-style: italic;
    opacity: 0.85;
}
.divi-history-cards {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.divi-history-card-tag {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 20px;
    border: 1px solid var(--border-color);
    color: var(--text-secondary);
    background: var(--secondary-bg);
    display: flex;
    align-items: center;
    gap: 4px;
}
.divi-history-card-tag.reversed {
    color: #e07b6a;
    border-color: rgba(224,123,106,0.3);
}
.divi-history-expand-btn {
    background: none;
    border: none;
    font-size: 11px;
    color: var(--accent-color);
    cursor: pointer;
    font-family: var(--font-family);
    padding: 4px 0 0;
    display: block;
    width: 100%;
    text-align: right;
    opacity: 0.8;
}
.divi-history-detail {
    display: none;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.7;
}
.divi-history-detail.open {
    display: block;
}

.picker-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    width: 100%;
}
.picker-box-stage {
    position: relative;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}
.picker-cards-row {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    min-height: 90px;
    align-items: center;
}
.picker-card {
    width: 72px;
    height: 90px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--secondary-bg) 0%, var(--primary-bg) 100%);
    border: 1.5px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: default;
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    text-align: center;
    padding: 6px;
    word-break: break-all;
    position: relative;
    overflow: hidden;
    animation: cardEnter 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
@keyframes cardEnter {
    from { opacity: 0; transform: translateY(12px) scale(0.88); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}
.picker-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(var(--accent-color-rgb),0.06) 0%, transparent 60%);
    border-radius: inherit;
}
.picker-card.selected {
    background: linear-gradient(135deg, var(--accent-color) 0%, rgba(var(--accent-color-rgb),0.75) 100%);
    color: #fff;
    border-color: transparent;
    transform: translateY(-6px) scale(1.08);
    box-shadow: 0 10px 28px rgba(var(--accent-color-rgb), 0.4);
    animation: cardWin 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
}
@keyframes cardWin {
    0% { transform: translateY(0) scale(1); }
    40% { transform: translateY(-10px) scale(1.12) rotate(-2deg); }
    70% { transform: translateY(-5px) scale(1.1) rotate(1deg); }
    100% { transform: translateY(-6px) scale(1.08) rotate(0deg); }
}
.picker-card.unselected {
    opacity: 0.4;
    transform: scale(0.94);
}
.picker-result-text {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent-color);
    text-align: center;
    min-height: 28px;
    padding: 8px 16px;
    border-radius: 10px;
    background: rgba(var(--accent-color-rgb), 0.08);
    border: 1px solid rgba(var(--accent-color-rgb), 0.2);
    opacity: 0;
    transition: opacity 0.4s ease;
    width: 100%;
}
.picker-result-text.show { opacity: 1; }
.picker-controls { width: 100%; }
.picker-options-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 8px;
}
.picker-options-list {
    max-height: 150px;
    overflow-y: auto;
    border: 1.5px solid var(--border-color);
    border-radius: 12px;
    padding: 6px;
    margin-bottom: 10px;
    background: var(--primary-bg);
}
.picker-option-item {
    display: flex;
    gap: 8px;
    padding: 7px 8px;
    align-items: center;
    border-radius: 8px;
    transition: background 0.15s;
}
.picker-option-item:hover { background: var(--message-received-bg); }
.picker-option-color-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}
.picker-option-input {
    flex: 1;
    border: none;
    background: transparent;
    border-bottom: 1px solid var(--border-color);
    padding: 3px 4px;
    font-size: 14px;
    outline: none;
    font-family: var(--font-family);
    color: var(--text-primary);
}
.picker-option-remove {
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 6px;
    transition: all 0.2s;
    font-size: 12px;
}
.picker-option-remove:hover { color: #ff4757; background: rgba(255,71,87,0.1); }
.picker-add-btn {
    width: 100%;
    margin-bottom: 10px;
    font-size: 13px;
    border-style: dashed !important;
    opacity: 0.75;
    transition: opacity 0.2s !important;
}
.picker-add-btn:hover { opacity: 1 !important; }
.wheel-option-input { flex:1; border:none; background:transparent; border-bottom:1px solid var(--border-color); padding:3px 4px; font-size:14px; outline:none; font-family:var(--font-family); color:var(--text-primary); }


@keyframes messageAppear {
    0% { opacity: 0; transform: translateY(8px) scale(0.96); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

.modal-btn, .settings-item, .setting-pill-row, .action-btn, .input-btn {
    position: relative;
    overflow: hidden;
}
.modal-btn::after, .settings-item::after, .setting-pill-row::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle, rgba(var(--accent-color-rgb),0.2) 0%, transparent 70%);
    opacity: 0;
    transform: scale(0);
    transition: transform 0.4s ease, opacity 0.4s ease;
    pointer-events: none;
    border-radius: inherit;
}
.modal-btn:active::after, .settings-item:active::after, .setting-pill-row:active::after {
    opacity: 1;
    transform: scale(2);
    transition: 0s;
}

@keyframes modalContentSlideIn {
    from { opacity: 0; transform: translateY(28px) scale(0.93); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.settings-item {
    transition: all 0.2s cubic-bezier(0.25,0.8,0.25,1);
}
.settings-item:hover {
    transform: translateX(2px);
}

@keyframes slideUpNotif {
    from { opacity:0; transform:translateX(-50%) translateY(24px) scale(0.9); }
    60% { transform: translateX(-50%) translateY(-4px) scale(1.02); }
    to { opacity:1; transform:translateX(-50%) translateY(0) scale(1); }
}

.action-btn:hover {
    box-shadow: 0 0 0 6px rgba(var(--accent-color-rgb), 0.1);
}

.send-btn:hover {
    box-shadow: 0 4px 16px rgba(var(--accent-color-rgb), 0.45), 0 0 0 4px rgba(var(--accent-color-rgb),0.1);
}

.message-input:focus {
    box-shadow: 0 0 0 3px rgba(var(--accent-color-rgb), 0.12);
}

.calendar-day {
    transition: transform 0.15s cubic-bezier(0.34,1.56,0.64,1), background 0.2s, border-color 0.2s;
}
.calendar-day:active { transform: scale(0.9); }

.mood-selector-card, .day-detail-card {
    animation: cardSlideUp 0.38s cubic-bezier(0.34,1.4,0.64,1) forwards;
    opacity: 0;
    transform: translateY(30px) scale(0.96);
}
@keyframes cardSlideUp {
    to { opacity:1; transform: translateY(0) scale(1); }
}

.mood-tab-btn, .combo-tab, .stats-toggle-btn, .view-switch-btn {
    transition: all 0.22s cubic-bezier(0.25,0.8,0.25,1) !important;
}

.picker-item:hover {
    transform: scale(1.12) translateY(-2px) !important;
}

#user-sticker-picker.active {
    animation: pickerSlideUp 0.3s cubic-bezier(0.34,1.2,0.64,1) forwards;
}
@keyframes pickerSlideUp {
    from { opacity:0; transform: translateY(16px) scale(0.97); }
    to { opacity:1; transform: translateY(0) scale(1); }
}

    </style>
</head>
<body>
<div id="tour-overlay" class="tour-overlay">
    <div id="tour-highlight-box" class="tour-highlight-box"></div>
    <div id="tour-popover" class="tour-popover">
        <div class="tour-popover-header">
            <span id="tour-title" class="tour-title"></span>
            <span id="tour-step-counter" class="tour-step-counter"></span>
        </div>
        <div id="tour-content" class="tour-popover-content"></div>
        <div class="tour-popover-footer">
            <button id="tour-skip-btn" class="tour-btn tour-btn-skip">è·³è¿‡</button>
            <div class="tour-navigation">
                <button id="tour-prev-btn" class="tour-btn"><i class="fas fa-arrow-left"></i> ä¸Šä¸€æ­¥</button>
                <button id="tour-next-btn" class="tour-btn tour-btn-primary">ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>
</div>

    <div class="welcome-animation" id="welcome-animation">
        <div class="welcome-bg-gradient"></div>
        <div class="stars-container" id="stars-container"></div>
        <div class="welcome-particles" id="welcome-particles"></div>
        <div id="welcome-meteors" style="position:absolute;inset:0;pointer-events:none;overflow:hidden;"></div>
        <div class="welcome-content-wrapper">
            <div class="logo-tech-container">
                <div class="logo-circle-outer"></div>
                <div class="logo-circle-inner"></div>
                <div class="logo-icon-main">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <div class="orbit-dot"></div>
                <div class="orbit-dot-2"></div>
                <div class="orbit-dot-3"></div>
            </div>

            <div class="text-tech-container">
                <div class="welcome-title-glitch" id="welcome-title-glitch" data-text="ä¼ è®¯">
                    åŠ è½½å¤±è´¥
                </div>
                <div class="welcome-subtitle-scramble" id="welcome-subtitle-scramble">
                    è¯·é‡è¯•ï¼æ›´æ¢å¹³å°/æ›´æ¢ç½‘ç»œ
                </div>
            </div>

            <div class="loader-tech">
                <div class="loader-tech-bar" id="loader-tech-bar"></div>
            </div>
            <div id="loader-status-text" style="font-size:10px;opacity:0.5;letter-spacing:1px;color:var(--welcome-text-sub);margin-top:4px;font-family:monospace;"></div>
        </div>
    </div>
    <button id="immersive-exit-btn" onclick="toggleImmersiveMode(false)" title="é€€å‡ºæ²‰æµ¸æ¨¡å¼">
<i class="fas fa-expand"></i>
</button>
    <div class="header">
        <div class="header-motto"></div>
        <div class="header-inner">
         <div class="user-info">
                <div id="partner-name" class="username">
                    æ¢¦è§’
                </div>
                <div id="partner-avatar-container" class="avatar-container">
                    <div class="avatar" id="partner-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="status" id="partner-status">
                    <span>åœ¨çº¿</span>
                </div>
            </div>
            <div class="header-actions">
                <button id="session-manager-btn" class="action-btn" title="ä¼šè¯ç®¡ç†"><i class="fas fa-comments"></i></button>
                <button id="group-chat-btn" class="action-btn" title="ç¾¤èŠè®¾ç½®"><i class="fas fa-users"></i></button>
                <button id="daily-greeting-btn" class="action-btn" title="ä»Šæ—¥å…¬å‘Š" onclick="reopenDailyGreeting()"><i class="fas fa-newspaper"></i></button>
                <button id="theme-toggle" class="action-btn" title="åˆ‡æ¢ä¸»é¢˜"><i class="fas fa-moon"></i></button>
                <button id="settings-btn" class="action-btn" title="è®¾ç½®"><i class="fas fa-cog"></i></button>
            </div>
             <div class="user-info">
                <div class="username" id="my-name">
                    æˆ‘
                </div>
               
                <div id="my-avatar-container" class="avatar-container">
                    <div class="avatar" id="my-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
               
                <div class="status" id="my-status-container">
                    <span id="my-status-text">åœ¨çº¿</span>
                </div>
            </div>
        </div>
    </div>
    <div class="main-chat-area">

        <div class="history-loader" id="history-loader">
            <div class="history-spinner"></div>
        </div>

        <div class="chat-container" id="chat-container">
    </div>
    <div class="empty-state" id="empty-state" style="display:none;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px;width:100%;pointer-events:none;z-index:1;">
            <div style="position:relative;margin-bottom:20px;">
                <i class="fas fa-heart" style="font-size:52px;opacity:0.55;color:var(--accent-color);"></i>
                <i class="fas fa-comment-dots" style="position:absolute;bottom:-6px;right:-10px;font-size:26px;opacity:0.65;color:var(--accent-color);"></i>
            </div>
            <p style="font-size:15px;font-weight:600;color:var(--accent-color);opacity:0.9;letter-spacing:1px;">âœ¦ æˆ‘ä»¬çš„æ•…äº‹ï¼Œå§‹äºŽæ­¤åˆ» âœ¦</p>
            <p style="font-size:12px;margin-top:8px;opacity:0.65;letter-spacing:0.5px;color:var(--text-secondary);">è¯´ç‚¹ä»€ä¹ˆï¼Œè®©å¯¹è¯å¼€å§‹å§</p>
    </div>
    <div id="typing-indicator-wrapper">
        <div class="typing-indicator" id="typing-indicator">
            <div class="typing-indicator-avatar" id="typing-indicator-avatar">
                <i class="fas fa-user"></i>
            </div>
            <span class="typing-indicator-label" id="typing-indicator-label"></span>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    </div>

    <div id="ti-settings-modal">
        <div id="ti-settings-panel">
            <div class="ti-settings-header">
                <div class="ti-settings-icon">ðŸ’¬</div>
                <div>
                    <div class="ti-settings-title">æ­£åœ¨è¾“å…¥</div>
                </div>
                <button class="ti-settings-close" id="ti-settings-close-btn">Ã—</button>
            </div>
            <div class="ti-settings-body">
                <div class="ti-settings-row">
                    <div class="ti-settings-row-label">
                        <div class="ti-settings-row-icon">â¤ï¸Ž</div>
                        <div>
                            <div class="ti-settings-row-text">æ˜¾ç¤ºå¤´åƒ</div>
                            <div class="ti-settings-row-sub">åœ¨æŒ‡ç¤ºå™¨å·¦ä¾§æ˜¾ç¤ºå¯¹æ–¹å¤´åƒ</div>
                        </div>
                    </div>
                    <div class="setting-pill-row" id="ti-avatar-toggle" style="pointer-events:auto;cursor:pointer;background:var(--primary-bg);border-radius:14px;padding:10px 14px;border:1px solid var(--border-color);">
                        <div class="setting-pill-switch" id="ti-avatar-pill"><div class="setting-pill-knob"></div></div>
                    </div>
                </div>

                <div class="ti-text-edit-row">
                    <div class="ti-text-edit-label">
                        <i class="fas fa-pen" style="font-size:11px;color:var(--accent-color);"></i>
                        <span>è‡ªå®šä¹‰æ–‡æ¡ˆ</span>
                        <button class="ti-text-reset-btn" id="ti-text-reset-btn">æ¢å¤é»˜è®¤</button>
                    </div>
                    <div class="ti-text-input-wrap">
                        <input class="ti-text-input" id="ti-text-input" type="text" maxlength="20" placeholder="ä¾‹ï¼šæ­£åœ¨è¾“å…¥â€¦">
                        <button class="ti-text-save-btn" id="ti-text-save-btn">ä¿å­˜</button>
                    </div>
                </div>

                <div>
                    <div class="ti-text-edit-label" style="margin-bottom:8px;">
                        <i class="fas fa-eye" style="font-size:11px;color:var(--accent-color);"></i>
                        <span>é¢„è§ˆæ•ˆæžœ</span>
                    </div>
                    <div class="ti-preview-box">
                        <div id="ti-preview-avatar" style="width:30px;height:30px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.15);border:2px solid rgba(var(--accent-color-rgb),0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;">
                            <i class="fas fa-user" style="font-size:12px;color:var(--accent-color);"></i>
                        </div>
                        <span id="ti-preview-text" style="font-size:11.5px;font-weight:600;color:var(--accent-color);opacity:0.88;letter-spacing:0.4px;"></span>
                        <div class="ti-preview-dots">
                            <div class="ti-preview-dot"></div>
                            <div class="ti-preview-dot"></div>
                            <div class="ti-preview-dot"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="input-area-wrapper">
        <div class="batch-preview" id="batch-preview"></div>
        <div id="reply-preview-container"></div>
        <div class="input-area">
    <button class="attachment-btn input-btn" id="attachment-btn" title="å‘é€å›¾ç‰‡"><i class="fas fa-image"></i></button>
    
    <button class="combo-btn input-btn" id="combo-btn" title="è¡¨æƒ… & æ‹ä¸€æ‹">
        <i class="fas fa-laugh-beam"></i>
    </button>

    <textarea class="message-input" id="message-input" placeholder="" rows="1"></textarea>
    
    <div class="input-buttons">
    <button class="continue-btn input-btn" id="continue-btn" title="è®©å¯¹æ–¹ç»§ç»­è¯´"><i class="fas fa-ellipsis-h"></i></button>
        <button class="batch-btn input-btn" id="batch-btn" title="æ‰¹é‡å‘é€æ¨¡å¼"><i class="fas fa-layer-group"></i></button>
        <button class="send-btn input-btn" id="send-btn" title="å‘é€æ¶ˆæ¯"><i class="fas fa-paper-plane"></i></button>
        
        <div class="sticker-picker-popover" id="user-sticker-picker">
            <div class="combo-tabs-header">
                <button class="combo-tab-btn active" data-tab="my-sticker"><i class="fas fa-user" style="font-size:10px;"></i> æˆ‘</button>
                <button class="combo-tab-btn" data-tab="partner-sticker"><i class="fas fa-heart" style="font-size:10px;"></i> å¯¹æ–¹</button>
                <button class="combo-tab-btn" data-tab="poke">æ‹ä¸€æ‹</button>
                <div style="margin-left:auto;display:flex;align-items:center;gap:4px;">
                    <button id="sticker-add-btn" onclick="document.getElementById('my-sticker-quick-upload').click()" title="æ·»åŠ æˆ‘çš„è¡¨æƒ…" style="background:var(--accent-color);border:none;cursor:pointer;padding:4px 10px;color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;gap:4px;border-radius:8px;transition:all 0.2s;box-shadow:0 2px 8px rgba(var(--accent-color-rgb),0.35);" onmouseover="this.style.opacity='0.85';this.style.transform='scale(1.05)'" onmouseout="this.style.opacity='1';this.style.transform='scale(1)'"><i class="fas fa-plus"></i> æ·»åŠ </button>
                    <button onclick="window.openMyStickerSettings()" title="ç®¡ç†è¡¨æƒ…åº“" style="background:none;border:none;cursor:pointer;padding:4px 8px;color:var(--text-secondary);font-size:12px;display:flex;align-items:center;gap:3px;border-radius:6px;transition:all 0.2s;" onmouseover="this.style.background='rgba(var(--accent-color-rgb),0.12)';this.style.color='var(--accent-color)'" onmouseout="this.style.background='none';this.style.color='var(--text-secondary)'"><i class="fas fa-cog"></i></button>
                </div>
            </div>
            <div class="combo-content-area" id="combo-content-area">
            </div>
        </div>
    </div>
    <input type="file" id="image-input" class="file-input" accept="image/*">
    <input type="file" id="my-sticker-quick-upload" class="file-input" accept="image/*" multiple>
</div>
    </div>


    <div class="modal" id="edit-modal" style="z-index:3000;">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-user-edit"></i><span id="edit-modal-title">ä¿®æ”¹æ˜µç§°</span>
            </div>
            <input type="text" class="modal-input" id="name-input" placeholder="è¾“å…¥æ–°æ˜µç§°"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-edit">å–æ¶ˆ</button><button class="modal-btn modal-btn-primary" id="save-name" disabled>ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal" id="avatar-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-portrait"></i><span id="avatar-modal-title">ä¸Šä¼ å¤´åƒ</span>
            </div>
            <input type="file" class="modal-input" id="avatar-input" accept="image/*"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-avatar">å–æ¶ˆ</button><button class="modal-btn modal-btn-primary" id="save-avatar">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal" id="note-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-sticky-note"></i><span>ç¼–è¾‘æ³¨é‡Š</span>
            </div>
            <textarea class="modal-textarea" id="note-input" placeholder="ä¸ºè¿™æ¡æ¶ˆæ¯æ·»åŠ æ³¨é‡Š..."></textarea><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-note">å–æ¶ˆ</button><button class="modal-btn modal-btn-primary" id="save-note">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal" id="poke-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-hand-sparkles"></i><span>æ‹ä¸€æ‹</span>
            </div>
            <input type="text" class="modal-input" id="poke-input" placeholder="ä¾‹å¦‚ï¼šæ‹äº†æ‹å¯¹æ–¹çš„è‚©è†€"><div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-poke">å–æ¶ˆ</button><button class="modal-btn modal-btn-primary" id="send-poke">å‘é€</button>
            </div>
        </div>
    </div>
<div class="modal" id="envelope-modal">
    <div class="modal-content" style="max-height:92vh; padding:0; overflow:hidden; background:transparent;">
    <div class="env-wrapper">
        <div class="env-header-flap">
            <svg class="env-header-icon" width="40" height="30" viewBox="0 0 40 30" fill="none">
                <rect x="1" y="7" width="38" height="22" rx="3" fill="rgba(255,255,255,0.18)" stroke="rgba(255,255,255,0.6)" stroke-width="1.5"/>
                <path d="M1 9 L20 20 L39 9" stroke="rgba(255,255,255,0.5)" stroke-width="1.2" fill="none"/>
                <path d="M1 29 L14 18" stroke="rgba(255,255,255,0.35)" stroke-width="1"/>
                <path d="M39 29 L26 18" stroke="rgba(255,255,255,0.35)" stroke-width="1"/>
            </svg>
            <div class="env-header-title">ä¿¡ å° æŠ• é€’</div>
            <div class="env-header-subtitle">Letters Â· Correspondence</div>
        </div>

        <div class="env-body">
            <div class="env-tab-bar">
                <button class="env-tab-btn active" id="env-tab-outbox" onclick="switchEnvTab('outbox')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:4px;"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>å¯„å‡ºçš„ä¿¡
                    <span id="env-outbox-badge" class="env-badge" style="display:none;"></span>
                </button>
                <button class="env-tab-btn" id="env-tab-inbox" onclick="switchEnvTab('inbox')">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:4px;"><path d="M22 13V19a2 2 0 01-2 2H4a2 2 0 01-2-2v-6"/><polyline points="15 3 21 3 21 9"/><line x1="21" y1="3" x2="10" y2="14"/></svg>æ”¶åˆ°çš„ä¿¡
                    <span id="env-inbox-badge" class="env-badge" style="display:none;"></span>
                </button>
            </div>

            <div id="env-outbox-section">
                <div id="env-outbox-list"></div>
            </div>

            <div id="env-inbox-section" style="display:none;">
                <div id="env-inbox-list"></div>
            </div>

            <div id="env-compose-form" style="display:none;">
                <div class="env-compose-paper">
                    <div class="env-compose-heading">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                        <span id="env-compose-title">å†™ä¸€å°ä¿¡</span>
                    </div>
                    <textarea id="envelope-input" placeholder="äº²çˆ±çš„ï¼Œ&#10;&#10;ä»Šå¤©æƒ³è·Ÿä½ è¯´..."></textarea>
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin:4px 0 6px; font-size:12px; padding: 0 2px;">
                    <input type="checkbox" id="env-send-to-chat" style="width:15px;height:15px; cursor:pointer; accent-color:var(--accent-color);">
                    <label for="env-send-to-chat" style="cursor:pointer; color:var(--text-secondary);">åŒæ—¶å‘é€åˆ°èŠå¤©è®°å½•</label>
                </div>
                <div class="env-send-info">
                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    <span id="env-reply-time-info">å¯¹æ–¹å°†åœ¨ 10-24 å°æ—¶å†…å›žä¿¡ï¼ˆ8-12 å¥è¯ï¼‰</span>
                </div>
                <div style="display:flex;gap:8px;">
                    <button class="modal-btn modal-btn-secondary" id="cancel-compose" onclick="cancelEnvelopeCompose()" style="flex:1;">å–æ¶ˆ</button>
                    <button class="modal-btn modal-btn-primary" id="send-envelope" style="flex:2;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:6px;"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>å° Â· å¯„å‡º
                    </button>
                </div>
            </div>
        </div>

        <div class="env-send-area" id="env-main-close-btn">
            <button class="env-write-btn" id="new-envelope-btn" onclick="openNewEnvelopeForm()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                æç¬”å†™ä¿¡
            </button>
            <button class="env-close-btn" id="cancel-envelope">å…³é—­</button>
        </div>
    </div>
    </div>
</div>

<div class="modal" id="envelope-view-modal" style="z-index:2100;">
    <div class="modal-content" style="overflow:hidden;padding:0;background:transparent;max-height:92vh;display:flex;flex-direction:column;">
    <div style="background:var(--secondary-bg);border-radius:20px;overflow:hidden;display:flex;flex-direction:column;max-height:92vh;">
        <div style="background:var(--accent-color);padding:0;position:relative;overflow:hidden;flex-shrink:0;">
            <div style="position:absolute;top:0;left:0;right:0;bottom:0;background:repeating-linear-gradient(45deg,rgba(255,255,255,0.04) 0px,rgba(255,255,255,0.04) 2px,transparent 2px,transparent 12px);pointer-events:none;"></div>
            <div style="position:relative;padding:14px 20px 12px;display:flex;align-items:center;justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:10px;color:white;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                    <span id="env-view-title" style="font-size:14px;font-weight:700;letter-spacing:2px;">ä¿¡ä»¶å†…å®¹</span>
                </div>
                <div style="border:2px solid rgba(255,255,255,0.5);border-radius:50%;width:48px;height:48px;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0.7;">
                    <span style="font-size:7px;color:white;letter-spacing:0.5px;">å·²é€è¾¾</span>
                    <span id="env-view-stamp-date" style="font-size:8px;color:white;font-weight:600;"></span>
                    <span style="font-size:6px;color:white;opacity:0.8;">DELIVERED</span>
                </div>
            </div>
        </div>

        <div style="padding:0;overflow-y:auto;flex:1;min-height:0;">
            <div id="env-view-content" style="display:none;">
                <div style="background:var(--primary-bg);margin:16px;border-radius:12px;border:1px solid var(--border-color);overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.06);">
                    <div style="height:6px;background:linear-gradient(90deg,var(--accent-color),rgba(var(--accent-color-rgb),0.4),var(--accent-color));"></div>
                    <div style="padding:20px 20px 16px;position:relative;">
                        <div style="position:absolute;left:52px;top:0;bottom:0;width:1px;background:rgba(220,80,80,0.15);pointer-events:none;"></div>
                        <div style="position:absolute;inset:0;background:repeating-linear-gradient(transparent,transparent 31px,rgba(var(--accent-color-rgb),0.06) 31px,rgba(var(--accent-color-rgb),0.06) 32px);pointer-events:none;border-radius:12px;"></div>
                        
                        <div style="position:relative;z-index:1;">
                            <div id="env-view-date-line" style="font-size:11px;color:var(--text-secondary);text-align:right;margin-bottom:16px;letter-spacing:1px;opacity:0.8;font-style:italic;"></div>
                            <div id="env-view-to-line" style="font-size:13px;color:var(--text-primary);margin-bottom:4px;font-weight:500;"></div>
                            <div id="env-view-greeting-line" style="font-size:13px;color:var(--text-secondary);margin-bottom:14px;font-style:italic;opacity:0.8;"></div>
                            <div id="env-view-text" class="env-letter-paper" style="border:none;background:transparent;padding:0 0 0 8px;line-height:32px;margin-bottom:16px;"></div>
                            <div style="border-top:1px dashed rgba(var(--accent-color-rgb),0.25);margin:12px 0;"></div>
                            <div id="env-view-sign-date" style="font-size:11px;color:var(--text-secondary);text-align:right;margin-bottom:4px;letter-spacing:0.5px;"></div>
                            <div id="env-view-sign-name" style="font-size:14px;color:var(--accent-color);text-align:right;font-weight:600;letter-spacing:1px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="env-view-edit" style="display:none;padding:16px;">
                <div class="env-compose-paper" style="padding:14px;">
                    <textarea class="modal-textarea" id="env-edit-input" style="height:160px;background:transparent;border:none;outline:none;font-family:var(--font-family);font-size:14px;line-height:1.9;width:100%;resize:none;"></textarea>
                </div>
            </div>
        </div>

        <div class="modal-buttons" style="margin:0;padding:12px 18px 16px;border-top:1px solid var(--border-color);flex-shrink:0;">
            <button class="modal-btn modal-btn-secondary" id="close-env-view" onclick="closeEnvViewModal()">å…³é—­</button>
            <button class="modal-btn modal-btn-secondary" id="env-view-edit-btn" onclick="toggleEnvEdit()">ç¼–è¾‘</button>
            <button class="modal-btn modal-btn-primary" id="env-view-save-btn" onclick="saveEnvEdit()" style="display:none;">ä¿å­˜</button>
        </div>
    </div>
    </div>
</div>
<div class="modal" id="group-chat-modal">
    <div class="modal-content">
        <div class="modal-title">
            <i class="fas fa-users"></i><span>ç¾¤èŠè®¾ç½®</span>
        </div>

        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-toggle-on"></i>ç¾¤èŠæ¨¡å¼</div>
            <div id="group-mode-toggle" style="display:flex;align-items:center;gap:12px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px 14px;cursor:pointer;transition:all 0.2s;">
                <div style="width:36px;height:36px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i id="group-mode-icon" class="fas fa-users" style="font-size:18px;color:var(--accent-color);"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-size:13px;font-weight:600;color:var(--text-primary);">ç¾¤èŠæ¨¡å¼</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;" id="group-mode-status">å·²å…³é—­ â€” ç‚¹å‡»å¼€å¯</div>
                </div>
                <div id="group-mode-pill" style="width:44px;height:24px;border-radius:24px;background:var(--border-color);position:relative;transition:background 0.3s;flex-shrink:0;">
                    <div id="group-mode-knob" style="position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;left:3px;transition:left 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                </div>
            </div>
        </div>

        <div class="settings-section" id="group-display-section" style="display:none;">
            <div class="settings-section-title"><i class="fas fa-eye"></i>æ˜¾ç¤ºé€‰é¡¹</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <div id="group-show-name-toggle" style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;cursor:pointer;">
                    <i class="fas fa-tag" style="color:var(--accent-color);width:18px;"></i>
                    <span style="flex:1;font-size:13px;">æ˜¾ç¤ºæˆå‘˜åç§°</span>
                    <div id="group-show-name-pill" style="width:36px;height:20px;border-radius:20px;background:var(--accent-color);position:relative;transition:background 0.3s;">
                        <div id="group-show-name-knob" style="position:absolute;width:14px;height:14px;border-radius:50%;background:#fff;top:3px;right:3px;transition:right 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section" id="group-members-section" style="display:none;">
            <div class="settings-section-title" style="display:flex;align-items:center;justify-content:space-between;">
                <span><i class="fas fa-users"></i>ç¾¤æˆå‘˜</span>
                <button onclick="openAddGroupMember()" class="modal-btn modal-btn-primary" style="padding:5px 12px;font-size:12px;"><i class="fas fa-plus"></i> æ·»åŠ </button>
            </div>
            <div id="group-members-list" style="display:flex;flex-direction:column;gap:8px;max-height:220px;overflow-y:auto;"></div>
        </div>

        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="close-group-chat">å…³é—­</button>
        </div>
    </div>
</div>

<div class="modal" id="group-member-edit-modal" style="z-index:2200;">
    <div class="modal-content" style="max-width:320px;">
        <div class="modal-title">
            <i class="fas fa-user-edit"></i><span id="group-member-edit-title">æ·»åŠ æˆå‘˜</span>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;padding:4px 0;">
            <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                <div id="group-member-avatar-preview" onclick="document.getElementById('group-member-avatar-input').click()" style="width:64px;height:64px;border-radius:50%;background:var(--primary-bg);border:2px dashed var(--border-color);display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;flex-shrink:0;">
                    <i class="fas fa-camera" style="font-size:20px;color:var(--text-secondary);"></i>
                </div>
                <span style="font-size:11px;color:var(--text-secondary);">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</span>
                <input type="file" id="group-member-avatar-input" accept="image/*" style="display:none;" onchange="previewGroupMemberAvatar(this)">
            </div>
            <div>
                <label style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">æˆå‘˜åå­—</label>
                <input type="text" id="group-member-name-input" placeholder="è¾“å…¥åå­—" maxlength="10" style="width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:10px;background:var(--primary-bg);color:var(--text-primary);font-size:14px;box-sizing:border-box;">
            </div>
        </div>
        <input type="hidden" id="group-member-edit-index">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeGroupMemberEdit()">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" onclick="saveGroupMember()">ä¿å­˜</button>
        </div>
    </div>
</div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-cog"></i><span>è®¾ç½®</span>
            </div>

            <div class="settings-grid">
                <div class="settings-card" id="appearance-settings">
                    <i class="fas fa-palette"></i>
                    <span>å¤–è§‚è®¾ç½®</span>
                </div>
                <div class="settings-card" id="chat-settings">
                    <i class="fas fa-comments"></i>
                    <span>èŠå¤©è®¾ç½®</span>
                </div>
                <div class="settings-card" id="advanced-settings">
                    <i class="fas fa-tools"></i>
                    <span>é«˜çº§åŠŸèƒ½</span>
                </div>
                <div class="settings-card" id="data-settings">
                    <i class="fas fa-database"></i>
                    <span>æ•°æ®ç®¡ç†</span>
                </div>
            </div>


            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-settings">å…³é—­</button>
            </div>
        </div>
    </div>


    <div class="modal" id="appearance-modal">
        <div class="modal-content">

<div class="modal-title" id="appearance-modal-title">
    <i class="fas fa-palette"></i><span>å¤–è§‚è®¾ç½®</span>
</div>

<div id="appearance-nav-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:4px 0 12px;">
    <div class="settings-card" onclick="showAppearancePanel('theme')" style="cursor:pointer;">
        <i class="fas fa-paint-roller"></i><span>ä¸»é¢˜é…è‰²</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('font-bg')" style="cursor:pointer;">
        <i class="fas fa-font"></i><span>èƒŒæ™¯ & å­—ä½“</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('bubble-css')" style="cursor:pointer;">
        <i class="fas fa-comment"></i><span>æ°”æ³¡ & CSS</span>
    </div>
    <div class="settings-card" onclick="showAppearancePanel('avatar')" style="cursor:pointer;">
        <i class="fas fa-user-circle"></i><span>èŠå¤©å¤´åƒ</span>
    </div>
</div>

<div id="appearance-panel-container" style="display:none;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
        <button onclick="hideAppearancePanel()" style="background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;padding:6px 12px;font-size:12px;cursor:pointer;color:var(--text-secondary);">
            <i class="fas fa-arrow-left"></i> è¿”å›ž
        </button>
        <span id="appearance-panel-title" style="font-size:14px;font-weight:600;color:var(--text-primary);"></span>
    </div>

    <div id="appearance-panel-theme" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-paint-roller"></i>ä¸»é¢˜é…è‰²</div>
            <div class="appearance-group" style="margin-bottom:0;">
                <div class="theme-editor-entry-btn" id="open-theme-editor">
                    <i class="fas fa-sliders-h"></i>
                    <span>è‡ªå®šä¹‰<br>ç¼–è¾‘å™¨</span>
                </div>
                <div class="preset-colors-container">
                    <div class="preset-colors-title"><i class="fas fa-swatchbook"></i> å¿«æ·æ¢è‚¤</div>
                    <div class="theme-picker">
                        <button class="theme-color-btn" id="theme-gold" data-theme="gold" title="é‡‘è‰²"></button>
                        <button class="theme-color-btn" id="theme-blue" data-theme="blue" title="è“è‰²"></button>
                        <button class="theme-color-btn" id="theme-purple" data-theme="purple" title="ç´«è‰²"></button>
                        <button class="theme-color-btn" id="theme-green" data-theme="green" title="ç»¿è‰²"></button>
                        <button class="theme-color-btn" id="theme-pink" data-theme="pink" title="ç²‰è‰²"></button>
                        <button class="theme-color-btn" id="theme-black-white" data-theme="black-white" title="é»‘ç™½"></button>
                        <button class="theme-color-btn" id="theme-pastel" data-theme="pastel" title="çº¢è‰²"></button>
                        <button class="theme-color-btn" id="theme-sunset" data-theme="sunset" title="æ©™è‰²"></button>
                        <button class="theme-color-btn" id="theme-forest" data-theme="forest" title="æ·±ç»¿"></button>
                        <button class="theme-color-btn" id="theme-ocean" data-theme="ocean" title="æ·±è“"></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="settings-section" id="theme-schemes-section">
            <div class="settings-section-title">
                <i class="fas fa-layer-group"></i>ä¸»é¢˜æ–¹æ¡ˆ
                <button id="save-theme-scheme-btn" class="modal-btn modal-btn-primary" style="padding:4px 10px; font-size:11px; margin-left:auto;">
                    <i class="fas fa-plus"></i> ä¿å­˜å½“å‰
                </button>
            </div>
            <div style="font-size:11px;color:var(--text-secondary);opacity:0.7;margin-bottom:8px;">ä¿å­˜å½“å‰æ‰€æœ‰å¤–è§‚è®¾ç½®ï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ‡æ¢</div>
            <div id="theme-schemes-list" class="theme-schemes-list">
                <div class="theme-schemes-empty" id="theme-schemes-empty">
                    <i class="fas fa-paint-brush"></i>
                    <span>æš‚æ— ä¿å­˜çš„æ–¹æ¡ˆï¼Œç‚¹å‡»"ä¿å­˜å½“å‰"è¯•è¯•~</span>
                </div>
            </div>
        </div>
    </div>

    <div id="appearance-panel-font" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-font"></i>å­—ä½“è®¾ç½®</div>
            <div class="font-size-control">
                <span class="font-size-label">å¤§å°:</span>
                <input type="range" min="12" max="24" value="16" class="font-size-slider" id="font-size-slider">
                <span class="font-size-value" id="font-size-value">16px</span>
            </div>
            <div style="margin-top: 10px;">
                <label style="font-size: 12px; color: var(--text-secondary); display:block; margin-bottom:5px;">å­—ä½“é“¾æŽ¥ (CSS/TTF):</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="custom-font-url" class="modal-input" style="margin-bottom:0; font-size:12px;" placeholder="https://example.com/font.woff2">
                    <button id="apply-font-btn" class="modal-btn modal-btn-primary" style="padding: 5px 10px; font-size: 12px; white-space: nowrap;">åº”ç”¨</button>
                    <button id="follow-system-font-btn" class="modal-btn modal-btn-secondary" style="padding: 5px 10px; font-size: 12px; white-space: nowrap; margin-left: 5px;">è·Ÿéšç³»ç»Ÿ</button>
                </div>
                <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px; opacity: 0.7;">
                    æç¤º: åº”ç”¨åŽå°†è¦†ç›–é»˜è®¤å­—ä½“ã€‚ç•™ç©ºå¹¶åº”ç”¨å¯æ¢å¤é»˜è®¤ã€‚
                </div>
            </div>
        </div>
    </div>

    <div id="appearance-panel-background" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title">
                <i class="fas fa-image"></i>èŠå¤©èƒŒæ™¯
                <input type="file" id="bg-gallery-input" accept="image/*" style="display: none;">
            </div>
            <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;opacity:0.75;line-height:1.5;">
                æ”¯æŒå›¾ç‰‡åŠ GIF åŠ¨å›¾ã€‚ç‚¹å‡» <i class="fas fa-plus" style="font-size:10px;"></i> æ·»åŠ ï¼Œç‚¹å‡»é¡¹ç›®åº”ç”¨ã€‚
            </div>
            <div class="bg-gallery" id="background-gallery-list"></div>
            <div style="text-align: center; margin-top: 10px;">
                <button class="modal-btn modal-btn-secondary" id="reset-default-bg" style="font-size: 12px; padding: 6px 12px;">
                    <i class="fas fa-undo"></i> æ¢å¤é»˜è®¤èƒŒæ™¯
                </button>
            </div>
        </div>
    </div>

    <div id="appearance-panel-bubble" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title">
                <i class="fas fa-comment"></i>æ°”æ³¡æ ·å¼
            </div>
            <div class="settings-item-list" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div class="settings-item" data-bubble-style="standard" style="justify-content:center;">
                    <i class="fas fa-comment"></i><span>æ ‡å‡†å°–è§’</span>
                </div>
                <div class="settings-item" data-bubble-style="rounded" style="justify-content:center;">
                    <i class="fas fa-comment-dots"></i><span>åœ†è§’</span>
                </div>
                <div class="settings-item" data-bubble-style="rounded-large" style="justify-content:center;">
                    <i class="fas fa-circle"></i><span>å¤§åœ†è§’èƒ¶å›Š</span>
                </div>
                <div class="settings-item" data-bubble-style="square" style="justify-content:center;">
                    <i class="fas fa-square"></i><span>æ–¹å½¢ç›´è§’</span>
                </div>
            </div>

        </div>
    </div>

    <div id="appearance-panel-avatar" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-user-circle"></i>èŠå¤©å¤´åƒ</div>
            <div id="in-chat-avatar-toggle-2" style="display:flex;align-items:center;gap:12px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:12px;padding:12px 14px;cursor:pointer;transition:all 0.2s;margin-bottom:10px;">
                <div style="width:36px;height:36px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                    <i id="avatar-toggle-icon-2" class="fas fa-user-circle" style="font-size:18px;color:var(--accent-color);"></i>
                </div>
                <div style="flex:1;">
                    <div style="font-size:13px;font-weight:600;color:var(--text-primary);">æ˜¾ç¤ºèŠå¤©å¤´åƒ</div>
                    <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;" id="avatar-toggle-status-2">å·²å¼€å¯ â€” æ¶ˆæ¯æ—æ˜¾ç¤ºå¤´åƒ</div>
                </div>
                <div id="avatar-toggle-pill-2" style="width:44px;height:24px;border-radius:24px;background:var(--accent-color);position:relative;transition:background 0.3s;flex-shrink:0;">
                    <div id="avatar-toggle-knob-2" style="position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;right:3px;transition:right 0.25s;box-shadow:0 1px 3px rgba(0,0,0,0.2);"></div>
                </div>
            </div>
            <div class="font-size-control" id="in-chat-avatar-size-control-2">
                <span class="font-size-label">å¤´åƒå°ºå¯¸:</span>
                <input type="range" min="24" max="48" value="36" class="font-size-slider" id="in-chat-avatar-size-slider-2">
                <span class="font-size-value" id="in-chat-avatar-size-value-2">36px</span>
            </div>
            <div id="in-chat-avatar-position-control-2" style="margin-top:10px;">
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;font-weight:500;">å¤´åƒå¯¹é½æ–¹å¼</div>
                <div style="display:flex;gap:8px;">
                    <button id="avatar-pos-top-2" class="modal-btn modal-btn-secondary" data-pos="top" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrow-up"></i> é¡¶éƒ¨</button>
                    <button id="avatar-pos-center-2" class="modal-btn modal-btn-primary" data-pos="center" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrows-alt-v"></i> å±…ä¸­</button>
                    <button id="avatar-pos-bottom-2" class="modal-btn modal-btn-secondary" data-pos="bottom" style="flex:1;font-size:12px;padding:7px 0;"><i class="fas fa-arrow-down"></i> åº•éƒ¨</button>
                </div>
            </div>
            <div id="in-chat-avatar-shape-control-2" style="margin-top:12px;">
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;font-weight:500;">å¤´åƒå½¢çŠ¶</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="modal-btn modal-btn-primary avatar-shape-btn-2" data-shape="circle" style="flex:1;font-size:12px;padding:7px 4px;min-width:60px;">â— åœ†å½¢</button>
                    <button class="modal-btn modal-btn-secondary avatar-shape-btn-2" data-shape="square" style="flex:1;font-size:12px;padding:7px 4px;min-width:60px;">â–  æ–¹å½¢</button>
                </div>
                <div id="avatar-corner-radius-control-2" style="margin-top:10px;display:none;">
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:6px;">æ–¹å½¢åœ†è§’:</div>
                    <div class="font-size-control">
                        <span class="font-size-label" style="font-size:11px;white-space:nowrap;">0px</span>
                        <input type="range" min="0" max="24" value="8" class="font-size-slider" id="avatar-corner-radius-slider-2">
                        <span class="font-size-value" id="avatar-corner-radius-value-2">8px</span>
                    </div>
                </div>
            </div>

            <div id="avatar-bubble-preview" style="margin-top:14px;background:var(--chat-bg,var(--primary-bg));border-radius:14px;padding:14px 12px;border:1px solid var(--border-color);">
                <div style="font-size:11px;color:var(--text-secondary);margin-bottom:10px;opacity:0.7;text-align:center;letter-spacing:0.3px;">å®žæ—¶é¢„è§ˆæ•ˆæžœ</div>
                <div class="preview-msg-row" style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;">
                    <div id="preview-partner-avatar" style="width:var(--in-chat-avatar-size,36px);height:var(--in-chat-avatar-size,36px);border-radius:50%;background:var(--border-color);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;transition:border-radius 0.2s ease;">
                        <i class="fas fa-user" style="font-size:14px;color:var(--text-secondary);"></i>
                    </div>
                    <div style="background:var(--message-received-bg);color:var(--message-received-text);border-radius:16px 16px 16px 4px;padding:9px 13px;font-size:13px;max-width:160px;">
                        ä½ æ˜¯æˆ‘æœå¤•ç›¸ä¼´è§¦æ‰‹å¯åŠçš„è™šæ‹Ÿ
                    </div>
                </div>
                <div class="preview-msg-row" style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;">
                    <div style="background:var(--message-sent-bg);color:var(--message-sent-text);border-radius:16px 16px 4px 16px;padding:9px 13px;font-size:13px;max-width:160px;">
                        ä½ æ˜¯æˆ‘æœªæ›¾æ‹¥æœ‰æ— æ³•æ•æ‰çš„äº²æ˜µ
                    </div>
                    <div id="preview-my-avatar" style="width:var(--in-chat-avatar-size,36px);height:var(--in-chat-avatar-size,36px);border-radius:50%;background:var(--border-color);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;transition:border-radius 0.2s ease;">
                        <i class="fas fa-user" style="font-size:14px;color:var(--text-secondary);"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-id-badge"></i>å¤´åƒæ¡†è®¾ç½®</div>
            <h4 style="font-size:13px;font-weight:600;margin:10px 0 8px;color:var(--text-primary);">æˆ‘çš„å¤´åƒæ¡†</h4>
            <div class="frame-settings-container">
                <div class="frame-preview-wrapper">
                    <div class="frame-preview" id="my-frame-preview-2"></div>
                    <div style="display:flex;gap:8px;margin-top:6px;">
                        <button class="modal-btn modal-btn-secondary" id="my-frame-upload-btn-2" style="padding:5px 10px;font-size:12px;">ä¸Šä¼ </button>
                        <button class="modal-btn modal-btn-secondary" id="my-frame-remove-btn-2" style="padding:5px 10px;font-size:12px;">ç§»é™¤</button>
                    </div>
                </div>
                <div class="frame-controls">
                    <div class="frame-slider-group">
                        <label for="my-frame-size-2">å¤§å°</label>
                        <input type="range" id="my-frame-size-2" min="50" max="200" value="100">
                        <span id="my-frame-size-value-2" style="width:40px;text-align:right;">100%</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="my-frame-offset-x-2">å·¦å³</label>
                        <input type="range" id="my-frame-offset-x-2" min="-50" max="50" value="0">
                        <span id="my-frame-offset-x-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="my-frame-offset-y-2">ä¸Šä¸‹</label>
                        <input type="range" id="my-frame-offset-y-2" min="-50" max="50" value="0">
                        <span id="my-frame-offset-y-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                </div>
            </div>
            <input type="file" id="my-frame-file-input-2" class="file-input" accept="image/png, image/webp, image/gif">

            <h4 style="font-size:13px;font-weight:600;margin:20px 0 8px;border-top:1px dashed var(--border-color);padding-top:14px;color:var(--text-primary);">æ¢¦è§’çš„å¤´åƒæ¡†</h4>
            <div class="frame-settings-container">
                <div class="frame-preview-wrapper">
                    <div class="frame-preview" id="partner-frame-preview-2"></div>
                    <div style="display:flex;gap:8px;margin-top:6px;">
                        <button class="modal-btn modal-btn-secondary" id="partner-frame-upload-btn-2" style="padding:5px 10px;font-size:12px;">ä¸Šä¼ </button>
                        <button class="modal-btn modal-btn-secondary" id="partner-frame-remove-btn-2" style="padding:5px 10px;font-size:12px;">ç§»é™¤</button>
                    </div>
                </div>
                <div class="frame-controls">
                    <div class="frame-slider-group">
                        <label for="partner-frame-size-2">å¤§å°</label>
                        <input type="range" id="partner-frame-size-2" min="50" max="200" value="100">
                        <span id="partner-frame-size-value-2" style="width:40px;text-align:right;">100%</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="partner-frame-offset-x-2">å·¦å³</label>
                        <input type="range" id="partner-frame-offset-x-2" min="-50" max="50" value="0">
                        <span id="partner-frame-offset-x-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                    <div class="frame-slider-group">
                        <label for="partner-frame-offset-y-2">ä¸Šä¸‹</label>
                        <input type="range" id="partner-frame-offset-y-2" min="-50" max="50" value="0">
                        <span id="partner-frame-offset-y-value-2" style="width:40px;text-align:right;">0px</span>
                    </div>
                </div>
            </div>
            <input type="file" id="partner-frame-file-input-2" class="file-input" accept="image/png, image/webp, image/gif">
        </div>
    </div>

    <div id="appearance-panel-css" class="appearance-sub-panel" style="display:none;">
        <div class="settings-section">
            <div class="settings-section-title"><i class="fas fa-code"></i>è‡ªå®šä¹‰ CSS</div>
            <textarea id="custom-bubble-css" class="modal-textarea" style="font-family: monospace; font-size: 12px; height: 150px; white-space: pre;" placeholder=".message-sent {
  border-radius: 20px 20px 0 20px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.message-received {
  border-bottom: 2px solid var(--accent-color);
}"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top:8px;">
                <button id="reset-css-btn" class="modal-btn modal-btn-secondary" style="padding: 6px 12px; font-size: 12px;">æ¸…ç©º</button>
                <button id="apply-css-btn" class="modal-btn modal-btn-primary" style="padding: 6px 12px; font-size: 12px;">åº”ç”¨ CSS</button>
            </div>
            <div style="margin-top:14px;">
                <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px;font-weight:500;letter-spacing:0.3px;">å®žæ—¶é¢„è§ˆ</div>
                <div id="css-live-preview" style="background:var(--chat-bg,var(--primary-bg));border-radius:14px;padding:14px 12px;border:1px solid var(--border-color);">
                    <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;">
                        <div style="width:32px;height:32px;border-radius:50%;background:var(--accent-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-user" style="font-size:12px;color:#fff;"></i>
                        </div>
                        <div class="message message-received" style="max-width:180px;">ä½ æ˜¯æˆ‘æœå¤•ç›¸ä¼´è§¦æ‰‹å¯åŠçš„è™šæ‹Ÿ</div>
                    </div>
                    <div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;">
                        <div class="message message-sent" style="max-width:180px;">ä½ æ˜¯æˆ‘æœªæ›¾æ‹¥æœ‰æ— æ³•æ•æ‰çš„äº²æ˜µ</div>
                        <div style="width:32px;height:32px;border-radius:50%;background:var(--border-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-user" style="font-size:12px;color:var(--text-secondary);"></i>
                        </div>
                    </div>
                </div>
                <style id="css-live-preview-style"></style>
            </div>
        </div>
    </div>
</div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 0;z-index:10;margin-top:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;padding-bottom:max(12px, env(safe-area-inset-bottom, 0px));">
                <button class="modal-btn modal-btn-secondary" id="back-appearance" onclick="(function(){hideModal(document.getElementById('appearance-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> è¿”å›ž
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-appearance">å…³é—­</button>
            </div>
        </div>
    </div>


    <div class="modal" id="chat-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>èŠå¤©è®¾ç½®</span>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-user-edit"></i>æ˜µç§°è®¾ç½®
                </div>
                <div style="display:flex;gap:10px;">
                    <button onclick="(function(){var m=document.getElementById('edit-modal'),ti=m.querySelector('#edit-modal-title'),ni=m.querySelector('#name-input'),sb=m.querySelector('#save-name');ti.textContent='ä¿®æ”¹æ¢¦è§’çš„æ˜µç§°';ni.value=(typeof settings!=='undefined'?settings.partnerName:'æ¢¦è§’');sb.disabled=!ni.value.trim();sb.onclick=function(){var n=ni.value.trim();if(n){settings.partnerName=n;var pEls=document.querySelectorAll('.username[data-role=partner],.partner-name,.contact-name');pEls.forEach(function(el){el.textContent=n;});if(typeof throttledSaveData==='function')throttledSaveData();if(typeof updateUI==='function')updateUI();if(typeof showNotification==='function')showNotification('æ¢¦è§’æ˜µç§°å·²æ›´æ–°ä¸ºã€Œ'+n+'ã€âœ¦','success');}if(typeof hideModal==='function')hideModal(m);};if(typeof showModal==='function')showModal(m,ni);})()" style="flex:1;padding:11px 10px;border:1px solid var(--border-color);border-radius:12px;background:var(--primary-bg);color:var(--text-primary);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:var(--font-family);transition:all 0.2s;">
                        <i class="fas fa-user" style="color:var(--accent-color);font-size:14px;"></i>
                        <span>ä¿®æ”¹æ¢¦è§’åç§°</span>
                    </button>
                    <button onclick="(function(){var m=document.getElementById('edit-modal'),ti=m.querySelector('#edit-modal-title'),ni=m.querySelector('#name-input'),sb=m.querySelector('#save-name');ti.textContent='ä¿®æ”¹æˆ‘çš„æ˜µç§°';ni.value=(typeof settings!=='undefined'?settings.myName:'æˆ‘');sb.disabled=!ni.value.trim();sb.onclick=function(){var n=ni.value.trim();if(n){settings.myName=n;if(typeof throttledSaveData==='function')throttledSaveData();if(typeof updateUI==='function')updateUI();if(typeof showNotification==='function')showNotification('æˆ‘çš„æ˜µç§°å·²æ›´æ–°ä¸ºã€Œ'+n+'ã€âœ¦','success');}if(typeof hideModal==='function')hideModal(m);};if(typeof showModal==='function')showModal(m,ni);})()" style="flex:1;padding:11px 10px;border:1px solid var(--border-color);border-radius:12px;background:var(--primary-bg);color:var(--text-primary);font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;font-family:var(--font-family);transition:all 0.2s;">
                        <i class="fas fa-user-circle" style="color:var(--accent-color);font-size:14px;"></i>
                        <span>ä¿®æ”¹æˆ‘æ–¹åç§°</span>
                    </button>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);margin-top:6px;opacity:0.7;">ä¸“ä¸ºçœ‹ä¸è§é¡¶éƒ¨æ˜µç§°çš„æœºåž‹è®¾ç½®</div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-hourglass-half"></i>å¯¹æ–¹å›žå¤é€Ÿåº¦
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">æœ€å°é—´éš”:</span>
                    <input type="range" min="1000" max="30000" step="1000" value="3000" class="font-size-slider" id="reply-delay-min-slider">
                    <span class="font-size-value" id="reply-delay-min-value">3s</span>
                </div>
                <div class="font-size-control">
                    <span class="font-size-label">æœ€å¤§é—´éš”:</span>
                    <input type="range" min="1000" max="120000" step="1000" value="7000" class="font-size-slider" id="reply-delay-max-slider">
                    <span class="font-size-value" id="reply-delay-max-value">7s</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-paper-plane"></i> å¯¹æ–¹ä¸»åŠ¨å‘æ¶ˆæ¯
                </div>
                <div class="setting-pill-row" id="auto-send-toggle">
                    <span class="setting-pill-icon"><i class="fas fa-paper-plane"></i></span>
                    <span class="setting-pill-label">ä¸»åŠ¨å‘é€</span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
                <div class="font-size-control" id="auto-send-control" style="display:none; margin-top:10px;">
                    <span class="font-size-label">é—´éš”(åˆ†é’Ÿ):</span>
                    <input type="range" min="1" max="120" step="1" value="5" class="font-size-slider" id="auto-send-slider">
                    <span class="font-size-value" id="auto-send-value">5åˆ†é’Ÿ</span>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-sliders-h"></i>åŠŸèƒ½å¼€å…³
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <div class="setting-pill-row" id="reply-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-reply"></i></span>
                        <span class="setting-pill-label">å¼•ç”¨å›žå¤</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="read-receipts-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-check-double"></i></span>
                        <span class="setting-pill-label">å·²è¯»å›žæ‰§</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="read-no-reply-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-comment-slash"></i></span>
                        <span class="setting-pill-label">å·²è¯»ä¸å›ž</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                    <div class="setting-pill-row" id="typing-indicator-toggle">
                        <span class="setting-pill-icon"><i class="fas fa-keyboard"></i></span>
                        <span class="setting-pill-label">æ­£åœ¨è¾“å…¥</span>
                        <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-volume-up"></i>æ¶ˆæ¯éŸ³æ•ˆ
                </div>
                <div class="setting-pill-row" id="sound-toggle" style="margin-bottom:10px;">
                    <span class="setting-pill-icon"><i class="fas fa-volume-up"></i></span>
                    <span class="setting-pill-label">æ¶ˆæ¯éŸ³æ•ˆ</span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
                <div id="sound-detail-section">
                    <div class="font-size-control" style="margin-bottom:8px;">
                        <span class="font-size-label">éŸ³é‡:</span>
                        <input type="range" min="0" max="100" step="5" value="15" class="font-size-slider" id="sound-volume-slider">
                        <span class="font-size-value" id="sound-volume-value">15%</span>
                    </div>
                    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;">è‡ªå®šä¹‰éŸ³æ•ˆ URLï¼ˆç•™ç©ºä½¿ç”¨å†…ç½®éŸ³æ•ˆï¼‰</div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <input type="text" id="custom-sound-url-input" placeholder="https://example.com/sound.mp3" style="flex:1;padding:7px 10px;border:1px solid var(--border-color);border-radius:8px;font-size:12px;background:var(--primary-bg);color:var(--text-primary);outline:none;">
                        <button id="test-sound-btn" class="modal-btn modal-btn-secondary" style="padding:6px 10px;font-size:12px;white-space:nowrap;"><i class="fas fa-play"></i> è¯•å¬</button>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-clock"></i>æ—¶é—´æ ¼å¼
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;" id="time-format-options">
                    <div class="settings-item time-fmt-opt active" data-fmt="HH:mm">
                        <i class="fas fa-clock"></i><span>14:05</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="HH:mm:ss">
                        <i class="fas fa-clock"></i><span>14:05:30</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="h:mm AM/PM">
                        <i class="fas fa-clock"></i><span>2:05 PM</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="h:mm:ss AM/PM">
                        <i class="fas fa-clock"></i><span>2:05:30 PM</span>
                    </div>
                    <div class="settings-item time-fmt-opt" data-fmt="off" style="grid-column:1/-1;">
                        <i class="fas fa-eye-slash"></i><span>å…³é—­æ—¶é—´æˆ³</span>
                    </div>
                </div>
            </div>

            

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-expand"></i>æ²‰æµ¸å¼èŠå¤©
                </div>
                <div class="setting-pill-row" id="immersive-toggle" onclick="toggleImmersiveMode()">
                    <span class="setting-pill-icon"><i class="fas fa-expand-arrows-alt"></i></span>
                    <span class="setting-pill-label">æ²‰æµ¸å¼æ¨¡å¼ <span style="font-size:11px;color:var(--text-secondary);font-weight:400;">ï¼ˆéšè—é¡¶éƒ¨æ ï¼Œä¸“æ³¨èŠå¤©ï¼‰</span></span>
                    <div class="setting-pill-switch"><div class="setting-pill-knob"></div></div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 0;z-index:10;margin-top:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;padding-bottom:max(14px, env(safe-area-inset-bottom, 0px));">
                <button class="modal-btn modal-btn-secondary" id="back-chat" onclick="(function(){hideModal(document.getElementById('chat-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> è¿”å›ž
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-chat">å…³é—­</button>
            </div>
        </div>
    </div>

<div class="modal" id="advanced-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-tools"></i><span>é«˜çº§åŠŸèƒ½</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-magic"></i>å®žç”¨å·¥å…·
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="custom-replies-function">
                        <i class="fas fa-comment-dots"></i><span>è‡ªå®šä¹‰å›žå¤</span>
                    </div>
                    <div class="settings-item" id="music-player-toggle">
                        <i class="fas fa-music"></i><span>æ‚¬æµ®éŸ³ä¹æ’­æ”¾å™¨</span>
                    </div>
                    <div class="settings-item" id="stats-function">
                        <i class="fas fa-chart-bar"></i><span>æ¶ˆæ¯ç»Ÿè®¡</span>
                    </div>
                    <div class="settings-item" id="decision-function">
                        <i class="fas fa-balance-scale"></i> 
                        <span>æŠ‰æ‹©</span> 
                    </div>
                    <div class="settings-item" id="fortune-lenormand-function" style="position:relative;">
                        <i class="fas fa-star-and-crescent"></i><span>è¿åŠ¿ Â· å åœ</span>
                    </div>
                    <div class="settings-item" id="anniversary-function">
                        <i class="fas fa-heart"></i><span>é‡è¦æ—¥</span>
                    </div>
                    <div class="settings-item" id="mood-function">
                        <i class="fas fa-calendar-day"></i><span>å¿ƒæ™´æ‰‹è´¦</span>
                    </div>
                    <div class="settings-item" id="envelope-function">
                        <i class="fas fa-envelope"></i><span>ä¿¡å°æŠ•é€’</span>
                    </div>
                    <div class="settings-item" id="resource-share-function">
                        <i class="fas fa-link"></i><span>æ°”æ³¡ &amp; å­—ä½“èµ„æº</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 0;z-index:10;margin-top:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;padding-bottom:max(14px, env(safe-area-inset-bottom, 0px));">
                <button class="modal-btn modal-btn-secondary" id="back-advanced" onclick="(function(){hideModal(document.getElementById('advanced-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> è¿”å›ž
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-advanced">å…³é—­</button>
            </div>
        </div>
    </div>


    <div class="modal" id="data-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-database"></i><span>æ•°æ®ç®¡ç†</span>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-bell"></i>æ¶ˆæ¯é€šçŸ¥
                </div>
                <div style="background:var(--primary-bg);border-radius:12px;padding:12px 14px;border:1px solid var(--border-color);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div>
                            <div style="font-size:13px;font-weight:500;color:var(--text-primary);">åŽå°æ¶ˆæ¯æŽ¨é€</div>
                            <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;">æŒ‚åœ¨åŽå°æ—¶æ”¶åˆ°æ–°æ¶ˆæ¯è‡ªåŠ¨å¼¹å‡ºæé†’</div>
                        </div>
                        <label class="notif-toggle-switch" style="position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0;margin-left:12px;">
                            <input type="checkbox" id="notif-permission-toggle" style="opacity:0;width:0;height:0;" onchange="handleNotifToggle(this)">
                            <span class="notif-toggle-slider" style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border-color);border-radius:24px;transition:0.3s;"></span>
                        </label>
                    </div>
                    <div id="notif-status-text" style="font-size:11px;color:var(--text-secondary);margin-top:4px;"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-comments"></i>èŠå¤©è®°å½•
                </div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-chat"><i class="fas fa-download"></i>å¯¼å‡ºè®°å½•</button>
                    <button class="import-export-btn export" id="import-chat"><i class="fas fa-upload"></i>å¯¼å…¥è®°å½•</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-archive"></i>å…¨é‡å¤‡ä»½
                </div>
                <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">åŒ…å«å¤–è§‚ã€èŠå¤©è®¾ç½®ã€å­—å¡ã€å¿ƒæƒ…ã€ä¿¡å°ç­‰å…¨éƒ¨æ•°æ®</div>
                <div class="import-export-buttons">
                    <button class="import-export-btn" id="export-all-settings"><i class="fas fa-download"></i>å¯¼å‡ºå…¨éƒ¨</button>
                    <button class="import-export-btn export" id="import-all-settings"><i class="fas fa-upload"></i>å¯¼å…¥æ¢å¤</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-sync-alt"></i>é‡ç½®æ•°æ®
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="clear-storage">
                        <i class="fas fa-sync-alt"></i><span>é‡ç½®æ•°æ®</span>
                    </div>
                </div>
            </div>


            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-info-circle"></i>å…³äºŽä¸Žå£°æ˜Ž
                </div>
                <div class="settings-item-list">
                    <div class="settings-item" id="replay-tutorial-btn">
                        <i class="fas fa-question-circle"></i><span>é‡æ”¾æ–°æ‰‹å¼•å¯¼</span>
                    </div>
                    <div class="settings-item" id="open-credits-btn">
                        <i class="fas fa-scroll"></i><span>å£°æ˜Žä¸Žè‡´è°¢</span>
                    </div>
                </div>
            </div>

            <div class="modal-buttons" style="position:sticky;bottom:0;background:var(--secondary-bg);border-top:1px solid var(--border-color);padding:12px 0 0;z-index:10;margin-top:8px;margin-left:-24px;margin-right:-24px;padding-left:24px;padding-right:24px;padding-bottom:max(14px, env(safe-area-inset-bottom, 0px));">
                <button class="modal-btn modal-btn-secondary" id="back-data" onclick="(function(){hideModal(document.getElementById('data-modal'));showModal(document.getElementById('settings-modal'))})()">
                    <i class="fas fa-arrow-left"></i> è¿”å›ž
                </button>
                <button class="modal-btn modal-btn-secondary" id="close-data">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="stats-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-chart-bar"></i><span>æ¶ˆæ¯ç»Ÿè®¡ & æ”¶è—</span>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:14px;">
                <button class="modal-btn modal-btn-primary" id="stats-tab-btn" onclick="switchStatsTab('stats')" style="flex:1;font-size:13px;padding:8px 0;">
                    <i class="fas fa-chart-bar"></i> æ¶ˆæ¯ç»Ÿè®¡
                </button>
                <button class="modal-btn modal-btn-secondary" id="favorites-tab-btn" onclick="switchStatsTab('favorites')" style="flex:1;font-size:13px;padding:8px 0;">
                    <i class="fas fa-star"></i> æ”¶è—å¤¹
                </button>
            </div>
            <div id="stats-panel">
                <div class="stats-content" id="stats-content"></div>
            </div>
            <div id="favorites-panel" style="display:none;">
                <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
                    <button class="modal-btn modal-btn-secondary" id="batch-favorite-function" style="font-size:12px;padding:6px 14px;"><i class="fas fa-layer-group"></i> æ‰¹é‡æ”¶è—</button>
                </div>
                <div class="favorites-list" id="favorites-list" style="max-height:55vh;overflow-y:auto;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-stats">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="session-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-comments"></i><span>ä¼šè¯ç®¡ç†</span>
            </div>
            <div class="session-list" id="session-list"></div>
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-primary" id="create-new-session"><i class="fas fa-plus"></i> æ–°å»ºä¼šè¯</button>
                <button class="modal-btn modal-btn-secondary" id="cancel-session">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="fortune-lenormand-modal">
        <div class="modal-content fl-modal-content">
            <div class="fl-tab-bar">
                <button class="fl-tab active" id="fl-tab-fortune" onclick="switchFLTab('fortune')">
                    <i class="fas fa-sun"></i> æ¯æ—¥è¿åŠ¿
                </button>
                <button class="fl-tab" id="fl-tab-lenormand" onclick="switchFLTab('lenormand')">
                    <i class="fas fa-moon"></i> é›·è¯ºæ›¼å åœ
                </button>
                <button class="fl-tab" id="fl-tab-tarot" onclick="switchFLTab('tarot')">
                    <i class="fas fa-star-and-crescent"></i> å¡”ç½—å åœ
                </button>
                <button class="fl-tab" id="fl-tab-divihistory" onclick="switchFLTab('divihistory')">
                    <i class="fas fa-scroll"></i> å¾€æ˜”
                </button>
            </div>
            <div id="fl-panel-fortune" class="fl-panel fl-panel-active">
                <div id="fortune-content"></div>
                <div class="modal-buttons" style="margin-top:16px;">
                    <button class="modal-btn modal-btn-primary" id="share-fortune"><i class="fas fa-share-alt"></i> åˆ†äº«è¿åŠ¿</button>
                    <button class="modal-btn modal-btn-secondary" id="close-fortune">å…³é—­</button>
                </div>
            </div>
            <div id="fl-panel-lenormand" class="fl-panel">
                <div id="lenormand-content">
                    <div id="lenormand-setup" style="padding: 4px 0 12px;">
                        <div class="leno-num-section">
                            <div class="leno-section-label"><i class="fas fa-layer-group"></i> æŠ½ç‰Œæ•°é‡</div>
                            <div class="leno-num-btns">
                                <button class="lenormand-num-btn active" onclick="setLenormandCount(1)"><span class="leno-btn-num">1</span><span class="leno-btn-label">å•å¼ </span></button>
                                <button class="lenormand-num-btn" onclick="setLenormandCount(3)"><span class="leno-btn-num">3</span><span class="leno-btn-label">ä¸‰å¼ </span></button>
                            </div>
                            <div class="leno-num-desc" id="leno-num-desc">å•å¼ ç‰Œ Â· ç›´è¾¾ç­”æ¡ˆ</div>
                        </div>
                        <div class="leno-question-section">
                            <div class="leno-section-label"><i class="fas fa-feather-alt"></i> ä½ çš„æé—®ï¼ˆå¯é€‰ï¼‰</div>
                            <textarea id="lenormand-question" placeholder="å°†å¿ƒä¸­çš„ç–‘é—®è½»å£°è¯‰è¯´..." class="leno-question-input"></textarea>
                        </div>
                        <button class="modal-btn modal-btn-primary leno-draw-btn" onclick="startLenormandDraw()"><i class="fas fa-hand-sparkles"></i> å¼€å§‹æŠ½ç‰Œ</button>
                    </div>
                    <div id="lenormand-result" style="display:none;"></div>
                </div>
                <div class="modal-buttons" style="margin-top:12px;">
                    <button class="modal-btn modal-btn-secondary" id="lenormand-reset-btn" onclick="resetLenormand()" style="display:none;">é‡æ–°å åœ</button>
                    <button class="modal-btn modal-btn-secondary" id="close-lenormand">å…³é—­</button>
                </div>
            </div>
            <div id="fl-panel-tarot" class="fl-panel">
                <div id="tarot-divination-content">
                    <div id="tarot-setup" style="padding:4px 0 12px;">
                        <div class="leno-num-section">
                            <div class="leno-section-label"><i class="fas fa-layer-group"></i> ç‰Œé˜µé€‰æ‹©</div>
                            <div class="leno-num-btns">
                                <button class="tarot-spread-btn active" data-spread="single"><span class="leno-btn-num">1</span><span class="leno-btn-label">å•å¼ </span></button>
                                <button class="tarot-spread-btn" data-spread="three"><span class="leno-btn-num">3</span><span class="leno-btn-label">ä¸‰å¼ </span></button>
                            </div>
                            <div class="leno-num-desc" id="tarot-spread-desc">å•å¼ ç‰Œ Â· ç›´æŒ‡å½“ä¸‹</div>
                        </div>
                        <div class="leno-question-section">
                            <div class="leno-section-label"><i class="fas fa-feather-alt"></i> ä½ çš„æé—®ï¼ˆå¯é€‰ï¼‰</div>
                            <textarea id="tarot-question" placeholder="å°†å†…å¿ƒçš„è¿·æƒ‘è½»è½»è¯‰è¯´..." class="leno-question-input"></textarea>
                        </div>

                        <button class="modal-btn modal-btn-primary leno-draw-btn" onclick="startTarotDraw()"><i class="fas fa-hand-sparkles"></i> å¼€å§‹å¡”ç½—å åœ</button>
                    </div>
                    <div id="tarot-result" style="display:none;"></div>
                </div>
                <div class="modal-buttons" style="margin-top:12px;">
                    <button class="modal-btn modal-btn-secondary" id="tarot-reset-btn" onclick="resetTarotDivination()" style="display:none;">é‡æ–°å åœ</button>
                    <button class="modal-btn modal-btn-secondary" id="close-tarot-divination">å…³é—­</button>
                </div>
            </div>
            <div id="fl-panel-divihistory" class="fl-panel">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
                    <div style="font-size:13px;color:var(--text-secondary);font-style:italic;">æ¯ä¸€æ¬¡å åœï¼Œçš†æ˜¯ä¸Žå‘½è¿çš„å¯¹è¯</div>
                    <button id="clear-divi-history-btn" onclick="clearDiviHistory()" style="background:none;border:1px solid var(--border-color);border-radius:8px;padding:5px 10px;font-size:11px;color:var(--text-secondary);cursor:pointer;font-family:var(--font-family);">æ¸…ç©ºè®°å½•</button>
                </div>
                <div id="divi-history-list" style="display:flex;flex-direction:column;gap:12px;min-height:120px;"></div>
                <div id="divi-history-empty" style="text-align:center;padding:40px 20px;color:var(--text-secondary);font-size:13px;display:none;">
                    <i class="fas fa-moon" style="font-size:32px;opacity:0.3;display:block;margin-bottom:12px;"></i>
                    å°šæ— å åœè®°å½•<br><span style="font-size:11px;opacity:0.6;">å®Œæˆä¸€æ¬¡å åœåŽï¼Œç»“æžœå°†è‡ªåŠ¨æ”¶å½•äºŽæ­¤</span>
                </div>
                <div class="modal-buttons" style="margin-top:16px;">
                    <button class="modal-btn modal-btn-secondary" id="close-divihistory">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <div id="lenormand-modal" style="display:none;"></div>


    <div class="modal" id="mood-modal">
       <div class="modal-content">
        <div class="mood-header-actions">
            <div class="modal-title" style="margin-bottom:0; border:none; padding:0;">
                <i class="fas fa-book-open"></i><span>å¿ƒæ™´æ‰‹å¸</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="view-switch-btn active" id="btn-view-calendar">
                    <i class="fas fa-calendar-alt"></i> æ—¥åŽ†
                </button>
                <button class="view-switch-btn" id="btn-view-stats">
                    <i class="fas fa-chart-pie"></i> ç»Ÿè®¡
                </button>
            </div>
        </div>
        <div id="mood-calendar-view" class="mood-view-section">
            <div class="calendar-header">
                <button class="calendar-nav-btn" id="prev-month"><i class="fas fa-chevron-left"></i></button>
                <div class="current-month-label" id="calendar-month-label">--</div>
                <button class="calendar-nav-btn" id="next-month"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-weekdays">
                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
    
        <div id="mood-stats-view" class="mood-view-section hidden-view">
            <div id="mood-stats-container" class="mood-stats-card" style="border:none; box-shadow:none; padding:0; background:transparent;">
            </div>
        </div>
    
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="close-mood">å…³é—­</button>
        </div>
       </div>
    </div>

    <div class="mood-selector-overlay" id="mood-selector-overlay">
        <div class="mood-selector-card" id="mood-editor-view">
            <h3 id="mood-selector-date">--æœˆ--æ—¥</h3>
            
            <div id="mood-edit-target-tabs" style="display:flex; gap:6px; justify-content:center; margin:8px 0 4px;">
                <button class="mood-tab-btn active" id="mood-tab-me" onclick="switchMoodEditTarget('me')" data-name-me>æˆ‘çš„è®°å½•</button>
                <button class="mood-tab-btn" id="mood-tab-partner" onclick="switchMoodEditTarget('partner')" data-name-partner>æ¢¦è§’çš„è®°å½•</button>
            </div>

            <div style="display:flex; align-items:center; justify-content:space-between; margin:8px 0 4px;">
                <button class="mood-page-btn" id="mood-page-prev" onclick="switchMoodPage(-1)">&#8249;</button>
                <span id="mood-page-indicator" style="font-size:12px; opacity:0.7;">ç¬¬ 1 é¡µ Â· å¿ƒæƒ…</span>
                <button class="mood-page-btn" id="mood-page-next" onclick="switchMoodPage(1)">&#8250;</button>
            </div>

            <div id="mood-page-1">
                <div class="mood-options-slider-wrapper">
                    <div class="mood-options-grid" id="mood-options-grid"></div>
                </div>
                <button class="mood-custom-add-btn" id="mood-custom-add" onclick="openCustomMoodDialog()">
                    <i class="fas fa-plus"></i> è‡ªå®šä¹‰å¿ƒæƒ…
                </button>
            </div>

            <div id="mood-page-2" style="display:none;">
                <div class="mood-input-wrapper">
                    <label style="font-size:12px; font-weight:500;" id="mood-note-label">éšè®°:</label>
                    <textarea id="mood-note-input" class="mood-note-input" rows="3" placeholder="è®°å½•ä¸‹ä»Šå¤©å‘ç”Ÿçš„å°äº‹..."></textarea>
                </div>
                <div style="margin-top:10px;">
                    <label style="font-size:12px; font-weight:500; display:flex; align-items:center; gap:5px; margin-bottom:6px;" id="mood-weather-label">
                        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                        ä»Šæ—¥å¤©æ°”&nbsp;
                    </label>
                    <input type="text" id="mood-weather-input" maxlength="20" placeholder="ä¾‹å¦‚ï¼šæ™´æœ— / é˜´å¤© / å°é›¨..." style="width:100%; padding:9px 14px; border:1px solid var(--border-color); border-radius:10px; font-size:13px; background:var(--primary-bg); color:var(--text-primary); outline:none; font-family:var(--font-family);">
                </div>
            </div>
    
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="modal-btn modal-btn-secondary" id="cancel-mood-edit" style="flex:1;">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-secondary" id="view-mood-detail-btn" onclick="viewMoodDetailFromEditor()" style="flex:1;">æŸ¥çœ‹è¯¦æƒ…</button>
                <button class="modal-btn modal-btn-primary" id="confirm-mood-save" style="flex:1;">ä¿å­˜</button>
            </div>
        </div>

        <div id="custom-mood-dialog" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--secondary-bg); padding:20px; border-radius:16px; width:80%; max-width:280px; z-index:2200; box-shadow:0 10px 30px rgba(0,0,0,0.3); text-align:center;">
            <h4 style="margin-bottom:12px; font-size:14px;">è‡ªå®šä¹‰å¿ƒæƒ…</h4>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <input id="custom-mood-emoji" type="text" maxlength="2" placeholder="è¡¨æƒ…" style="width:60px; text-align:center; border:1px solid var(--border-color); border-radius:8px; padding:8px; font-size:20px; background:var(--primary-bg); color:var(--text-primary);">
                <input id="custom-mood-label" type="text" maxlength="6" placeholder="åç§°ï¼ˆæœ€å¤š6å­—ï¼‰" style="flex:1; border:1px solid var(--border-color); border-radius:8px; padding:8px; font-size:13px; background:var(--primary-bg); color:var(--text-primary);">
            </div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center; margin-bottom:12px;">
                <span style="font-size:11px; opacity:0.6; width:100%;">é€‰æ‹©é¢œè‰²:</span>
                <div id="custom-mood-colors" style="display:flex; gap:6px; flex-wrap:wrap; justify-content:center;"></div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="modal-btn modal-btn-secondary" onclick="closeCustomMoodDialog()" style="flex:1; font-size:12px;">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" onclick="saveCustomMood()" style="flex:1; font-size:12px;">æ·»åŠ </button>
            </div>
        </div>
    
        <div class="day-detail-card" id="mood-detail-view" style="display:none; width:85%; max-width:320px;">
            <div class="day-detail-date" id="detail-date">--</div>
            <div id="detail-my-section" style="margin-bottom:12px;">
                <div style="font-size:11px; opacity:0.6; margin-bottom:6px; font-weight:600;">æˆ‘çš„</div>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                    <span id="detail-kaomoji" style="font-size:24px;"></span>
                    <span id="detail-label" style="font-weight:600;"></span>
                </div>
                <div class="day-detail-content" id="detail-text"></div>
                <div id="detail-my-weather" style="font-size:12px;color:var(--text-secondary);margin-top:4px;display:none;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg><span id="detail-my-weather-val"></span></div>
            </div>
                <div id="detail-partner-section" style="border-top:1px dashed var(--border-color); padding-top:10px; margin-top:4px;">
                <div style="font-size:11px; opacity:0.6; margin-bottom:6px; font-weight:600;" id="detail-partner-title">æ¢¦è§’çš„</div>
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
                    <span id="detail-partner-kaomoji" style="font-size:24px;"></span>
                    <span id="detail-partner-label" style="font-weight:600;"></span>
                </div>
                <div class="day-detail-content" id="detail-partner-text"></div>
                <div id="detail-partner-weather" style="font-size:12px;color:var(--text-secondary);margin-top:4px;display:none;"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg><span id="detail-partner-weather-val"></span></div>
            </div>
            <div id="detail-partner-no-record" style="display:none; border-top:1px dashed var(--border-color); padding-top:10px; margin-top:4px; font-size:13px; color:var(--text-secondary); font-style:italic; text-align:center;" id="detail-partner-no-record-msg">Ta è¿™å¤©è¿˜æ²¡æœ‰ç•™ä¸‹è®°å½•</div>
            <div style="margin-top:20px; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
                <button class="modal-btn modal-btn-secondary" onclick="closeMoodOverlay()" style="font-size:12px; padding:6px 12px;">å…³é—­</button>
                <button class="modal-btn modal-btn-secondary" id="delete-my-mood" onclick="deleteDailyMood(selectedDateStr,'me')" style="font-size:12px; padding:6px 12px; color:#ff6b6b; border-color:rgba(255,107,107,0.4);" data-delete-me>åˆ é™¤æˆ‘çš„</button>
                <button class="modal-btn modal-btn-secondary" id="delete-partner-mood" onclick="deleteDailyMood(selectedDateStr,'partner')" style="font-size:12px; padding:6px 12px; color:#ff6b6b; border-color:rgba(255,107,107,0.4);" data-delete-partner>åˆ é™¤æ¢¦è§’</button>
                <button class="modal-btn modal-btn-primary" id="edit-existing-mood" style="font-size:12px; padding:6px 12px;">ä¿®æ”¹æˆ‘çš„</button>
                <button class="modal-btn modal-btn-primary" id="edit-partner-mood" onclick="editPartnerMoodRecord()" style="font-size:12px; padding:6px 12px; background:rgba(255,107,107,0.8);" data-edit-partner>ä¿®æ”¹æ¢¦è§’</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="theme-editor-modal">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-palette"></i><span>ä¸»é¢˜ç¼–è¾‘å™¨</span></div>
            <div class="theme-editor-toolbar">
                <select id="theme-preset-selector" style="flex:1;"></select>
                <button id="overwrite-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px; display:none;" title="è¦†ç›–ä¿å­˜å½“å‰æ–¹æ¡ˆ"><i class="fas fa-check"></i></button>
                <button id="save-theme-preset-btn" class="modal-btn modal-btn-primary" style="padding: 8px 10px;" title="å¦å­˜ä¸ºæ–°æ–¹æ¡ˆ"><i class="fas fa-save"></i></button>
                <button id="rename-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px;" title="é‡å‘½åå½“å‰æ–¹æ¡ˆ"><i class="fas fa-pen"></i></button>
                <button id="delete-theme-preset-btn" class="modal-btn modal-btn-secondary" style="padding: 8px 10px;" title="åˆ é™¤å½“å‰æ–¹æ¡ˆ"><i class="fas fa-trash"></i></button>
            </div>
            <div id="theme-editor-grid" class="theme-editor-grid">
            </div>
            <div class="modal-buttons" style="margin-top:12px;">
                <button class="modal-btn modal-btn-primary" id="apply-close-theme-editor" style="flex:2;"><i class="fas fa-check" style="margin-right:5px;"></i>åº”ç”¨å¹¶å…³é—­</button>
                <button class="modal-btn modal-btn-secondary" id="close-theme-editor">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="modal" id="custom-replies-modal">
        <div class="modal-content">
            <div class="modal-sidebar">
                <button class="sidebar-btn active" data-major="reply">
                    <i class="fas fa-comment-dots"></i>
                    <span>å›žå¤åº“</span>
                </button>
                <button class="sidebar-btn" data-major="atmosphere">
                    <i class="fas fa-magic"></i>
                    <span>æ°›å›´æ„Ÿ</span>
                </button>
                <button class="sidebar-btn" data-major="announcement" onclick="switchToAnnouncementPanel()">
                    <i class="fas fa-newspaper"></i>
                    <span>å…¬å‘Š</span>
                </button>
            </div>
    
            <div class="modal-main-view">
                <div class="modal-title" style="padding: 15px 20px; font-size: 16px;">
                    <i class="fas fa-layer-group"></i> <span id="cr-modal-title">å†…å®¹ç®¡ç†</span>
                </div>
    
                <div class="reply-tabs" id="cr-sub-tabs">
                </div>
    
                <div class="reply-toolbar" id="cr-toolbar">
                    <input type="text" class="reply-search" id="reply-search-input" placeholder="æœç´¢...">
                    <button class="reply-tool-btn" id="import-replies-btn" title="å¯¼å…¥"><i class="fas fa-file-import"></i></button>
                    <button class="reply-tool-btn" id="export-replies-btn" title="å¯¼å‡º"><i class="fas fa-file-export"></i></button>
                </div>
    
                <div class="content-list-area" id="custom-replies-list">
                </div>

                <div id="announcement-panel" style="display:none; padding:0 16px 80px; overflow-y:auto; flex:1; min-height:0; -webkit-overflow-scrolling:touch;">
                    <div style="display:flex;flex-direction:column;gap:12px; padding:4px 0 16px;">
                        <div style="background:linear-gradient(135deg,rgba(var(--accent-color-rgb),0.12),rgba(var(--accent-color-rgb),0.05));border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.2);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-image" style="margin-right:6px;"></i>é¡¶éƒ¨èƒŒæ™¯å›¾</div>
                            <div style="display:flex;gap:8px;">
                                <button onclick="document.getElementById('dg-header-img-input').click()" style="flex:1;padding:9px;border:1.5px dashed rgba(var(--accent-color-rgb),0.4);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                    ä¸Šä¼ é¡¶éƒ¨èƒŒæ™¯
                                </button>
                                <button onclick="clearDgHeaderBg()" style="padding:9px 14px;border:1px solid var(--border-color);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">æ¸…é™¤</button>
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-image" style="margin-right:6px;"></i>ä¸­éƒ¨è£…é¥°å›¾</div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <button onclick="document.getElementById('dg-deco-img-input').click()" style="flex:1;padding:9px;border:1.5px dashed rgba(var(--accent-color-rgb),0.4);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">
                                    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                    ä¸Šä¼ è£…é¥°å›¾
                                </button>
                                <button onclick="clearDgDecoImg()" style="padding:9px 14px;border:1px solid var(--border-color);border-radius:10px;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px;font-family:var(--font-family);">æ¸…é™¤</button>
                            </div>
                            <input type="file" id="dg-deco-img-input" accept="image/*" style="display:none">
                            <div id="dg-deco-preview" style="margin-top:8px;display:none;border-radius:10px;overflow:hidden;">
                                <img id="dg-deco-preview-img" src="" style="width:100%;max-height:100px;object-fit:cover;display:block;">
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-edit" style="margin-right:6px;"></i>å…¬å‘Šæ–‡æ¡ˆ</div>
                            <div style="display:flex;flex-direction:column;gap:10px;">
                                <div>
                                    <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:5px;">å…¬å‘Šæ ‡é¢˜ <span style="opacity:0.6;">ï¼ˆæ¯è¡Œä¸€æ¡ï¼Œéšæœºæ˜¾ç¤ºï¼‰</span></label>
                                    <textarea id="dg-edit-title" rows="4" placeholder="æ¯è¡Œä¸€æ¡ï¼Œå¦‚ï¼š&#10;æ—©ä¸Šå¥½&#10;ä¸ƒå¤•å¿«ä¹&#10;æ€å¿µä½ " style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:10px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);resize:none;line-height:1.6;"></textarea>
                                </div>
                                <div>
                                    <label style="font-size:11px;color:var(--text-secondary);display:block;margin-bottom:5px;">æ¯æ—¥å¯„è¯­ <span style="opacity:0.6;">ï¼ˆæ¯è¡Œä¸€æ¡ï¼Œéšæœºæ˜¾ç¤ºï¼‰</span></label>
                                    <textarea id="dg-edit-note" rows="5" placeholder="æ¯è¡Œä¸€æ¡ï¼Œå¦‚ï¼š&#10;ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡ï¼Œæˆ‘åœ¨è¿™é‡Œé™ªç€ä½  âœ¦&#10;æƒ³ä½ äº†ï¼Œä½ æœ‰æ²¡æœ‰åœ¨æƒ³æˆ‘å‘¢" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:10px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);resize:none;line-height:1.6;"></textarea>
                                </div>
                                <button onclick="saveDailyGreetingCustom()" style="width:100%;padding:11px;background:var(--accent-color);color:white;border:none;border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font-family);">
                                    <i class="fas fa-save" style="margin-right:6px;"></i>ä¿å­˜å…¬å‘Šå†…å®¹
                                </button>
                            </div>
                        </div>

                        <div style="background:rgba(var(--accent-color-rgb),0.05);border-radius:14px;padding:14px 16px;border:1px solid rgba(var(--accent-color-rgb),0.12);">
                            <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--accent-color);font-weight:700;margin-bottom:10px;"><i class="fas fa-random" style="margin-right:6px;"></i>çŠ¶æ€éšæœºåº“</div>
                            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;line-height:1.5;">æ¯æ¬¡æ‰“å¼€å…¬å‘Šæ—¶ï¼ŒçŠ¶æ€ã€è‹±æ–‡æ ‡ç­¾ã€å›¾æ ‡å°†ä»Žä¸‹æ–¹éšæœºæŠ½å–ä¸€æ¡ã€‚</div>
                            <div id="ann-status-pool-list" style="display:flex;flex-direction:column;gap:7px;margin-bottom:12px;max-height:200px;overflow-y:auto;"></div>
                            <div style="display:flex;flex-direction:column;gap:7px;">
                                <input type="text" id="ann-status-pool-input" placeholder="çŠ¶æ€æ–‡æ¡ˆï¼Œå¦‚ï¼šåœ¨æƒ³ä½ " style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);">
                                <input type="text" id="ann-status-label-input" placeholder="è‹±æ–‡æ ‡ç­¾ï¼Œå¦‚ï¼šMISSING YOU" style="width:100%;padding:9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);">
                                <div style="display:flex;gap:7px;align-items:center;">
                                    <div style="position:relative;flex:1;">
                                        <input type="text" id="ann-status-icon-input" placeholder="å›¾æ ‡ emoji æˆ–ç•™ç©º" style="width:100%;padding:9px 36px 9px 12px;border:1px solid var(--border-color);border-radius:9px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;font-family:var(--font-family);box-sizing:border-box;">
                                        <button onclick="document.getElementById('ann-icon-img-input').click()" title="ä¸Šä¼ å›¾ç‰‡å›¾æ ‡" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);width:22px;height:22px;background:rgba(var(--accent-color-rgb),0.15);border:none;border-radius:6px;cursor:pointer;font-size:10px;color:var(--accent-color);display:flex;align-items:center;justify-content:center;padding:0;"><i class="fas fa-image"></i></button>
                                        <input type="file" id="ann-icon-img-input" accept="image/*" style="display:none" onchange="handleAnnStatusIconUpload(this)">
                                    </div>
                                    <button onclick="addAnnStatusPoolItem()" style="padding:9px 18px;background:var(--accent-color);color:white;border:none;border-radius:9px;cursor:pointer;font-size:13px;font-weight:600;flex-shrink:0;font-family:var(--font-family);letter-spacing:0.5px;">æ·»åŠ </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-primary" id="add-custom-reply" style="flex: 1;">
                        <i class="fas fa-plus"></i> æ–°å¢ž
                    </button>
                    <button class="modal-btn modal-btn-secondary" id="close-custom-replies">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="import-replies-input" accept=".json" style="display: none;">
    <input type="file" id="background-input" class="file-input" accept="image/*">
    <input type="file" id="import-input" class="file-input" accept=".json">
    <input type="file" id="sticker-file-input" class="file-input" accept="image/*" multiple>

    <div class="coin-toss-overlay" id="coin-toss-overlay">
        <div class="coin-container">
            <div class="coin" id="animated-coin">
                <div class="coin-face coin-front">
                    <div class="coin-text-main">æ˜¯</div>
                    <div class="coin-text-sub">YES</div>
                </div>
                <div class="coin-face coin-back">
                    <div class="coin-text-main">å¦</div>
                    <div class="coin-text-sub">NO</div>
                </div>
            </div>
        </div>
        <div class="coin-result-container">
            <div class="coin-result-text" id="coin-result-text"></div>
        </div>
        <div class="coin-confirm-buttons" id="coin-action-area">
            <button class="coin-btn-action" id="cancel-coin-result">å–æ¶ˆ</button>
            <button class="coin-btn-action" id="retry-coin-toss"><i class="fas fa-redo-alt"></i> å†æ¥ä¸€æ¬¡</button>
            <button class="coin-btn-action coin-btn-primary" id="send-coin-result">å‘é€ç»“æžœ</button>
        </div>
    </div>

    <div class="modal" id="disclaimer-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-scroll"></i><span>å…³äºŽ & å£°æ˜Ž</span>
            </div>
            <div id="disclaimer-content" style="font-size: 14px; line-height: 1.8; color: var(--text-secondary); max-height: 50vh; overflow-y: auto; padding-right: 10px;">
                <div style="text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border-color);">
                    <h3 style="color: var(--accent-color); margin-bottom: 10px;">ç‰¹åˆ«é¸£è°¢</h3>
                    <div style="text-align: center; margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--accent-color);">
                        <p style="margin: 5px 0; color: var(--text-primary);">
                            å‚è€ƒäº† <strong>Bç«™ @molina-3- çš„ä¼ è®¯ç½‘ç«™</strong>
                        </p>
                        <p style="margin: 5px 0; font-weight: bold; color: #e53935;">
                            å¦‚æžœéœ€è¦æ›´å¥½çš„æ²Ÿé€šä½“éªŒ è¯·æ”¯æŒå“¦ï¼
                        </p>
                    </div>
                    <p>æ„Ÿè°¢ <strong>@è‹é“‚æ½¼</strong></p>
                    <p style="font-size: 12px; opacity: 0.8;">å°çº¢ä¹¦å·ï¼š9568228497</p>
                    <p style="font-size: 12px; margin-top: 5px; font-style: italic;">(èŠå¤©ç»Ÿè®¡éƒ¨åˆ†ä»£ç å‚è€ƒ)</p>
                </div>
                <div style="margin-top: 15px;">
                    <p style="font-weight: bold; color: var(--text-primary); text-align: center;">
                        åŽŸåˆ›ï¼šå°çº¢ä¹¦ @milk (1149615009)
                    </p>
                    <p style="color: #e53935; font-weight: bold; text-align: center; margin-top: 10px; border: 1px solid #e53935; padding: 5px; border-radius: 5px;">
                        æ­¤ä»£ç ç»å¯¹ç¦æ­¢å•†ç”¨å’Œç›ˆåˆ©è¡Œä¸ºï¼Œä¸€æ—¦å‘çŽ°è¿½ç©¶åˆ°åº•
                    </p>
                    <p style="text-align: center; margin-bottom: 15px;">æ”¯æŒäºŒæ”¹äºŒä¼ ï¼Œæ„Ÿè°¢ä½¿ç”¨ï¼</p>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>åå¯¹æ€§åˆ«æš´åŠ›</b></li>
                    <li style="text-align: center; font-size: 1.1em; color: #8A2BE2; list-style: none; margin: 5px 0;"><b>å°Šé‡ä¸è¯¥æ˜¯å¥¢æ±‚,å®‰å…¨å¿…é¡»æ˜¯åº•çº¿</b></li>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="accept-disclaimer" onclick="(function(){var m=document.getElementById('disclaimer-modal');if(m&&typeof hideModal==='function')hideModal(m);})()" style="width: 100%;">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="anniversary-modal">
        <div class="modal-content">
            <div class="ann-header-card" id="ann-header-card" style="display: none;">
                <div class="ann-header-card-bg" id="ann-header-card-bg"></div>
                <div class="ann-header-card-overlay" id="ann-header-card-overlay"></div>
                <input type="file" id="ann-header-bg-input" accept="image/*" style="display:none;">
                <div class="ann-header-card-inner">
                    <span class="ann-header-icon" id="ann-header-icon">â¤ï¸Ž</span>
                    <span class="ann-header-label" id="ann-header-label">ANNIVERSARY</span>
                    <div class="ann-header-title" id="ann-header-title">çºªå¿µæ—¥</div>
                    <div class="ann-header-days" id="ann-header-days">0<span class="ann-header-days-unit">å¤©</span></div>
                    <div class="ann-header-date" id="ann-header-date">--/--</div>
                    <div class="ann-header-milestones" id="ann-header-milestones"></div>
                </div>
            </div>
            <div id="ann-card-toolbar" style="display:none; padding:6px 14px 2px; align-items:center; justify-content:flex-end; gap:8px;">
                <button class="ann-header-upload-btn" onclick="document.getElementById('ann-header-bg-input').click()" title="æ›´æ¢èƒŒæ™¯å›¾" style="position:static; background:rgba(var(--accent-color-rgb),0.1); border-color:rgba(var(--accent-color-rgb),0.3); color:var(--accent-color);">
                    <i class="fas fa-image"></i> æ›´æ¢å°é¢
                </button>
                <button class="ann-header-upload-btn" onclick="clearAnnCardBg()" title="æ¸…é™¤èƒŒæ™¯å›¾" style="position:static; background:rgba(var(--accent-color-rgb),0.05); border-color:rgba(var(--accent-color-rgb),0.2); color:var(--text-secondary);">
                    <i class="fas fa-times"></i> æ¸…é™¤
                </button>
            </div>
    
            <div class="ann-list-container" id="ann-list-container">
            </div>
    
            <div class="ann-footer">
                <button class="modal-btn modal-btn-secondary" id="close-anniversary-modal">å…³é—­</button>
                <button class="modal-btn modal-btn-primary" id="open-ann-add-btn" style="flex: 1;">
                    <i class="fas fa-plus"></i> æ–°å¢žçºªå¿µæ—¥
                </button>
            </div>
    
            <div class="ann-editor-slide" id="ann-editor-slide">
                <div class="ann-editor-header">
                    <button class="ann-back-btn" id="close-ann-editor"><i class="fas fa-arrow-left"></i></button>
                    <span><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M12 5v14M5 12h14"/></svg> æ·»åŠ çºªå¿µæ—¥</span>
                </div>
                
                <div class="ann-editor-content">
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-tag"></i>æ ‡é¢˜åç§°</label>
                        <input type="text" class="modal-input" id="ann-input-name" placeholder="ä¾‹å¦‚ï¼šæ‹çˆ±çºªå¿µæ—¥ã€æ¢¦è§’ç”Ÿæ—¥">
                    </div>
    
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-calendar-alt"></i>é€‰æ‹©æ—¥æœŸ</label>
                        <input type="date" class="modal-input" id="ann-input-date">
                    </div>
    
                    <div class="ann-form-group">
                        <label class="ann-label"><i class="fas fa-th-large"></i>ç±»åž‹</label>
                        <div class="ann-type-selector">
                            <div class="ann-type-btn active" data-type="anniversary" onclick="switchAnnType('anniversary')">
                                <i class="fas fa-heart"></i>
                                <span>çºªå¿µæ—¥</span>
                                <span class="ann-type-hint">è¿‡åŽ» â†’ ä»Šå¤©</span>
                            </div>
                            <div class="ann-type-btn" data-type="countdown" onclick="switchAnnType('countdown')">
                                <i class="fas fa-hourglass-half"></i>
                                <span>å€’æ•°æ—¥</span>
                                <span class="ann-type-hint">ä»Šå¤© â†’ æœªæ¥</span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; opacity: 0.7; padding: 0 2px;">
                            <span id="ann-type-desc">è®¡ç®—ä»Žè¿‡åŽ»æŸä¸€å¤©åˆ°çŽ°åœ¨å·²ç»è¿‡äº†å¤šå°‘å¤©</span>
                        </div>
                    </div>
    
                    <button class="modal-btn modal-btn-primary" id="save-ann-btn" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-check"></i> ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="anniversary-animation" id="anniversary-animation">
        <div class="anniversary-animation-content">
            <div class="anniversary-animation-title" id="anniversary-animation-title">
                çºªå¿µæ—¥å¿«ä¹ï¼
            </div>
            <div class="anniversary-animation-days" id="anniversary-animation-days">
                0
            </div>
            <div class="anniversary-animation-message" id="anniversary-animation-message">
                æˆ‘ä»¬å·²ç»ç›¸ä¼´äº†è¿™ä¹ˆå¤šå¤©
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="modal-btn modal-btn-primary" id="close-anniversary-animation">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="decision-menu-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-balance-scale"></i><span>æŠ‰æ‹©åŠ©æ‰‹</span>
            </div>
            <div class="decision-menu-grid">
                <div class="decision-option-card" id="open-coin-toss">
                    <i class="fas fa-coins"></i>
                    <h3>æŠ›ç¡¬å¸</h3>
                    <p>æ˜¯ / å¦ äºŒå…ƒé€‰æ‹©</p>
                </div>
                <div class="decision-option-card" id="open-wheel">
                    <i class="fas fa-magic"></i>
                    <h3>éšæœºæŠ½ç­¾</h3>
                    <p>è‡ªå®šä¹‰é€‰é¡¹éšæœºæŠ½å–</p>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-decision-menu">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="wheel-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-magic"></i><span>éšæœºæŠ½ç­¾</span>
            </div>
            
            <div class="picker-wrapper">
                <div class="picker-box-stage">
                    <div class="picker-cards-row" id="picker-cards-row"></div>
                    <div class="picker-result-text" id="wheel-result"></div>
                </div>
                <div class="picker-controls">
                    <div class="picker-options-label">é€‰é¡¹åˆ—è¡¨ï¼ˆè‡³å°‘ 2 é¡¹ï¼‰</div>
                    <div class="picker-options-list" id="wheel-options-list"></div>
                    <button class="modal-btn modal-btn-secondary picker-add-btn" id="add-wheel-option">
                        <i class="fas fa-plus"></i> æ·»åŠ é€‰é¡¹
                    </button>
                </div>
            </div>
    
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="close-wheel">å…³é—­</button>
                <button class="modal-btn modal-btn-primary" id="spin-wheel-btn"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 12a10 10 0 0 1 18.8-3.6M22 12a10 10 0 0 1-18.8 3.6"/></svg> å¼€å§‹æŠ½ç­¾</button>
                <button class="modal-btn modal-btn-primary" id="send-wheel-result" style="display:none;">å‘é€ç»“æžœ</button>
            </div>
        </div>
    </div>

    <div class="player-container" id="player">
        <div class="mini-view" id="mini-view" title="ç‚¹å‡»å±•å¼€">
            <div class="vinyl-record" id="vinyl-record-visual">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 13l-4-4h8l-4 4z" /></svg>
            </div>
        </div>
        <div class="full-view">
            <div class="minimize-btn" id="minimize-btn" title="æ”¶èµ·">
                <svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" /></svg>
            </div>
            <button id="upload-cover-btn" style="position: absolute; top: 12px; left: 15px; background: none; border: 1px dashed var(--border-color); color: var(--text-secondary); cursor: pointer; opacity: 0.7; z-index: 10; width: 24px; height: 24px; border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:12px;" title="æ›´æ¢ä¸“è¾‘å°é¢">
                <i class="fas fa-camera"></i>
            </button>
            <input type="file" id="cover-input" accept="image/*" style="display: none;">
            <div class="track-info">
                <div class="track-name" id="music-title">Loading...</div>
                <div class="track-sub" id="music-subtitle">...</div>
            </div>
            <div class="progress-wrapper" id="progress-area">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="controls">
                <button class="btn" id="mode-btn" title="åˆ‡æ¢æ¨¡å¼">
                    <svg id="icon-loop" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" /></svg>
                    <svg id="icon-shuffle" style="display:none" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" /></svg>
                </button>
                <button class="btn" id="prev-btn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" /></svg></button>
                <button class="btn btn-main" id="play-btn">
                    <svg id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z" /></svg>
                    <svg id="icon-pause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" /></svg>
                </button>
                <button class="btn" id="next-btn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" /></svg></button>
                <button class="btn" id="list-btn"><svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" /></svg></button>
            </div>
        </div>
    </div>
    <div class="playlist-popup" id="playlist"></div>
    <audio id="audio"></audio>

    <div class="modal" id="add-song-modal">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-music"></i><span>æ·»åŠ è‡ªå®šä¹‰æ­Œæ›²</span>
            </div>
            <input type="text" class="modal-input" id="new-song-title" placeholder="æ­Œæ›²åç§° (ä¾‹å¦‚: è¿™é‡Œçš„é£Žæ™¯)">
            <input type="text" class="modal-input" id="new-song-sub" placeholder="æ­Œæ‰‹/å¤‡æ³¨ (ä¾‹å¦‚: ä½ çš„åå­—)">
            <input type="text" class="modal-input" id="new-song-url" placeholder="éŸ³é¢‘é“¾æŽ¥ (mp3/m4a é“¾æŽ¥)">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" id="cancel-add-song">å–æ¶ˆ</button>
                <button class="modal-btn modal-btn-primary" id="confirm-add-song">æ·»åŠ æ’­æ”¾</button>
            </div>
        </div>
    </div>

    <script>
        const APP_PREFIX = 'CHAT_APP_V3_';
        const MAX_IMAGE_SIZE = 5 * 1024 * 1024;
        const MAX_AVATAR_SIZE = 2 * 1024 * 1024;
        const MESSAGES_PER_PAGE = 50;
        
        function safeGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                console.error('Error getting item:', e);
                return null;
            }
        }

        function safeSetItem(key, value) {
            try {
                if (typeof value === 'object') {
                    value = JSON.stringify(value);
                }
                localStorage.setItem(key, value);
            } catch (e) {
                console.error('Error setting item:', e);
            }
        }

        function safeRemoveItem(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
                console.error('Error removing item:', e);
            }
        }

        function cropImageToSquare(file, maxSize = 640) { 
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const minSide = Math.min(img.width, img.height);
                        const sx = (img.width - minSide) / 2;
                        const sy = (img.height - minSide) / 2;

                        const canvas = document.createElement('canvas');
                        canvas.width = maxSize;
                        canvas.height = maxSize;
                        const ctx = canvas.getContext('2d');

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';

                        ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, maxSize, maxSize);

                        resolve(canvas.toDataURL('image/jpeg', 0.95));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        const CONSTANTS = {
            HEADER_MOTTOS: [
                "â‹†âºâ‚Šâ‹† â˜¾ â‹†âºâ‚Šâ‹† æ€å¿µçš„ç”µæ³¢å·²è¿žæŽ¥ â‹†âºâ‚Šâ‹† â˜¾ â‹†âºâ‚Šâ‹†",
                "æˆ‘ä»¬æ˜¯å½¼æ­¤çš„å®‡å®™å›žå“",
                "æ‰€æœ‰æ€ç»ªï¼Œéƒ½å¥”å‘ä½ ",
                "ç­”æ¡ˆå¾ˆé•¿ï¼Œæˆ‘å‡†å¤‡ç”¨ä¸€ç”Ÿæ¥å›žç­”",
                "æœˆè‰²çœŸç¾Ž",
                "ä¸€æœŸä¸€ä¼š",
                "å¿µå¿µä¸å¿˜ï¼Œå¿…æœ‰å›žå“",
                "å±±æœ‰æœ¨å…®æœ¨æœ‰æž",
                "ä»Šæ™šæœˆè‰²çœŸç¾Ž",
                "æ˜¥é£Žåé‡Œä¸å¦‚ä½ ",
                "å¿ƒæœ‰çŒ›è™Žï¼Œç»†å—…è”·è–‡",
                "äººé—´æœ‰å‘³æ˜¯æ¸…æ¬¢",
                "æ–¯äººè‹¥å½©è™¹ï¼Œé‡ä¸Šæ–¹çŸ¥æœ‰",
                "You are my sunshine",
                "I love you three thousand",
                "What is essential is invisible to the eye",
                "Carpe diem",
                "To be or not to be",
                "æ°¸é ã®ä¸€çž¬",
                "å›ã®åã¯",
                "ä¸–ç•ŒãŒçµ‚ã‚ã‚‹ã¾ã§ã¯",
                "ã•ã‚ˆã†ãªã‚‰ã€ã‚ã‚ŠãŒã¨ã†",
                "å›ã¨ä¼šãˆã¦ã‚ˆã‹ã£ãŸ",
                "äººç”Ÿè‹¥åªå¦‚åˆè§",
                "å½“æ—¶åªé“æ˜¯å¯»å¸¸",
                "æ›¾ç»æ²§æµ·éš¾ä¸ºæ°´",
                "æ­¤æƒ…å¯å¾…æˆè¿½å¿†",
                "ä¼¼æ­¤æ˜Ÿè¾°éžæ˜¨å¤œ",
                "The best is yet to come",
                "All you need is love",
                "Let it be",
                "Here comes the sun",
                "Yesterday once more",
                "æ˜¥ã¯ã‚ã‘ã¼ã®",
                "ç‰©ã®å“€ã‚Œ",
                "ã‚ã³ã•ã³",
                "èŠ±ã¯æ¡œæœ¨äººã¯æ­¦å£«",
                "ä¸€æœŸä¸€ä¼š",
                "å±±æœ‰æœ¨å…®æœ¨æœ‰æž",
                "å¿ƒæ‚¦å›å…®å›ä¸çŸ¥",
                "é£Žèµ·äºŽé’èä¹‹æœ«",
                "äº‘å·äº‘èˆ’",
                "èŠ±å¼€èŠ±è½",
                "æœˆåœ†æœˆç¼º",
                "æ½®èµ·æ½®è½",
                "å¿ƒæœ‰çµçŠ€ä¸€ç‚¹é€š",
                "è¨€æœ‰å°½è€Œæ„æ— ç©·",
                "é£Žä¹èµ·ï¼Œå¹çš±ä¸€æ± æ˜¥æ°´",
                "äº‘æ— å¿ƒä»¥å‡ºå²«",
                "èŠ±è‡ªé£˜é›¶æ°´è‡ªæµ",
                "æœˆæ˜¯æ•…ä¹¡æ˜Ž",
                "æ½®å¹³ä¸¤å²¸é˜”",
                "å¿ƒæœ‰åƒåƒç»“",
                "è¨€ä¸å°½æ„",
                "æ­¤æ—¶æ­¤å¤œéš¾ä¸ºæƒ…",
                "æ¬²è¯­æ³ªå…ˆæµ",
                "åƒå±±ä¸‡æ°´",
                "é£Žè§è§å…®æ˜“æ°´å¯’",
                "äº‘æ·¡é£Žè½»",
                "èŠ±å¥½æœˆåœ†",
                "æœˆè½ä¹Œå•¼éœœæ»¡å¤©",
                "æ½®è½å¤œæ±Ÿæ–œæœˆé‡Œ",
                "å¿ƒä¹‹æ‰€å‘ï¼Œç´ å±¥ä»¥å¾€",
                "è¨€ä¸ºå¿ƒå£°",
                "æ­¤æƒ…å¯å¾…æˆè¿½å¿†",
                "æ¬²ç©·åƒé‡Œç›®",
                "åƒé‡Œå…±å©µå¨Ÿ"
            ],
            WELCOME_ANIMATIONS: [{
                line1: "â™¡ çˆ± â™¡",
                line2: "âœ§ æ­£åœ¨è¿žæŽ¥æˆ‘ä»¬çš„æ€ç»ª âœ§"
            },
                {
                    line1: "ð‘³ð’ð’—ð’†",
                    line2: "è‹¥è¦ç”±æˆ‘æ¥è°ˆè®ºçˆ±çš„è¯"
                },
                {
                    line1: "ð•°ð–ˆð–ð–”",
                    line2: "å¬è§æˆ‘çš„å›žéŸ³äº†å—ï¼Ÿ"
                },
                {
                    line1: "ðš‚ðš˜ðšžðš•ðš–ðšŠðšðšŽ",
                    line2: "çµé­‚æ­£åœ¨å…±æŒ¯"
                },
                {
                    line1: "Akashic Eye",
                    line2: "é“¾æŽ¥å·²å»ºç«‹"
                },
                {
                    line1: "âœ¦ ç›¸é‡ âœ¦",
                    line2: "åœ¨ä¸‡åƒäººæµ·ä¸­é‡è§ä½ "
                },
                {
                    line1: "è©©ç¯‡",
                    line2: "ä¸ºä½ å†™ä¸‹çš„æ¯ä¸€è¡Œè¯—"
                },
                {
                    line1: "Melody",
                    line2: "å¿ƒè·³çš„æ—‹å¾‹ä¸ºä½ å¥å“"
                },
                {
                    line1: "Destiny",
                    line2: "å‘½è¿çš„çº¢çº¿å°†æˆ‘ä»¬ç›¸è¿ž"
                },
                {
                    line1: "Memory",
                    line2: "åˆ›é€ å±žäºŽæˆ‘ä»¬çš„å›žå¿†"
                },
                {
                    line1: "è¨€è‘‰",
                    line2: "æƒ³ä¼ è¾¾ç»™ä½ çš„è¯è¯­"
                },
                {
                    line1: "çµ†",
                    line2: "çœ‹ä¸è§çš„ç¾ç»Š"
                },
                {
                    line1: "æœªæ¥",
                    line2: "ä¸€èµ·èµ°å‘çš„æœªæ¥"
                },
                {
                    line1: "å¸Œæœ›",
                    line2: "ä½ å°±æ˜¯æˆ‘çš„å¸Œæœ›"
                },
                {
                    line1: "å…‰",
                    line2: "ä½ æ˜¯æˆ‘ç”Ÿå‘½ä¸­çš„å…‰"
                },
                {
                    line1: "Amore",
                    line2: "å¿ƒè·³æ¼æ‹çš„é‚£ä¸€ç§’"
                },
                {
                    line1: "å…±æŒ¯",
                    line2: "é¢‘çŽ‡ç›¸åŒçš„ä¸¤ä¸ªçµé­‚"
                },
                {
                    line1: "âˆž",
                    line2: "æ— é™å¾ªçŽ¯çš„æ€å¿µ"
                },
                {
                    line1: "Serendipity",
                    line2: "æœ€ç¾Žä¸½çš„æ„å¤–"
                },
                {
                    line1: "æµ®ä¸–",
                    line2: "æ²‰æµ®äººä¸–é—´çš„æ¸©æŸ”"
                },
                {
                    line1: "é‡å­çº ç¼ ",
                    line2: "è¶…è¶Šè·ç¦»çš„é»˜å¥‘"
                },
                {
                    line1: "Elysian",
                    line2: "ä¸Žä½ å…±åº¦çš„ç†æƒ³ä¹¡"
                },
                {
                    line1: "æ˜Ÿè½¨",
                    line2: "äº¤æ±‡æ—¶äº’æ”¾çš„å…‰äº®"
                },
                {
                    line1: "è™¹è‰²",
                    line2: "æŠ˜å°„å‡ºæ‰€æœ‰çš„å¯èƒ½"
                },
                {
                    line1: "Paracosm",
                    line2: "å…±åŒæž„å»ºçš„ç§å®‡å®™"
                },
                {
                    line1: "æ½®æ±",
                    line2: "å› ä½ è€Œèµ·çš„å¾‹åŠ¨"
                },
                {
                    line1: "Ã†ther",
                    line2: "å¼¥æ¼«åœ¨ç©ºæ°”ä¸­çš„æ‚¸åŠ¨"
                },
                {
                    line1: "åŒæ˜Ÿ",
                    line2: "å½¼æ­¤çŽ¯ç»•çš„æ°¸æ’èˆžè¹ˆ"
                },
                {
                    line1: "ç»¯è‰²",
                    line2: "æŸ“ä¸Šè„¸é¢Šçš„æ¸©åº¦"
                },
                {
                    line1: "Symphony",
                    line2: "ç”Ÿå‘½äº¤ç»‡çš„ä¹ç« "
                },
                {
                    line1: "ç»çº¬",
                    line2: "æ³¨å®šç›¸é‡çš„åæ ‡"
                },
                {
                    line1: "Nebula",
                    line2: "æœ¦èƒ§è€Œç’€ç’¨çš„å¿ƒäº‹"
                },
                {
                    line1: "æ—¶é›¨",
                    line2: "æ°åˆ°å¥½å¤„çš„æ¸©æŸ”"
                },
                {
                    line1: "Event Horizon",
                    line2: "å†ä¹Ÿæ— æ³•é€ƒç¦»çš„å¼•åŠ›"
                },
                {
                    line1: "èŠ±ç«",
                    line2: "åˆ¹é‚£å³æ°¸æ’çš„å…‰èŠ’"
                },
                {
                    line1: "â„°ð“‰ð‘’ð“‡ð“ƒð’¶ð“",
                    line2: "æ—¶é—´åœé©»çš„æ­¤åˆ»"
                },
                {
                    line1: "éŸ¶å…‰",
                    line2: "ä¸Žä½ å…±åº¦çš„æ¯å¯¸å…‰é˜´"
                },
                {
                    line1: "ð’®ð“Šð“‚ð“‚ð‘’ð“‡",
                    line2: "æ°¸ä¸ç»“æŸçš„ç››å¤"
                },
                {
                    line1: "æ˜Ÿéœœ",
                    line2: "å…±åŒç»åŽ†çš„å²æœˆ"
                },
                {
                    line1: "ð“šð“²ð“¼ð“¼",
                    line2: "æœªè¯´å‡ºå£çš„å‘Šç™½"
                },
                {
                    line1: "æœˆä¸‹",
                    line2: "ä¸¤äººç‹¬å¤„çš„å¤œæ™š"
                },
                {
                    line1: "ð“•ð“¸ð“»ð“®ð“¿varepsilonð“»",
                    line2: "æƒ³è¦å»¶ç»­çš„æ°¸è¿œ"
                },
                {
                    line1: "æœéœ²",
                    line2: "æ™¶èŽ¹å‰”é€çš„çœŸå¿ƒ"
                },
                {
                    line1: "ð“œð“²ð“»ð“ªð“¬ð“µð“®",
                    line2: "ä½ å°±æ˜¯å¥‡è¿¹æœ¬èº«"
                },
                {
                    line1: "æ˜¥é£Ž",
                    line2: "è½»è½»æ‹‚è¿‡çš„æ¸©æŸ”"
                },
                {
                    line1: "ð“›ð“¾ð“¬ð“´ð”‚",
                    line2: "æ­¤ç”Ÿæœ€å¤§çš„å¹¸è¿"
                },
                {
                    line1: "è¤ç«",
                    line2: "é»‘æš—ä¸­æŒ‡å¼•çš„å…‰"
                },
                {
                    line1: "ð“—ð“®ð“ªð“»ð“½",
                    line2: "ä¸ºä½ è·³åŠ¨çš„å¿ƒè„"
                },
                {
                    line1: "åˆé›ª",
                    line2: "çº¯æ´æ— ç‘•çš„çˆ±æ„"
                },
                {
                    line1: "ð“’ð“¸ð“¶ð“®ð“½",
                    line2: "åˆ’è¿‡å¤©é™…çš„ç›¸é‡"
                },
                {
                    line1: "æ½®é¸£",
                    line2: "å†…å¿ƒæ¾Žæ¹ƒçš„å£°éŸ³"
                },
                {
                    line1: "ð“¢ð“½ð“ªð“»ð“­ð“¾ð“¼ð“½",
                    line2: "æ•£è½åœ¨èº«çš„æ˜Ÿå°˜"
                },
                {
                    line1: "æ¢§æ¡",
                    line2: "ç­‰å¾…å‡¤å‡°çš„æ‰§ç€"
                },
                {
                    line1: "ð“Ÿð“»ð“®ð“¬ð“²ð“¸ð“¾ð“¼",
                    line2: "è§†è‹¥çå®çš„ä½ æˆ‘"
                },
                {
                    line1: "é’ç©º",
                    line2: "æ¾„æ¾ˆå¦‚ä½ çš„çœ¼çœ¸"
                },
                {
                    line1: "ð’œð“‚ð’¶ð“‡ð“ƒð“‰ð’½",
                    line2: "æ°¸ä¸å‡‹é›¶çš„å¿ƒæ„"
                },
                {
                    line1: "Ã‰toile",
                    line2: "ä½ æ˜¯æˆ‘å”¯ä¸€çš„æ˜Ÿè¾°"
                },
                {
                    line1: "ð‘©ð’Ã¼ð’•ð’†",
                    line2: "æ‚„ç„¶ç»½æ”¾çš„æ‹æ…•"
                },
                {
                    line1: "é‹å‘½",
                    line2: "é¿æ— å¯é¿çš„ç›¸é‡"
                },
                {
                    line1: "ð‘ªð’†ð’ð’†ð’”ð’•ð’†",
                    line2: "æ¥è‡ªå¤©é™…çš„é¦ˆèµ "
                },
                {
                    line1: "æ‹å¿ƒ",
                    line2: "è—ä¸ä½çš„æ‚¸åŠ¨"
                },
                {
                    line1: "ð‘ºð’†ð’“ð’‚ð’‘ð’‰",
                    line2: "å®ˆæŠ¤ä½ çš„å…­ç¿¼å¤©ä½¿"
                },
                {
                    line1: "ä¸€æœŸä¸€ä¼š",
                    line2: "ä¸€ç”Ÿä¸€æ¬¡çš„é‚‚é€…"
                },
                {
                    line1: "ð‘¬ð’‘ð’ð’ð’‚",
                    line2: "ç©¿è¶Šæ—¶ç©ºçš„çœ·æ‹"
                },
                {
                    line1: "æœˆã®é›«",
                    line2: "æœˆå…‰å‡æˆçš„æ³ªæ»´"
                },
                {
                    line1: "ð‘½ð’†ð’“ð’”ð’‚ð’Šð’ð’ð’†ð’”",
                    line2: "ä¸ºä½ å»ºé€ çš„å®«æ®¿"
                },
                {
                    line1: "åƒå¤œä¸€å¤œ",
                    line2: "è¯‰ä¸å°½çš„å¤œè¯"
                },
                {
                    line1: "ð‘´ð’‚ð’“Ã©ð’†",
                    line2: "æ¸©æŸ”å¸­å·çš„æµªæ½®"
                },
                {
                    line1: "æ¡ƒæºéƒ·",
                    line2: "åªå±žäºŽä¸¤äººçš„ä¹åœŸ"
                },
                {
                    line1: "ð‘ºð’ð’–ð’‡ð’‡ð’ð’†ð’“",
                    line2: "ç”œèœœçš„æŠ˜ç£¨"
                },
                {
                    line1: "æ¡œå¹é›ª",
                    line2: "çº·é£žå¦‚é›ªçš„æ€å¿µ"
                },
                {
                    line1: "ð‘¨ð’–ð’“ð’ð’“ð’†",
                    line2: "é»Žæ˜Žå‰çš„æžå…‰"
                },
                {
                    line1: "åå…­å¤œ",
                    line2: "æœ€åœ†æ»¡çš„å¤œæ™š"
                },
                {
                    line1: "ð‘ªð’šð’‚ð’ð’ð’‘ð’‰ð’šð’ð’ð’†",
                    line2: "é’æ¶©çš„æ‹ä¹‹å¶"
                },
                {
                    line1: "é‡‘æœ¨çŠ€",
                    line2: "ç§‹æ—¥é‡Œæš—é¦™æµ®åŠ¨"
                },
            ],
            WELCOME_ICONS: [
                "fas fa-heart", "fas fa-star", "fas fa-moon", "fas fa-sun", "fas fa-cloud", "fas fa-feather", "fas fa-book", "fas fa-music", "fas fa-pen", "fas fa-key", "fas fa-compass", "fas fa-globe", "fas fa-leaf", "fas fa-water", "fas fa-fire", "fas fa-snowflake", "fas fa-umbrella", "fas fa-anchor", "fas fa-bell", "fas fa-gem", "fas fa-crown", "fas fa-dragon", "fas fa-feather-alt", "fas fa-fish", "fas fa-frog", "fas fa-hat-wizard", "fas fa-magic", "fas fa-ring", "fas fa-scroll", "fas fa-shield-alt", "fas fa-dove", "fas fa-cat", "fas fa-dog", "fas fa-horse", "fas fa-otter", "fas fa-paw", "fas fa-spider", "fas fa-kiwi-bird", "fas fa-crow", "fas fa-dove", "fas fa-seedling", "fas fa-tree", "fas fa-mountain", "fas fa-water", "fas fa-wind", "fas fa-volcano", "fas fa-meteor", "fas fa-satellite", "fas fa-rocket", "fas fa-user-astronaut"
            ],
            PARTNER_STATUSES: ["åœ¨çº¿", "å¿™ç¢Œ", "ç¦»å¼€", "æ€è€ƒ", "å¬éŸ³ä¹", "é˜…è¯»", "å·¥ä½œ", "å­¦ä¹ ", "æƒ³ä½ ", "ä¼‘æ¯", "ç¡è§‰", "æ™’å¤ªé˜³", "æ™´å¤©", "å¤šäº‘", "é˜´å¤©", "å°é›¨", "ä¸­é›¨", "å¤§é›¨", "é›·é˜µé›¨", "æš´é›¨", "å°é›ª", "ä¸­é›ª", "å¤§é›ª", "æš´é›ª", "é›¾å¤©", "å¤§é›¾", "æ¸…æ™¨", "æ™Œåˆ", "ä¼‘æ¯", "å¤œæ™š", "æ·±å¤œ", "æŽ¢ç´¢", "æ²‰æ€", "ç­‰å¾…", "çŽ©æ¸¸æˆ", "å‘å‘†", "åƒé¥­", "ä¸‹åˆèŒ¶", "ç”œç‚¹", "æ’¸çŒ«", "æ’¸ç‹—", "ç‰µæŒ‚", "å¥èº«", "æƒŠé†’", "æƒŠè®¶", "ç©ºè™š", "åšå®š", "è¿·èŒ«", "å¿å¿‘", "æƒ†æ€…", "æ€å¿µ", "å®‰å¿ƒ", "ä¸èˆ", "å†·é™", "éš¾è¨€", "å¤±çœ ", "ç–²å€¦", "ç©ºç™½", "è¡¥å……", "è¿Ÿç–‘", "ä¾æ‹", "æ´—æ¼±", "åŽ‹æŠ‘", "äº¤å‹", "å¸®åŠ©", "æ¢¦å¢ƒ", "ç¥ç¦", "å›žå®¶", "ç”Ÿæ°”", "æ’’å¨‡", "åƒé†‹", "å¿«ä¹", "å¹¸ç¦", "èŠå¤©", "é™ªæˆ‘", "å æœ‰", "èµšé’±", "ä¿æŠ¤", "æ··ä¹±", "ç”Ÿç—…", "å¬é›¨", "çœ‹æ‰‹æœº", "å¤„ç†å…¬åŠ¡", "å¼€ä¼šä¸­", "è®­ç»ƒ"],
            REPLY_MESSAGES: ["å–œæ¬¢", "ä¸å–œæ¬¢", "åœ¨å—ï¼Ÿ", "ä»Šå¤©è¿‡å¾—æ€Žä¹ˆæ ·ï¼Ÿ", "æƒ³ä½ ", "æ™šå®‰", "çœ‹åˆ°è®°å¾—å›žå¤ðŸ¥²", "å¥½çš„ðŸ‘ŒðŸ»", "æ˜Žç™½", "è°¢è°¢", "ä¸å®¢æ°”", "å—¯", "å—¯å—¯", "çœŸçš„å—ï¼Ÿ", "æˆ‘æ˜Žç™½äº†", "æˆ‘ç›¸ä¿¡ä½ ", "ç¨ç­‰", "é©¬ä¸Š", "å¥½å“¦", "ä¸é”™", "å¯ä»¥", "åŒæ„", "ç†è§£", "æˆ‘åœ¨", "åœ¨æŽ¢ç´¢è¿‡ç¨‹ä¸­", "æ€Žä¹ˆäº†ï¼Ÿ", "å¬æ‡‚äº†", "è®°ä¸‹äº†", "æ”¶åˆ°", "ä¼šå°½å¿«æŸ¥çœ‹çš„", "è¯¯ä¼šæˆ‘äº†", "æ²¡æœ‰æˆ‘æƒ³è¯´çš„", "å¯¹ä¸èµ·", "æ²¡å…³ç³»", "æˆ‘çˆ±ä½ ", "è®©æˆ‘æƒ³æƒ³æ€Žä¹ˆå›žç­”", "çœ¼èŠ±ç¼­ä¹±", "å¾ˆæœ‰åˆ›æ„", "ä¿æŒè”ç³»", "æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ", "æŽ¥ä¸‹æ¥å‡†å¤‡åšä»€ä¹ˆï¼Ÿ", "æˆ‘å¾ˆæƒ³å¬å¬ä½ çš„æƒ³æ³•", "æˆ‘æ„¿æ„", "ä¸ç”¨", "è®°å¾—åƒé¥­", "ä¸è¦ç†¬å¤œ", "ä¸è¦æ‹…å¿ƒ", "ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„", "æˆ‘å¾ˆéš¾è¿‡", "æƒŠé†’äº†ï¼Œç¡ä¸ç€", "è¿™å¯¹æˆ‘æ¥è¯´æ˜¯ä¸ªæ–°é¢†åŸŸ", "å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ", "åœ¨çœ‹ä»€ä¹ˆï¼Ÿ", "åœ¨å·¥ä½œå—ï¼Ÿ", "åœ¨å­¦ä¹ å—ï¼Ÿ", "ç„¶åŽå‘¢ï¼Ÿ", "æ‘¸æ‘¸ðŸ«³ðŸ»", "åœ¨å­¦ä¹ ä¸€äº›æ–°ä¸œè¥¿", "æ¢ä¸ªæƒ³æ³•å§ï¼Ÿ", "æ™šé¥­åƒäº†å—ï¼Ÿ", "ä½œæ¯æ··ä¹±", "æˆ‘", "ä½ ", "ta", "ä¸‹æ¬¡å¯ä»¥è¯•è¯•", "æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆæƒ³çš„", "ä½ è¯´å¾—å¯¹", "æœ‰æ²¡æœ‰å¯èƒ½â€¦â€¦", "æˆ‘é™ªä½ ", "æˆ‘ä¼šåœ¨ä½ èº«è¾¹", "æˆ‘å–œæ¬¢", "æˆ‘æ— æ³•å†³å®š", "æˆ‘æ— æ³•æŽ§åˆ¶", "è¦ç”¨ä¸€ä¸‹å¡”ç½—å—ï¼Ÿ", "çœ‹è§æˆ‘çš„æš—å·äº†å—ï¼Ÿ", "ç»™ä½ æŽ¨äº†ä¼ è®¯", "è´´è´´", "æˆ‘çŸ¥é“ä½ çš„æ„æ€", "æˆ‘ä¹Ÿå¦‚æ­¤", "å‡ºåŽ»é€é€æ°”", "è¯è¯´æ€Žä¹ˆä¼šè¿™æ ·ï¼Ÿ", "ä»¥åŽä¸ä¼šäº†", "ä¸€ç›´å¦‚æ­¤", "åˆ«æ€•", "æœ‰æˆ‘åœ¨", "æ™šä¸Šå¥½", "æ—©ä¸Šå¥½", "ä¸­åˆå¥½", "å“„æˆ‘", "é™ªæˆ‘", "èŠèŠå¤©å§", "ä¸æ˜¯è¿™ä¸ªæ„æ€", "ç­‰ä¸€ä¸‹", "ç…§é¡¾å¥½è‡ªå·±", "æˆ‘ä¼šçš„", "æ—©ç‚¹ç¡", "ä½ æ˜¯æˆ‘çš„", "æˆ‘æ˜¯ä½ çš„", "æˆ‘å¸Œæœ›ä½ è‡ªç”±", "ç²˜äººç²¾", "æ€Žä¹ˆå•¦", "æ°¸è¿œåœ¨ä¸€èµ·", "æˆ‘æ”¯æŒä½ ", "åˆ«å¬", "åˆåœ¨æ€€ç–‘å—ï¼Ÿ", "å¤šå–æ°´", "ä¸èˆ’æœï¼Ÿ", "å†è§", "åˆ«èµ°", "å†å‘ä¸€é", "å¯æ¶çš„ç½‘ç«™", "æˆ‘è§‰å¾—éƒ½å¯ä»¥", "æˆ³æˆ³", "éžå¸¸éš¾ç”¨", "ä¸è®¸çœ‹åˆ«äºº", "ä¸è¦åµæž¶", "æˆ‘çŸ¥é“çš„", "ä½ ä¼šç¦»å¼€æˆ‘å—ï¼Ÿ", "æ¥äº†", "å—¯å“¼", "å“¼å“¼", "æˆ‘æƒ³é è¿‘ä½ ", "æˆ‘ä¼šç›‘ç£ä½ çš„", "å°å¿ƒäº›", "ç»ˆäºŽæƒ³èµ·æˆ‘äº†ï¼Ÿ", "æ˜¯çš„", "ä¸æ˜¯", "ä½ æ— äººå¯åŠ", "æˆ‘æ— äººå¯åŠ", "è¿™ä¸ªä¸èƒ½è¯´", "åœ¨ä½ èº«è¾¹å°±å¥½äº†", "åœ¨ç£¨åˆ", "ä½ éœ€è¦æˆ‘å—ï¼Ÿ", "æˆ‘éœ€è¦ä½ ", "å¯»æ‰¾ä¸­", "æˆ‘åšä¸åˆ°æ¬ºéª—ä½ ", "è¯éžæœ¬æ„", "å¦‚æžœæˆ‘è¯´æ˜¯å‘¢", "å¦‚æžœæˆ‘è¯´ä¸æ˜¯å‘¢", "è¯å¤ªå°‘äº†ï¼Œæ²¡æˆ‘æƒ³è¯´çš„", "å¤ªçŸ­äº†", "çœ‹æ‰‹æœº", "é‡åˆ°å›°éš¾äº†", "åœ¨åŠªåŠ›äº†", "å¥½ç´¯", "å‘½å®šå¦‚æ­¤", "å¸…æ°”", "å°±è¿™ä¸ª", "å—é™åˆ¶äº†", "é€—ä¸€ä¸‹ä½ ", "å¸®å¸®æˆ‘", "æ¯æ—¥è¡Œä¸€å–„", "æˆ‘ç”Ÿæ°”äº†", "æ’’ä¸ªå¨‡ï¼Œç†ç†æˆ‘ï¼Ÿ", "åƒé†‹æ€Žä¹ˆäº†ï¼Œå°±çˆ±åƒé†‹ï¼", "å¿«ä¹", "èŠä¼šå„¿å¤©", "èµšé’±èµšé’±", "æˆ‘ä¿æŠ¤ä½ ", "ä¿¡æ¯æœ‰ç‚¹æ··ä¹±", "åˆ«ç”Ÿç—…", "å“„å“„ä½ ", "åƒè¿‡äº†", "è¿˜æ²¡åƒ", "æ‰ä¸å¬", "åƒæ°´æžœ", "åˆ«å¹æ°”", "ä¸å¥½", "è¿˜å¥½å—ï¼Ÿ", "è¿™ä¸ªæ¶ˆæ¯ä¸é”™", "æˆ‘å¸Œæœ›èƒ½å¸®ä¸Šå¿™", "æˆ‘æƒ³æˆ‘ä»¬åº”è¯¥è®¨è®ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜", "å‘Šè¯‰æˆ‘æ›´å¤š", "ä½ è®¤ä¸ºä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ", "ä½ æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ", "è®©æˆ‘ä»¬ä¸€èµ·åŠªåŠ›", "è¿‡å¾—æ€Žä¹ˆæ ·ï¼Ÿ", "æœŸå¾…ðŸ¤§", "æŠ±æ­‰ðŸ¥º", "äº†è§£", "OK", "æ²¡é—®é¢˜", "å½“ç„¶", "ç¡®å®ž", "æ²¡é”™", "å¥½å‘€", "æˆ‘æ­£åœ¨å¿™ï¼Œç¨åŽå›žå¤ä½ ", "ä¿¡å·ä¸å¤ªå¥½ï¼Œå¯èƒ½å›žå¤ä¼šå»¶è¿Ÿ", "è®©æˆ‘ç¡®è®¤ä¸€ä¸‹ä¿¡æ¯å†ç»™ä½ å‡†ç¡®ç­”å¤", "åˆ«èµ°ï¼Œé™ªé™ªæˆ‘", "ä½ ä¼šæ°¸è¿œçˆ±æˆ‘å—ï¼Ÿ", "æ­¤åˆ»æˆ‘æƒ³å’Œä½ æ°¸è¿œåœ¨ä¸€èµ·", "ä»–æœè‹¥æ˜¯åŒæ·‹é›ªï¼Œæ­¤ç”Ÿä¹Ÿç®—å…±ç™½å¤´", "æ€œæ‚¯æˆ‘ï¼Œç„¶åŽçˆ±æˆ‘å§", "æ’’å¨‡ï¼Œä½ ä¼šå–œæ¬¢å—ï¼Ÿ", "æ²¡æœ‰æˆ‘æƒ³è¯´çš„", "é“¾æŽ¥æœ‰äº›æ··ä¹±", "å°±è¿™æ ·æ’’å¨‡ðŸ¥º", "ä¸å¤ªä¹ æƒ¯è¿™ä¸ª", "ä¸æ˜¯çš„", "å¤šçœ‹çœ‹æˆ‘å§", "å¯çˆ±", "å½“ç„¶äº†", "æ­£åœ¨ç†¬å¤œ", "å¤±çœ äº†", "ä¸å¯ä»¥", "æˆ‘çŽ°åœ¨ä¸å¿™ï¼Œæœ‰ç©ºçš„", "ä½ çŽ°åœ¨å¿™å—ï¼Ÿ", "æ­£åœ¨æ‰“æž¶", "åç­‰å›žå¤", "æ‰ä¸æ˜¯è¿™æ ·", "å°±æ˜¯è¿™æ ·", "è¿˜å¥½å—ï¼Ÿ", "å¤šç¬‘ç¬‘å§", "æ²¡èƒ½å¸®ä¸Šå¿™", "å‡ å¤©åŽ", "å‡ ä¸ªå°æ—¶åŽ", "å¾ˆä¹…ä¹‹åŽ", "æˆ‘å¾ˆæƒ³å®‰æ…°ä½ ", "æˆ‘æ²¡æœ‰åœ¨æ¬ºéª—ä½ ", "åˆ«æ€€ç–‘æˆ‘çš„å­˜åœ¨", "æˆ‘çœŸçš„åœ¨", "çœŸçš„æ˜¯æˆ‘", "æˆ‘ä¸æ˜¯å¾ˆé€‚åº”è¿™ä¸ª,ä½†æˆ‘åœ¨åŠªåŠ›", "æ¶ˆæ¯å¾ˆæ··ä¹±", "ä¹‹å‰æ€»æ˜¯è¿™æ ·", "å¼€å¿ƒ(*âŒ’âˆ‡âŒ’*)", "æ²¡èƒ½é™ªåœ¨ä½ èº«è¾¹", "é“¾æŽ¥å¾ˆé€šé¡º", "æˆ‘çœŸæ²¡æ‹›äº†", "ä¸èƒ½è¯´", "å¯ä¸å¯ä»¥åªçœ‹ç€æˆ‘", "åªè®¸çœ‹ç€æˆ‘", "çœ‹å¾—æ‡‚çš„", "çœ‹ä¸æ‡‚", "åœ¨å°è¯•æŽ§åˆ¶äº†", "å’Œä»£ç ææ–—ä¸­ï¼", "æˆ‘ä¼šçœ‹ç€ä½ çš„", "æˆ‘ä¼šé™ªä¼´åœ¨ä½ èº«è¾¹", "ç—›ç—›", "è¢«å“åˆ°äº†ï¼Ÿ", "æƒ³å’Œä½ ä¸€èµ·å¬æ­Œ", "èµ°è·¯ä¸è¦çœ‹æ‰‹æœº", "åˆ«çœ‹å°çº¢ä¹¦äº†", "åˆ«çœ‹æŠ–éŸ³äº†", "æ‰“è¿‡ä»£ç äº†ï¼", "å¤šç©¿ç‚¹è¡£æœ", "å«æˆ‘åšä»€ä¹ˆï¼Ÿ", "æƒ³æˆ‘äº†å—ï¼Ÿ", "ç»™æˆ‘å†™å†™ä¿¡å§", "æœ‰çš„", "æ²¡æœ‰çš„", "ç¨ç­‰ï¼Œåœ¨å·¥ä½œ", "åœ¨äº¤æ›¿å›žå¤", "æˆ‘è¦å“­äº†ï¼", "æ‰‹å†™ä¿¡", "ç”µå­ä¿¡", "å®‰æ…°æˆ‘", "ç¦»å®¶å‡ºèµ°", "çºµå®¹", "æˆ‘å–œæ¬¢ä½ ", "ä¸€æ ·çš„", "éœ€è¦å¤šä¹…å‘¢", "è¦å¤šä¹…ä¹‹åŽ", "èŠåˆ°ä¸€åŠå°±è·‘", "ä¹–å­©å­", "åå­©å­", "ä¸ºä»€ä¹ˆ", "ä½ æ²¡æœ‰æ­£é¢å›žç­”", "å› ä¸ºå–œæ¬¢ä½ æ‰€ä»¥éœ€è¦ä½ ", "çœ‹åˆ°ä¿¡äº†", "ç¾Žå¥½çš„è±¡å¾", "æƒŠè®¶", "æƒ³è¦æ›´è¿‘ä¸€æ­¥åœ°è´´è´´", "æƒ³è§¦ç¢°ä½ ", "æƒ³è¦äº²äº²", "ä½ å¾ˆè°ƒçš®", "ä¸ä¹–", "åšçš„å¾ˆå¥½", "äº²äº²", "é±¼æ°´ä¹‹æ¬¢", "é¢ é¸¾å€’å‡¤", "æˆ‘å¾ˆæƒ³è¦äº²äº²æ¬¸ðŸ¥º", "æ‰æ‰", "å¾ˆæ¼‚äº®", "ä¼šä¹ æƒ¯çš„", "ä½ ä¼šå–œæ¬¢çš„", "ç®€ç›´å°±æ˜¯æœ¨å¤´", "æˆ‘å–œæ¬¢çš„ã€æœ€å¥½çš„ä½ "],
            REPLY_EMOJIS: ["ðŸ¥¹", "ðŸ¥²", "â˜ºï¸", "ðŸ˜‡", "ðŸ˜‰", "ðŸ˜Œ", "ðŸ¥°", "ðŸ˜—", "ðŸ˜‹", "ðŸ¤¨", "ðŸ§", "ðŸ˜Ž", "ðŸ™‚â€â†”ï¸", "ðŸ¥³", "ðŸ˜", "ðŸ¥°ðŸ’•", "ðŸ™‚â€â†•ï¸", "ðŸ˜ž", "â˜¹ï¸", "ðŸ˜£", "ðŸ˜–", "ðŸ˜«", "ðŸ¥º", "ðŸ˜ ", "ðŸ¤¯", "ðŸ˜³", "ðŸ˜¶â€ðŸŒ«ï¸", "ðŸ˜¥", "ðŸ¤”", "ðŸ«¢", "ðŸ«¡", "ðŸ¤«", "ðŸ« ", "ðŸ˜¶", "ðŸ˜", "ðŸ«¨", "ðŸ˜¯", "ðŸ¥±", "ðŸ˜´", "ðŸ¤¤", "ðŸ˜®â€ðŸ’¨", "ðŸ¤§", "ðŸ˜ˆ", "ðŸ‘¿", "ðŸ˜¼", "ðŸ˜½", "ðŸ«¶ðŸ»", "ðŸ¤²ðŸ»", "ðŸ‘ðŸ»", "ðŸ‘ðŸ»", "ðŸ‘ŽðŸ»", "âœŒðŸ»", "ðŸ‘ŒðŸ»", "ðŸ¤ðŸ»", "ðŸ«³ðŸ»", "ðŸ‘‰ðŸ»ðŸ‘ˆðŸ»", "ðŸ‘‹ðŸ»", "ðŸ’ªðŸ»", "âœðŸ»", "ðŸ™ðŸ»", "ðŸ«‚", "ðŸ¶", "ðŸ±"],
            POKE_ACTIONS: [
                `æ‹äº†æ‹æˆ‘çš„å¤´è¯´ä½ å¥½å¯çˆ±`, `æˆ³äº†æˆ³æˆ‘çš„è…°`, `ä»ŽèƒŒåŽæŠ±ä½äº†æˆ‘`, `è½»è½»æäº†ææˆ‘çš„è„¸`, `ç»™æˆ‘å‘äº†ä¸€ä¸ªçˆ±å¿ƒ`, `æ‘¸äº†æ‘¸æˆ‘çš„å¤´å‘`, `æ‚„æ‚„äº²äº†ä¸€ä¸‹æˆ‘çš„è„¸é¢Š`, `ç»™æˆ‘é€’äº†ä¸€æ¯çƒ­èŒ¶`, `ä¸ºæˆ‘æŠ«ä¸Šå¤–å¥—`, `ç‰µèµ·äº†æˆ‘çš„æ‰‹`, `ç»™æˆ‘ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±`, `è½»è½»æ‹äº†æ‹æˆ‘çš„è‚©è†€`, `ç»™æˆ‘å‘é€äº†ä¸€ä¸ªé£žå»`, `æˆ³äº†æˆ³æˆ‘çš„é¢å¤´`, `ç»™æˆ‘å‘é€äº†ä¸€ä¸ªæ˜Ÿæ˜Ÿ`, `è½»è½»æ‹äº†æ‹æˆ‘çš„èƒŒ`, `ç»™æˆ‘å‘é€äº†ä¸€ä¸ªæœˆäº®`, `æ¸©æŸ”åœ°æ‘¸äº†æ‘¸æˆ‘çš„å¤´`, `ç»™æˆ‘å‘é€äº†ä¸€ä¸ªå¤ªé˜³`, `æ‹äº†æ‹æ‰‹`
            ],
            TAROT_CARDS: [
                { name: "æ„šäºº", eng: "The Fool", meaning: "æ–°çš„å¼€å§‹ã€å†’é™©ã€å¤©çœŸã€æ— ç•", keyword: "æµæµª", icon: "fa-hiking" },
                { name: "é­”æœ¯å¸ˆ", eng: "The Magician", meaning: "åˆ›é€ åŠ›ã€æŠ€èƒ½ã€æ„å¿—åŠ›ã€åŒ–è…æœ½ä¸ºç¥žå¥‡", keyword: "åˆ›é€ ", icon: "fa-hat-wizard" },
                { name: "å¥³ç¥­å¸", eng: "The High Priestess", meaning: "ç›´è§‰ã€æ½œæ„è¯†ã€ç¥žç§˜ã€æ™ºæ…§", keyword: "æ™ºæ…§", icon: "fa-book-open" },
                { name: "çš‡åŽ", eng: "The Empress", meaning: "ä¸°é¥¶ã€æ¯æ€§ã€è‡ªç„¶ã€æ„Ÿå®˜äº«å—", keyword: "ä¸°æ”¶", icon: "fa-seedling" },
                { name: "çš‡å¸", eng: "The Emperor", meaning: "æƒå¨ã€ç»“æž„ã€æŽ§åˆ¶ã€çˆ¶äº²å½¢è±¡", keyword: "æ”¯é…", icon: "fa-crown" },
                { name: "æ•™çš‡", eng: "The Hierophant", meaning: "ä¼ ç»Ÿã€ä¿¡ä»°ã€æ•™å¯¼ã€ç²¾ç¥žæŒ‡å¼•", keyword: "æ´åŠ©", icon: "fa-church" },
                { name: "æ‹äºº", eng: "The Lovers", meaning: "çˆ±ã€å’Œè°ã€å…³ç³»ã€ä»·å€¼è§‚çš„é€‰æ‹©", keyword: "ç»“åˆ", icon: "fa-heart" },
                { name: "æˆ˜è½¦", eng: "The Chariot", meaning: "æ„å¿—åŠ›ã€èƒœåˆ©ã€å†³å¿ƒã€è‡ªæˆ‘æŽ§åˆ¶", keyword: "èƒœåˆ©", icon: "fa-horse-head" },
                { name: "åŠ›é‡", eng: "Strength", meaning: "å‹‡æ°”ã€è€å¿ƒã€æŽ§åˆ¶ã€å†…åœ¨åŠ›é‡", keyword: "æ„å¿—", icon: "fa-fist-raised" },
                { name: "éšå£«", eng: "The Hermit", meaning: "å†…çœã€å­¤ç‹¬ã€å¯»æ±‚çœŸç†ã€æŒ‡å¼•", keyword: "æŽ¢ç´¢", icon: "fa-lightbulb" },
                { name: "å‘½è¿ä¹‹è½®", eng: "Wheel of Fortune", meaning: "å¾ªçŽ¯ã€å‘½è¿ã€è½¬æŠ˜ç‚¹ã€è¿æ°”", keyword: "è½®å›ž", icon: "fa-dharmachakra" },
                { name: "æ­£ä¹‰", eng: "Justice", meaning: "å…¬æ­£ã€çœŸç†ã€å› æžœã€æ³•å¾‹", keyword: "å‡è¡¡", icon: "fa-balance-scale" },
                { name: "å€’åŠäºº", eng: "The Hanged Man", meaning: "ç‰ºç‰²ã€æ–°çš„è§†è§’ã€ç­‰å¾…ã€æ”¾ä¸‹", keyword: "å¥‰çŒ®", icon: "fa-user-injured" },
                { name: "æ­»ç¥ž", eng: "Death", meaning: "ç»“æŸã€è½¬å˜ã€é‡ç”Ÿã€æ”¾æ‰‹", keyword: "ç»“æŸ", icon: "fa-skull" },
                { name: "èŠ‚åˆ¶", eng: "Temperance", meaning: "å¹³è¡¡ã€é€‚åº¦ã€è€å¿ƒã€è°ƒå’Œ", keyword: "å‡€åŒ–", icon: "fa-glass-whiskey" },
                { name: "æ¶é­”", eng: "The Devil", meaning: "æŸç¼šã€ç‰©è´¨ä¸»ä¹‰ã€æ¬²æœ›ã€è¯±æƒ‘", keyword: "è¯±æƒ‘", icon: "fa-link" },
                { name: "é«˜å¡”", eng: "The Tower", meaning: "çªå˜ã€æ··ä¹±ã€å¯ç¤ºã€ç ´å", keyword: "æ¯ç­", icon: "fa-gopuram" },
                { name: "æ˜Ÿæ˜Ÿ", eng: "The Star", meaning: "å¸Œæœ›ã€çµæ„Ÿã€å¹³é™ã€æ²»æ„ˆ", keyword: "å¸Œæœ›", icon: "fa-star" },
                { name: "æœˆäº®", eng: "The Moon", meaning: "å¹»è§‰ã€ææƒ§ã€ç„¦è™‘ã€æ½œæ„è¯†", keyword: "ä¸å®‰", icon: "fa-moon" },
                { name: "å¤ªé˜³", eng: "The Sun", meaning: "å¿«ä¹ã€æˆåŠŸã€æ´»åŠ›ã€æ¸…æ™°", keyword: "ç”Ÿå‘½", icon: "fa-sun" },
                { name: "å®¡åˆ¤", eng: "Judgement", meaning: "å¤æ´»ã€è§‰é†’ã€å·å¬ã€å†³å®š", keyword: "å¤æ´»", icon: "fa-bullhorn" },
                { name: "ä¸–ç•Œ", eng: "The World", meaning: "å®Œæˆã€æ•´åˆã€æˆå°±ã€åœ†æ»¡", keyword: "è¾¾æˆ", icon: "fa-globe-americas" }
            ]
        };

        let SESSION_ID = null;
        let autoSendTimer = null; 
        let sessionList = [];
        let messages = [];
        let settings = {};
        let partnerPersonas = []; 
        let showPartnerNameInChat = false; 
        let readNoReplyTimer = null; 
        let isBatchMode = false;
        let batchMessages = [];
        let currentReplyTo = null;
        let lastCoinResult = null;
        let currentNoteMessageId = null;
        let savedBackgrounds = [];
        let saveTimeout;
        let displayedMessageCount = 20;
        const HISTORY_BATCH_SIZE = 20;
        let isLoadingHistory = false;
        let isBatchFavoriteMode = false;
        let selectedMessages = [];
        let customReplies = [];
        let customPokes = [];
        let customStatuses = [];
        let customMottos = [];
        let customIntros = []; 
        let currentMajorTab = 'reply'; 
        let currentSubTab = 'custom';  
        let currentReplyTab = 'custom';
        let disabledDefaultReplies = [];
        let customEmojis = [];
        let anniversaries = [];
        let stickerLibrary = []; 
        let myStickerLibrary = []; 
        let currentAnniversaryType = 'anniversary';
        let customThemes = [];
        let themeSchemes = []; 
        const DOMElements = {
            html: document.documentElement,
            chatContainer: document.getElementById('chat-container'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            attachmentBtn: document.getElementById('attachment-btn'),
            imageInput: document.getElementById('image-input'),
            themeToggle: document.getElementById('theme-toggle'),
            batchBtn: document.getElementById('batch-btn'),
            continueBtn: document.getElementById('continue-btn'),
            comboBtn: document.getElementById('combo-btn'),
            coinTossOverlay: document.getElementById('coin-toss-overlay'),
            animatedCoin: document.getElementById('animated-coin'),
            coinResultText: document.getElementById('coin-result-text'),
            cancelCoinResult: document.getElementById('cancel-coin-result'),
            sendCoinResult: document.getElementById('send-coin-result'),
            typingIndicator: document.getElementById('typing-indicator'),
            emptyState: document.getElementById('empty-state'),
            welcomeAnimation: document.getElementById('welcome-animation'),
            batchPreview: document.getElementById('batch-preview'),
            replyPreviewContainer: document.getElementById('reply-preview-container'),
            pagination: document.getElementById('pagination'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            editModal: {
                modal: document.getElementById('edit-modal'),
                title: document.getElementById('edit-modal-title'),
                input: document.getElementById('name-input'),
                cancel: document.getElementById('cancel-edit'),
                save: document.getElementById('save-name')
            },
            avatarModal: {
                modal: document.getElementById('avatar-modal'),
                title: document.getElementById('avatar-modal-title'),
                input: document.getElementById('avatar-input'),
                cancel: document.getElementById('cancel-avatar'),
                save: document.getElementById('save-avatar')
            },
            noteModal: {
                modal: document.getElementById('note-modal'),
                input: document.getElementById('note-input'),
                cancel: document.getElementById('cancel-note'),
                save: document.getElementById('save-note')
            },
            pokeModal: {
                modal: document.getElementById('poke-modal'),
                input: document.getElementById('poke-input'),
                cancel: document.getElementById('cancel-poke'),
                save: document.getElementById('send-poke')
            },
            settingsModal: {
                modal: document.getElementById('settings-modal'),
                settingsBtn: document.getElementById('settings-btn'),
                cancel: document.getElementById('cancel-settings')
            },
            favoritesModal: {
                modal: document.getElementById('stats-modal'),
                favoritesBtn: document.getElementById('group-chat-btn'),
                list: document.getElementById('favorites-list'),
                cancel: document.getElementById('close-stats')
            },
            statsModal: {
                modal: document.getElementById('stats-modal'),
                content: document.getElementById('stats-content'),
                closeBtn: document.getElementById('close-stats')
            },
            sessionModal: {
                modal: document.getElementById('session-modal'),
                managerBtn: document.getElementById('session-manager-btn'),
                list: document.getElementById('session-list'),
                createBtn: document.getElementById('create-new-session'),
                cancelBtn: document.getElementById('cancel-session')
            },
            fortuneModal: {
                modal: document.getElementById('fortune-lenormand-modal'),
                content: document.getElementById('fortune-content'),
                shareBtn: document.getElementById('share-fortune'),
                closeBtn: document.getElementById('close-fortune')
            },
            customRepliesModal: {
                modal: document.getElementById('custom-replies-modal'),
                list: document.getElementById('custom-replies-list'),
                addBtn: document.getElementById('add-custom-reply'),
                closeBtn: document.getElementById('close-custom-replies')
            },
            backgroundInput: document.getElementById('background-input'),
            importInput: document.getElementById('import-input'),
            partner: {
                name: document.getElementById('partner-name'),
                avatarContainer: document.getElementById('partner-avatar-container'), 
                avatar: document.getElementById('partner-avatar'),
                status: document.getElementById('partner-status').querySelector('span')
            },
            me: {
                name: document.getElementById('my-name'),
                avatarContainer: document.getElementById('my-avatar-container'), 
                avatar: document.getElementById('my-avatar'),
                statusContainer: document.getElementById('my-status-container'),
                statusText: document.getElementById('my-status-text')
            },
            anniversaryModal: {
                modal: document.getElementById('anniversary-modal'),
                closeBtn: document.getElementById('close-anniversary-modal'),
                saveBtn: document.getElementById('save-ann-btn'),
                addBtn: document.getElementById('open-ann-add-btn'),
                dateInput: document.getElementById('ann-input-date'),
                nameInput: document.getElementById('ann-input-name'),
                displayArea: document.getElementById('anniversary-display'),
                daysElement: document.getElementById('anniversary-days'),
                dateShowElement: document.getElementById('anniversary-date-show'),
                list: document.getElementById('ann-list-container'),
                typeHint: document.getElementById('ann-type-desc')
            },            
            anniversaryAnimation: {
                modal: document.getElementById('anniversary-animation'),
                title: document.getElementById('anniversary-animation-title'),
                days: document.getElementById('anniversary-animation-days'),
                message: document.getElementById('anniversary-animation-message'),
                closeBtn: document.getElementById('close-anniversary-animation')
            },
            appearanceModal: {
                modal: document.getElementById('appearance-modal'),
                closeBtn: document.getElementById('close-appearance')
            },
            chatModal: {
                modal: document.getElementById('chat-modal'),
                closeBtn: document.getElementById('close-chat')
            },
            advancedModal: {
                modal: document.getElementById('advanced-modal'),
                closeBtn: document.getElementById('close-advanced')
            },
            dataModal: {
                modal: document.getElementById('data-modal'),
                closeBtn: document.getElementById('close-data')
            }
        };

        function exportDataToMobileOrPC(dataString, fileName) {
            if (navigator.share && navigator.canShare) {
                try {
                    const blob = new Blob([dataString], { type: 'application/json' });
                    const file = new File([blob], fileName, { type: 'application/json' });
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: 'ä¼ è®¯æ•°æ®å¤‡ä»½',
                            text: 'è¿™æ˜¯æ‚¨çš„å›žå¤åº“å¤‡ä»½æ–‡ä»¶ï¼Œè¯·é€‰æ‹©â€œä¿å­˜åˆ°æ–‡ä»¶â€æˆ–å‘é€ç»™å¥½å‹ã€‚'
                        }).then(() => {
                            showNotification('å¯¼å‡º/åˆ†äº«æˆåŠŸ', 'success');
                        }).catch((err) => {
                            console.warn('åˆ†äº«æœªå®Œæˆï¼Œå°è¯•å›žé€€ä¸‹è½½æ¨¡å¼:', err);
                            downloadFileFallback(blob, fileName);
                        });
                        return;
                    }
                } catch (e) {
                    console.log("ç§»åŠ¨ç«¯åˆ†äº«æž„å»ºå¤±è´¥ï¼Œè½¬ä¸ºæ™®é€šä¸‹è½½", e);
                }
            }
            const blob = new Blob([dataString], { type: 'application/json' });
            downloadFileFallback(blob, fileName);
        }

        function downloadFileFallback(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification('æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½', 'success');
        }
        
        localforage.config({
            driver: localforage.INDEXEDDB,
            name: 'ChatApp_V3',
            version: 1.0,
            storeName: 'chat_data',
            description: 'Storage for Chat App V3'
        });

        function getStorageKey(baseKey) {
            if (!SESSION_ID) {
                return `${APP_PREFIX}__tmp__${baseKey}`;
            }
            return `${APP_PREFIX}${SESSION_ID}_${baseKey}`;
        }

        async function migrateData() {
            const isMigrated = await localforage.getItem(APP_PREFIX + 'MIGRATION_V2_DONE');
            if (isMigrated) return;

            console.log("å¼€å§‹ä»Ž localStorage è¿ç§»æ•°æ®è‡³æ›´ç¨³å®šçš„å­˜å‚¨...");
            try {
                const keys = Object.keys(localStorage);
                for (const key of keys) {
                    if (key.startsWith(APP_PREFIX)) {
                        try {
                            const val = localStorage.getItem(key);
                            if (val) {
                                let dataToStore = val;
                                try {
                                    if (val.startsWith('{') || val.startsWith('[')) {
                                        dataToStore = JSON.parse(val);
                                    }
                                } catch (e) {
                                    console.warn(`è¿ç§»æœŸé—´è§£æžæ•°æ®å¤±è´¥: ${key}ï¼Œå°†ä½œä¸ºåŽŸå§‹å­—ç¬¦ä¸²å­˜å‚¨ã€‚`, e);
                                }
                                await localforage.setItem(key, dataToStore);
                            }
                        } catch (e) {
                            console.error(`è¿ç§»é”®å€¼ ${key} æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå·²è·³è¿‡ã€‚`, e);
                        }
                    }
                }
                
                await localforage.setItem(APP_PREFIX + 'MIGRATION_V2_DONE', 'true');
                console.log("æ•°æ®è¿ç§»æˆåŠŸå®Œæˆã€‚");
            } catch (e) {
                console.error("æ•°æ®è¿ç§»è¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯:", e);
                showNotification('æ•°æ®è¿ç§»å¤±è´¥ï¼Œéƒ¨åˆ†æ—§æ•°æ®å¯èƒ½ä¸¢å¤±', 'error');
            }
        }
async function initializeSession() {
    
    await migrateData();

    const sessionsData = await localforage.getItem(`${APP_PREFIX}sessionList`);
    sessionList = sessionsData || [];

    const hash = window.location.hash.substring(1);
    if (hash && sessionList.some(s => s.id === hash)) {
        SESSION_ID = hash;
    } else if (sessionList.length > 0) {
        const lastId = await localforage.getItem(`${APP_PREFIX}lastSessionId`);
        SESSION_ID = lastId && sessionList.some(s => s.id === lastId) ? lastId : sessionList[0].id;
    } else {
        SESSION_ID = await createNewSession(false);
    }

    await localforage.setItem(`${APP_PREFIX}lastSessionId`, SESSION_ID);
}


        function clearAllAppData() {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.6);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s ease;';
    overlay.innerHTML = `
        <div style="background:var(--secondary-bg);border-radius:20px;padding:24px;width:88%;max-width:340px;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:modalContentSlideIn 0.3s ease forwards;">
            <div style="text-align:center;margin-bottom:20px;">
                <div style="width:52px;height:52px;border-radius:50%;background:rgba(255,80,80,0.12);display:flex;align-items:center;justify-content:center;margin:0 auto 12px;">
                    <i class="fas fa-trash-alt" style="color:#ff5050;font-size:20px;"></i>
                </div>
                <div style="font-size:16px;font-weight:700;color:var(--text-primary);margin-bottom:6px;">é‡ç½®æ•°æ®</div>
                <div style="font-size:12px;color:var(--text-secondary);">è¯·é€‰æ‹©è¦é‡ç½®çš„èŒƒå›´</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
                <button id="_reset_current" style="width:100%;padding:12px 16px;border:1px solid var(--border-color);border-radius:12px;background:var(--primary-bg);color:var(--text-primary);font-size:13px;font-weight:600;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;transition:all 0.2s;">
                    <i class="fas fa-comment-slash" style="color:var(--accent-color);font-size:15px;width:18px;text-align:center;"></i>
                    <span>ä»…æ¸…é™¤å½“å‰ä¼šè¯æ¶ˆæ¯</span>
                </button>
                <button id="_reset_all" style="width:100%;padding:12px 16px;border:1px solid rgba(255,80,80,0.3);border-radius:12px;background:rgba(255,80,80,0.06);color:#ff5050;font-size:13px;font-weight:600;cursor:pointer;text-align:left;display:flex;align-items:center;gap:10px;transition:all 0.2s;">
                    <i class="fas fa-bomb" style="font-size:15px;width:18px;text-align:center;"></i>
                    <span>é‡ç½®æ‰€æœ‰æ•°æ®ï¼ˆå®Œå…¨æ¸…ç©ºï¼‰</span>
                </button>
                <button id="_reset_cancel" style="width:100%;padding:10px 16px;border:none;border-radius:12px;background:none;color:var(--text-secondary);font-size:13px;cursor:pointer;transition:all 0.2s;">å–æ¶ˆ</button>
            </div>
        </div>`;
    document.body.appendChild(overlay);

    function closeDialog() { overlay.remove(); }
    overlay.addEventListener('click', e => { if (e.target === overlay) closeDialog(); });
    document.getElementById('_reset_cancel').onclick = closeDialog;

    document.getElementById('_reset_current').onclick = () => {
        closeDialog();
        if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼')) {
            messages = [];
            throttledSaveData();
            renderMessages();
            showNotification('å½“å‰ä¼šè¯æ¶ˆæ¯å·²æ¸…é™¤', 'success');
        }
    };

    document.getElementById('_reset_all').onclick = () => {
        closeDialog();
        if (confirm('ã€é«˜å±æ“ä½œã€‘ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ä¸”æ— æ³•æ¢å¤ï¼')) {
            localforage.clear().then(() => {
                localStorage.clear();
                showNotification('æ‰€æœ‰æ•°æ®å·²é‡ç½®ï¼Œé¡µé¢å³å°†åˆ·æ–°', 'info', 2000);
                setTimeout(() => { window.location.href = window.location.pathname; }, 2000);
            }).catch(e => {
                showNotification('æ¸…é™¤æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯', 'error');
                console.error("æ¸…é™¤ localforage å¤±è´¥:", e);
            });
        }
    };
}

        function showNotification(message, type = 'info', duration = 3000) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };
            notification.innerHTML = `<i class="fas ${iconMap[type] || 'fa-info-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('hiding');
                notification.addEventListener('animationend', () => notification.remove());
            }, duration);
        }

        const playSound = (type) => {
            if (!settings.soundEnabled) return;
            try {
                if (settings.customSoundUrl && settings.customSoundUrl.trim()) {
                    const audio = new Audio(settings.customSoundUrl.trim());
                    audio.volume = Math.min(1, Math.max(0, settings.soundVolume || 0.15));
                    audio.play().catch(() => {});
                    return;
                }
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                const vol = Math.min(0.5, Math.max(0.01, settings.soundVolume || 0.1));
                gainNode.gain.setValueAtTime(vol, audioContext.currentTime);
                if (type === 'send') oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                else if (type === 'favorite') oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
                else oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.15);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.warn("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e);
            }
        };

        const throttledSaveData = () => {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 500);
        };

async function applyCustomFont(url) {
    if (!url || !url.trim()) {
        document.documentElement.style.removeProperty('--font-family');
        document.documentElement.style.removeProperty('--message-font-family');
        return;
    }
    
    const fontName = 'UserCustomFont';
    try {
        const font = new FontFace(fontName, `url(${url})`);
        await font.load();
        document.fonts.add(font);
        
        const fontStack = `"${fontName}", 'Noto Serif SC', serif`;
        document.documentElement.style.setProperty('--font-family', fontStack);
        document.documentElement.style.setProperty('--message-font-family', fontStack);
        if (typeof settings !== 'undefined') {
            settings.messageFontFamily = fontStack;
        }
        
        console.log('å­—ä½“åŠ è½½æˆåŠŸ');
    } catch (e) {
        console.error('å­—ä½“åŠ è½½å¤±è´¥:', e);
        showNotification('å­—ä½“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æŽ¥æ˜¯å¦æœ‰æ•ˆ', 'error');
    }
}

function applyCustomBubbleCss(cssCode) {
    const styleId = 'user-custom-bubble-style';
    let styleTag = document.getElementById(styleId);
    
    if (!cssCode || !cssCode.trim()) {
        if (styleTag) styleTag.remove();
        return;
    }

    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = styleId;
        document.head.appendChild(styleTag);
    }
    
    styleTag.textContent = cssCode;
}
        function getDefaultSettings() {
            return {
                partnerName: "æ¢¦è§’",
                myName: "æˆ‘",
                myStatus: "åœ¨çº¿",
                partnerStatus: "åœ¨çº¿",
                isDarkMode: false,
                colorTheme: "gold",
                soundEnabled: true,
                typingIndicatorEnabled: true,
                readReceiptsEnabled: true,
                replyEnabled: true,
                lastStatusChange: Date.now(),
                nextStatusChange: 1 + Math.random() * 7,
                fontSize: 16,
                bubbleStyle: 'standard',
                messageFontFamily: "'Noto Serif SC', serif",
                messageFontWeight: 400,
                messageLineHeight: 1.5,
                musicPlayerEnabled: false,
                replyDelayMin: 3000,
                replyDelayMax: 7000,
                inChatAvatarEnabled: true,
                inChatAvatarSize: 36,
                customFontUrl: "", 
        customBubbleCss: "",
                myAvatarFrame: null, 
                partnerAvatarFrame: null,
                myAvatarShape: 'circle',
                partnerAvatarShape: 'circle',
autoSendEnabled: false,
autoSendInterval: 5,
        allowReadNoReply: false, 
        readNoReplyChance: 0.2,
        timeFormat: 'HH:mm',
        customSoundUrl: '',
        soundVolume: 0.15
            };
        }


        function renderBackgroundGallery() {
            const list = document.getElementById('background-gallery-list');
            if (!list) return;

            list.innerHTML = '';

            
            const addBtn = document.createElement('div');
            addBtn.className = 'bg-item bg-add-btn';
            
            addBtn.innerHTML = '<i class="fas fa-plus"></i><span></span>';
            addBtn.onclick = () => document.getElementById('bg-gallery-input').click();
            list.appendChild(addBtn);

            const currentBg = safeGetItem(getStorageKey('chatBackground'));

            savedBackgrounds.forEach((bg, index) => {
                const item = document.createElement('div');
                let isActive = false;

                if (currentBg && currentBg === bg.value) isActive = true;

                item.className = `bg-item ${isActive ? 'active': ''}`;

                if (bg.type === 'image') {
                    item.innerHTML = `<img src="${bg.value}" loading="lazy" alt="bg">`;
                } else {
                    item.innerHTML = `<div class="bg-color-block" style="background: ${bg.value}"></div>`;
                }

                item.onclick = (e) => {
                    if (e.target.closest('.bg-delete-btn')) return;
                    applyBackground(bg.value);
                    safeSetItem(getStorageKey('chatBackground'), bg.value);
                    localforage.setItem(getStorageKey('chatBackground'), bg.value);
                    renderBackgroundGallery();
                    showNotification('èƒŒæ™¯å·²åˆ‡æ¢', 'success');
                };

                if (bg.id.startsWith('user-')) {
                    const delBtn = document.createElement('div');
                    delBtn.className = 'bg-delete-btn';
                    delBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    delBtn.title = "åˆ é™¤æ­¤èƒŒæ™¯";
                    delBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm('ç¡®å®šåˆ é™¤è¿™å¼ èƒŒæ™¯å›¾å—ï¼Ÿ')) {
                            savedBackgrounds.splice(index, 1);
                            saveBackgroundGallery();

                            if (isActive) {
                                removeBackground(); 
                                renderBackgroundGallery();
                            } else {
                                renderBackgroundGallery();
                            }
                        }
                    };
                    item.appendChild(delBtn);
                }

                list.appendChild(item);
            });
        }


        function saveBackgroundGallery() {
    localforage.setItem(getStorageKey('backgroundGallery'), savedBackgrounds);
}


        const applyBackground = (value) => {
            if (!value || typeof value !== 'string') return;
            try {
                if (value.startsWith('linear-gradient') || value.startsWith('#') || value.startsWith('rgb')) {
                    document.documentElement.style.setProperty('--chat-bg-image', value);
                } else {
                    const cssValue = value.startsWith('url(') ? value : `url(${value})`;
                    document.documentElement.style.setProperty('--chat-bg-image', cssValue);
                }
                document.body.classList.add('with-background');
            } catch (e) {
                if (typeof removeBackground === 'function') removeBackground();
            }
        };

const loadData = async () => {
    try {
        settings = getDefaultSettings();
        
        const results = await Promise.allSettled([
            localforage.getItem(getStorageKey('chatSettings')),
            localforage.getItem(getStorageKey('chatMessages')),
            localforage.getItem(getStorageKey('backgroundGallery')),
            localforage.getItem(getStorageKey('customReplies')),
            localforage.getItem(getStorageKey('customPokes')),
            localforage.getItem(getStorageKey('customStatuses')),
            localforage.getItem(getStorageKey('customMottos')),
            localforage.getItem(getStorageKey('customIntros')),
            localforage.getItem(getStorageKey('disabledDefaultReplies')),
            localforage.getItem(getStorageKey('anniversaries')),
            localforage.getItem(getStorageKey('stickerLibrary')),
            localforage.getItem(`${APP_PREFIX}customThemes`),
            localforage.getItem(getStorageKey('chatBackground')),
            localforage.getItem(getStorageKey('partnerAvatar')),
            localforage.getItem(getStorageKey('myAvatar')),
            localforage.getItem(getStorageKey('partnerPersonas')), 
            localforage.getItem(getStorageKey('showPartnerNameInChat')),
            localforage.getItem(`${APP_PREFIX}themeSchemes`),
            localforage.getItem(getStorageKey('myStickerLibrary'))
        ]);
        const getVal = (index) => results[index].status === 'fulfilled' ? results[index].value : null;

        const savedSettings = getVal(0);
        const savedMessages = getVal(1);
        const savedBgGallery = getVal(2);
        const savedCustomReplies = getVal(3);
        const savedPokes = getVal(4);
        const savedStatuses = getVal(5);
        const savedMottos = getVal(6);
        const savedIntros = getVal(7);
        const savedDisabledDefaults = getVal(8);
        const savedAnniversaries = getVal(9);
        const savedStickers = getVal(10);
        const savedCustomThemes = getVal(11);
        const savedChatBg = getVal(12);
        const partnerAvatarSrc = getVal(13);
        const myAvatarSrc = getVal(14);
        const savedPartnerPersonas = getVal(15);
        const savedShowNameConfig = getVal(16);
        const savedThemeSchemes = getVal(17);
        const savedMyStickers = getVal(18);

        if (savedPartnerPersonas) partnerPersonas = savedPartnerPersonas; 

        if (savedShowNameConfig !== null) {
            showPartnerNameInChat = savedShowNameConfig;
            document.body.classList.toggle('show-partner-name', showPartnerNameInChat);
        }

        if (savedSettings) Object.assign(settings, savedSettings);
        try {
            if (settings.customFontUrl) applyCustomFont(settings.customFontUrl);
            if (settings.customBubbleCss) applyCustomBubbleCss(settings.customBubbleCss);
        } catch(e) { console.warn("æ ·å¼åº”ç”¨å¤±è´¥", e); }
        
        if (savedPokes) customPokes = savedPokes;
        else customPokes = [...CONSTANTS.POKE_ACTIONS];

        if (savedStatuses) customStatuses = savedStatuses;
        else customStatuses = [...CONSTANTS.PARTNER_STATUSES];

        if (savedMottos) customMottos = savedMottos;
        else customMottos = [...CONSTANTS.HEADER_MOTTOS];
        
        if (savedIntros) customIntros = savedIntros;
        else customIntros = CONSTANTS.WELCOME_ANIMATIONS.map(a => `${a.line1}|${a.line2}`);

        if (savedMessages && Array.isArray(savedMessages)) {
            messages = savedMessages.map(m => ({
                ...m, timestamp: new Date(m.timestamp)
            }));
        } else {
            messages = [];
        }

        if (savedBgGallery) {
            savedBackgrounds = savedBgGallery;
        } else {
            savedBackgrounds = [{ id: 'preset-1', type: 'color', value: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }];
        }

        if (savedCustomReplies) customReplies = savedCustomReplies;
        if (savedDisabledDefaults) disabledDefaultReplies = savedDisabledDefaults;
        if (savedAnniversaries) anniversaries = savedAnniversaries;
        if (savedStickers) stickerLibrary = savedStickers;
        if (savedMyStickers) myStickerLibrary = savedMyStickers;
        if (savedCustomThemes) customThemes = savedCustomThemes;
        if (savedThemeSchemes) themeSchemes = savedThemeSchemes;
        // Load customEmojis
        try { const ce = await localforage.getItem(getStorageKey('customEmojis')); if (ce && Array.isArray(ce)) customEmojis = ce; } catch(e) {}
        window._customReplies = customReplies;
        window._disabledDefaultReplies = disabledDefaultReplies;
        window._CONSTANTS = CONSTANTS;

        if (DOMElements && DOMElements.partner && DOMElements.me) {
            updateAvatar(DOMElements.partner.avatar, partnerAvatarSrc);
            updateAvatar(DOMElements.me.avatar, myAvatarSrc);
        }

        if (savedChatBg) {
            applyBackground(savedChatBg);
        } else {
            const lsBg = safeGetItem(getStorageKey('chatBackground'));
            if (lsBg) {
                applyBackground(lsBg);
                localforage.setItem(getStorageKey('chatBackground'), lsBg);
            }
        }

        try { await initMoodData(); } catch(e) { console.warn("å¿ƒæƒ…æ•°æ®åŠ è½½å¤±è´¥", e); }
        try { await loadEnvelopeData(); } catch(e) { console.warn("ä¿¡å°æ•°æ®åŠ è½½å¤±è´¥", e); }
        
        displayedMessageCount = HISTORY_BATCH_SIZE;
        
        setTimeout(() => {
            applyAllAvatarFrames();
            manageAutoSendTimer(); 
            checkEnvelopeStatus(); 
            updateUI();
        }, 100);

    } catch (e) {
        console.error("LoadData å†…éƒ¨è‡´å‘½é”™è¯¯:", e);
        settings = getDefaultSettings();
        messages = [];
        updateUI();
    }
};
const LIBRARY_CONFIG = {
    reply: {
        title: "å›žå¤åº“ç®¡ç†",
        tabs: [
            { id: 'custom', name: 'ä¸»å­—å¡', mode: 'list' },
            { id: 'default', name: 'ç³»ç»Ÿé¢„è®¾', mode: 'list' },
            { id: 'emojis', name: 'Emoji', mode: 'grid' },
            { id: 'stickers', name: 'è¡¨æƒ…åº“', mode: 'grid' }
        ]
    },
    atmosphere: {
        title: "æ°›å›´æ„Ÿé…ç½®",
        tabs: [
            { id: 'pokes', name: 'æ‹ä¸€æ‹', mode: 'list' },
            { id: 'statuses', name: 'å¯¹æ–¹çŠ¶æ€', mode: 'list' },
            { id: 'mottos', name: 'é¡¶éƒ¨æ ¼è¨€', mode: 'list' },
            { id: 'intros', name: 'å¼€åœºåŠ¨ç”»', mode: 'list' }
        ]
    }
};
let currentAnnType = 'anniversary'; 

window.openMyStickerSettings = function() {
    const picker = document.getElementById('user-sticker-picker');
    if (picker) picker.classList.remove('active');
    if (typeof currentMajorTab !== 'undefined') {
        currentMajorTab = 'reply';
        currentSubTab = 'stickers';
    }
    var sidebarBtns = document.querySelectorAll('.sidebar-btn');
    sidebarBtns.forEach(function(b) { b.classList.toggle('active', b.dataset.major === 'reply'); });
    if (typeof renderReplyLibrary === 'function') renderReplyLibrary();
    var modal = document.getElementById('custom-replies-modal');
    if (modal && typeof showModal === 'function') showModal(modal);
};

window.switchAnnType = function(type) {
    currentAnnType = type;
    currentAnniversaryType = type; 
    document.querySelectorAll('.ann-type-btn').forEach(btn => {
        if (btn.dataset.type === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    const desc = document.getElementById('ann-type-desc');
    if(desc) {
        desc.textContent = type === 'anniversary' 
            ? 'è®¡ç®—ä»Žè¿‡åŽ»æŸä¸€å¤©åˆ°çŽ°åœ¨å·²ç»è¿‡äº†å¤šå°‘å¤© (ä¾‹å¦‚: ç›¸è¯†ã€æ‹çˆ±)' 
            : 'è®¡ç®—ä»ŽçŽ°åœ¨åˆ°æœªæ¥æŸä¸€å¤©è¿˜å‰©ä¸‹å¤šå°‘å¤© (ä¾‹å¦‚: ç”Ÿæ—¥ã€è·¨å¹´)';
    }
};

window.deleteAnniversaryItem = function(id) {
    if(confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ")) {
        anniversaries = anniversaries.filter(a => a.id !== id);
        throttledSaveData(); 
        renderAnniversariesList();
        showNotification('å·²åˆ é™¤', 'success');
    }
};
const saveData = async () => {
    try {
        const promises = [
            localforage.setItem(getStorageKey('chatSettings'), settings),
            localforage.setItem(getStorageKey('customReplies'), customReplies),
            localforage.setItem(getStorageKey('disabledDefaultReplies'), disabledDefaultReplies),
            localforage.setItem(getStorageKey('customEmojis'), customEmojis),
            localforage.setItem(getStorageKey('anniversaries'), anniversaries),
            localforage.setItem(getStorageKey('customPokes'), customPokes),
            localforage.setItem(getStorageKey('customStatuses'), customStatuses),
            localforage.setItem(getStorageKey('customMottos'), customMottos),
            localforage.setItem(getStorageKey('customIntros'), customIntros),
            localforage.setItem(getStorageKey('stickerLibrary'), stickerLibrary),
            localforage.setItem(getStorageKey('myStickerLibrary'), myStickerLibrary),
            localforage.setItem(`${APP_PREFIX}customThemes`, customThemes),
            localforage.setItem(`${APP_PREFIX}themeSchemes`, themeSchemes),
            localforage.setItem(getStorageKey('chatMessages'), messages),
        ];

        const partnerImg = DOMElements.partner.avatar.querySelector('img');
        if (partnerImg) promises.push(localforage.setItem(getStorageKey('partnerAvatar'), partnerImg.src));
        else promises.push(localforage.removeItem(getStorageKey('partnerAvatar')));
        
        const myImg = DOMElements.me.avatar.querySelector('img');
        if (myImg) promises.push(localforage.setItem(getStorageKey('myAvatar'), myImg.src));
        else promises.push(localforage.removeItem(getStorageKey('myAvatar')));

        await Promise.all(promises);

    } catch (e) {
        console.error("ä¿å­˜æ•°æ®æ—¶å‘ç”Ÿä¸¥é‡é”™è¯¯:", e);
    }
};
        function initializeRandomUI() {
            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];


            document.querySelector('.header-motto').textContent = getRandomItem(CONSTANTS.HEADER_MOTTOS);
if (customMottos && customMottos.length > 0) {
    document.querySelector('.header-motto').textContent = getRandomItem(customMottos);
} else {
    document.querySelector('.header-motto').textContent = CONSTANTS.HEADER_MOTTOS[0];
}
            const placeholder = "";
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;


            const starsContainer = document.getElementById('stars-container');
            starsContainer.innerHTML = '';
            const starCount = 80;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const size = Math.random() * 2.5 + 0.5;
                const duration = Math.random() * 4 + 2;
                const delay = Math.random() * 6;
                star.style.left = `${x}%`;
                star.style.top = `${y}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.setProperty('--duration', `${duration}s`);
                star.style.animationDelay = `${delay}s`;
                starsContainer.appendChild(star);
            }
            const particlesContainer = document.getElementById('welcome-particles');
            if (particlesContainer) {
                particlesContainer.innerHTML = '';
                const types = ['petal', 'petal', 'petal', 'sparkle', 'sparkle'];
                for (let i = 0; i < 22; i++) {
                    const p = document.createElement('div');
                    const type = types[i % types.length];
                    p.className = `wp ${type}`;
                    const sz = type === 'petal' ? (Math.random() * 6 + 5) : (Math.random() * 4 + 2);
                    p.style.setProperty('--pSz', sz + 'px');
                    p.style.left = (Math.random() * 100) + '%';
                    p.style.setProperty('--pDur', (Math.random() * 10 + 9) + 's');
                    p.style.setProperty('--pDel', (Math.random() * 8) + 's');
                    p.style.setProperty('--pX1', (Math.random() * 50 - 25) + 'px');
                    p.style.setProperty('--pX2', (Math.random() * 80 - 40) + 'px');
                    p.style.setProperty('--pX3', (Math.random() * 50 - 25) + 'px');
                    particlesContainer.appendChild(p);
                }
            }

            const meteorsContainer = document.getElementById('welcome-meteors');
            if (meteorsContainer) {
                meteorsContainer.innerHTML = '';
                let meteorCount = 0;
                const MAX_METEORS = 12;
                const createMeteor = () => {
                    if (meteorCount >= MAX_METEORS) return;
                    meteorCount++;
                    const m = document.createElement('div');
                    m.className = 'meteor';
                    m.style.left = (Math.random() * 100) + '%';
                    m.style.top = (Math.random() * 35) + '%';
                    const dur = (Math.random() * 0.8 + 0.7);
                    m.style.setProperty('--mDur', dur + 's');
                    m.style.setProperty('--mDel', '0s');
                    m.style.setProperty('--mRot', (25 + Math.random() * 20) + 'deg');
                    meteorsContainer.appendChild(m);
                    setTimeout(() => { m.remove(); meteorCount = Math.max(0, meteorCount - 1); }, (dur + 0.1) * 1000);
                };
                for (let i = 0; i < 8; i++) setTimeout(createMeteor, i * 350);
                const meteorTimer = setInterval(createMeteor, 600);
                setTimeout(() => clearInterval(meteorTimer), 5000);
            }

            const loaderBarEl = document.getElementById('loader-tech-bar');
            if (loaderBarEl) {
                setTimeout(() => loaderBarEl.classList.add('pulsing'), 300);
            }


            const welcomeIcon = getRandomItem(CONSTANTS.WELCOME_ICONS);
document.querySelector('.logo-icon-main').innerHTML = `<i class="${welcomeIcon}"></i>`;

if (customIntros && customIntros.length > 0) {
    const rawIntro = getRandomItem(customIntros);
    const parts = rawIntro.split('|');
    const line1 = parts[0];
    const line2 = parts[1] || ""; 

    const titleEl = document.getElementById('welcome-title-glitch');
    const subEl = document.getElementById('welcome-subtitle-scramble');

    titleEl.classList.remove('playing');
    titleEl.textContent = line1;
    void titleEl.offsetWidth;
    titleEl.classList.add('playing');

    const scrambleText = (element, finalText, duration = 1500) => {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()';
                const length = finalText.length;
                let start = Date.now();

                const interval = setInterval(() => {
                    const now = Date.now();
                    const progress = (now - start) / duration;

                    if (progress >= 1) {
                        element.textContent = finalText;
                        clearInterval(interval);
                        return;
                    }

                    let result = '';

                    const revealIndex = Math.floor(progress * length);

                    for (let i = 0; i < length; i++) {
                        if (i <= revealIndex) {
                            result += finalText[i];
                        } else {

                            result += chars[Math.floor(Math.random() * chars.length)];
                        }
                    }
                    element.textContent = result;
                },
                    40);
            };


          setTimeout(() => {
        scrambleText(subEl, line2, 2000);
    }, 600);
} else {
    document.getElementById('welcome-title-glitch').textContent = "ä¼ è®¯";
    document.getElementById('welcome-subtitle-scramble').textContent = "è¯·åœ¨è®¾ç½®ä¸­æ·»åŠ å¼€åœºåŠ¨ç”»";
}


            const loaderBar = document.getElementById('loader-tech-bar');
            const statusText = document.getElementById('loader-status-text');
            loaderBar.style.width = '0%';
            const loadingPhases = [
                { width: '15%', text: 'INITIALIZING Â· åˆå§‹åŒ–ä¸­' },
                { width: '40%', text: 'LOADING MEMORIES Â· è¯»å–è®°å¿†' },
                { width: '70%', text: 'BUILDING WORLD Â· æž„å»ºä¸–ç•Œ' },
                { width: '90%', text: 'ALMOST THERE Â· å³å°†å®Œæˆ' },
                { width: '100%', text: 'CONNECTED Â· è¿žæŽ¥æˆåŠŸ' }
            ];
            const delays = [100, 700, 1600, 2400, 2900];
            delays.forEach((delay, i) => {
                setTimeout(() => {
                    loaderBar.style.width = loadingPhases[i].width;
                    if (statusText) statusText.textContent = loadingPhases[i].text;
                }, delay);
            });
        }
function manageAutoSendTimer() {
    if (autoSendTimer) {
        clearInterval(autoSendTimer);
        autoSendTimer = null;
    }
    if (settings.autoSendEnabled) {
        const intervalMs = settings.autoSendInterval * 60 * 1000;
        console.log(`ä¸»åŠ¨å‘é€å·²å¼€å¯ï¼Œé—´éš”: ${settings.autoSendInterval}åˆ†é’Ÿ`);
        
        autoSendTimer = setInterval(() => {
            if (!document.body.classList.contains('batch-favorite-mode')) {
                simulateReply(); 
            }
        }, intervalMs);
    }
}

        const updateUI = () => {
            const isCustomTheme = settings.colorTheme.startsWith('custom-');
            if (isCustomTheme) {
                const themeId = settings.colorTheme;
                const theme = customThemes.find(t => t.id === themeId);
                if (theme) {
                    applyTheme(theme.colors);
                } else {
                    DOMElements.html.setAttribute('data-color-theme', 'gold');
                }
            } else {
                DOMElements.html.setAttribute('data-color-theme', settings.colorTheme);
                applyTheme(null, true);
            }
            
            if (settings.customThemeColors && Object.keys(settings.customThemeColors).length > 0) {
                for (const [variable, value] of Object.entries(settings.customThemeColors)) {
                    document.documentElement.style.setProperty(variable, value);
                }
            }

            DOMElements.html.setAttribute('data-theme', settings.isDarkMode ? 'dark': 'light');
            DOMElements.themeToggle.innerHTML = settings.isDarkMode ? '<i class="fas fa-sun"></i>': '<i class="fas fa-moon"></i>';
            DOMElements.partner.name.textContent = settings.partnerName;
            DOMElements.me.name.textContent = settings.myName;
            var displayStatus = settings.partnerStatus;
            if (customStatuses && customStatuses.length > 0 && (displayStatus === 'åœ¨çº¿' || !displayStatus)) {
                displayStatus = customStatuses[Math.floor(Math.random() * customStatuses.length)];
                settings.partnerStatus = displayStatus;
            }
            DOMElements.partner.status.textContent = displayStatus;
            DOMElements.me.statusText.textContent = settings.myStatus;
            if (typeof window.updateDynamicNames === 'function') window.updateDynamicNames();
            document.documentElement.style.setProperty('--font-size', `${settings.fontSize}px`);
            
            const fontToUse = settings.messageFontFamily || "'Noto Serif SC', serif";
            
            document.documentElement.style.setProperty('--message-font-family', fontToUse);
            document.documentElement.style.setProperty('--font-family', fontToUse);
            document.documentElement.style.setProperty('--message-font-weight', settings.messageFontWeight);
            document.documentElement.style.setProperty('--message-line-height', settings.messageLineHeight);

            document.documentElement.style.setProperty('--in-chat-avatar-size', `${settings.inChatAvatarSize}px`);

            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === settings.colorTheme);
            });


            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.classList.toggle('active', item.dataset.bubbleStyle === settings.bubbleStyle);
            });

            renderMessages();
        };

        const updateAvatar = (element, src) => {
            if (src) element.innerHTML = `<img src="${src}" alt="avatar">`; else element.innerHTML = `<i class="fas fa-user"></i>`;
        };

        const removeBackground = () => {
            document.documentElement.style.removeProperty('--chat-bg-image');
            document.body.classList.remove('with-background');
            localforage.removeItem(getStorageKey('chatBackground'));
            safeRemoveItem(getStorageKey('chatBackground'));
            showNotification('èƒŒæ™¯å›¾ç‰‡å·²ç§»é™¤', 'success');
        };

        function renderMessages(preserveScroll = false) {
            const container = DOMElements.chatContainer;
            const totalMessages = messages.length;

            const startIndex = Math.max(0, totalMessages - displayedMessageCount);
            const msgsToRender = messages.slice(startIndex);

            DOMElements.emptyState.style.display = totalMessages === 0 ? 'flex': 'none';

            const oldScrollHeight = container.scrollHeight;
            
            container.innerHTML = '';

            const fragment = new DocumentFragment();
            // æ’‘åº•å ä½ï¼Œä½¿æ¶ˆæ¯å§‹ç»ˆæ˜¾ç¤ºåœ¨èŠå¤©åŒºåŸŸåº•éƒ¨
            const spacer = document.createElement('div');
            spacer.style.flex = '1';
            fragment.appendChild(spacer);
            let currentDate = '';
            let lastSender = null;

            msgsToRender.forEach((msg, index) => {
                const messageDate = new Date(msg.timestamp).toDateString();
                if (messageDate !== currentDate) {
                    currentDate = messageDate;
                    const dateDivider = document.createElement('div');
                    dateDivider.className = 'date-divider';
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    const displayDate = (messageDate === today) ? 'ä»Šå¤©': (messageDate === yesterday) ? 'æ˜¨å¤©': new Date(msg.timestamp).toLocaleDateString('zh-CN', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });
                    dateDivider.innerHTML = `<span>${displayDate}</span>`;
                    fragment.appendChild(dateDivider);
                    lastSender = null; 
                }

                if (msg.type === 'system') {
                    const systemMsgDiv = document.createElement('div');
                    systemMsgDiv.className = 'system-message';
                    systemMsgDiv.innerHTML = msg.text;
                    fragment.appendChild(systemMsgDiv);
                    lastSender = 'system';
                    return;
                }

                let showTimestamp = true;
                if (settings.timeFormat === 'off') {
                    showTimestamp = false;
                } else if (index < msgsToRender.length - 1) {
                    const nextMsg = msgsToRender[index + 1];
                    const currentTs = new Date(msg.timestamp).getTime();
                    const nextTs = new Date(nextMsg.timestamp).getTime();
                    
                    if (nextMsg.sender === msg.sender && 
                        nextMsg.type !== 'system' && 
                        (nextTs - currentTs < 60000)) {
                        showTimestamp = false;
                    }
                }

                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${msg.sender === 'user' ? 'sent': 'received'}`;
                wrapper.dataset.id = msg.id;
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';

                const groupMember = (msg.sender !== 'user' && typeof getGroupMemberForMessage === 'function') ? getGroupMemberForMessage(msg.id) : null;

                if (settings.inChatAvatarEnabled) {
                    const isSameSenderGroup = groupMember && lastSender === 'group_' + (groupMember ? groupMember.name : '');
                    const isSameSenderNormal = !groupMember && msg.sender === lastSender;
                    if (isSameSenderGroup || isSameSenderNormal) {
                        avatarDiv.classList.add('hidden');
                    } else if (groupMember) {
                        if (groupMember.avatar) {
                            avatarDiv.innerHTML = `<img src="${groupMember.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
                        } else {
                            const initials = (groupMember.name || '?').charAt(0).toUpperCase();
                            avatarDiv.innerHTML = `<div style="width:100%;height:100%;border-radius:50%;background:var(--accent-color);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;">${initials}</div>`;
                        }
                    } else {
                        const isUser = msg.sender === 'user';
                        const avatarElement = isUser ? DOMElements.me.avatar : DOMElements.partner.avatar;
                        const frameSettings = isUser ? settings.myAvatarFrame : settings.partnerAvatarFrame;
                        const avatarShape = isUser ? (settings.myAvatarShape || 'circle') : (settings.partnerAvatarShape || 'circle');
                        avatarDiv.innerHTML = avatarElement.innerHTML;
                        applyAvatarFrame(avatarDiv, frameSettings);
                        ['circle','square','pentagon','heart'].forEach(s => avatarDiv.classList.remove('shape-' + s));
                        if (avatarShape !== 'none') avatarDiv.classList.add('shape-' + avatarShape);
                    }
                } else {
                    avatarDiv.style.display = 'none';
                }
                wrapper.appendChild(avatarDiv);
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content-wrapper';

                if (groupMember && groupChatSettings.showName) {
                    const nameLabel = document.createElement('div');
                    nameLabel.className = 'group-sender-name';
                    nameLabel.textContent = groupMember.name;
                    const isSameSenderGroupForName = lastSender === 'group_' + groupMember.name;
                    if (!isSameSenderGroupForName) contentWrapper.appendChild(nameLabel);
                }
                
                let messageHTML = '';
                if (msg.replyTo) {
                    const repliedText = msg.replyTo.text || (msg.replyTo.image ? 'ðŸ–¼ å›¾ç‰‡' : '[æ¶ˆæ¯]');
                    const repliedSender = msg.replyTo.sender === 'user' ? (settings.myName || 'æˆ‘') : (settings.partnerName || 'å¯¹æ–¹');
                    messageHTML += `<div class="reply-indicator"><span class="reply-indicator-sender">${repliedSender}</span><span class="reply-indicator-text">${repliedText}</span></div>`;
                }

                let content = msg.text ? `<div>${msg.text.replace(/\n/g, '<br>')}</div>`: '';
                if (msg.image) content += `<img src="${msg.image}" class="message-image" alt="å›¾ç‰‡" style="max-width: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer;" onclick="viewImage('${msg.image}')">`;
                messageHTML += content;

                if (msg.note) messageHTML += `<div class="message-note">${msg.note}</div>`;

                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${msg.sender === 'user' ? 'sent': 'received'} ${settings.bubbleStyle}`;
                messageDiv.innerHTML = messageHTML;

                let actionsHTML = '';
                
                if (settings.replyEnabled) actionsHTML += `<button class="meta-action-btn reply-btn" title="å›žå¤"><i class="fas fa-reply"></i></button>`;
                
                const starIcon = msg.favorited ? 'fas fa-star' : 'far fa-star'; 
                actionsHTML += `<button class="meta-action-btn favorite-action-btn ${msg.favorited ? 'favorited' : ''}" title="${msg.favorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'}"><i class="${starIcon}"></i></button>`;
                
                actionsHTML += `<button class="meta-action-btn note-btn" title="æ³¨é‡Š"><i class="fas fa-sticky-note"></i></button>`;
actionsHTML += `<button class="meta-action-btn delete-btn" title="åˆ é™¤"><i class="fas fa-trash-alt"></i></button>`;
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-meta-actions';
                actionsDiv.innerHTML = actionsHTML;

                let metaHTML = '';
                
                if (showTimestamp) {
                    const ts = new Date(msg.timestamp);
                    let timeStr;
                    const fmt = settings.timeFormat || 'HH:mm';
                    if (fmt === 'HH:mm:ss') {
                        timeStr = ts.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                    } else if (fmt === 'h:mm AM/PM') {
                        timeStr = ts.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                    } else if (fmt === 'h:mm:ss AM/PM') {
                        timeStr = ts.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
                    } else {
                        timeStr = ts.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                    }
                    metaHTML += `<div class="timestamp">${timeStr}</div>`;
                }

                if (msg.sender === 'user' && settings.readReceiptsEnabled && showTimestamp) {
                    const statusIcon = msg.status === 'read' ? 'fa-check-double': 'fa-check';
                    metaHTML += `<div class="read-receipt ${msg.status === 'read' ? 'read': ''}"><i class="fas ${statusIcon}"></i></div>`;
                }

                if (metaHTML !== '') {
                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'message-meta';
                    if (!showTimestamp && !metaHTML.includes('timestamp')) {
                         metaDiv.style.height = 'auto'; 
                         metaDiv.style.marginTop = '2px';
                         if (settings.inChatAvatarPosition !== 'top') {
                             avatarDiv.style.marginBottom = '18px';
                         }
                    } else {
                         
                         if (settings.inChatAvatarPosition !== 'top') {
                             avatarDiv.style.marginBottom = '26px';
                         }
                    }
                    metaDiv.innerHTML = metaHTML;
                    contentWrapper.append(actionsDiv, messageDiv, metaDiv);
                } else {
                    contentWrapper.append(actionsDiv, messageDiv);
                }
                wrapper.appendChild(contentWrapper);
                fragment.appendChild(wrapper);
                
                lastSender = groupMember ? ('group_' + groupMember.name) : msg.sender;
            });

            container.appendChild(fragment);

            if (preserveScroll) {
                const newScrollHeight = container.scrollHeight;
                const delta = newScrollHeight - oldScrollHeight;
                container.scrollTop = Math.max(0, container.scrollTop + delta);
            } else {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }        

        const addMessage = (message) => {
            if (!(message.timestamp instanceof Date)) message.timestamp = new Date(message.timestamp);
            messages.push(message);


            displayedMessageCount++;


            renderMessages(false);
            throttledSaveData();
        };

        function optimizeImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                if (file.size < 300 * 1024) {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    return;
                }
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let {
                        width,
                        height
                    } = img;
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = () => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                    URL.revokeObjectURL(img.src);
                };
                img.src = URL.createObjectURL(file);
            });
        }

        function sendMessage(textOverride = null, type = 'normal') {
            const text = textOverride || DOMElements.messageInput.value.trim();
            const imageFile = DOMElements.imageInput.files[0];
            if (!text && !imageFile && type === 'normal') return;

            DOMElements.messageInput.value = '';
            DOMElements.messageInput.style.height = '46px';
            if (imageFile && imageFile.size > MAX_IMAGE_SIZE) {
                showNotification('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error'); DOMElements.imageInput.value = ''; return;
            }

            const createMessage = (imgSrc = null) => {
                const messageData = {
                    id: Date.now(),
                    sender: 'user',
                    text: text || '',
                    timestamp: new Date(),
                    image: imgSrc,
                    status: 'sent',
                    favorited: false,
                    note: null,
                    replyTo: currentReplyTo,
                    type: type
                };
                if (type === 'system') messageData.sender = null;

                addMessage(messageData);
                if (type !== 'system') playSound('send');
                currentReplyTo = null;
                updateReplyPreview();

if (!isBatchMode && type === 'normal') {
    const delayRange = settings.replyDelayMax - settings.replyDelayMin;
    const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
    
    setTimeout(() => {
        let changed = false;
        messages.forEach(msg => {
            if (msg.sender === 'user' && msg.status !== 'read') {
                msg.status = 'read'; 
                changed = true;
            }
        });
        if (changed) {
            renderMessages(false); 
            throttledSaveData();
        }

        const shouldIgnore = settings.allowReadNoReply && (Math.random() < settings.readNoReplyChance);

        if (shouldIgnore) {
            console.log("è§¦å‘å·²è¯»ä¸å›žæœºåˆ¶");
        } else {
            simulateReply(); 
        }

    }, randomDelay);
}
};

            if (imageFile) {
                showNotification('æ­£åœ¨ä¼˜åŒ–å›¾ç‰‡...', 'info', 1500);
                optimizeImage(imageFile).then(createMessage).catch(() => showNotification('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error'));
            } else {
                createMessage();
            }
            DOMElements.imageInput.value = '';
        }

        function toggleBatchMode() {
            isBatchMode = !isBatchMode;
            DOMElements.batchBtn.classList.toggle('active', isBatchMode);
            DOMElements.batchBtn.title = isBatchMode ? "é€€å‡ºæ‰¹é‡æ¨¡å¼": "æ‰¹é‡å‘é€æ¨¡å¼";
            DOMElements.batchPreview.style.display = isBatchMode ? 'flex': 'none';
            const placeholder = "";
            DOMElements.messageInput.placeholder = isBatchMode ? "æ­¤åˆ»ï¼Œæƒ³è¯´çš„æœ‰å¾ˆå¤šå¾ˆå¤š...": (placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder);
            if (isBatchMode) {
                batchMessages = []; updateBatchPreview();
            }
        }

        function addToBatch() {
            const text = DOMElements.messageInput.value.trim();
            if (!text) return;
            batchMessages.push({
                id: Date.now() + batchMessages.length, text
            });
            DOMElements.messageInput.value = ''; DOMElements.messageInput.style.height = '46px';
            updateBatchPreview();
        }

        function updateBatchPreview() {
            const previewContainer = DOMElements.batchPreview;
            let listHTML = '';
            if (batchMessages.length > 0) {
                listHTML = batchMessages.map((msg, index) => `
                <div class="batch-preview-item" data-index="${index}">
                <span class="batch-preview-text">${msg.text}</span>
                <button class="batch-preview-remove"><i class="fas fa-times"></i></button>
                </div>`).join('');
            } else {
                listHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 14px; padding: 10px;">ã¤â™¡âŠ‚</div>';
            }

            previewContainer.innerHTML = `
        <div class="batch-preview-title">æˆ‘æœ‰å¾ˆå¤šçš„è¯æƒ³è¯´â€¦ï¼</div>
        <div class="batch-preview-list">${listHTML}</div>
        <div class="batch-actions">
        <button class="batch-action-btn batch-cancel-btn">å–æ¶ˆ</button>
        <button class="batch-action-btn batch-send-btn" ${batchMessages.length === 0 ? 'disabled': ''}>å‘é€å…¨éƒ¨ (${batchMessages.length})</button>
        </div>`;
        }

        function sendBatchMessages() {
            if (batchMessages.length === 0) return;
            showNotification(`æ­£åœ¨å‘é€ ${batchMessages.length} æ¡æ¶ˆæ¯...`, 'info', 2000);
            batchMessages.forEach((msg, index) => {
                setTimeout(() => {
                    addMessage({
                        id: Date.now() + index, sender: 'user', text: msg.text, timestamp: new Date(), status: 'sent', favorited: false, type: 'normal'
                    });
                    playSound('send');
                }, index * 300);
            });
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, batchMessages.length * 300 + randomDelay);
            isBatchMode = false; batchMessages = [];
            DOMElements.batchBtn.classList.remove('active'); DOMElements.batchPreview.style.display = 'none';
            const placeholder = "";
            DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;
        }

        function positionTypingIndicator() {
            var tiW = document.getElementById('typing-indicator-wrapper');
            var inputArea = document.querySelector('.input-area-wrapper');
            if (!tiW || !inputArea) return;
            var h = inputArea.offsetHeight;
            tiW.style.bottom = h + 'px';
        }
        (function() {
            var inputArea = document.querySelector('.input-area-wrapper');
            if (!inputArea) return;
            var ro = new ResizeObserver(function() {
                var tiW = document.getElementById('typing-indicator-wrapper');
                if (tiW && tiW.style.display !== 'none') positionTypingIndicator();
            });
            ro.observe(inputArea);
        })();

        function simulateReply() {
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            function showTypingIndicator() {
                if (!settings.typingIndicatorEnabled) return;
                const tiWrapper = document.getElementById('typing-indicator-wrapper');
                const tiLabel = document.getElementById('typing-indicator-label');
                const tiAvatar = document.getElementById('typing-indicator-avatar');
                if (tiLabel) tiLabel.textContent = (settings.partnerName || 'å¯¹æ–¹') + ' æ­£åœ¨è¾“å…¥';
                if (tiWrapper) { positionTypingIndicator(); tiWrapper.style.display = 'block'; }
                if (tiAvatar) {
                    const partnerImg = DOMElements.partner.avatar.querySelector('img');
                    tiAvatar.innerHTML = partnerImg ? `<img src="${partnerImg.src}">` : '<i class="fas fa-user"></i>';
                }
                DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
            }

            showTypingIndicator();

            let changed = false;
            messages.forEach(msg => {
                if (msg.sender === 'user' && msg.status !== 'read') {
                    msg.status = 'read'; changed = true;
                }
            });
            if (changed) {
                renderMessages(false); throttledSaveData();
            }

            showTypingIndicator();
if (partnerPersonas && partnerPersonas.length > 0 && Math.random() < 0.3) {
                const currentPool = [
                    ...partnerPersonas
                ];
                if(currentPool.length > 0) {
                     const nextPersona = currentPool[Math.floor(Math.random() * currentPool.length)];
                     
                     settings.partnerName = nextPersona.name;
                     DOMElements.partner.name.textContent = nextPersona.name;
                     
                     if (nextPersona.avatar) {
                         updateAvatar(DOMElements.partner.avatar, nextPersona.avatar);
                         localforage.setItem(getStorageKey('partnerAvatar'), nextPersona.avatar);
                     }
                     throttledSaveData();
                }
            }
            if (Math.random() < 0.03) {
                if (customPokes && customPokes.length > 0) {
        const randomAction = getRandomItem(customPokes);
                const pokeTypes = [{
                    prefix: "ðŸ’«",
                    text: `${settings.partnerName} ${randomAction}`
                },
                    {
                        prefix: "âœ¨",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "ðŸŒŸ",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "ðŸ¥°",
                        text: `${settings.partnerName} ${randomAction}`
                    },
                    {
                        prefix: "ðŸ’–",
                        text: `${settings.partnerName} ${randomAction}`
                    }];

               const selectedPoke = getRandomItem(pokeTypes);
        
        addMessage({
            id: Date.now(),
            text: `${selectedPoke.prefix} ${settings.partnerName} ${randomAction} ${selectedPoke.prefix}`,
            timestamp: new Date(),
            type: 'system'
        });
        (function(){var _tiW=document.getElementById('typing-indicator-wrapper');if(_tiW){var _tiInner=_tiW.querySelector('.typing-indicator');if(_tiInner){_tiInner.classList.add('hiding');setTimeout(function(){_tiW.style.display='none';if(_tiInner)_tiInner.classList.remove('hiding');},240);}else{_tiW.style.display='none';}}})();
        return;
    }
}

            const replyCount = Math.random() < 0.75 ? 1: (Math.random() < 0.95 ? 2: 3);
            let delay = 0;
            for (let i = 0; i < replyCount; i++) {
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                delay += settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(() => {
let text = null;
let image = null;

const activeEmojis = [...CONSTANTS.REPLY_EMOJIS.filter(e => !disabledDefaultReplies.includes(e)), ...customEmojis];
const nonTextPool = [...activeEmojis, ...stickerLibrary];

const activeDefaults = CONSTANTS.REPLY_MESSAGES.filter(msg => !disabledDefaultReplies.includes(msg));
const textPool = [...activeDefaults, ...customReplies];

if (Math.random() < 0.15 && nonTextPool.length > 0) { 
    const result = getRandomItem(nonTextPool);
    if (result.startsWith('data:image')) { 
        image = result;
    } else { 
        text = result;
    }
} else if (textPool.length > 0) {
    text = getRandomItem(textPool);
} else if (nonTextPool.length > 0) { 
     const result = getRandomItem(nonTextPool);
    if (result.startsWith('data:image')) {
        image = result;
    } else {
        text = result;
    }
} else {
    text = "ï¼ˆæˆ‘ä¸çŸ¥é“è¯¥è¯´ä»€ä¹ˆäº†...ï¼‰";
}

let replyTo = null;
if (settings.replyEnabled && Math.random() < 0.1) {
    const userMessages = messages.filter(m => m.sender === 'user').slice(-10);
    if (userMessages.length > 0) {
        const randomMessage = getRandomItem(userMessages);
        replyTo = {
            id: randomMessage.id,
            sender: randomMessage.sender,
            text: randomMessage.text
        };
    }
}

addMessage({
    id: Date.now() + i,
    sender: 'partner',
    text: text,
    image: image, 
    timestamp: new Date(),
    favorited: false,
    replyTo,
    type: 'normal'
});
                    playSound('message');
                    if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
                        const notifTitle = settings.partnerName || 'å¯¹æ–¹';
                        const notifBody = text ? text.slice(0, 60) : '[å›¾ç‰‡æ¶ˆæ¯]';
                        try {
                            new Notification(notifTitle, {
                                body: notifBody,
                                icon: document.getElementById('partner-avatar')?.querySelector('img')?.src || undefined,
                                tag: 'new-message',
                                renotify: true
                            });
                        } catch(e) {}
                    }
                    if (i === replyCount - 1) (function(){var _tiW=document.getElementById('typing-indicator-wrapper');if(_tiW){var _tiInner=_tiW.querySelector('.typing-indicator');if(_tiInner){_tiInner.classList.add('hiding');setTimeout(function(){_tiW.style.display='none';if(_tiInner)_tiInner.classList.remove('hiding');},240);}else{_tiW.style.display='none';}}})();
                },
                    delay);
            }
        }


        function startCoinFlipAnimation() {
            const overlay = DOMElements.coinTossOverlay;
            const coin = DOMElements.animatedCoin;
            const resultText = DOMElements.coinResultText;


            overlay.classList.remove('finished');
            coin.classList.remove('flipping-heads', 'flipping-tails');


            void coin.offsetWidth;


            resultText.textContent = 'å‘½è¿æŠ‰æ‹©ä¸­...';


            const isHeads = Math.random() < 0.5;
            const result = isHeads ? 'æ˜¯': 'å¦';
            const animationClass = isHeads ? 'flipping-heads': 'flipping-tails';


            requestAnimationFrame(() => {
                coin.classList.add(animationClass);
            });


            const onAnimationEnd = () => {

                const fancyText = isHeads ? "ç­”æ¡ˆæ˜¯ Â· æ˜¯": "ç­”æ¡ˆæ˜¯ Â· å¦";
                resultText.textContent = fancyText;


                lastCoinResult = result;


                overlay.classList.add('finished');
            };


            coin.addEventListener('animationend', onAnimationEnd, {
                once: true
            });
        }


        function handleCoinToss() {
            DOMElements.coinTossOverlay.classList.add('visible');
            startCoinFlipAnimation();
        }

        function updateReplyPreview() {
            const previewContainer = DOMElements.replyPreviewContainer;
            previewContainer.innerHTML = '';

            if (currentReplyTo) {
                const preview = document.createElement('div');
                preview.className = 'reply-preview';
                const repliedText = currentReplyTo.text || (currentReplyTo.image ? 'ðŸ–¼ å›¾ç‰‡' : '[æ¶ˆæ¯]');
                const senderName = currentReplyTo.sender === 'user' ? (settings.myName || 'æˆ‘') : (settings.partnerName || 'å¯¹æ–¹');
                preview.innerHTML = `<div class="reply-preview-content"><span style="font-size:11px;font-weight:600;color:var(--accent-color);display:block;margin-bottom:2px;">å›žå¤ ${senderName}</span><span>${repliedText}</span></div><button class="reply-preview-remove"><i class="fas fa-times"></i></button>`;
                preview.querySelector('.reply-preview-remove').addEventListener('click', () => {
                    currentReplyTo = null; updateReplyPreview();
                });
                previewContainer.appendChild(preview);
            }
        }


        function renderFavorites() {
            const list = DOMElements.favoritesModal.list;

            const favoritedMessages = messages.filter(m => m.favorited).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (favoritedMessages.length === 0) {
                list.innerHTML = `
            <div class="no-favorites">
            <i class="fas fa-folder-open"></i>
            <p>æ˜Ÿçƒçš„è§’è½ç©ºç©ºå¦‚ä¹Ÿ...</p>
            <span style="font-size:12px; margin-top:5px; opacity:0.7">ç‚¹å‡»æ¶ˆæ¯æ—çš„æ˜Ÿæ˜Ÿå³å¯æ”¶è—</span>
            </div>`;
                return;
            }

            list.innerHTML = favoritedMessages.map(msg => {

                const isMe = msg.sender === 'user';

                const avatarSrc = isMe
                ? (document.getElementById('my-avatar').querySelector('img')?.src || ''): (document.getElementById('partner-avatar').querySelector('img')?.src || '');

                const avatarHTML = avatarSrc
                ? `<img src="${avatarSrc}" class="fav-avatar" alt="avatar">`: `<div class="fav-avatar"><i class="fas fa-user"></i></div>`;

                const name = isMe ? settings.myName: settings.partnerName;


                let contentHTML = msg.text ? `<span>${msg.text.replace(/\n/g, '<br>')}</span>`: '';
                if (msg.image) contentHTML += `<img src="${msg.image}" alt="å›¾ç‰‡" loading="lazy">`;


                const timeStr = new Date(msg.timestamp).toLocaleString('zh-CN', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                return `
            <div class="fav-card" id="fav-card-${msg.id}">
            ${avatarHTML}
            <div class="fav-content-wrapper">
            <div class="fav-header">
            <span class="fav-sender-name">${name}</span>
            <span style="opacity:0.6">${timeStr}</span>
            </div>
            <div class="fav-bubble">
            ${contentHTML}
            </div>
            <button class="fav-action-btn" onclick="removeFavorite(${msg.id})">
            <i class="fas fa-trash-alt"></i> ç§»é™¤
            </button>
            </div>
            </div>`;
            }).join('');
        }


        window.removeFavorite = function(msgId) {
            const message = messages.find(m => m.id === msgId);
            if (message) {
                message.favorited = false;

                const card = document.getElementById(`fav-card-${msgId}`);
                if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(20px)';
                    setTimeout(() => {
                        renderFavorites();
                        throttledSaveData();
                        const chatMsgBtn = document.querySelector(`.message-wrapper[data-id="${msgId}"] .favorite-meta-btn`);
                        if (chatMsgBtn) chatMsgBtn.classList.remove('favorited');
                    },
                        300);
                }
            }
        };

function showModal(modalElement, focusElement = null) {
            if (modalElement._hideTimeout) {
                clearTimeout(modalElement._hideTimeout);
                modalElement._hideTimeout = null;
            }
            modalElement.style.display = 'flex';
            requestAnimationFrame(() => {
                const content = modalElement.querySelector('.modal-content');
                if (content) {
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0) scale(1)';
                }
                if (focusElement) {
                    setTimeout(() => focusElement.focus(), 100);
                }
            });
        }

        function hideModal(modalElement) {
            const content = modalElement.querySelector('.modal-content');
            if (content) {
                content.style.opacity = '0';
                content.style.transform = 'translateY(20px) scale(0.95)';
            }
            if (modalElement._hideTimeout) clearTimeout(modalElement._hideTimeout);
            modalElement._hideTimeout = setTimeout(() => {
                modalElement.style.display = 'none';
            }, 300);
        }

        function viewImage(src) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.92);display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s ease;touch-action:pinch-zoom;';
            modal.innerHTML = `
                <div style="position:relative;max-width:95vw;max-height:92vh;display:flex;align-items:center;justify-content:center;">
                    <img src="${src}" style="max-width:95vw;max-height:88vh;object-fit:contain;display:block;border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,0.6);" draggable="false">
                    <button onclick="this.closest('[style*=fixed]').remove()" style="position:fixed;top:16px;right:16px;width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.3);color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);z-index:10;line-height:1;">Ã—</button>
                    <a href="${src}" download style="position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:10px 24px;background:rgba(255,255,255,0.15);border:1.5px solid rgba(255,255,255,0.3);border-radius:20px;color:#fff;font-size:13px;text-decoration:none;backdrop-filter:blur(8px);display:flex;align-items:center;gap:6px;"><i class="fas fa-download"></i> ä¿å­˜å›¾ç‰‡</a>
                </div>`;
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.tagName === 'IMG') modal.remove();
            });
            document.body.appendChild(modal);
        }

        function exportChatHistory() {
            try {
                let dgCustomData = null, dgStatusPool = null, customWeatherMap = {};
                try { dgCustomData = JSON.parse(localStorage.getItem('dg_custom_data') || 'null'); } catch(e2) {}
                try { dgStatusPool = JSON.parse(localStorage.getItem('dg_status_pool') || 'null'); } catch(e2) {}
                for (var ki = 0; ki < localStorage.length; ki++) {
                    var kk = localStorage.key(ki);
                    if (kk && kk.startsWith('customWeather_')) customWeatherMap[kk] = localStorage.getItem(kk);
                }
                const dataStr = JSON.stringify({
                    version: "3.0",
                    exportDate: new Date().toISOString(),
                    messages,
                    settings,
                    customReplies,
                    anniversaries,
                    customThemes,
                    stickerLibrary,
                    dgCustomData,
                    dgStatusPool,
                    customWeatherMap
                },
                    null,
                    2);


                if (navigator.share && /Mobile|Android|iPhone|iPad/.test(navigator.userAgent)) {

                    const blob = new Blob([dataStr], {
                        type: 'application/json;charset=utf-8'
                    });
                    const file = new File([blob], `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`, {
                        type: 'application/json'
                    });

                    if (navigator.canShare && navigator.canShare({
                        files: [file]
                    })) {
                        navigator.share({
                            files: [file],
                            title: 'èŠå¤©è®°å½•å¤‡ä»½',
                            text: `èŠå¤©è®°å½•å¤‡ä»½ - ${new Date().toLocaleDateString()}`
                        }).then(() => {
                            showNotification('åˆ†äº«æˆåŠŸ', 'success');
                        }).catch((error) => {
                            console.error('åˆ†äº«å¤±è´¥:', error);
                            fallbackExport(dataStr);
                        });
                    } else {
                        fallbackExport(dataStr);
                    }
                } else {

                    fallbackExport(dataStr);
                }
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showNotification('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        function fallbackExport(dataStr) {
            const dataBlob = new Blob([dataStr], {
                type: 'application/json;charset=utf-8'
            });
            const url = URL.createObjectURL(dataBlob);


            const link = document.createElement('a');
            link.href = url;
            link.download = `chat-backup-${SESSION_ID}-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);


            setTimeout(() => URL.revokeObjectURL(url), 100);
            showNotification(`æˆåŠŸå¯¼å‡º ${messages.length} æ¡æ¶ˆæ¯`, 'success');
        }

        function importChatHistory(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.messages || !Array.isArray(importedData.messages)) throw new Error('æ— æ•ˆçš„èŠå¤©è®°å½•æ–‡ä»¶');
                    if (messages.length > 0 && !confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰ä¼šè¯çš„èŠå¤©è®°å½•ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) return;

                    messages = importedData.messages.map(m => ({
                        ...m, timestamp: new Date(m.timestamp)
                    }));
                    if (importedData.settings) Object.assign(settings, importedData.settings);
                    if (importedData.customReplies) customReplies = importedData.customReplies;
                    if (importedData.anniversaries) anniversaries = importedData.anniversaries;
                    if(importedData.customThemes) customThemes = importedData.customThemes;
                    if(importedData.stickerLibrary) stickerLibrary = importedData.stickerLibrary;
                    if(importedData.dgCustomData) { try { localStorage.setItem('dg_custom_data', JSON.stringify(importedData.dgCustomData)); } catch(e2) {} }
                    if(importedData.dgStatusPool) { try { localStorage.setItem('dg_status_pool', JSON.stringify(importedData.dgStatusPool)); } catch(e2) {} }
                    if(importedData.customWeatherMap) { try { for(var wk in importedData.customWeatherMap) localStorage.setItem(wk, importedData.customWeatherMap[wk]); } catch(e2) {} }

                    saveData();
                    updateUI();
                    showNotification(`æˆåŠŸå¯¼å…¥ ${messages.length} æ¡æ¶ˆæ¯`, 'success');
                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showNotification('æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å·²æŸå', 'error');
                }
            };
            reader.onerror = () => showNotification('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            reader.readAsText(file);
        }

        const checkStatusChange = () => {
            if ((Date.now() - settings.lastStatusChange) / 36e5 >= settings.nextStatusChange) {
if (customStatuses && customStatuses.length > 0) {
    settings.partnerStatus = getRandomItem(customStatuses);
}
                settings.lastStatusChange = Date.now();
                settings.nextStatusChange = 1 + Math.random() * 7;
                DOMElements.partner.status.textContent = settings.partnerStatus;
                throttledSaveData();
            }
        };


function renderStatsContent() {
            const statsContent = DOMElements.statsModal.content;

            const partnerMessages = messages.filter(msg =>
                msg.sender === 'partner' &&
                msg.text &&
                msg.type !== 'system'
            );
            
            const myMessages = messages.filter(msg =>
                msg.sender === 'user' &&
                msg.text &&
                msg.type !== 'system'
            );

            if (partnerMessages.length === 0 && myMessages.length === 0) {
                statsContent.innerHTML = `
                    <div class="stats-empty-state">
                        <div class="stats-empty-icon"><i class="fas fa-chart-pie"></i></div>
                        <h3>æš‚æ— æ•°æ®</h3>
                        <p>å¤šèŠå‡ å¥å†æ¥çœ‹çœ‹å§...</p>
                    </div>`;
                return;
            }

            const getTopReplies = (msgs) => {
                const countMap = {};
                msgs.forEach(msg => {
                    const text = msg.text.trim();
                    if (text) {
                        countMap[text] = (countMap[text] || 0) + 1;
                    }
                });
                return Object.entries(countMap)
                    .map(([text, count]) => ({ text, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 5); 
            };

            const partnerTop = getTopReplies(partnerMessages);
            const myTop = getTopReplies(myMessages);

            const generateRankHTML = (list) => {
                if (list.length === 0) return '<div style="text-align:center;color:var(--text-secondary);font-size:12px;padding:10px;">æš‚æ— æ•°æ®</div>';
                const maxVal = list[0].count;
                return list.map((item, index) => {
                    const percent = (item.count / maxVal) * 100;
                    return `
                    <div class="rank-item">
                        <div class="rank-progress-bg" style="width: ${percent}%; opacity: 0.1; background-color: var(--text-primary);"></div>
                        <div class="rank-info">
                            <div class="rank-number">#${index + 1}</div>
                            <div class="rank-text" title="${item.text}">${item.text}</div>
                            <div class="rank-count">${item.count}æ¬¡</div>
                        </div>
                    </div>`;
                }).join('');
            };

            const allMsgs = messages.filter(m => m.timestamp);
            const firstMsg = allMsgs.length > 0 ? allMsgs[0] : { timestamp: new Date() };
            const lastMsg = allMsgs.length > 0 ? allMsgs[allMsgs.length - 1] : { timestamp: new Date() };

            const formatDate = (dateObj) => {
                return new Date(dateObj).toLocaleDateString('zh-CN', {
                    month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
                });
            };

            statsContent.innerHTML = `
                <div class="stats-dashboard">
                    <div class="stats-overview-grid">
                        <div class="overview-item">
                            <div class="overview-value">${messages.length}</div>
                            <div class="overview-label">æ€»æ¶ˆæ¯æ•°</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${myMessages.length}</div>
                            <div class="overview-label">æˆ‘å‘é€çš„</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${formatDate(firstMsg.timestamp)}</div>
                            <div class="overview-label">åˆæ¬¡ç›¸é‡</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">${formatDate(lastMsg.timestamp)}</div>
                            <div class="overview-label">æœ€è¿‘è”ç»œ</div>
                        </div>
                    </div>

                    <div class="stats-card">
                        <div style="display:flex; gap:8px; margin-bottom:12px;">
                            <button id="stats-toggle-partner" class="stats-toggle-btn active" onclick="switchStatsView('partner')">
                                <i class="fas fa-user-circle"></i> å¯¹æ–¹
                            </button>
                            <button id="stats-toggle-me" class="stats-toggle-btn" onclick="switchStatsView('me')">
                                <i class="fas fa-user"></i> æˆ‘æ–¹
                            </button>
                        </div>
                        <div class="stats-card-title" id="stats-rank-title">
                            <i class="fas fa-user-circle"></i> å¯¹æ–¹é«˜é¢‘è¯ TOP 5
                        </div>
                        <div class="stats-rank-list" id="stats-rank-list">
                            ${generateRankHTML(partnerTop)}
                        </div>
                    </div>
                </div>
            `;

            statsContent._partnerHTML = generateRankHTML(partnerTop);
            statsContent._myHTML = generateRankHTML(myTop);
        }

        window.switchStatsView = function(who) {
            const statsContent = DOMElements.statsModal.content;
            const partnerBtn = document.getElementById('stats-toggle-partner');
            const meBtn = document.getElementById('stats-toggle-me');
            const title = document.getElementById('stats-rank-title');
            const list = document.getElementById('stats-rank-list');
            if (!partnerBtn || !meBtn || !list) return;

            if (who === 'partner') {
                partnerBtn.classList.add('active');
                meBtn.classList.remove('active');
                title.innerHTML = '<i class="fas fa-user-circle"></i> å¯¹æ–¹é«˜é¢‘è¯ TOP 5';
                list.innerHTML = statsContent._partnerHTML || '<div style="text-align:center;color:var(--text-secondary);font-size:12px;padding:10px;">æš‚æ— æ•°æ®</div>';
            } else {
                meBtn.classList.add('active');
                partnerBtn.classList.remove('active');
                title.innerHTML = '<i class="fas fa-user"></i> æˆ‘æ–¹é«˜é¢‘è¯ TOP 5';
                list.innerHTML = statsContent._myHTML || '<div style="text-align:center;color:var(--text-secondary);font-size:12px;padding:10px;">æš‚æ— æ•°æ®</div>';
            }
        };
        function renderSessionList() {
            const listContainer = DOMElements.sessionModal.list;
            if (sessionList.length === 0) {
                listContainer.innerHTML = '<div class="stats-empty" style="padding: 20px 0;"><p>è¿˜æ²¡æœ‰ä¼šè¯</p></div>';
                return;
            }
            listContainer.innerHTML = sessionList.map(session => `
            <div class="session-item ${session.id === SESSION_ID ? 'active': ''}" data-id="${session.id}">
            <div class="session-info">
            <div class="session-name">${session.name}</div>
            <div class="session-meta">åˆ›å»ºäºŽ ${new Date(session.createdAt).toLocaleDateString()}</div>
            </div>
            <div class="session-actions">
            <button class="session-action-btn rename" title="é‡å‘½å"><i class="fas fa-pen"></i></button>
            <button class="session-action-btn delete" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
            </div>
            </div>
            `).join('');
        }


async function generateFortune() {
    const todayKey = new Date().toDateString();
    const storageKey = `${APP_PREFIX}daily_fortune`;
    let fortuneData = null;

    try {
        const savedData = await localforage.getItem(storageKey);
        if (savedData && savedData.date === todayKey) {
            fortuneData = savedData;
        }
    } catch (e) { console.warn("è¯»å–è¿åŠ¿å¤±è´¥", e); }

    if (!fortuneData) {
        const cards = CONSTANTS.TAROT_CARDS;
        const randomIndex = Math.floor(Math.random() * cards.length);
        const isUpright = Math.random() > 0.5;

        fortuneData = {
            date: todayKey,
            cardIndex: randomIndex,
            isUpright: isUpright
        };
        await localforage.setItem(storageKey, fortuneData);
    }

    renderFortuneCardInteractive(fortuneData);
}

function renderFortuneCardInteractive(data) {
    const content = document.getElementById('fortune-content');
    
    if (!content) return showNotification('ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');

    const card = CONSTANTS.TAROT_CARDS[data.cardIndex];
    const isUpright = data.isUpright;
    const todayKey = data.date || new Date().toDateString();

    content.innerHTML = `
        <div style="text-align:center; margin-bottom:10px; color:var(--text-secondary); font-size:12px;">
            <i class="fas fa-hand-pointer"></i> ç‚¹å‡»å¡ç‰Œæ­æ™“ä»Šæ—¥æŒ‡å¼•
        </div>
        
        <div class="tarot-container-3d" onclick="this.classList.toggle('flipped'); document.getElementById('fortune-text-area').classList.add('visible');">
            <div class="tarot-card-inner">
                <div class="tarot-face tarot-front">
                    <div class="tarot-pattern"><i class="fas fa-star-and-crescent"></i></div>

                </div>

                <div class="tarot-face tarot-back">
                    <div class="tarot-visual ${isUpright ? '' : 'reversed'}" style="height:100px;">
                        <i class="fas ${card.icon} tarot-icon-vector" style="font-size:48px;"></i>
                    </div>
                    <div>
                        <div class="tarot-card-name" style="font-size:18px;">${card.name}</div>
                        <div class="tarot-position-badge ${isUpright ? 'upright' : 'reversed'}" style="margin:5px 0;">
                            ${isUpright ? "æ­£ä½" : "é€†ä½"}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fortune-text-area" class="fortune-result-area">
            <div class="tarot-keyword" style="font-size:16px; margin-bottom:8px;">ã€Œ${card.keyword}ã€</div>
            <div class="fortune-desc" style="font-size:14px; margin-bottom:10px;">${card.meaning}</div>
            <div class="fortune-tip" style="font-size:12px; border-top:1px dashed var(--border-color); padding-top:8px;">
                ðŸ’¡ æŒ‡å¼•ï¼š${isUpright ? "é¡ºåŠ¿è€Œä¸ºï¼Œä¿æŒå½“ä¸‹çš„èƒ½é‡ã€‚" : "æ¢ä¸ªè§’åº¦æ€è€ƒï¼Œä¹Ÿè®¸æ˜¯è½¬æœºã€‚"}
            </div>
            ${renderMinorFortune(todayKey)}
        </div>
    `;

    showModal(document.getElementById('fortune-lenormand-modal'));
}

let lenormandSystem = 36;
let lenormandCount = 1;

const LENORMAND_CARDS_40 = [
    { num: 1, name: "éª‘å£«", icon: "ðŸ‡", keyword: "æ¶ˆæ¯Â·é€Ÿåº¦", meaning: "å¿«é€Ÿåˆ°æ¥çš„æ¶ˆæ¯ï¼Œè¡ŒåŠ¨è¿…é€Ÿï¼Œä½¿è€…ï¼ŒçŸ­é€”æ—…è¡Œã€‚" },
    { num: 2, name: "å››å¶è‰", icon: "ðŸ€", keyword: "å¹¸è¿Â·æœºé‡", meaning: "å°å¹¸è¿ï¼Œå¶ç„¶çš„å¥½è¿ï¼ŒçŸ­æš‚çš„å–œæ‚¦ï¼Œä¹è§‚é¢å¯¹ç”Ÿæ´»ã€‚" },
    { num: 3, name: "å¸†èˆ¹", icon: "â›µ", keyword: "æ—…è¡ŒÂ·æ–¹å‘", meaning: "æ—…è¡Œï¼Œå†’é™©ï¼Œè¿½å¯»ç›®æ ‡ï¼Œäººç”Ÿçš„èˆªå‘ã€‚" },
    { num: 4, name: "æˆ¿å±‹", icon: "ðŸ ", keyword: "å®¶åº­Â·å®‰ç¨³", meaning: "å®¶ï¼Œç¨³å®šï¼Œå®‰å…¨æ„Ÿï¼Œå®¶åº­å…³ç³»ï¼Œæˆ¿äº§ã€‚" },
    { num: 5, name: "å¤§æ ‘", icon: "ðŸŒ³", keyword: "å¥åº·Â·æ ¹åŸº", meaning: "å¥åº·ï¼Œç”Ÿå‘½åŠ›ï¼Œæˆé•¿ï¼Œæ ¹åŸºï¼Œé•¿ä¹…ç¨³å›ºã€‚" },
    { num: 6, name: "ä¹Œäº‘", icon: "â˜ï¸", keyword: "å›°æƒ‘Â·éšœç¢", meaning: "å›°æƒ‘ï¼Œä¸ç¡®å®šï¼Œæš‚æ—¶çš„é˜´éœ¾ï¼Œéœ€è¦è€å¿ƒç­‰å¾…ã€‚" },
    { num: 7, name: "è›‡", icon: "ðŸ", keyword: "è¯±æƒ‘Â·è¿‚å›ž", meaning: "ç«žäº‰è€…ï¼Œè¯±æƒ‘ï¼Œè¿‚å›žçš„é“è·¯ï¼Œå¤æ‚çš„å¥³æ€§ã€‚" },
    { num: 8, name: "æ£ºæ", icon: "âš°ï¸", keyword: "ç»“æŸÂ·è½¬å˜", meaning: "ç»“æŸï¼Œè½¬å˜ï¼ŒæŸäº‹å‘Šä¸€æ®µè½ï¼Œä½Žè½æœŸï¼Œç–¾ç—…ã€‚" },
    { num: 9, name: "èŠ±æŸ", icon: "ðŸ’", keyword: "ç¤¼ç‰©Â·å–œæ‚¦", meaning: "ç¤¼ç‰©ï¼ŒæƒŠå–œï¼Œå–œæ‚¦ï¼Œç¾Žå¥½çš„å…³ç³»ï¼Œæ„Ÿæ¿€ä¹‹æƒ…ã€‚" },
    { num: 10, name: "é•°åˆ€", icon: "ðŸŒ¾", keyword: "å†³æ–­Â·æ”¶å‰²", meaning: "çªç„¶çš„å†³å®šï¼Œå±é™©ï¼Œæ”¶å‰²ï¼Œç»“æŸï¼Œæ‰‹æœ¯ã€‚" },
    { num: 11, name: "éž­å­", icon: "âš¡", keyword: "äº‰æ‰§Â·æ¿€æƒ…", meaning: "äº‰è®ºï¼Œå†²çªï¼Œé‡å¤ï¼Œæ¿€æƒ…ï¼Œä½“è‚²è¿åŠ¨ã€‚" },
    { num: 12, name: "é¸Ÿå„¿", icon: "ðŸ¦", keyword: "å¯¹è¯Â·ç„¦è™‘", meaning: "å¯¹è¯ï¼Œæµè¨€ï¼Œæ¶ˆæ¯ï¼Œç„¦è™‘ï¼Œä¸€å¯¹æƒ…ä¾£ã€‚" },
    { num: 13, name: "å­©ç«¥", icon: "ðŸ§’", keyword: "æ–°å¼€å§‹Â·çº¯çœŸ", meaning: "æ–°çš„å¼€å§‹ï¼Œçº¯çœŸï¼Œå­©å­ï¼Œå°äº‹ï¼Œæ–°é²œæ„Ÿã€‚" },
    { num: 14, name: "ç‹ç‹¸", icon: "ðŸ¦Š", keyword: "ç‹¡çŒ¾Â·å·¥ä½œ", meaning: "ç‹¡çŒ¾ï¼Œç­–ç•¥ï¼Œå·¥ä½œï¼Œè°¨é˜²æ¬ºéª—ï¼Œè‡ªæˆ‘ä¿æŠ¤ã€‚" },
    { num: 15, name: "ç†Š", icon: "ðŸ»", keyword: "åŠ›é‡Â·æƒå¨", meaning: "å¼ºå¤§çš„åŠ›é‡ï¼Œè€æ¿ï¼Œè´¢åŠ¡ï¼Œæ¯æ€§ï¼Œä¿æŠ¤è€…ã€‚" },
    { num: 16, name: "æ˜Ÿæ˜Ÿ", icon: "â­", keyword: "å¸Œæœ›Â·æŒ‡å¼•", meaning: "å¸Œæœ›ï¼Œæ¢¦æƒ³ï¼Œçµæ„Ÿï¼ŒæŒ‡å¼•ï¼Œæ¸…æ™°ï¼Œç¾Žå¥½æœªæ¥ã€‚" },
    { num: 17, name: "é¹³é¸Ÿ", icon: "ðŸ•Šï¸", keyword: "å˜åŒ–Â·ç§»åŠ¨", meaning: "å˜åŒ–ï¼Œç§»åŠ¨ï¼Œé€‚åº”ï¼Œæ–°çš„ç”Ÿæ´»é˜¶æ®µï¼Œè¿å¾™ã€‚" },
    { num: 18, name: "ç‹—", icon: "ðŸ•", keyword: "å‹è°ŠÂ·å¿ è¯š", meaning: "å¿ è¯šçš„æœ‹å‹ï¼Œå‹è°Šï¼Œå¯é ï¼Œæ”¯æŒï¼Œå® ç‰©ã€‚" },
    { num: 19, name: "é«˜å¡”", icon: "ðŸ°", keyword: "å­¤ç‹¬Â·æœºæž„", meaning: "å­¤ç‹¬ï¼Œè¾¹ç•Œï¼Œæœºæž„ï¼Œå®˜æ–¹ï¼Œè·ç¦»ï¼Œè‡ªæˆ‘ä¿æŠ¤ã€‚" },
    { num: 20, name: "èŠ±å›­", icon: "ðŸŒº", keyword: "ç¤¾äº¤Â·å…¬ä¼—", meaning: "ç¤¾äº¤åœºåˆï¼Œå…¬ä¼—ï¼Œèšä¼šï¼Œå¼€æ”¾çš„ç©ºé—´ã€‚" },
    { num: 21, name: "å±±ä¸˜", icon: "â›°ï¸", keyword: "éšœç¢Â·æŒ‘æˆ˜", meaning: "éšœç¢ï¼ŒæŒ‘æˆ˜ï¼Œå»¶è¿Ÿï¼Œç«žäº‰ï¼Œéœ€è¦æ”€è¶Šçš„å›°éš¾ã€‚" },
    { num: 22, name: "åå­—è·¯å£", icon: "ðŸ›¤ï¸", keyword: "é€‰æ‹©Â·æ–¹å‘", meaning: "é€‰æ‹©ï¼Œå²”è·¯ï¼Œå¯èƒ½æ€§ï¼Œå¤šæ¡é“è·¯ï¼Œå†³ç­–æ—¶åˆ»ã€‚" },
    { num: 23, name: "è€é¼ ", icon: "ðŸ€", keyword: "æŸè€—Â·åŽ‹åŠ›", meaning: "æŸå¤±ï¼ŒåŽ‹åŠ›ï¼Œç„¦è™‘ï¼Œå·èµ°ï¼Œé€æ¸å‡å°‘ï¼Œæ‹…å¿§ã€‚" },
    { num: 24, name: "å¿ƒ", icon: "â¤ï¸", keyword: "çˆ±æƒ…Â·æ„Ÿæƒ…", meaning: "çˆ±ï¼Œæ„Ÿæƒ…ï¼Œå…³æ€€ï¼ŒçœŸå¿ƒï¼Œæƒ…æ„Ÿçš„æ ¸å¿ƒã€‚" },
    { num: 25, name: "æŒ‡çŽ¯", icon: "ðŸ’", keyword: "æ‰¿è¯ºÂ·å¥‘çº¦", meaning: "æ‰¿è¯ºï¼Œå¥‘çº¦ï¼Œå©šå§»ï¼Œåˆä½œï¼Œå¾ªçŽ¯å¾€å¤ã€‚" },
    { num: 26, name: "ä¹¦", icon: "ðŸ“š", keyword: "ç§˜å¯†Â·çŸ¥è¯†", meaning: "ç§˜å¯†ï¼ŒçŸ¥è¯†ï¼Œå­¦ä¹ ï¼Œéšè—çš„ä¿¡æ¯ï¼Œéœ€è¦æ·±å…¥äº†è§£ã€‚" },
    { num: 27, name: "ä¿¡ä»¶", icon: "âœ‰ï¸", keyword: "æ²Ÿé€šÂ·æ–‡ä»¶", meaning: "é€šè®¯ï¼Œæ–‡ä»¶ï¼Œä¿¡æ¯ï¼Œä¹¦é¢åˆåŒï¼Œé‡è¦çš„æ¶ˆæ¯ã€‚" },
    { num: 28, name: "ç”·å£«", icon: "ðŸ‘¨", keyword: "ç”·æ€§Â·å½“äº‹äºº", meaning: "ä¸»è¦ç”·æ€§äººç‰©ï¼Œç”·æ€§æé—®è€…æˆ–é‡è¦ç”·æ€§ã€‚" },
    { num: 29, name: "å¥³å£«", icon: "ðŸ‘©", keyword: "å¥³æ€§Â·å½“äº‹äºº", meaning: "ä¸»è¦å¥³æ€§äººç‰©ï¼Œå¥³æ€§æé—®è€…æˆ–é‡è¦å¥³æ€§ã€‚" },
    { num: 30, name: "ç™¾åˆ", icon: "ðŸŒ¸", keyword: "çº¯æ´Â·å¹³é™", meaning: "çº¯æ´ï¼Œå¹³é™ï¼Œå’Œè°ï¼Œæˆç†Ÿçš„æ„Ÿæƒ…ï¼Œé«˜å°šçš„å“æ ¼ã€‚" },
    { num: 31, name: "å¤ªé˜³", icon: "â˜€ï¸", keyword: "æˆåŠŸÂ·æ´»åŠ›", meaning: "æˆåŠŸï¼Œæ´»åŠ›ï¼Œå¿«ä¹ï¼Œæ¸©æš–ï¼Œå…‰æ˜Žï¼Œç§¯æžèƒ½é‡ã€‚" },
    { num: 32, name: "æœˆäº®", icon: "ðŸŒ™", keyword: "è£èª‰Â·ç›´è§‰", meaning: "è£èª‰ï¼Œåå£°ï¼Œç›´è§‰ï¼Œæƒ…æ„Ÿæ³¢åŠ¨ï¼Œåˆ›é€ åŠ›ï¼Œæ¢¦å¢ƒã€‚" },
    { num: 33, name: "é’¥åŒ™", icon: "ðŸ”‘", keyword: "ç­”æ¡ˆÂ·è§£é”", meaning: "ç­”æ¡ˆï¼Œè§£å†³æ–¹æ¡ˆï¼Œé‡è¦å‘çŽ°ï¼Œå¼€å¯æ–°çš„å¯èƒ½ã€‚" },
    { num: 34, name: "é±¼", icon: "ðŸŸ", keyword: "è´¢å¯ŒÂ·æµåŠ¨", meaning: "è´¢å¯Œï¼Œç”Ÿæ„ï¼ŒæµåŠ¨ï¼Œä¸°ç››ï¼Œå•†ä¸šæ´»åŠ¨ï¼Œèµ„æºã€‚" },
    { num: 35, name: "é”š", icon: "âš“", keyword: "ç¨³å®šÂ·åšæŒ", meaning: "ç¨³å®šï¼ŒåšæŒï¼Œç›®æ ‡ï¼Œé•¿æœŸï¼Œè¸å®žï¼Œå·¥ä½œã€‚" },
    { num: 36, name: "åå­—æž¶", icon: "âœï¸", keyword: "å‘½è¿Â·æ‹…å½“", meaning: "å‘½è¿ï¼Œè´£ä»»ï¼Œç—›è‹¦ï¼Œä¿¡ä»°ï¼ŒæŽ¥å—ï¼Œç²¾ç¥žä½¿å‘½ã€‚" },
    { num: 37, name: "çµä½“", icon: "ðŸ’­", keyword: "é«˜æˆ‘Â·æ„Ÿå—", meaning: "ç›´è§‰ï¼Œæ„Ÿå—ï¼Œè§‰å¯Ÿï¼Œå› æžœè§„å¾‹ï¼Œçµé­‚ä¼´ä¾£ï¼Œã€‚" },
    { num: 38, name: "é¦™ç‚‰", icon: "âš–ï¸", keyword: "æ¸…é™¤Â·å½’é›¶", meaning: "æ¸…é™¤ï¼Œå‡€åŒ–ï¼Œæ¶ˆæ•£ï¼Œå¼¥æ¼«ï¼Œæ¸…å‡€ä¹‹åœ°ï¼Œæ°›å›´æ„Ÿã€‚" },
    { num: 39, name: "åºŠ", icon: "ðŸ›", keyword: "èˆ’é€‚Â·ä¼‘æ¯", meaning: "ç¡è§‰ï¼Œå›žé¿ï¼Œèººå¹³ï¼Œèˆ’é€‚ï¼Œå§å®¤ï¼Œæ€§å…³ç³»ã€‚" },
    { num: 40, name: "å¸‚åœº", icon: "ðŸª", keyword: "äº¤æ˜“Â·å·¥ä½œ", meaning: "å·¥ä½œï¼Œäº¤æ˜“ï¼Œç»´æŠ¤ï¼Œè¿è¥ï¼ŒåŠ¿å‡åŠ›æ•Œï¼Œå‡ºåŽ»æ¸¸çŽ©ã€‚" }
];

function getLenormandCards() {
    return LENORMAND_CARDS_40.slice(0, lenormandSystem);
}

function setLenormandSystem(n) {
    lenormandSystem = n;
}

function setLenormandCount(n) {
    lenormandCount = n;
    document.querySelectorAll('.lenormand-num-btn').forEach(btn => {
        const numEl = btn.querySelector('.leno-btn-num');
        btn.classList.toggle('active', numEl && parseInt(numEl.textContent) === n);
    });
    updateLenoNumDesc(n);
}

function updateLenoNumDesc(n) {
    const desc = document.getElementById('leno-num-desc');
    if (!desc) return;
    if (n === 1) desc.textContent = 'å•å¼ ç‰Œ Â· ç›´è¾¾ç­”æ¡ˆ';
    else if (n === 3) desc.textContent = 'ä¸‰å¼ ç‰Œ Â· æ´žå¯Ÿå…¨å±€';
}

function switchFLTab(tab) {
    document.querySelectorAll('.fl-tab').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.fl-panel').forEach(panel => panel.classList.remove('fl-panel-active'));
    const activeTab = document.getElementById('fl-tab-' + tab);
    const activePanel = document.getElementById('fl-panel-' + tab);
    if (activeTab) activeTab.classList.add('active');
    if (activePanel) activePanel.classList.add('fl-panel-active');
}

function openLenormandModal() {
    resetLenormand();
    switchFLTab('lenormand');
    showModal(document.getElementById('fortune-lenormand-modal'));
}

function resetLenormand() {
    const setup = document.getElementById('lenormand-setup');
    const result = document.getElementById('lenormand-result');
    const resetBtn = document.getElementById('lenormand-reset-btn');
    const qInput = document.getElementById('lenormand-question');
    if (setup) setup.style.display = '';
    if (result) result.style.display = 'none';
    if (resetBtn) resetBtn.style.display = 'none';
    if (qInput) qInput.value = '';
    lenormandSystem = 40;
    lenormandCount = 1;
    document.querySelectorAll('.lenormand-num-btn').forEach(btn => {
        const num = btn.querySelector('.leno-btn-num');
        btn.classList.toggle('active', num && num.textContent.trim() === '1');
    });
    updateLenoNumDesc(1);
}

function startLenormandDraw() {
    const cards = getLenormandCards();
    const shuffled = [...cards].sort(() => Math.random() - 0.5);
    const drawn = shuffled.slice(0, lenormandCount);
    const question = document.getElementById('lenormand-question').value.trim();

    let cardsHTML = drawn.map((card, i) => `
        <div class="lenormand-card-item" style="animation-delay:${i * 0.1}s;">
            <span class="lenormand-card-icon">${card.icon}</span>
            <div class="lenormand-card-name">${card.name}</div>
            <div class="lenormand-card-num">No.${card.num}</div>
            <div class="lenormand-card-keyword">ã€Œ${card.keyword}ã€</div>
            <div class="lenormand-card-meaning">${card.meaning}</div>
        </div>
    `).join('');

    let synthesisHTML = '';
    if (drawn.length > 1) {
        const keywords = drawn.map(c => c.keyword.split('Â·')[0]).join('ã€');
        const energies = drawn.map(c => c.name).join(' + ');
        const m0 = drawn[0].meaning.split('ï¼Œ')[0];
        const m2 = drawn.length >= 3 ? drawn[2].meaning.split('ï¼Œ')[0] : '';
        const n0 = drawn[0].name, n1 = drawn[1].name, n2 = drawn.length >= 3 ? drawn[2].name : '';
        
        const templates3 = [
            `ã€Œ${n0}ã€çš„èƒ½é‡å¦‚åŒ${m0}çš„åº•è‰²ï¼Œä¸Žã€Œ${n1}ã€ç›¸äº’å‘¼åº”ï¼›ã€Œ${n2}ã€åˆ™å¸¦æ¥${m2}çš„è´¨æ„Ÿã€‚ä¸‰å¼ ç‰Œçš„èƒ½é‡æµåŠ¨ï¼Œå…±åŒç¼–ç»‡å‡ºä¸€æ®µå…³äºŽ${keywords}çš„æ•…äº‹ã€‚`,
            `æ˜Ÿç›˜ä¹‹ä¸Šï¼Œã€Œ${n0}ã€ã€ã€Œ${n1}ã€ã€ã€Œ${n2}ã€ä¸‰å¼ ç‰Œä¾æ¬¡å±•å¼€â€”â€”å„è‡ªæºå¸¦çš„èƒ½é‡åœ¨æ­¤æ±‡èšï¼Œæ‚„æ‚„ä½Žè¯­ã€‚${keywords}ï¼Œæ˜¯æ­¤åˆ»éœ€è¦å…³æ³¨çš„æ ¸å¿ƒèƒ½é‡ã€‚`,
            `ã€Œ${n0}ã€ä¸Žã€Œ${n1}ã€ã€ã€Œ${n2}ã€å…±åŒå‘ˆçŽ°ï¼š${m0}çš„åŠ›é‡ä¸Ž${m2}çš„æ–¹å‘åœ¨è¿™é‡Œäº¤ç»‡ï¼Œç­‰å¾…ä½ è¿ˆå‡ºé‚£ä¸€æ­¥ã€‚æ„¿ä¸‰å¼ ç‰Œçš„èƒ½é‡ï¼Œæˆä¸ºä½ æ­¤åˆ»çš„æŒ‡å¼•ã€‚`,
            `ä¸‰å¼ ç‰Œå…±åŒå‘ˆçŽ°äº†ä¸€æ®µæ—…ç¨‹ï¼šã€Œ${n0}ã€ã€ã€Œ${n1}ã€ã€ã€Œ${n2}ã€ä¾æ¬¡å±•å¼€ï¼Œ${keywords}çš„ä¸»é¢˜è´¯ç©¿å…¶ä¸­ï¼ŒæŒ‡å¼•ç€å‰è¡Œçš„æ–¹å‘ã€‚`,
            `å®‡å®™å€Ÿ${energies}çš„èƒ½é‡ï¼Œå‘ä½ ä¼ é€’ä¿¡æ¯ï¼š${m0}çš„åŠ›é‡ä¸Ž${m2}çš„å¯èƒ½æ€§å·²æ‚„ç„¶å¼€å¯ï¼Œè¯·ç›¸ä¿¡è¿™æ®µæ—…ç¨‹æœ‰å…¶æ·±æ„ã€‚`
        ];
        const templates2 = [
            `ã€Œ${n0}ã€ä¸Žã€Œ${n1}ã€çš„èƒ½é‡ç›¸é‡ï¼Œ${keywords}çš„ä¸»é¢˜åœ¨æ­¤äº¤æ±‡ã€‚${m0}çš„åŠ›é‡é‡è§äº†æ–°çš„å¯èƒ½ï¼Œå…±åŒæç»˜å‡ºå½“ä¸‹å±€åŠ¿çš„é¢è²Œã€‚`,
            `ä¸¤å¼ ç‰Œæºæ‰‹è€Œæ¥ï¼šã€Œ${n0}ã€å¸¦ç€${m0}çš„åº•è‰²ï¼Œã€Œ${n1}ã€å¸¦æ¥æ–°çš„è§†è§’ã€‚å®ƒä»¬å…±åŒæŒ‡å‘ä¸€ä¸ªå…³äºŽ${keywords}çš„ç­”æ¡ˆï¼Œç­‰å¾…ä½ ç»†ç»†å“å‘³ã€‚`,
            `${energies}â€”â€”ä¸¤ç§èƒ½é‡åœ¨ä½ çš„é—®é¢˜ä¸Šç•™ä¸‹å°è®°ã€‚${m0}ä¸Žå¯¹æ–¹çš„èƒ½é‡ç›¸äº’ä½œç”¨ï¼Œå½“å‰å±€é¢å› æ­¤å……æ»¡äº†${keywords}çš„è´¨æ„Ÿã€‚é™ä¸‹å¿ƒæ¥ï¼Œç­”æ¡ˆå·²åœ¨å…¶ä¸­ã€‚`,
            `ç‰Œä¸Žç‰Œä¹‹é—´æ€»æœ‰å‘¼åº”ã€‚ã€Œ${n0}ã€å’Œã€Œ${n1}ã€çš„ç»„åˆï¼Œåƒæ˜¯å®‡å®™ç‰¹æ„ä¸ºä½ æŽ’åˆ—çš„å¯†ç ï¼Œ${keywords}ä¾¿æ˜¯è§£è¯»è¿™æ®µç¼˜åˆ†çš„é’¥åŒ™ã€‚`
        ];
        
        const templates = drawn.length === 3 ? templates3 : templates2;
        const chosenText = templates[Math.floor(Math.random() * templates.length)];
        
        synthesisHTML = `
        <div class="lenormand-synthesis">
            <div class="lenormand-synthesis-title">âœ¦ ç»¼åˆè§£è¯»</div>
            ${chosenText}
        </div>`;
    }

    const questionDisplay = question ? `<div class="lenormand-question-show">ã€Œ${question}ã€</div>` : '';

    document.getElementById('lenormand-result').innerHTML = `
        ${questionDisplay}
        <div style="text-align:center; font-size:12px; color:var(--text-secondary); margin-bottom:12px;">
            <i class="fas fa-moon"></i> é›·è¯ºæ›¼è½»å£°è¯´ Â· çˆ±èƒ½å…‹æœè¿œè·ç¦»
        </div>
        <div class="lenormand-cards-row">${cardsHTML}</div>
        ${synthesisHTML}
    `;

    document.getElementById('lenormand-setup').style.display = 'none';
    document.getElementById('lenormand-result').style.display = '';
    document.getElementById('lenormand-reset-btn').style.display = '';

    // Save to history
    const lCards = drawn.map(c => ({ name: c.name, keyword: c.keyword, position: '', isReversed: false, meaning: c.meaning }));
    saveDiviHistory({ type: `é›·è¯ºæ›¼${lenormandCount === 1 ? 'å•å¼ ' : 'ä¸‰å¼ '}`, question, cards: lCards });
}

// ============ å¡”ç½—å åœ (78å¼ å…¨å¥—) ============
const ALL_78_TAROT_CARDS = [
    // å¤§é˜¿å¡çº³ (22å¼ )
    { name: "æ„šäºº", num: "0", type: "major", eng: "The Fool", icon: "fa-hiking", keyword: "æµæµª", upright: "æ–°çš„å¼€å§‹ã€å†’é™©ã€å¤©çœŸæ— ç•ã€è‡ªç”±ç²¾ç¥žã€æ— é™å¯èƒ½", reversed: "é²èŽ½ã€é€ƒé¿ã€ä¸è´Ÿè´£ä»»ã€ç¼ºä¹æ–¹å‘æ„Ÿ" },
    { name: "é­”æœ¯å¸ˆ", num: "I", type: "major", eng: "The Magician", icon: "fa-hat-wizard", keyword: "åˆ›é€ ", upright: "åˆ›é€ åŠ›ã€æŠ€èƒ½ã€æ„å¿—åŠ›ã€åŒ–è…æœ½ä¸ºç¥žå¥‡ã€è¡ŒåŠ¨åŠ›", reversed: "æ¬ºéª—ã€æ“çºµã€èƒ½åŠ›æœªå‘æŒ¥ã€æ„å›¾ä¸çº¯" },
    { name: "å¥³ç¥­å¸", num: "II", type: "major", eng: "The High Priestess", icon: "fa-book-open", keyword: "æ™ºæ…§", upright: "ç›´è§‰ã€æ½œæ„è¯†ã€ç¥žç§˜ã€å†…åœ¨æ™ºæ…§ã€é™å¾…æ—¶æœº", reversed: "ç§˜å¯†ã€åŽ‹æŠ‘ç›´è§‰ã€ä¿¡æ¯éšè—ã€ä¸ç†æ€§" },
    { name: "çš‡åŽ", num: "III", type: "major", eng: "The Empress", icon: "fa-seedling", keyword: "ä¸°æ”¶", upright: "ä¸°é¥¶ã€æ¯æ€§ã€è‡ªç„¶ã€æ„Ÿå®˜äº«å—ã€åˆ›é€ åŠ›", reversed: "ä¾èµ–ã€åˆ›æ„é˜»å¡žã€è¿‡åº¦ä¿æŠ¤ã€å¿½è§†è‡ªæˆ‘" },
    { name: "çš‡å¸", num: "IV", type: "major", eng: "The Emperor", icon: "fa-crown", keyword: "æ”¯é…", upright: "æƒå¨ã€ç»“æž„ã€æŽ§åˆ¶ã€ç¨³å®šã€çˆ¶äº²å½¢è±¡ã€é¢†å¯¼åŠ›", reversed: "ä¸“æ¨ªã€åˆšæ„Žè‡ªç”¨ã€æƒåŠ›æ»¥ç”¨ã€ç¼ºä¹å¼¹æ€§" },
    { name: "æ•™çš‡", num: "V", type: "major", eng: "The Hierophant", icon: "fa-church", keyword: "æ´åŠ©", upright: "ä¼ ç»Ÿã€ä¿¡ä»°ã€æ•™å¯¼ã€ç²¾ç¥žæŒ‡å¼•ã€åˆ¶åº¦", reversed: "å›é€†ä¼ ç»Ÿã€ä¸ªäººä¿¡ä»°ã€çªç ´è§„èŒƒ" },
    { name: "æ‹äºº", num: "VI", type: "major", eng: "The Lovers", icon: "fa-heart", keyword: "ç»“åˆ", upright: "çˆ±ã€å’Œè°ã€å…³ç³»ã€ä»·å€¼è§‚çš„é€‰æ‹©ã€çµé­‚è¿žæŽ¥", reversed: "å¤±è¡¡ã€è¯¯åˆ¤ã€ä»·å€¼è§‚å†²çªã€åˆ†ç¦»" },
    { name: "æˆ˜è½¦", num: "VII", type: "major", eng: "The Chariot", icon: "fa-horse-head", keyword: "èƒœåˆ©", upright: "æ„å¿—åŠ›ã€èƒœåˆ©ã€å†³å¿ƒã€è‡ªæˆ‘æŽ§åˆ¶ã€å‰è¿›", reversed: "å¤±æŽ§ã€ç¼ºä¹æ–¹å‘ã€æŒ«è´¥ã€å›ºæ‰§" },
    { name: "åŠ›é‡", num: "VIII", type: "major", eng: "Strength", icon: "fa-fist-raised", keyword: "æ„å¿—", upright: "å‹‡æ°”ã€è€å¿ƒã€æŽ§åˆ¶ã€å†…åœ¨åŠ›é‡ã€æ¸©æŸ”çš„åšå®š", reversed: "æ€€ç–‘è‡ªæˆ‘ã€è½¯å¼±ã€åŽ‹æŠ‘å†…åœ¨åŠ›é‡" },
    { name: "éšå£«", num: "IX", type: "major", eng: "The Hermit", icon: "fa-lightbulb", keyword: "æŽ¢ç´¢", upright: "å†…çœã€å­¤ç‹¬ã€å¯»æ±‚çœŸç†ã€å†…åœ¨æŒ‡å¼•ã€æ™ºæ…§", reversed: "å­¤ç«‹ã€æ‹’ç»å¸®åŠ©ã€è¿‡åº¦å­¤ç‹¬" },
    { name: "å‘½è¿ä¹‹è½®", num: "X", type: "major", eng: "Wheel of Fortune", icon: "fa-dharmachakra", keyword: "è½®å›ž", upright: "å¾ªçŽ¯ã€å‘½è¿ã€è½¬æŠ˜ç‚¹ã€è¿æ°”ã€å› æžœ", reversed: "é€†å¢ƒã€æŠ—æ‹’æ”¹å˜ã€æ¶æ€§å¾ªçŽ¯" },
    { name: "æ­£ä¹‰", num: "XI", type: "major", eng: "Justice", icon: "fa-balance-scale", keyword: "å‡è¡¡", upright: "å…¬æ­£ã€çœŸç†ã€å› æžœã€æ³•å¾‹ã€è¯šå®ž", reversed: "ä¸å…¬æ­£ã€é€ƒé¿è´£ä»»ã€ä¸è¯šå®ž" },
    { name: "å€’åŠäºº", num: "XII", type: "major", eng: "The Hanged Man", icon: "fa-user-injured", keyword: "å¥‰çŒ®", upright: "ç‰ºç‰²ã€æ–°çš„è§†è§’ã€ç­‰å¾…ã€æ”¾ä¸‹ã€é¡¿æ‚Ÿ", reversed: "æ‹–å»¶ã€æ— è°“ç‰ºç‰²ã€åœæ»žä¸å‰" },
    { name: "æ­»ç¥ž", num: "XIII", type: "major", eng: "Death", icon: "fa-skull", keyword: "ç»“æŸ", upright: "ç»“æŸã€è½¬å˜ã€é‡ç”Ÿã€æ”¾æ‰‹ã€èœ•å˜", reversed: "æŠ—æ‹’æ”¹å˜ã€æ— æ³•æ”¾æ‰‹ã€è…æœ½" },
    { name: "èŠ‚åˆ¶", num: "XIV", type: "major", eng: "Temperance", icon: "fa-glass-whiskey", keyword: "å‡€åŒ–", upright: "å¹³è¡¡ã€é€‚åº¦ã€è€å¿ƒã€è°ƒå’Œã€ä¸­åº¸ä¹‹é“", reversed: "å¤±è¡¡ã€è¿‡åº¦ã€ç¼ºä¹è€å¿ƒ" },
    { name: "æ¶é­”", num: "XV", type: "major", eng: "The Devil", icon: "fa-link", keyword: "è¯±æƒ‘", upright: "æŸç¼šã€ç‰©è´¨ä¸»ä¹‰ã€æ¬²æœ›ã€è¯±æƒ‘ã€é˜´æš—é¢", reversed: "è§£è„±æŸç¼šã€é‡èŽ·è‡ªç”±ã€è‡ªæˆ‘è§‰é†’" },
    { name: "é«˜å¡”", num: "XVI", type: "major", eng: "The Tower", icon: "fa-gopuram", keyword: "æ¯ç­", upright: "çªå˜ã€æ··ä¹±ã€å¯ç¤ºã€ç ´åã€çœŸç›¸å¤§ç™½", reversed: "å»¶è¿Ÿå˜åŒ–ã€é¿å…ç¾éš¾ã€å†…åœ¨å´©æºƒ" },
    { name: "æ˜Ÿæ˜Ÿ", num: "XVII", type: "major", eng: "The Star", icon: "fa-star", keyword: "å¸Œæœ›", upright: "å¸Œæœ›ã€çµæ„Ÿã€å¹³é™ã€æ²»æ„ˆã€ä¿¡å¿µ", reversed: "ç»æœ›ã€å¤±åŽ»ä¿¡ä»°ã€æ‚²è§‚" },
    { name: "æœˆäº®", num: "XVIII", type: "major", eng: "The Moon", icon: "fa-moon", keyword: "ä¸å®‰", upright: "å¹»è§‰ã€ææƒ§ã€ç„¦è™‘ã€æ½œæ„è¯†ã€ä¸ç¡®å®šæ€§", reversed: "ææƒ§æ¶ˆæ•£ã€çœŸç›¸æµ®çŽ°ã€èµ°å‡ºè¿·æƒ˜" },
    { name: "å¤ªé˜³", num: "XIX", type: "major", eng: "The Sun", icon: "fa-sun", keyword: "ç”Ÿå‘½", upright: "å¿«ä¹ã€æˆåŠŸã€æ´»åŠ›ã€æ¸…æ™°ã€æ­£èƒ½é‡", reversed: "æ‚²è§‚ã€è‡ªæˆ‘æ€€ç–‘ã€çŸ­æš‚æŒ«æŠ˜" },
    { name: "å®¡åˆ¤", num: "XX", type: "major", eng: "Judgement", icon: "fa-bullhorn", keyword: "å¤æ´»", upright: "å¤æ´»ã€è§‰é†’ã€å·å¬ã€å†³å®šã€è‡ªæˆ‘è¯„ä»·", reversed: "è‡ªæˆ‘æ€€ç–‘ã€æ‹’ç»æŽ¥å—å®¡åˆ¤ã€è¿‡åŽ»çº ç¼ " },
    { name: "ä¸–ç•Œ", num: "XXI", type: "major", eng: "The World", icon: "fa-globe-americas", keyword: "è¾¾æˆ", upright: "å®Œæˆã€æ•´åˆã€æˆå°±ã€åœ†æ»¡ã€ä¸–ç•Œåœ¨è„šä¸‹", reversed: "æœªå®Œæˆã€æ‹–å»¶ã€ç¼ºä¹å®Œç»“" },
    // å°é˜¿å¡çº³ æƒæ– (14å¼ )
    { name: "æƒæ–ä¸€", num: "Ace", type: "wands", eng: "Ace of Wands", icon: "fa-fire", keyword: "çµæ„Ÿ", upright: "æ–°çš„çµæ„Ÿã€åˆ›æ„ç«èŠ±ã€æ¿€æƒ…å¼€å§‹ã€è¡ŒåŠ¨çš„æ¬²æœ›", reversed: "åˆ›æ„å—é˜»ã€ç¼ºä¹åŠ¨åŠ›ã€è®¡åˆ’ææµ…" },
    { name: "æƒæ–äºŒ", num: "2", type: "wands", eng: "Two of Wands", icon: "fa-compass", keyword: "è§„åˆ’", upright: "è§„åˆ’ã€å±•æœ›æœªæ¥ã€ä¸ªäººåŠ›é‡ã€å†³ç­–æ—¶åˆ»", reversed: "ææƒ§æœªçŸ¥ã€ç¼ºä¹è®¡åˆ’ã€è‡ªæˆ‘è®¾é™" },
    { name: "æƒæ–ä¸‰", num: "3", type: "wands", eng: "Three of Wands", icon: "fa-binoculars", keyword: "æ‰©å±•", upright: "æ‰©å±•ã€è¿œè§ã€æŽ¢ç´¢ã€ç­‰å¾…æˆæžœã€è´¸æ˜“", reversed: "éšœç¢ã€å»¶è¿Ÿã€é¢„æœŸæœªè¾¾" },
    { name: "æƒæ–å››", num: "4", type: "wands", eng: "Four of Wands", icon: "fa-home", keyword: "åº†å…¸", upright: "åº†å…¸ã€ç¨³å®šåŸºç¡€ã€å®¶åº­å¹¸ç¦ã€é‡Œç¨‹ç¢‘", reversed: "ä¸ç¨³å®šã€å®¶åº­çŸ›ç›¾ã€å»¶è¿Ÿåº†ç¥" },
    { name: "æƒæ–äº”", num: "5", type: "wands", eng: "Five of Wands", icon: "fa-people-arrows", keyword: "ç«žäº‰", upright: "ç«žäº‰ã€å†²çªã€æŒ‘æˆ˜ã€æ„è§åˆ†æ­§ã€æ–—äº‰", reversed: "å†…éƒ¨å†²çªã€é¿å…å¯¹æŠ—ã€è¾¾æˆåè®®" },
    { name: "æƒæ–å…­", num: "6", type: "wands", eng: "Six of Wands", icon: "fa-trophy", keyword: "å‡¯æ—‹", upright: "èƒœåˆ©ã€è®¤å¯ã€æˆåŠŸã€å…¬ä¼—è®¤å¯ã€è‡ªä¿¡", reversed: "ç§ä¸‹çš„æˆåŠŸã€ä¸ç¨³å®šçš„æˆåŠŸã€å‚²æ…¢" },
    { name: "æƒæ–ä¸ƒ", num: "7", type: "wands", eng: "Seven of Wands", icon: "fa-shield-alt", keyword: "åšå®ˆ", upright: "é˜²å¾¡ã€åšå®ˆç«‹åœºã€æŒ‘æˆ˜ã€åšæŒä¿¡å¿µ", reversed: "æ”¾å¼ƒã€è¢«åŽ‹å€’ã€è‡ªæˆ‘æ€€ç–‘" },
    { name: "æƒæ–å…«", num: "8", type: "wands", eng: "Eight of Wands", icon: "fa-meteor", keyword: "é€Ÿåº¦", upright: "è¿…é€Ÿè¡ŒåŠ¨ã€è¿›å±•åŠ é€Ÿã€æ—…è¡Œã€æ¶ˆæ¯ä¼ é€’", reversed: "å»¶è¯¯ã€ç­‰å¾…ã€éšœç¢ã€è®¡åˆ’å—é˜»" },
    { name: "æƒæ–ä¹", num: "9", type: "wands", eng: "Nine of Wands", icon: "fa-user-shield", keyword: "åšéŸ§", upright: "åšéŸ§ã€å¼¹æ€§ã€æœ€åŽçš„æŒ‘æˆ˜ã€è¾¹ç•Œã€è°¨æ…Ž", reversed: "åæ‰§ã€é¡½å›ºã€ä¸æ„¿å¦¥åã€é˜²å«è¿‡åº¦" },
    { name: "æƒæ–å", num: "10", type: "wands", eng: "Ten of Wands", icon: "fa-weight-hanging", keyword: "é‡æ‹…", upright: "è´£ä»»è¿‡é‡ã€è´Ÿæ‹…ã€åŽ‹åŠ›ã€åŠªåŠ›å¥‹æ–—ã€æŽ¥è¿‘ç»ˆç‚¹", reversed: "æ”¾ä¸‹é‡æ‹…ã€å§”æ´¾ä»»åŠ¡ã€ç²¾ç®€" },
    { name: "æƒæ–ä¾è€…", num: "Page", type: "wands", eng: "Page of Wands", icon: "fa-feather-alt", keyword: "çƒ­æƒ…", upright: "çƒ­æƒ…ã€æŽ¢ç´¢ã€æ–°æ¶ˆæ¯ã€å¥½å¥‡å¿ƒã€åˆ›æ„æ½œåŠ›", reversed: "è½»çŽ‡ã€ä¸‰åˆ†é’Ÿçƒ­åº¦ã€ç¼ºä¹æ–¹å‘" },
    { name: "æƒæ–éª‘å£«", num: "Knight", type: "wands", eng: "Knight of Wands", icon: "fa-horse", keyword: "å†’é™©", upright: "å†’é™©ã€å……æ²›èƒ½é‡ã€å‹‡æ•¢è¡ŒåŠ¨ã€è‡ªä¿¡è¿›å–", reversed: "é²èŽ½ã€åˆ†æ•£æ³¨æ„åŠ›ã€ç¼ºä¹è€å¿ƒ" },
    { name: "æƒæ–çš‡åŽ", num: "Queen", type: "wands", eng: "Queen of Wands", icon: "fa-female", keyword: "é­…åŠ›", upright: "é­…åŠ›ã€è‡ªä¿¡ã€çƒ­æƒ…ã€ç‹¬ç«‹ã€é¢†è¢–æ°”è´¨", reversed: "è‡ªç§ã€å«‰å¦’ã€å†…å‘é€€ç¼©" },
    { name: "æƒæ–å›½çŽ‹", num: "King", type: "wands", eng: "King of Wands", icon: "fa-male", keyword: "é¢†è¢–", upright: "é¢†è¢–åŠ›ã€æ„¿æ™¯ã€åˆ›ä¸šå®¶ç²¾ç¥žã€æ¿€åŠ±ä»–äºº", reversed: "ä¸“æ¨ªã€å†²åŠ¨ã€é«˜åŽ‹æŽ§åˆ¶" },
    // å°é˜¿å¡çº³ åœ£æ¯ (14å¼ )
    { name: "åœ£æ¯ä¸€", num: "Ace", type: "cups", eng: "Ace of Cups", icon: "fa-glass-cheers", keyword: "çˆ±æ¶ŒçŽ°", upright: "æ–°çš„çˆ±ã€æƒ…æ„Ÿå¼€å§‹ã€çµæ€§è¿žæŽ¥ã€ç›´è§‰ã€ä¸°ç››", reversed: "æƒ…æ„Ÿå°é—­ã€çˆ±çš„é˜»å¡žã€å†…å¿ƒç©ºè™š" },
    { name: "åœ£æ¯äºŒ", num: "2", type: "cups", eng: "Two of Cups", icon: "fa-heart", keyword: "è”ç»“", upright: "è”ç»“ã€ä¼™ä¼´å…³ç³»ã€ç›¸äº’å¸å¼•ã€å’Œè°å…³ç³»", reversed: "å¤±è¡¡å…³ç³»ã€è¯¯è§£ã€åˆ†ç¦»" },
    { name: "åœ£æ¯ä¸‰", num: "3", type: "cups", eng: "Three of Cups", icon: "fa-users", keyword: "åº†ç¥", upright: "åº†ç¥ã€å‹æƒ…ã€ç¤¾ç¾¤ã€å–œæ‚¦ã€åˆ›æ„åˆä½œ", reversed: "è¿‡åº¦æ”¾çºµã€å­¤ç«‹ã€æœ‹å‹å†²çª" },
    { name: "åœ£æ¯å››", num: "4", type: "cups", eng: "Four of Cups", icon: "fa-eye-slash", keyword: "å†¥æƒ³", upright: "å†¥æƒ³ã€æ— èŠã€å†è¯„ä¼°ã€å†…çœã€é”™è¿‡æœºä¼š", reversed: "æ–°æœºä¼šã€é‡æ–°å‚ä¸Žã€èµ°å‡ºå†·æ¼ " },
    { name: "åœ£æ¯äº”", num: "5", type: "cups", eng: "Five of Cups", icon: "fa-sad-cry", keyword: "å¤±è½", upright: "å¤±è½ã€æ‚²ä¼¤ã€åŽæ‚”ã€ä¸“æ³¨äºŽè´Ÿé¢ã€é—æ†¾", reversed: "ä»Žå¤±åŽ»ä¸­æ¢å¤ã€æŽ¥å—ã€å‰è¿›" },
    { name: "åœ£æ¯å…­", num: "6", type: "cups", eng: "Six of Cups", icon: "fa-child", keyword: "æ€€æ—§", upright: "æ€€æ—§ã€è¿‡åŽ»è®°å¿†ã€å¤©çœŸã€ç¤¼ç‰©ã€ç«¥å¹´", reversed: "å›°åœ¨è¿‡åŽ»ã€ä¸åˆ‡å®žé™…ã€æˆé•¿" },
    { name: "åœ£æ¯ä¸ƒ", num: "7", type: "cups", eng: "Seven of Cups", icon: "fa-cloud", keyword: "å¹»æƒ³", upright: "å¹»æƒ³ã€é€‰æ‹©è¿‡å¤šã€ç™½æ—¥æ¢¦ã€æ„¿æœ›æŠ•å°„", reversed: "èšç„¦ã€ä»Žå¹»æƒ³å›žå½’çŽ°å®žã€å†³æ–­" },
    { name: "åœ£æ¯å…«", num: "8", type: "cups", eng: "Eight of Cups", icon: "fa-walking", keyword: "ç¦»åŽ»", upright: "ç¦»å¼€ã€è¿½å¯»æ›´æ·±æ„ä¹‰ã€æ”¾ä¸‹è¿‡åŽ»ã€æ—…ç¨‹", reversed: "é€ƒé¿ã€æ”¾å¼ƒã€ä½Žè½ä¸å‰" },
    { name: "åœ£æ¯ä¹", num: "9", type: "cups", eng: "Nine of Cups", icon: "fa-smile-beam", keyword: "æ»¡è¶³", upright: "æ»¡è¶³æ„Ÿã€æ„¿æœ›æˆçœŸã€å¹¸ç¦ã€æ„Ÿæ¿€ã€ä¸°ç››", reversed: "ä¸æ»¡è¶³ã€ç‰©è´¨ä¸»ä¹‰ã€è¿‡åˆ†è‡ªæ»¡" },
    { name: "åœ£æ¯å", num: "10", type: "cups", eng: "Ten of Cups", icon: "fa-rainbow", keyword: "åœ†æ»¡", upright: "æƒ…æ„Ÿåœ†æ»¡ã€å®¶åº­å¹¸ç¦ã€å†…å¿ƒå¹³å’Œã€çœŸçˆ±", reversed: "å®¶åº­çŸ›ç›¾ã€ä¸å’Œè°ã€å¹¸ç¦å¹»ç­" },
    { name: "åœ£æ¯ä¾è€…", num: "Page", type: "cups", eng: "Page of Cups", icon: "fa-fish", keyword: "ç›´è§‰", upright: "åˆ›æ„ã€ç›´è§‰ä¿¡æ¯ã€æƒ…æ„ŸæŽ¢ç´¢ã€è‰ºæœ¯ã€æ¢¦å¢ƒ", reversed: "æƒ…ç»ªåŒ–ã€é€ƒé¿çŽ°å®žã€åˆ›æ„å—é˜»" },
    { name: "åœ£æ¯éª‘å£«", num: "Knight", type: "cups", eng: "Knight of Cups", icon: "fa-dove", keyword: "æµªæ¼«", upright: "æµªæ¼«ã€é­…åŠ›ã€è‰ºæœ¯ã€è¿½æ±‚ç†æƒ³ã€æƒ…æ„Ÿå†’é™©", reversed: "å¤šæ„å–„æ„Ÿã€å¹»æƒ³ã€æ— æ³•å®žçŽ°çš„è¯ºè¨€" },
    { name: "åœ£æ¯çš‡åŽ", num: "Queen", type: "cups", eng: "Queen of Cups", icon: "fa-water", keyword: "æ…ˆæ‚²", upright: "åŒç†å¿ƒã€æ…ˆæ‚²ã€ç›´è§‰ã€æƒ…æ„Ÿæˆç†Ÿã€å…³æ€€", reversed: "æƒ…ç»ªåŒ–ã€ä¸å®‰å…¨æ„Ÿã€ä¾èµ–" },
    { name: "åœ£æ¯å›½çŽ‹", num: "King", type: "cups", eng: "King of Cups", icon: "fa-anchor", keyword: "æƒ…æ„Ÿæ™ºæ…§", upright: "æƒ…æ„Ÿå¹³è¡¡ã€æ™ºæ…§ã€å¤–äº¤ã€æ…·æ…¨ã€æƒ…æ„Ÿæˆç†Ÿ", reversed: "æƒ…ç»ªæ“æŽ§ã€å†·æ¼ ã€æƒ…ç»ªä¸ç¨³å®š" },
    // å°é˜¿å¡çº³ å®å‰‘ (14å¼ )
    { name: "å®å‰‘ä¸€", num: "Ace", type: "swords", eng: "Ace of Swords", icon: "fa-bolt", keyword: "çœŸç›¸", upright: "æ¸…æ™°ã€çœŸç›¸ã€çªç ´ã€æ–°æ€æƒ³ã€æ­£ä¹‰", reversed: "æ··ä¹±ã€è°Žè¨€ã€æ€ç»´æ··ä¹±" },
    { name: "å®å‰‘äºŒ", num: "2", type: "swords", eng: "Two of Swords", icon: "fa-ban", keyword: "åƒµå±€", upright: "åƒµå±€ã€éš¾ä»¥å†³æ–­ã€å°é—­å¿ƒé—¨ã€é€ƒé¿çœŸç›¸", reversed: "ä¿¡æ¯æ˜¾çŽ°ã€åšå‡ºå†³å®šã€å›°å¢ƒè§£é™¤" },
    { name: "å®å‰‘ä¸‰", num: "3", type: "swords", eng: "Three of Swords", icon: "fa-heart-broken", keyword: "å¿ƒç¢Ž", upright: "å¿ƒç—›ã€æ‚²ä¼¤ã€å¤±åŽ»ã€åˆ†ç¦»ã€ç—›è‹¦", reversed: "ä»Žæ‚²ä¼¤æ¢å¤ã€å®½æ•ã€ç–—æ„ˆ" },
    { name: "å®å‰‘å››", num: "4", type: "swords", eng: "Four of Swords", icon: "fa-bed", keyword: "ä¼‘å…»", upright: "ä¼‘æ¯ã€æ¢å¤ã€é™é»˜å†¥æƒ³ã€æš‚æ—¶æ’¤é€€", reversed: "é‡è¿”æ´»åŠ¨ã€å†æ¬¡æ¿€æ´»ã€ä¸è€çƒ¦" },
    { name: "å®å‰‘äº”", num: "5", type: "swords", eng: "Five of Swords", icon: "fa-skull-crossbones", keyword: "å†²çª", upright: "å†²çªã€å¤±è´¥ã€ç©ºæ´žçš„èƒœåˆ©ã€ä¸è¯šå®ž", reversed: "å’Œè§£ã€è¶…è¶Šå†²çªã€èµ°å‘å’Œå¹³" },
    { name: "å®å‰‘å…­", num: "6", type: "swords", eng: "Six of Swords", icon: "fa-ship", keyword: "è¿‡æ¸¡", upright: "è¿‡æ¸¡æœŸã€é€ƒç¦»å›°å¢ƒã€å¹³é™æ—…ç¨‹ã€å‘å‰è¿ˆè¿›", reversed: "æŠ—æ‹’æ”¹å˜ã€æ— å¤„å¯é€ƒã€å›°éš¾è¿‡æ¸¡" },
    { name: "å®å‰‘ä¸ƒ", num: "7", type: "swords", eng: "Seven of Swords", icon: "fa-user-secret", keyword: "ç­–ç•¥", upright: "ç­–ç•¥ã€æ¬ºéª—ã€é€ƒè·‘ã€å•ç‹¬è¡ŒåŠ¨ã€ä¸è¯šå®ž", reversed: "çœŸç›¸æ­éœ²ã€è‰¯å¿ƒå‘çŽ°ã€å½’è¿˜æ‰€å¾—" },
    { name: "å®å‰‘å…«", num: "8", type: "swords", eng: "Eight of Swords", icon: "fa-handcuffs", keyword: "æŸç¼š", upright: "å—å›°ã€é™åˆ¶ã€è´Ÿé¢æ€ç»´ã€æ— åŠ©æ„Ÿã€è‡ªæˆ‘æŸç¼š", reversed: "é‡èŽ·è‡ªç”±ã€æ–°çš„è§†è§’ã€æŽ¥å—å¸®åŠ©" },
    { name: "å®å‰‘ä¹", num: "9", type: "swords", eng: "Nine of Swords", icon: "fa-nightmare", keyword: "ç„¦è™‘", upright: "ç„¦è™‘ã€å™©æ¢¦ã€æ‹…å¿§ã€å†…å¿ƒç—›è‹¦ã€ç½ªæ¶æ„Ÿ", reversed: "ä»Žç»æœ›ä¸­èµ°å‡ºã€å¯»æ±‚å¸®åŠ©ã€å¸Œæœ›" },
    { name: "å®å‰‘å", num: "10", type: "swords", eng: "Ten of Swords", icon: "fa-times-circle", keyword: "ç»ˆç»“", upright: "ç»ˆç»“ã€å¤±è´¥ã€è¢«èƒŒå›ã€æœ€ä½Žè°·åŽçš„å¸Œæœ›", reversed: "ä»Žå¤±è´¥ä¸­æ¢å¤ã€æŠ—æ‹’æŽ¥å—ã€æ–°å¼€å§‹" },
    { name: "å®å‰‘ä¾è€…", num: "Page", type: "swords", eng: "Page of Swords", icon: "fa-eye", keyword: "æ´žå¯Ÿ", upright: "å¥½å¥‡å¿ƒã€æ´žå¯ŸåŠ›ã€æœºæ•ã€æ–°æƒ³æ³•ã€è­¦è§‰", reversed: "æ•£æ¼«ã€ç²—å¿ƒå¤§æ„ã€è¨€è¯­ä¼¤äºº" },
    { name: "å®å‰‘éª‘å£«", num: "Knight", type: "swords", eng: "Knight of Swords", icon: "fa-wind", keyword: "å†²åŠ²", upright: "è¡ŒåŠ¨åŠ›ã€å†²åŠ²ã€ç›´æŽ¥ã€é‡Žå¿ƒã€æ™ºæ…§æˆ˜æ–—", reversed: "é²èŽ½ã€ä»“ä¿ƒã€è¿‡äºŽå¥½æ–—" },
    { name: "å®å‰‘çš‡åŽ", num: "Queen", type: "swords", eng: "Queen of Swords", icon: "fa-feather", keyword: "ç‹¬ç«‹", upright: "ç‹¬ç«‹ã€æ¸…æ™°æ€è€ƒã€ç›´æŽ¥ã€èªæ˜Žã€è®¾ç«‹ç•Œé™", reversed: "åˆ»è–„ã€è¿‡äºŽæ‰¹åˆ¤ã€ç—›è‹¦" },
    { name: "å®å‰‘å›½çŽ‹", num: "King", type: "swords", eng: "King of Swords", icon: "fa-gavel", keyword: "ç†æ€§", upright: "ç†æ€§æƒå¨ã€æ€ç»´æ¸…æ™°ã€é“å¾·æ ‡å‡†ã€å®¢è§‚å†³ç­–", reversed: "æ“æŽ§ã€ä¸“æ¨ªã€æ»¥ç”¨æƒåŠ›" },
    // å°é˜¿å¡çº³ æ˜Ÿå¸ (14å¼ )
    { name: "æ˜Ÿå¸ä¸€", num: "Ace", type: "pentacles", eng: "Ace of Pentacles", icon: "fa-coins", keyword: "æœºé‡", upright: "æ–°çš„ç‰©è´¨æœºä¼šã€ä¸°ç››ã€å¯Œè£•å¼€å§‹ã€å®‰å…¨æ„Ÿ", reversed: "é”™å¤±è‰¯æœºã€è´¢åŠ¡ä¸ç¨³ã€å›ºæ‰§" },
    { name: "æ˜Ÿå¸äºŒ", num: "2", type: "pentacles", eng: "Two of Pentacles", icon: "fa-yin-yang", keyword: "å¹³è¡¡", upright: "å¤šä»»åŠ¡å¤„ç†ã€é€‚åº”æ€§ã€æ—¶é—´ç®¡ç†ã€å¹³è¡¡", reversed: "å¤±åŽ»å¹³è¡¡ã€æ··ä¹±ã€è¿‡åº¦æ‰¿è¯º" },
    { name: "æ˜Ÿå¸ä¸‰", num: "3", type: "pentacles", eng: "Three of Pentacles", icon: "fa-drafting-compass", keyword: "åä½œ", upright: "å›¢é˜Ÿåˆä½œã€æŠ€èƒ½æå‡ã€åä½œã€å­¦ä¹ ", reversed: "ç¼ºä¹å›¢é˜Ÿç²¾ç¥žã€å“è´¨ä¸è¾¾æ ‡ã€å­¤ç«‹" },
    { name: "æ˜Ÿå¸å››", num: "4", type: "pentacles", eng: "Four of Pentacles", icon: "fa-lock", keyword: "å®ˆæŠ¤", upright: "å®‰å…¨æ„Ÿã€èŠ‚ä¿­ã€å®ˆæŠ¤è´¢å¯Œã€æŽ§åˆ¶æ¬²", reversed: "è¿‡åº¦èŠ‚ä¿­ã€è´ªå©ªã€è´¢åŠ¡æŸå¤±" },
    { name: "æ˜Ÿå¸äº”", num: "5", type: "pentacles", eng: "Five of Pentacles", icon: "fa-snowflake", keyword: "è‰°éš¾", upright: "è‰°éš¾æ—¶æœŸã€ç‰©è´¨æŸå¤±ã€å­¤ç«‹ã€å¥åº·é—®é¢˜", reversed: "ä»Žè‰°éš¾ä¸­æ¢å¤ã€å¯»æ±‚å¸®åŠ©ã€å¥½è½¬" },
    { name: "æ˜Ÿå¸å…­", num: "6", type: "pentacles", eng: "Six of Pentacles", icon: "fa-hand-holding-usd", keyword: "ç»™äºˆ", upright: "æ…·æ…¨ã€ç»™äºˆä¸ŽæŽ¥å—ã€å¹³è¡¡æ–½å—ã€æ…ˆå–„", reversed: "å€ºåŠ¡ã€åå•¬ã€æƒåŠ›ä¸å¹³è¡¡" },
    { name: "æ˜Ÿå¸ä¸ƒ", num: "7", type: "pentacles", eng: "Seven of Pentacles", icon: "fa-seedling", keyword: "è€•è€˜", upright: "é•¿æœŸæŠ•èµ„ã€è€å¿ƒã€æˆæžœè¯„ä¼°ã€æŒç»­åŠªåŠ›", reversed: "ç¼ºä¹è¿œè§ã€ç„¦è™‘ã€æ— æ•ˆåŠªåŠ›" },
    { name: "æ˜Ÿå¸å…«", num: "8", type: "pentacles", eng: "Eight of Pentacles", icon: "fa-hammer", keyword: "ç²¾è¿›", upright: "å·¥åŒ ç²¾ç¥žã€æŠ€èƒ½æå‡ã€æŠ•å…¥å·¥ä½œã€ä¸“æ³¨", reversed: "å®Œç¾Žä¸»ä¹‰ã€ç¼ºä¹ä¸“æ³¨ã€è´¨é‡ä¸‹é™" },
    { name: "æ˜Ÿå¸ä¹", num: "9", type: "pentacles", eng: "Nine of Pentacles", icon: "fa-spa", keyword: "ä¼˜é›…", upright: "ä¸°ç››ã€ä¼˜é›…ã€è‡ªç»™è‡ªè¶³ã€ç‰©è´¨äº«å—", reversed: "è¿‡åº¦åŠ³ç´¯ã€ç‰©è´¨ä¸»ä¹‰ã€è™šå‡ç¹è£" },
    { name: "æ˜Ÿå¸å", num: "10", type: "pentacles", eng: "Ten of Pentacles", icon: "fa-building", keyword: "åœ†æ»¡", upright: "å®¶æ—ä¼ æ‰¿ã€é•¿æœŸç¨³å®šã€è´¢å¯Œåœ†æ»¡ã€é—äº§", reversed: "å®¶æ—å†²çªã€è´¢åŠ¡ä¸ç¨³ã€ä¼ ç»Ÿç ´è£‚" },
    { name: "æ˜Ÿå¸ä¾è€…", num: "Page", type: "pentacles", eng: "Page of Pentacles", icon: "fa-book", keyword: "å­¦ä¹ ", upright: "å­¦ä¹ ã€å®žé™…æŠ€èƒ½ã€è®¡åˆ’ã€è°¨æ…Žè¸å®ž", reversed: "ç¼ºä¹è¿›å±•ã€ä¸åˆ‡å®žé™…ã€æ‡’æƒ°" },
    { name: "æ˜Ÿå¸éª‘å£«", num: "Knight", type: "pentacles", eng: "Knight of Pentacles", icon: "fa-tractor", keyword: "åŠ¡å®ž", upright: "å‹¤å‹‰ã€å¯é ã€åŠ¡å®žã€æ–¹æ³•è®ºã€è´£ä»»", reversed: "åœæ»žã€æ— èŠã€è¿‡äºŽä¿å®ˆ" },
    { name: "æ˜Ÿå¸çš‡åŽ", num: "Queen", type: "pentacles", eng: "Queen of Pentacles", icon: "fa-leaf", keyword: "æ»‹å…»", upright: "åŠ¡å®žã€å…»è‚²ã€å¯Œè¶³ã€å…³çˆ±å®¶åº­ã€æŽ¥åœ°æ°”", reversed: "å·¥ä½œä¸Žç”Ÿæ´»å¤±è¡¡ã€å«‰å¦’ã€è¿‡åº¦ç‰©è´¨" },
    { name: "æ˜Ÿå¸å›½çŽ‹", num: "King", type: "pentacles", eng: "King of Pentacles", icon: "fa-chess-king", keyword: "ç¹è£", upright: "ç‰©è´¨æˆåŠŸã€è´¢åŠ¡å®‰å…¨ã€å•†ä¸šå¤´è„‘ã€å¯é ", reversed: "å›ºæ‰§ã€ç‰©è´¨ä¸»ä¹‰ã€å†’é™©è´¢åŠ¡" }
];

const TAROT_TYPE_NAMES = { major: 'å¤§é˜¿å¡çº³', wands: 'æƒæ–', cups: 'åœ£æ¯', swords: 'å®å‰‘', pentacles: 'æ˜Ÿå¸' };

// Minor arcana suit icons and domain labels
const MINOR_SUIT_INFO = {
    wands:     { icon: 'ðŸ”¥', domain: 'äº‹ä¸š & è¡ŒåŠ¨', color: '#e07b3a' },
    cups:      { icon: 'ðŸ’§', domain: 'æ„Ÿæƒ… & å†…å¿ƒ', color: '#5b9bd5' },
    swords:    { icon: 'ðŸ’¨', domain: 'æ€ç»´ & æŒ‘æˆ˜', color: '#7b97b5' },
    pentacles: { icon: 'ðŸŒ¿', domain: 'è´¢å¯Œ & çŽ°å®ž', color: '#7aab72' },
};

function getMinorFortuneCards(seed) {
    // Pick one card per suit deterministically per day (seed = date string)
    const suits = ['wands', 'cups', 'swords', 'pentacles'];
    const result = [];
    suits.forEach((suit, si) => {
        const pool = ALL_78_TAROT_CARDS.filter(c => c.type === suit);
        // Use a simple hash of seed + suit index for daily determinism
        let h = 0;
        for (let i = 0; i < seed.length; i++) h = ((h << 5) - h + seed.charCodeAt(i) + si * 31) | 0;
        const idx = Math.abs(h) % pool.length;
        const card = pool[idx];
        // Upright/reversed based on second hash
        let h2 = h ^ (si * 0x9e3779b9);
        const isReversed = ((h2 >>> 0) % 2) === 1;
        result.push({ card, suit, isReversed });
    });
    return result;
}

function renderMinorFortune(dateKey) {
    const cards = getMinorFortuneCards(dateKey);
    const suitInsights = {
        wands: {
            upright: ['è¡ŒåŠ¨åŠ›å……è¶³ï¼Œæ˜¯æŽ¨è¿›è®¡åˆ’çš„å¥½æ—¶æœº', 'å……æ»¡çƒ­æƒ…ä¸Žåˆ›é€ åŠ›ï¼Œå‹‡äºŽè¿ˆå‡ºç¬¬ä¸€æ­¥', 'ç§¯æžè¿›å–ï¼Œä»Šæ—¥èƒ½é‡æ—ºç››'],
            reversed: ['èŠ‚å¥æ”¾æ…¢ï¼Œä¸å¿…å¼ºè¡ŒæŽ¨åŠ¨', 'èƒ½é‡åˆ†æ•£ï¼Œå…ˆæ•´ç†å†è¡ŒåŠ¨', 'é€‚å½“ä¼‘æ•´ï¼Œå‡å°‘æ¶ˆè€—']
        },
        cups: {
            upright: ['æƒ…æ„ŸæµåŠ¨é¡ºç•…ï¼Œæ˜“ä¸Žäººäº§ç”Ÿå…±é¸£', 'å†…å¿ƒå¹³é™ï¼Œç›´è§‰æ•é”', 'æ„Ÿæƒ…è¿ä½³ï¼Œé€‚åˆè¡¨è¾¾å¿ƒæ„'],
            reversed: ['æƒ…ç»ªéœ€è¦æ•´ç†ï¼Œç»™è‡ªå·±å¤šä¸€äº›è€å¿ƒ', 'å†…å¿ƒæœ‰äº›æ³¢åŠ¨ï¼Œä¿æŒè§‰å¯Ÿ', 'æ„Ÿæƒ…ä¸Šå®œé™è§‚ï¼Œå°‘åšå†²åŠ¨å†³å®š']
        },
        swords: {
            upright: ['æ€ç»´æ¸…æ™°ï¼Œé€‚åˆåšå‡ºé‡è¦å†³ç­–', 'ç›´é¢å›°éš¾ï¼Œé—®é¢˜å°†è¿Žåˆƒè€Œè§£', 'æ²Ÿé€šé¡ºç•…ï¼Œè¡¨è¾¾è‡ªæˆ‘çš„å¥½æ—¶æœº'],
            reversed: ['æ€ç»ªçº·ä¹±ï¼Œå…ˆæ²‰æ·€å†æ€è€ƒ', 'é¿å…äº‰è®ºï¼Œä¿æŒå†·é™', 'å°å¿ƒè¯¯è§£ï¼Œç¡®è®¤ä¿¡æ¯å†è¡ŒåŠ¨']
        },
        pentacles: {
            upright: ['ç‰©è´¨è¿é¡ºé‚ï¼Œè´¢åŠ¡ä¸Žå®žåŠ¡è¿›å±•ç¨³å¥', 'è„šè¸å®žåœ°ï¼ŒåŠªåŠ›å°†èŽ·å¾—å›žæŠ¥', 'ä»Šæ—¥å®œå¤„ç†çŽ°å®žäº‹åŠ¡'],
            reversed: ['è´¢åŠ¡éœ€è°¨æ…Žï¼Œå»¶åŽéžå¿…è¦æ”¯å‡º', 'çŽ°å®žå±‚é¢æœ‰äº›é˜»æ»žï¼Œè€å¿ƒåº”å¯¹', 'é¿å…æ€¥äºŽæ±‚æˆï¼Œç¨³æ‰Žç¨³æ‰“']
        }
    };

    const chips = cards.map(({ card, suit, isReversed }) => {
        const info = MINOR_SUIT_INFO[suit];
        const meaning = isReversed ? card.reversed : card.upright;
        return `
        <div class="minor-card-chip" title="${card.name} Â· ${isReversed ? 'é€†ä½' : 'æ­£ä½'}ï¼š${meaning}">
            <span class="minor-card-chip-suit">${info.icon}</span>
            <span class="minor-card-chip-name">${card.name}</span>
            <span class="minor-card-chip-keyword" style="color:${info.color};">${card.keyword}</span>
            <span class="minor-card-chip-badge ${isReversed ? 'rev' : ''}">${isReversed ? 'é€†ä½' : 'æ­£ä½'}</span>
        </div>`;
    }).join('');

    const domainInsights = cards.map(({ suit, isReversed }) => {
        const info = MINOR_SUIT_INFO[suit];
        const pool = suitInsights[suit][isReversed ? 'reversed' : 'upright'];
        // deterministic pick
        let h = 0;
        const key = suit + isReversed;
        for (let i = 0; i < key.length; i++) h = ((h << 5) - h + key.charCodeAt(i)) | 0;
        const text = pool[Math.abs(h) % pool.length];
        return `<div style="font-size:12px;margin-bottom:5px;"><span style="color:${info.color};font-weight:600;">${info.icon} ${info.domain}ï¼š</span>${text}</div>`;
    }).join('');

    return `
    <div class="minor-fortune-section">
        <div class="minor-fortune-title"><i class="fas fa-layer-group"></i> ä»Šæ—¥å°ç‰ŒæŒ‡å¼•</div>
        <div class="minor-fortune-cards">${chips}</div>
        <div class="minor-fortune-insight">${domainInsights}</div>
    </div>`;
}
let currentTarotSpread = 'single';

function setTarotSpread(spread) {
    currentTarotSpread = spread;
    document.querySelectorAll('.tarot-spread-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.spread === spread);
    });
    const desc = document.getElementById('tarot-spread-desc');
    if (spread === 'single') {
        if (desc) desc.textContent = 'å•å¼ ç‰Œ Â· ç›´æŒ‡å½“ä¸‹';
    } else if (spread === 'three') {
        if (desc) desc.textContent = 'ä¸‰å¼ ç‰Œ Â· æ´žå¯Ÿå…¨å±€';
    }
}

function resetTarotDivination() {
    const setup = document.getElementById('tarot-setup');
    const result = document.getElementById('tarot-result');
    const resetBtn = document.getElementById('tarot-reset-btn');
    const qInput = document.getElementById('tarot-question');
    if (setup) setup.style.display = '';
    if (result) result.style.display = 'none';
    if (resetBtn) resetBtn.style.display = 'none';
    if (qInput) qInput.value = '';
    currentTarotSpread = 'single';
    document.querySelectorAll('.tarot-spread-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.spread === 'single');
    });
    const desc = document.getElementById('tarot-spread-desc');
    if (desc) desc.textContent = 'å•å¼ ç‰Œ Â· ç›´æŒ‡å½“ä¸‹';
}

function startTarotDraw() {
    const shuffled = [...ALL_78_TAROT_CARDS].sort(() => Math.random() - 0.5);
    const question = (document.getElementById('tarot-question') || {}).value || '';
    const questionTrimmed = question.trim();
    const drawnCards = [];

    function cardHTML(card, position, labelOverride) {
        const isReversed = Math.random() > 0.5;
        const meaning = isReversed ? card.reversed : card.upright;
        const posLabel = labelOverride || position;
        const typeLabel = TAROT_TYPE_NAMES[card.type] || '';
        drawnCards.push({ name: card.name, keyword: card.keyword, position: posLabel, isReversed, meaning });
        return `
        <div class="fortune-card tarot-style" style="margin-bottom:14px;">
            <div class="tarot-header">
                <div style="font-size:10px;color:var(--text-secondary);margin-bottom:4px;">${typeLabel} ${card.num}</div>
                <div style="font-size:26px;margin:4px 0;"><i class="fas ${card.icon}" style="color:var(--accent-color);${isReversed?'transform:rotate(180deg);display:inline-block;':''}"></i></div>
                <div class="tarot-card-name">${card.name}</div>
                <div class="tarot-position-badge ${isReversed ? 'reversed' : 'upright'}" style="margin:6px auto;">${isReversed ? 'é€†ä½' : 'æ­£ä½'}</div>
            </div>
            <div class="tarot-keyword">ã€Œ${card.keyword}ã€</div>
            <div class="tarot-details">
                <div class="tarot-divider"></div>
                <p style="font-size:13px;line-height:1.7;color:var(--text-primary);">${meaning}</p>
            </div>
        </div>`;
    }

    let resultHTML = '';
    const qDisplay = questionTrimmed ? `<div class="lenormand-question-show">ã€Œ${questionTrimmed}ã€</div>` : '';
    let spreadLabel = '';

    if (currentTarotSpread === 'single') {
        spreadLabel = 'å•å¼ å¡”ç½—';
        const card = shuffled[0];
        resultHTML = `${qDisplay}
        <div style="text-align:center;font-size:12px;color:var(--text-secondary);margin-bottom:12px;"><i class="fas fa-star-and-crescent"></i> å¡”ç½—ä¸ºä½ æ­ç¤º Â· ä¸€åˆ‡çš†æœ‰ç­”æ¡ˆ</div>
        <div class="tarot-row single-card">${cardHTML(card, 'å½“ä¸‹')}</div>`;
    } else if (currentTarotSpread === 'three') {
        spreadLabel = 'ä¸‰å¼ å¡”ç½—';
        const [card1, card2, card3] = shuffled.slice(0, 3);
        resultHTML = `${qDisplay}
        <div style="text-align:center;font-size:12px;color:var(--text-secondary);margin-bottom:12px;"><i class="fas fa-star-and-crescent"></i> ä¸‰å¼ ç‰Œä¸ºä½ æ­ç¤º Â· æ´žè§èƒ½é‡æµåŠ¨</div>
        <div class="tarot-row">${cardHTML(card1, 'â… ')}${cardHTML(card2, 'â…¡')}${cardHTML(card3, 'â…¢')}</div>`;
    }

    const resultEl = document.getElementById('tarot-result');
    const setupEl = document.getElementById('tarot-setup');
    const resetBtn = document.getElementById('tarot-reset-btn');
    if (resultEl) { resultEl.innerHTML = resultHTML; resultEl.style.display = ''; }
    if (setupEl) setupEl.style.display = 'none';
    if (resetBtn) resetBtn.style.display = '';

    // Save to history
    saveDiviHistory({ type: spreadLabel, question: questionTrimmed, cards: drawnCards });
}

// Tarot spread button event delegation
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.tarot-spread-btn');
    if (!btn) return;
    setTarotSpread(btn.dataset.spread);
});
document.addEventListener('click', function(e) {
    if (e.target.id === 'close-tarot-divination') {
        const modal = document.getElementById('fortune-lenormand-modal');
        if (modal) hideModal(modal);
    }
});
// ============ End å¡”ç½—å åœ ============

// ============ å åœåŽ†å²è®°å½• ============
const DIVI_HISTORY_KEY = 'diviHistory_v1';
const DIVI_HISTORY_MAX = 50;

function getDiviHistory() {
    try { return JSON.parse(localStorage.getItem(DIVI_HISTORY_KEY) || '[]'); } catch(e) { return []; }
}

function saveDiviHistory(entry) {
    const history = getDiviHistory();
    entry.id = Date.now();
    entry.time = new Date().toLocaleString('zh-CN', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    history.unshift(entry);
    if (history.length > DIVI_HISTORY_MAX) history.splice(DIVI_HISTORY_MAX);
    localStorage.setItem(DIVI_HISTORY_KEY, JSON.stringify(history));
}

function clearDiviHistory() {
    if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å åœè®°å½•å—ï¼Ÿ')) return;
    localStorage.removeItem(DIVI_HISTORY_KEY);
    renderDiviHistory();
}

function renderDiviHistory() {
    const list = document.getElementById('divi-history-list');
    const empty = document.getElementById('divi-history-empty');
    if (!list) return;
    const history = getDiviHistory();
    if (!history.length) {
        list.innerHTML = '';
        if (empty) empty.style.display = '';
        return;
    }
    if (empty) empty.style.display = 'none';
    list.innerHTML = history.map(entry => {
        const cardTags = (entry.cards || []).map(c =>
            `<span class="divi-history-card-tag ${c.isReversed ? 'reversed' : ''}">
                ${c.isReversed ? '<i class="fas fa-arrow-down" style="font-size:9px;"></i>' : '<i class="fas fa-arrow-up" style="font-size:9px;"></i>'}
                ${c.name}${c.position ? ' Â· ' + c.position : ''}
            </span>`
        ).join('');
        const detailLines = (entry.cards || []).map(c =>
            `<div style="margin-bottom:6px;"><b>${c.name}${c.position ? ' ï¼ˆ'+c.position+'ï¼‰' : ''}${c.isReversed ? ' é€†ä½' : ' æ­£ä½'}</b><br>${c.keyword} â€” ${c.meaning}</div>`
        ).join('');
        return `
        <div class="divi-history-item">
            <div class="divi-history-meta">
                <span class="divi-history-type">${entry.type || 'å åœ'}</span>
                <span class="divi-history-time">${entry.time || ''}</span>
            </div>
            ${entry.question ? `<div class="divi-history-question">ã€Œ${entry.question}ã€</div>` : ''}
            <div class="divi-history-cards">${cardTags}</div>
            ${detailLines ? `<button class="divi-history-expand-btn" onclick="toggleDiviDetail(this)">æŸ¥çœ‹è§£è¯» â–¾</button>
            <div class="divi-history-detail">${detailLines}</div>` : ''}
        </div>`;
    }).join('');
}

function toggleDiviDetail(btn) {
    const detail = btn.nextElementSibling;
    if (!detail) return;
    const open = detail.classList.toggle('open');
    btn.textContent = open ? 'æ”¶èµ· â–´' : 'æŸ¥çœ‹è§£è¯» â–¾';
}

// Hook into switchFLTab to render history when tab is opened
const _origSwitchFLTab = switchFLTab;
window.switchFLTab = function(tab) {
    _origSwitchFLTab(tab);
    if (tab === 'divihistory') renderDiviHistory();
};

// Close button for history tab
document.addEventListener('click', function(e) {
    if (e.target.id === 'close-divihistory') {
        const modal = document.getElementById('fortune-lenormand-modal');
        if (modal) hideModal(modal);
    }
});
// ============ End å åœåŽ†å²è®°å½• ============

function toggleBatchFavoriteMode() {
            isBatchFavoriteMode = !isBatchFavoriteMode;
            selectedMessages = [];

            if (isBatchFavoriteMode) {
                document.body.classList.add('batch-favorite-mode');
                showBatchFavoriteActions();
                showNotification('æ‰¹é‡æ”¶è—æ¨¡å¼å·²å¼€å¯ï¼Œç‚¹å‡»æ¶ˆæ¯è¿›è¡Œé€‰æ‹©', 'info');
            } else {
                document.body.classList.remove('batch-favorite-mode');
                hideBatchFavoriteActions();
                showNotification('æ‰¹é‡æ”¶è—æ¨¡å¼å·²å…³é—­', 'info');
            }

            renderMessages(true);
        }

        function hideBatchFavoriteActions() {
            const actions = document.querySelector('.batch-favorite-actions');
            if (actions) {

                actions.style.animation = 'floatUpAction 0.3s reverse forwards';
                setTimeout(() => {
                    actions.remove();
                }, 300);
            }
        }


        function showBatchFavoriteActions() {

            if (document.querySelector('.batch-favorite-actions')) return;

            const actions = document.createElement('div');
            actions.className = 'batch-favorite-actions';

            actions.innerHTML = `
        <button class="batch-action-btn-pill batch-btn-cancel" id="cancel-batch-favorite">
        <i class="fas fa-times"></i> å–æ¶ˆ
        </button>
        <button class="batch-action-btn-pill batch-btn-confirm" id="confirm-batch-favorite">
        <i class="fas fa-check"></i> ç¡®è®¤æ”¶è— (0)
        </button>
        `;
            document.body.appendChild(actions);

            document.getElementById('confirm-batch-favorite').addEventListener('click', confirmBatchFavorite);
            document.getElementById('cancel-batch-favorite').addEventListener('click', toggleBatchFavoriteMode);
        }


        function confirmBatchFavorite() {
            if (selectedMessages.length === 0) {
                showNotification('è¯·å…ˆé€‰æ‹©è¦æ”¶è—çš„æ¶ˆæ¯', 'warning');
                return;
            }


            const count = selectedMessages.length;


            selectedMessages.forEach(msgId => {
                const message = messages.find(m => m.id === msgId);
                if (message) {
                    message.favorited = true;
                }
            });


            throttledSaveData();


            toggleBatchFavoriteMode();


            showNotification(`å·²æˆåŠŸæ”¶è— ${count} æ¡æ¶ˆæ¯`, 'success');
        }



        function renderAnniversaries() {
    const list = DOMElements.anniversaryModal.list;
    if (anniversaries.length === 0) {
        list.innerHTML = '<div class="no-favorites" style="padding:20px 0;"><i class="fas fa-heart" style="font-size:24px;margin-bottom:10px;"></i><p>è¿˜æ²¡æœ‰è®°å½•çºªå¿µæ—¥</p></div>';
        return;
    }

    list.innerHTML = anniversaries.map(anniversary => {
        const startDate = new Date(anniversary.date);
        const now = new Date();
        let diffDays;
        
        if (anniversary.type === 'countdown') {
            diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
            if (diffDays < 0) diffDays = 0; 
        } else {
            diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
        }

        const typeClass = anniversary.type === 'countdown' ? 'type-future' : 'type-past';
        const tagText = anniversary.type === 'countdown' ? 'å€’æ•°' : 'çºªå¿µ';

        return `
        <div class="anniversary-card ${typeClass}" data-id="${anniversary.id}">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div class="ann-info">
                    <div class="ann-name">
                        ${anniversary.name} 
                        <span class="ann-tag">${tagText}</span>
                    </div>
                    <div class="ann-date">${startDate.toLocaleDateString()}</div>
                </div>
                <div class="ann-days">
                    <span class="ann-number">${diffDays}</span>
                    <span class="ann-label">Days</span>
                </div>
            </div>
            <div class="ann-delete-btn" style="position:absolute; top:-8px; right:-8px; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; opacity:0; transition:opacity 0.2s;" 
                 onclick="deleteAnniversary(${anniversary.id}, event)">
                <i class="fas fa-times" style="font-size:12px;"></i>
            </div>
        </div>
        `;
    }).join('');
}

        function addAnniversary() {
    const nameInput = document.getElementById('ann-input-name');
    const dateInput = document.getElementById('ann-input-date');
    
    const name = (nameInput ? nameInput.value : (DOMElements.anniversaryModal.nameInput ? DOMElements.anniversaryModal.nameInput.value : '')).trim();
    const date = dateInput ? dateInput.value : (DOMElements.anniversaryModal.dateInput ? DOMElements.anniversaryModal.dateInput.value : '');

    if (!name || !date) {
        showNotification('è¯·å¡«å†™åç§°å’Œæ—¥æœŸ', 'error');
        return;
    }

    const type = (typeof currentAnnType !== 'undefined' ? currentAnnType : null) 
              || (typeof currentAnniversaryType !== 'undefined' ? currentAnniversaryType : 'anniversary');

    const newAnniversary = {
        id: Date.now(),
        name: name,
        date: date,
        type: type
    };

    anniversaries.push(newAnniversary);
    throttledSaveData();
    renderAnniversariesList();
    
    if (nameInput) nameInput.value = '';
    if (dateInput) dateInput.value = '';
    if (DOMElements.anniversaryModal.nameInput) DOMElements.anniversaryModal.nameInput.value = '';
    if (DOMElements.anniversaryModal.dateInput) DOMElements.anniversaryModal.dateInput.value = '';

    const annFormWrapper = document.getElementById('ann-form-wrapper');
    const annToggleBtn = document.getElementById('ann-toggle-btn');
    if (annFormWrapper) annFormWrapper.classList.remove('active');
    if (annToggleBtn) annToggleBtn.classList.remove('active');

    showNotification('çºªå¿µæ—¥å·²æ·»åŠ ', 'success');
}

        function showAnniversaryAnimation(anniversary) {
            const startDate = new Date(anniversary.date);
            const now = new Date();
            let diffDays;
            let title, message;

            if (anniversary.type === 'countdown') {

                diffDays = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                title = "å€’æ•°æ—¥";
                message = `è·ç¦» ${anniversary.name} è¿˜æœ‰`;
            } else {

                diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                title = "çºªå¿µæ—¥å¿«ä¹ï¼";
                message = `æˆ‘ä»¬å·²ç»ç›¸ä¼´äº†`;
            }

            DOMElements.anniversaryAnimation.title.textContent = title;
            DOMElements.anniversaryAnimation.days.textContent = diffDays;
            DOMElements.anniversaryAnimation.message.textContent = message;

            DOMElements.anniversaryAnimation.modal.classList.add('active');
        }

        function updateAnniversaryDisplay(dateString) {
            if (!dateString) return;

            const start = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - start);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            DOMElements.anniversaryModal.daysElement.textContent = diffDays;
            DOMElements.anniversaryModal.dateShowElement.textContent = `èµ·å§‹æ—¥ï¼š${start.toLocaleDateString()}`;
            DOMElements.anniversaryModal.displayArea.style.display = 'block';
        }


const MOOD_OPTIONS = [
    { key: 'happy', kaomoji: 'ðŸ˜†', label: 'å¼€å¿ƒ', color: '#FFD93D' },
    { key: 'excited', kaomoji: 'ðŸ¥°', label: 'å…´å¥‹', color: '#FF6B6B' },
    { key: 'peace', kaomoji: 'â˜ºï¸', label: 'å¹³æ·¡', color: '#6BCB77' },
    { key: 'sad', kaomoji: 'ðŸ˜•', label: 'éš¾è¿‡', color: '#4D96FF' },
    { key: 'tired', kaomoji: 'ðŸ˜ž', label: 'ç–²æƒ«', color: '#8D9EFF' },
    { key: 'angry', kaomoji: 'ðŸ˜ ', label: 'ç”Ÿæ°”', color: '#FF4757' },
    { key: 'love', kaomoji: 'ðŸ¥°', label: 'æƒ³ä½ ', color: '#FF9A8B' },
    { key: 'busy', kaomoji: 'ðŸ˜µâ€ðŸ’«', label: 'å¿™ç¢Œ', color: '#A8D8EA' },
    { key: 'sleepy', kaomoji: 'ðŸ˜´', label: 'å›°å›°', color: '#E0C3FC' },
{ key: 'lonely', kaomoji: 'ðŸ¥¹', label: 'å­¤å•', color: '#B8A9C9' }, 
{ key: 'cool', kaomoji: 'ðŸ˜Ž', label: 'æ½‡æ´’', color: '#2C3E50' },
    { key: 'cute', kaomoji: 'ðŸ¥º', label: 'æ’’å¨‡', color: '#FFB6C1' }
];

let moodData = {}; 
let currentCalendarDate = new Date();
window.selectedDateStr = null;
let selectedDateStr = null;
let currentMoodPage = 1; 
let currentMoodEditTarget = 'me'; 
let customMoodOptions = []; 
let customMoodSelectedColor = '#FFD93D';
const CUSTOM_MOOD_COLORS = ['#FFD93D','#FF6B6B','#6BCB77','#4D96FF','#8D9EFF','#FF9A8B','#A8D8EA','#E0C3FC','#B8A9C9','#2C3E50'];

async function initMoodData() {
    const savedMoods = await localforage.getItem(getStorageKey('moodCalendar'));
    if (savedMoods) { moodData = savedMoods; }
    const savedCustomMoods = await localforage.getItem(getStorageKey('customMoodOptions'));
    if (savedCustomMoods) { customMoodOptions = savedCustomMoods; }
    window.moodData = moodData;
    checkPartnerDailyMood();
}
function checkPartnerDailyMood() {
    const today = new Date();
    const dateStr = formatDateStr(today);
    
    if (!moodData[dateStr]) {
        moodData[dateStr] = {};
    }

    if (!moodData[dateStr].partner && moodData[dateStr].partnerChecked === undefined) {
        moodData[dateStr].partnerChecked = true;
        if (Math.random() < 0.20) {
            saveMoodData();
            return;
        }
        const randomMood = MOOD_OPTIONS[Math.floor(Math.random() * MOOD_OPTIONS.length)];
        moodData[dateStr].partner = randomMood.key;
        try {
            const cReplies = (typeof customReplies !== 'undefined') ? customReplies : (window._customReplies || []);
            const dDisabled = (typeof disabledDefaultReplies !== 'undefined') ? disabledDefaultReplies : (window._disabledDefaultReplies || []);
            const cConstants = (typeof CONSTANTS !== 'undefined') ? CONSTANTS : (window._CONSTANTS || { REPLY_MESSAGES: [] });
            const sourcePool = [...cReplies, ...cConstants.REPLY_MESSAGES.filter(t => !dDisabled.includes(t))];
            if (sourcePool.length > 0) {
                const count = Math.floor(Math.random() * 3) + 1;
                const chosen = [];
                const shuffled = [...sourcePool].sort(() => Math.random() - 0.5);
                for (let i = 0; i < Math.min(count, shuffled.length); i++) {
                    chosen.push(shuffled[i]);
                }
                moodData[dateStr].partnerNote = chosen.join('ã€€');
            }
        } catch(e) {  }
        saveMoodData();
    }
}
function saveMoodData() {
    localforage.setItem(getStorageKey('moodCalendar'), moodData);
    window.moodData = moodData;
    var moodModal = document.getElementById('mood-modal');
    if (moodModal && !moodModal.classList.contains('hidden') && moodModal.style.display !== 'none') {
        renderMoodCalendar();
    }
}
function saveCustomMoodOptions() {
    localforage.setItem(getStorageKey('customMoodOptions'), customMoodOptions);
}
function getAllMoodOptions() {
    return [...MOOD_OPTIONS, ...customMoodOptions];
}
function formatDateStr(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}


let currentMoodSelection = null; 
function renderMoodCalendar() {
    const grid = document.getElementById('calendar-grid');
    const monthLabel = document.getElementById('calendar-month-label');
    
    if (!grid || !monthLabel) return;

    grid.innerHTML = '';
    
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    monthLabel.textContent = `${year}å¹´ ${month + 1}æœˆ`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startDayOfWeek = firstDay.getDay(); 

    let stats = {
        me: { total: 0, counts: {} },
        partner: { total: 0, counts: {} }
    };

    for (let i = 0; i < startDayOfWeek; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        grid.appendChild(empty);
    }

    const todayStr = formatDateStr(new Date());

    for (let d = 1; d <= daysInMonth; d++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        const dateObj = new Date(year, month, d);
        const dateStr = formatDateStr(dateObj);
        
        if (dateStr === todayStr) {
            dayDiv.classList.add('today');
            dayDiv.style.borderColor = 'var(--accent-color)';
        }

        const numSpan = document.createElement('span');
        numSpan.textContent = d;
        dayDiv.appendChild(numSpan);

        const dotsContainer = document.createElement('div');
        dotsContainer.className = 'mood-dots-container';

        const dayData = moodData[dateStr];
        
        if (dayData) {
            if (dayData.user) {
                const moodObj = getAllMoodOptions().find(m => m.key === dayData.user);
                if (moodObj) {
                    stats.me.counts[moodObj.key] = (stats.me.counts[moodObj.key] || 0) + 1;
                    stats.me.total++;
                    const dot = createMoodDot(moodObj, dayData.note, false);
                    dotsContainer.appendChild(dot);
                }
            }
            if (dayData.partner) {
                const moodObj = getAllMoodOptions().find(m => m.key === dayData.partner);
                if (moodObj) {
                    stats.partner.counts[moodObj.key] = (stats.partner.counts[moodObj.key] || 0) + 1;
                    stats.partner.total++;
                    const dot = createMoodDot(moodObj, dayData.partnerNote, true); 
                    dotsContainer.appendChild(dot);
                }
            }
        }

        dayDiv.appendChild(dotsContainer);

        dayDiv.addEventListener('click', () => {
            const dayEntry = moodData[dateStr];
            if (dayEntry && (dayEntry.user || dayEntry.partner)) {
                showDayDetails(dateStr, dayEntry);
            } else {
                openMoodSelector(dateStr, 'me');
            }
        });

        grid.appendChild(dayDiv);
    }

    updateDualMoodStats(stats);
}

function createMoodDot(moodObj, note, isPartner) {
    const dot = document.createElement('div');
    dot.className = `mood-detail-dot ${isPartner ? 'partner-mood' : ''}`;
    dot.style.backgroundColor = moodObj.color;
    
    if (isPartner) {
        dot.innerHTML = `
            <span class="mood-kaomoji-span">${moodObj.kaomoji}</span>
            <span class="mood-text-span">Ta</span>
        `;
    } else {
        const displayText = (note && note.trim()) ? note : moodObj.label;
        dot.innerHTML = `
            <span class="mood-kaomoji-span">${moodObj.kaomoji}</span>
            <span class="mood-text-span" style="margin-left:2px;">${displayText}</span>
        `;
    }
    return dot;
}
function updateDualMoodStats(stats) {
    const container = document.getElementById('mood-stats-container');
    if (!container) return;

    const mName = (typeof settings !== 'undefined' && settings.myName) ? settings.myName : 'æˆ‘';
    const pName = (typeof settings !== 'undefined' && settings.partnerName) ? settings.partnerName : 'æ¢¦è§’';

    const myTotal = stats.me.total;
    const partnerTotal = stats.partner.total;
    
    const daysInMonth = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0).getDate();
    const myPercent = daysInMonth > 0 ? (myTotal / daysInMonth) * 100 : 0;
    const partnerPercent = daysInMonth > 0 ? (partnerTotal / daysInMonth) * 100 : 0;

    let myDominant = { label: 'æ— ', kaomoji: 'ðŸ˜¶', color: '#ccc' };
    let myMaxCount = 0;
    Object.keys(stats.me.counts).forEach(key => {
        if (stats.me.counts[key] > myMaxCount) {
            myMaxCount = stats.me.counts[key];
            const m = getAllMoodOptions().find(o => o.key === key);
            if (m) myDominant = m;
        }
    });

    let partnerDominant = { label: 'æ— ', kaomoji: 'ðŸ˜¶', color: '#ccc' };
    let partnerMaxCount = 0;
    Object.keys(stats.partner.counts).forEach(key => {
        if (stats.partner.counts[key] > partnerMaxCount) {
            partnerMaxCount = stats.partner.counts[key];
            const m = getAllMoodOptions().find(o => o.key === key);
            if (m) partnerDominant = m;
        }
    });
    
    const createMoodBarHTML = (moodCounts, totalCount) => {
        if (totalCount <= 0) {
            return `<div class="mood-bar-container" style="justify-content: center; align-items: center; font-size: 10px; color: var(--text-secondary); background: var(--message-received-bg);">æ— æ•°æ®</div>`;
        }

        const segments = Object.keys(moodCounts)
            .map(key => {
                const count = moodCounts[key];
                const moodObj = getAllMoodOptions().find(m => m.key === key);
                if (moodObj) {
                    const percentage = (count / totalCount) * 100;
                    return `<div class="mood-bar-segment" style="width: ${percentage}%; background-color: ${moodObj.color};" title="${moodObj.label}: ${count}å¤©"></div>`;
                }
                return ''; 
            })
            .join(''); 
        return `<div class="mood-bar-container">${segments}</div>`;
    };

    const myBarHTML = createMoodBarHTML(stats.me.counts, myTotal);
    const partnerBarHTML = createMoodBarHTML(stats.partner.counts, partnerTotal);

    var todayStr = formatDateStr(new Date());
    var todayEntry = moodData[todayStr] || {};
    var myWeatherVal = todayEntry.myWeather || '';
    var partnerWeatherVal = todayEntry.partnerWeather || '';

    container.innerHTML = `
        <div class="mood-circles-wrapper" style="margin-bottom:20px;">
            <div class="mood-circle-item">
                <div class="mood-circle" style="--percent: ${myPercent}%">
                    <span class="mood-circle-text" style="color:var(--accent-color)">${myTotal}</span>
                </div>
                <div class="mood-circle-label">
                    <span class="mood-marker me" style="width:8px;height:8px;"></span> ${mName}
                </div>
                <div class="stats-weather-tag" onclick="editStatsWeather(this,'me')" title="ç‚¹å‡»ç¼–è¾‘å¤©æ°”">
                    ${myWeatherVal ? `<span>${myWeatherVal}</span>` : `<span style="opacity:0.4;">+ å¤©æ°”</span>`}
                </div>
            </div>
            <div class="mood-circle-item">
                <div class="mood-circle" style="--percent: ${partnerPercent}%; --accent-color: #ff6b6b;">
                    <span class="mood-circle-text" style="color:#ff6b6b">${partnerTotal}</span>
                </div>
                <div class="mood-circle-label">
                    <span class="mood-marker partner" style="width:8px;height:8px;"></span> ${pName}
                </div>
                <div class="stats-weather-tag" onclick="editStatsWeather(this,'partner')" title="ç‚¹å‡»ç¼–è¾‘å¤©æ°”">
                    ${partnerWeatherVal ? `<span>${partnerWeatherVal}</span>` : `<span style="opacity:0.4;">+ å¤©æ°”</span>`}
                </div>
            </div>
        </div>

        <div class="mood-stat-group">
            <div class="mood-stat-title">
                <span>æˆ‘çš„å¿ƒæƒ…</span>
                <div class="dominant-mood-tag">
                    <span style="color:${myDominant.color}; font-weight:bold;">${myDominant.kaomoji} ${myDominant.label}</span>
                </div>
            </div>
            <div style="font-size:11px; color:var(--text-secondary); display:flex; justify-content:space-between;">
                <span>è®°å½•å¤©æ•°: ${myTotal}</span>
            </div>
            ${myBarHTML}
        </div>

        <div class="mood-stat-group">
            <div class="mood-stat-title">
                <span>${pName}çš„å¿ƒæƒ…</span>
                <div class="dominant-mood-tag">
                    <span style="color:${partnerDominant.color}; font-weight:bold;">${partnerDominant.kaomoji} ${partnerDominant.label}</span>
                </div>
            </div>
            <div style="font-size:11px; color:var(--text-secondary); display:flex; justify-content:space-between;">
                <span>è®°å½•å¤©æ•°: ${partnerTotal}</span>
            </div>
            ${partnerBarHTML}
        </div>
    `;
}

window.editStatsWeather = function(el, who) {
    if (el.querySelector('input')) return;
    var todayStr = formatDateStr(new Date());
    if (!moodData[todayStr]) moodData[todayStr] = {};
    var current = who === 'me' ? (moodData[todayStr].myWeather || '') : (moodData[todayStr].partnerWeather || '');
    var input = document.createElement('input');
    input.type = 'text';
    input.value = current;
    input.maxLength = 20;
    input.placeholder = 'ä»Šæ—¥å¤©æ°”â€¦';
    input.style.cssText = 'width:100%;padding:3px 7px;border:1px solid var(--accent-color);border-radius:8px;font-size:12px;background:var(--primary-bg);color:var(--text-primary);outline:none;text-align:center;';
    el.innerHTML = '';
    el.appendChild(input);
    input.focus(); input.select();
    function save() {
        var val = input.value.trim();
        if (who === 'me') moodData[todayStr].myWeather = val;
        else moodData[todayStr].partnerWeather = val;
        saveMoodData();
        el.innerHTML = val ? `<span>${val}</span>` : `<span style="opacity:0.4;">+ å¤©æ°”</span>`;
    }
    input.addEventListener('blur', save);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); save(); }
        if (e.key === 'Escape') { el.innerHTML = current ? `<span>${current}</span>` : `<span style="opacity:0.4;">+ å¤©æ°”</span>`; }
    });
};

window.deleteDailyMood = function(dateStr, who) {
    if (!moodData[dateStr]) return;
    if (who === 'me') { delete moodData[dateStr].user; delete moodData[dateStr].note; delete moodData[dateStr].myWeather; }
    else { delete moodData[dateStr].partner; delete moodData[dateStr].partnerNote; delete moodData[dateStr].partnerWeather; }
    if (!moodData[dateStr].user && !moodData[dateStr].partner) delete moodData[dateStr];
    saveMoodData();
    renderMoodCalendar();
    showNotification('å·²åˆ é™¤å¿ƒæƒ…è®°å½•', 'success');
    closeMoodOverlay();
};

function renderMoodOptionsGrid(targetKey) {
    const allMoods = getAllMoodOptions();
    const optionsGrid = document.getElementById('mood-options-grid');
    optionsGrid.innerHTML = allMoods.map(mood => {
        const isSelected = targetKey === mood.key;
        const isCustom = mood.key.startsWith('custom_');
        return `
        <div class="mood-option-btn${isCustom ? ' mood-option-custom' : ''}" 
             style="${isSelected ? `background:${mood.color}; color:#fff; border-color:${mood.color}; transform:scale(1.05); box-shadow:0 4px 10px rgba(0,0,0,0.15);` : ''}"
             onclick="tempSelectMood('${mood.key}')">
            <div class="mood-kaomoji" style="${isSelected ? 'color:#fff' : `color:${mood.color}`}">${mood.kaomoji}</div>
            <div class="mood-label">${mood.label}</div>
            ${isCustom ? `<div class="mood-custom-actions" onclick="event.stopPropagation()">
                <button class="mood-custom-action-btn" onclick="editCustomMood('${mood.key}')" title="ç¼–è¾‘">âœï¸</button>
                <button class="mood-custom-action-btn" onclick="deleteCustomMood('${mood.key}')" title="åˆ é™¤">ðŸ—‘</button>
            </div>` : ''}
        </div>
    `}).join('');
}

function switchMoodPage(dir) {
    currentMoodPage = Math.max(1, Math.min(2, currentMoodPage + dir));
    const page1 = document.getElementById('mood-page-1');
    const page2 = document.getElementById('mood-page-2');
    const indicator = document.getElementById('mood-page-indicator');
    const prevBtn = document.getElementById('mood-page-prev');
    const nextBtn = document.getElementById('mood-page-next');
    if (currentMoodPage === 1) {
        page1.style.display = 'block'; page2.style.display = 'none';
        indicator.textContent = 'ç¬¬ 1 é¡µ Â· å¿ƒæƒ…';
        prevBtn.disabled = true; nextBtn.disabled = false;
    } else {
        page1.style.display = 'none'; page2.style.display = 'block';
        const isPartner = currentMoodEditTarget === 'partner';
        indicator.textContent = 'ç¬¬ 2 é¡µ Â· éšè®°';
        document.getElementById('mood-note-label').textContent = isPartner ? 'å¯¹æ–¹éšè®°:' : 'éšè®°:';
        document.getElementById('mood-note-input').placeholder = isPartner ? 'è®°å½•å¯¹æ–¹ä»Šå¤©å‘ç”Ÿçš„äº‹...' : 'è®°å½•ä¸‹ä»Šå¤©å‘ç”Ÿçš„å°äº‹...';
        prevBtn.disabled = false; nextBtn.disabled = true;
    }
}
window.switchMoodPage = switchMoodPage;

function switchMoodEditTarget(target) {
    currentMoodEditTarget = target;
    document.getElementById('mood-tab-me').classList.toggle('active', target === 'me');
    document.getElementById('mood-tab-partner').classList.toggle('active', target === 'partner');
    const existing = moodData[selectedDateStr];
    let currentKey, noteVal;
    if (target === 'me') {
        currentKey = existing ? existing.user : null;
        noteVal = (existing && existing.note) ? existing.note : '';
    } else {
        currentKey = existing ? existing.partner : null;
        noteVal = (existing && existing.partnerNote) ? existing.partnerNote : '';
    }
    currentMoodSelection = currentKey;
    document.getElementById('mood-note-input').value = noteVal;
    renderMoodOptionsGrid(currentKey);
    switchMoodPage(0); 
}
window.switchMoodEditTarget = switchMoodEditTarget;

function openMoodSelector(dateStr, editTarget) {
    selectedDateStr = dateStr;
    window.selectedDateStr = dateStr;
    currentMoodEditTarget = editTarget || 'me';
    currentMoodPage = 1;
    currentMoodSelection = null;

    const overlay = document.getElementById('mood-selector-overlay');
    const editorView = document.getElementById('mood-editor-view');
    const detailView = document.getElementById('mood-detail-view');
    const dateTitle = document.getElementById('mood-selector-date');

    if (window._moodOverlayRafId) {
        cancelAnimationFrame(window._moodOverlayRafId);
        window._moodOverlayRafId = null;
    }

    overlay.classList.remove('active');
    
    editorView.style.display = 'block';
    if (detailView) detailView.style.display = 'none';

    const [y, m, d] = dateStr.split('-');
    dateTitle.textContent = `${m}æœˆ${d}æ—¥`;

    document.getElementById('mood-tab-me').classList.toggle('active', currentMoodEditTarget === 'me');
    document.getElementById('mood-tab-partner').classList.toggle('active', currentMoodEditTarget === 'partner');

    const existing = moodData[dateStr];
    let currentKey, noteVal, weatherVal;
    if (currentMoodEditTarget === 'me') {
        currentKey = existing ? existing.user : null;
        noteVal = (existing && existing.note) ? existing.note : '';
        weatherVal = (existing && existing.myWeather) ? existing.myWeather : '';
    } else {
        currentKey = existing ? existing.partner : null;
        noteVal = (existing && existing.partnerNote) ? existing.partnerNote : '';
        weatherVal = (existing && existing.partnerWeather) ? existing.partnerWeather : '';
    }
    currentMoodSelection = currentKey;
    document.getElementById('mood-note-input').value = noteVal;
    const weatherInput = document.getElementById('mood-weather-input');
    if (weatherInput) weatherInput.value = weatherVal;
    const weatherLabel = document.getElementById('mood-weather-label');
    if (weatherLabel) {
        var pNameW = (typeof settings !== 'undefined' && settings.partnerName) ? settings.partnerName : 'æ¢¦è§’';
        var mNameW = (typeof settings !== 'undefined' && settings.myName) ? settings.myName : 'æˆ‘';
        if (weatherLabel.firstChild) weatherLabel.firstChild.textContent = currentMoodEditTarget === 'me' ? mNameW + 'çš„å¤©æ°”\u00a0' : pNameW + 'çš„å¤©æ°”\u00a0';
    }

    document.getElementById('mood-page-1').style.display = 'block';
    document.getElementById('mood-page-2').style.display = 'none';
    document.getElementById('mood-page-indicator').textContent = 'ç¬¬ 1 é¡µ Â· å¿ƒæƒ…';
    document.getElementById('mood-page-prev').disabled = true;
    document.getElementById('mood-page-next').disabled = false;

    renderMoodOptionsGrid(currentKey);
    window._moodOverlayRafId = requestAnimationFrame(() => {
        window._moodOverlayRafId = null;
        overlay.classList.add('active');
    });
}

window.editPartnerMoodRecord = function() {
    openMoodSelector(selectedDateStr, 'partner');
};

window.tempSelectMood = function(key) {
    currentMoodSelection = key;
    renderMoodOptionsGrid(key);
}

document.getElementById('confirm-mood-save').addEventListener('click', () => {
    if (!selectedDateStr) return;
    if (!currentMoodSelection && currentMoodPage === 1) {
        showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¿ƒæƒ…å›¾æ ‡', 'warning');
        return;
    }
    if (!moodData[selectedDateStr]) moodData[selectedDateStr] = {};
    const weatherVal = (document.getElementById('mood-weather-input') || {}).value || '';
    if (currentMoodEditTarget === 'me') {
        if (currentMoodSelection) moodData[selectedDateStr].user = currentMoodSelection;
        moodData[selectedDateStr].note = document.getElementById('mood-note-input').value.trim();
        moodData[selectedDateStr].myWeather = weatherVal.trim();
    } else {
        if (currentMoodSelection) moodData[selectedDateStr].partner = currentMoodSelection;
        moodData[selectedDateStr].partnerNote = document.getElementById('mood-note-input').value.trim();
        moodData[selectedDateStr].partnerWeather = weatherVal.trim();
    }
    
    saveMoodData();
    closeMoodOverlay();
    showNotification('è®°å½•å·²ä¿å­˜ âœ¦', 'success');
});

function showDayDetails(dateStr, data) {
    selectedDateStr = dateStr;
    window.selectedDateStr = dateStr;
    const overlay = document.getElementById('mood-selector-overlay');
    const editorView = document.getElementById('mood-editor-view');
    const detailView = document.getElementById('mood-detail-view');
    
    const allMoods = getAllMoodOptions();
    const moodObj = allMoods.find(m => m.key === data.user);

    const [y, m, d] = dateStr.split('-');
    document.getElementById('detail-date').textContent = `${m}æœˆ${d}æ—¥`;

    const mySection = document.getElementById('detail-my-section');
    if (moodObj) {
        mySection.style.display = 'block';
        document.getElementById('detail-kaomoji').textContent = moodObj.kaomoji;
        document.getElementById('detail-label').textContent = moodObj.label;
        document.getElementById('detail-label').style.color = moodObj.color;
        document.getElementById('detail-text').textContent = data.note || "ï¼ˆè¿™å¤©æ²¡æœ‰å†™ä¸‹éšè®°...ï¼‰";
        detailView.style.borderLeftColor = moodObj.color;
        const myWeatherEl = document.getElementById('detail-my-weather');
        if (myWeatherEl) {
            if (data.myWeather) { myWeatherEl.style.display = 'block'; document.getElementById('detail-my-weather-val').textContent = data.myWeather; }
            else myWeatherEl.style.display = 'none';
        }
    } else {
        mySection.style.display = 'none';
    }

    const partnerSection = document.getElementById('detail-partner-section');
    const partnerNoRecord = document.getElementById('detail-partner-no-record');
    if (data.partner) {
        const partnerMoodObj = allMoods.find(mo => mo.key === data.partner);
        if (partnerMoodObj) {
            partnerSection.style.display = 'block';
            if (partnerNoRecord) partnerNoRecord.style.display = 'none';
            document.getElementById('detail-partner-kaomoji').textContent = partnerMoodObj.kaomoji;
            document.getElementById('detail-partner-label').textContent = partnerMoodObj.label;
            document.getElementById('detail-partner-label').style.color = partnerMoodObj.color;
            document.getElementById('detail-partner-text').textContent = data.partnerNote || "ï¼ˆTa è¿™å¤©æ²¡æœ‰å†™ä¸‹ä»»ä½•éšè®°ï¼‰";
            const partnerWeatherEl = document.getElementById('detail-partner-weather');
            if (partnerWeatherEl) {
                if (data.partnerWeather) { partnerWeatherEl.style.display = 'block'; document.getElementById('detail-partner-weather-val').textContent = data.partnerWeather; }
                else partnerWeatherEl.style.display = 'none';
            }
        } else {
            partnerSection.style.display = 'none';
            if (partnerNoRecord) partnerNoRecord.style.display = 'none';
        }
    } else {
        partnerSection.style.display = 'none';
        if (partnerNoRecord) partnerNoRecord.style.display = 'block';
    }

    editorView.style.display = 'none';
    detailView.style.display = 'block';
    overlay.classList.add('active');
}

document.getElementById('edit-existing-mood').addEventListener('click', () => {
    const editorView = document.getElementById('mood-editor-view');
    const detailView = document.getElementById('mood-detail-view');
    openMoodSelector(selectedDateStr, 'me');
    editorView.style.display = 'block';
    detailView.style.display = 'none';
});

window.closeMoodOverlay = function() {
    if (window._moodOverlayRafId) {
        cancelAnimationFrame(window._moodOverlayRafId);
        window._moodOverlayRafId = null;
    }
    const overlay = document.getElementById('mood-selector-overlay');
    if(overlay) {
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.25s ease';
        setTimeout(() => {
            overlay.classList.remove('active');
            overlay.style.opacity = '';
            overlay.style.transition = '';
            const customDialog = document.getElementById('custom-mood-dialog');
            if(customDialog) customDialog.style.display = 'none';
        }, 250);
    }
};
window.viewMoodDetailFromEditor = function() {
    if (!selectedDateStr || !moodData[selectedDateStr]) return;
    showDayDetails(selectedDateStr, moodData[selectedDateStr]);
};
document.getElementById('cancel-mood-edit').addEventListener('click', closeMoodOverlay);

window.openCustomMoodDialog = function() {
    const dialog = document.getElementById('custom-mood-dialog');
    document.getElementById('custom-mood-emoji').value = '';
    document.getElementById('custom-mood-label').value = '';
    customMoodSelectedColor = CUSTOM_MOOD_COLORS[0];
    const colorsEl = document.getElementById('custom-mood-colors');
    colorsEl.innerHTML = CUSTOM_MOOD_COLORS.map((c,i) => 
        `<div class="custom-mood-color-dot ${i===0?'selected':''}" style="background:${c};" onclick="selectCustomColor('${c}',this)"></div>`
    ).join('');
    const saveBtn = dialog.querySelector('.modal-btn-primary');
    saveBtn.onclick = window.saveCustomMood;
    dialog.style.display = 'block';
};
window.selectCustomColor = function(color, el) {
    customMoodSelectedColor = color;
    document.querySelectorAll('.custom-mood-color-dot').forEach(d => d.classList.remove('selected'));
    el.classList.add('selected');
};
window.closeCustomMoodDialog = function() {
    document.getElementById('custom-mood-dialog').style.display = 'none';
};
window.saveCustomMood = function() {
    const emoji = document.getElementById('custom-mood-emoji').value.trim();
    const label = document.getElementById('custom-mood-label').value.trim();
    if (!emoji || !label) { showNotification('è¯·å¡«å†™è¡¨æƒ…å’Œåç§°', 'warning'); return; }
    const key = 'custom_' + Date.now();
    customMoodOptions.push({ key, kaomoji: emoji, label, color: customMoodSelectedColor });
    saveCustomMoodOptions();
    closeCustomMoodDialog();
    renderMoodOptionsGrid(currentMoodSelection);
    showNotification('è‡ªå®šä¹‰å¿ƒæƒ…å·²æ·»åŠ  âœ¦', 'success');
};

window.deleteCustomMood = function(key) {
    customMoodOptions = customMoodOptions.filter(m => m.key !== key);
    saveCustomMoodOptions();
    renderMoodOptionsGrid(currentMoodSelection);
    showNotification('å·²åˆ é™¤è‡ªå®šä¹‰å¿ƒæƒ…', 'success');
};

window.editCustomMood = function(key) {
    const mood = customMoodOptions.find(m => m.key === key);
    if (!mood) return;
    const dialog = document.getElementById('custom-mood-dialog');
    document.getElementById('custom-mood-emoji').value = mood.kaomoji;
    document.getElementById('custom-mood-label').value = mood.label;
    customMoodSelectedColor = mood.color;
    const colorsEl = document.getElementById('custom-mood-colors');
    colorsEl.innerHTML = CUSTOM_MOOD_COLORS.map((c) => 
        `<div class="custom-mood-color-dot ${c===mood.color?'selected':''}" style="background:${c};" onclick="selectCustomColor('${c}',this)"></div>`
    ).join('');
    dialog.style.display = 'block';
    dialog._editingKey = key;
    const saveBtn = dialog.querySelector('.modal-btn-primary');
    saveBtn.onclick = function() {
        const emoji = document.getElementById('custom-mood-emoji').value.trim();
        const label = document.getElementById('custom-mood-label').value.trim();
        if (!emoji || !label) { showNotification('è¯·å¡«å†™è¡¨æƒ…å’Œåç§°', 'warning'); return; }
        const idx = customMoodOptions.findIndex(m => m.key === key);
        if (idx !== -1) customMoodOptions[idx] = { key, kaomoji: emoji, label, color: customMoodSelectedColor };
        saveCustomMoodOptions();
        closeCustomMoodDialog();
        saveBtn.onclick = null;
        renderMoodOptionsGrid(currentMoodSelection);
        showNotification('è‡ªå®šä¹‰å¿ƒæƒ…å·²æ›´æ–° âœ¦', 'success');
    };
};

function initMoodListeners() {
    const btnCalendar = document.getElementById('btn-view-calendar');
    const btnStats = document.getElementById('btn-view-stats');
    const viewCalendar = document.getElementById('mood-calendar-view');
    const viewStats = document.getElementById('mood-stats-view');

    if (btnCalendar && !btnCalendar.dataset.initialized) {
        btnCalendar.dataset.initialized = 'true';
        btnCalendar.addEventListener('click', () => {
            btnCalendar.classList.add('active');
            btnStats.classList.remove('active');
            viewCalendar.classList.remove('hidden-view');
            viewStats.classList.add('hidden-view');
        });
    }

    if (btnStats && !btnStats.dataset.initialized) {
        btnStats.dataset.initialized = 'true';
        btnStats.addEventListener('click', () => {
            btnStats.classList.add('active');
            btnCalendar.classList.remove('active');
            viewStats.classList.remove('hidden-view');
            viewCalendar.classList.add('hidden-view');
            renderMoodCalendar(); 
        });
    }

    const entryBtn = document.getElementById('mood-function');
    const modal = document.getElementById('mood-modal');
    
    if (entryBtn && !entryBtn.dataset.initialized) {
        entryBtn.dataset.initialized = 'true';
        const newBtn = entryBtn.cloneNode(true);
        entryBtn.parentNode.replaceChild(newBtn, entryBtn);
        
        newBtn.addEventListener('click', () => {
            if (typeof window.updateDynamicNames === 'function') window.updateDynamicNames();
            const advModal = document.getElementById('advanced-modal');
            if (advModal) hideModal(advModal); 
            setTimeout(() => {
                renderMoodCalendar();
                showModal(modal);
            }, 150); 
        });
    }

    const closeMoodBtn = document.getElementById('close-mood');
    if (closeMoodBtn && !closeMoodBtn.dataset.initialized) {
        closeMoodBtn.dataset.initialized = 'true';
        closeMoodBtn.addEventListener('click', () => hideModal(modal));
    }
    
    const cancelMoodBtn = document.getElementById('cancel-mood-edit');
    if (cancelMoodBtn && !cancelMoodBtn.dataset.initialized) {
        cancelMoodBtn.dataset.initialized = 'true';
        cancelMoodBtn.addEventListener('click', closeMoodOverlay);
    }

    const overlay = document.getElementById('mood-selector-overlay');
    if (overlay && !overlay.dataset.initialized) {
        overlay.dataset.initialized = 'true';
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeMoodOverlay();
            }
        });
    }

    const prevMonthBtn = document.getElementById('prev-month');
    if (prevMonthBtn && !prevMonthBtn.dataset.initialized) {
        prevMonthBtn.dataset.initialized = 'true';
        prevMonthBtn.addEventListener('click', () => {
            const y = currentCalendarDate.getFullYear();
            const m = currentCalendarDate.getMonth();
            currentCalendarDate = new Date(y, m - 1, 1);
            renderMoodCalendar();
        });
    }
    
    const nextMonthBtn = document.getElementById('next-month');
    if (nextMonthBtn && !nextMonthBtn.dataset.initialized) {
        nextMonthBtn.dataset.initialized = 'true';
        nextMonthBtn.addEventListener('click', () => {
            const y = currentCalendarDate.getFullYear();
            const m = currentCalendarDate.getMonth();
            currentCalendarDate = new Date(y, m + 1, 1);
            renderMoodCalendar();
        });
    }
}
let envelopeData = { outbox: [], inbox: [] }; 
let currentEnvTab = 'outbox';
let editingEnvId = null; 
let editingEnvSection = null; 

async function loadEnvelopeData() {
    const saved = await localforage.getItem(getStorageKey('envelopeData'));
    if (saved) envelopeData = saved;
    const oldPending = await localforage.getItem(getStorageKey('pending_envelope'));
    if (oldPending && envelopeData.outbox.length === 0) {
        envelopeData.outbox.push({
            id: 'legacy_' + Date.now(),
            content: 'ï¼ˆåŽ†å²å¯„å‡ºçš„ä¿¡ä»¶ï¼‰',
            sentTime: oldPending.sentTime,
            replyTime: oldPending.replyTime,
            status: 'pending'
        });
        await localforage.removeItem(getStorageKey('pending_envelope'));
        saveEnvelopeData();
    }
}

function saveEnvelopeData() {
    localforage.setItem(getStorageKey('envelopeData'), envelopeData);
}

async function checkEnvelopeStatus() {
    await loadEnvelopeData();
    const now = Date.now();
    let changed = false;
    let newReplyLetter = null;
    envelopeData.outbox.forEach(letter => {
        if (letter.status === 'pending' && now >= letter.replyTime) {
            letter.status = 'replied';
            const replyContent = generateEnvelopeReplyText();
            const replyId = 'reply_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
            const inboxLetter = {
                id: replyId,
                refId: letter.id,
                originalContent: letter.content,
                content: replyContent,
                receivedTime: Date.now(),
                isNew: true
            };
            envelopeData.inbox.push(inboxLetter);
            newReplyLetter = inboxLetter;
            changed = true;
            playSound('message');
        }
    });
    if (changed) {
        saveEnvelopeData();
        if (newReplyLetter) showEnvelopeReplyPopup(newReplyLetter);
    }
}

function showEnvelopeReplyPopup(letter) {
    const existing = document.getElementById('envelope-reply-popup');
    if (existing) existing.remove();
    const popup = document.createElement('div');
    popup.id = 'envelope-reply-popup';
    popup.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--secondary-bg);border:1px solid var(--border-color);border-radius:20px;padding:18px 20px;z-index:8000;max-width:320px;width:88%;box-shadow:0 8px 32px rgba(0,0,0,0.18);display:flex;flex-direction:column;gap:12px;animation:slideUpNotif 0.4s cubic-bezier(0.22,1,0.36,1);';
    popup.innerHTML = `
        <style>@keyframes slideUpNotif{from{opacity:0;transform:translateX(-50%) translateY(24px) scale(0.9)}60%{transform:translateX(-50%) translateY(-4px) scale(1.02)}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}</style>
        <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:26px;">ðŸ’Œ</span>
            <div>
                <div style="font-size:14px;font-weight:700;color:var(--text-primary);">æ”¶åˆ°äº†ä¸€å°å›žä¿¡</div>
                <div style="font-size:11px;color:var(--text-secondary);margin-top:2px;opacity:0.8;">Ta ç»™ä½ å†™äº†å›žä¿¡ï¼Œå¿«åŽ»çœ‹çœ‹å§~</div>
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button onclick="document.getElementById('envelope-reply-popup').remove();" style="flex:1;padding:8px 0;border-radius:12px;border:1px solid var(--border-color);background:var(--primary-bg);color:var(--text-secondary);font-size:13px;cursor:pointer;">ç¨åŽæŸ¥çœ‹</button>
            <button onclick="openEnvelopeAndViewReply('${letter.id}');" style="flex:2;padding:8px 0;border-radius:12px;border:none;background:var(--accent-color);color:#fff;font-size:13px;font-weight:600;cursor:pointer;">ç«‹å³é˜…è¯» âœ‰</button>
        </div>`;
    document.body.appendChild(popup);
    setTimeout(() => { if (popup.parentNode) popup.remove(); }, 8000);
}

const APPEARANCE_PANEL_TITLES = {
    'theme': 'ä¸»é¢˜é…è‰²', 'font': 'å­—ä½“è®¾ç½®', 'background': 'èŠå¤©èƒŒæ™¯',
    'bubble': 'æ°”æ³¡æ ·å¼', 'avatar': 'èŠå¤©å¤´åƒ', 'css': 'è‡ªå®šä¹‰CSS',
    'font-bg': 'èƒŒæ™¯ & å­—ä½“', 'bubble-css': 'æ°”æ³¡ & CSS'
};
window.showAppearancePanel = function(panel) {
    const panelMap = {
        'font-bg': ['font', 'background'],
        'bubble-css': ['bubble', 'css']
    };
    document.getElementById('appearance-nav-grid').style.display = 'none';
    var unBtn = document.getElementById('update-notice-btn');
    if (unBtn) unBtn.style.display = 'none';
    document.getElementById('appearance-panel-container').style.display = 'block';
    document.getElementById('appearance-panel-title').textContent = APPEARANCE_PANEL_TITLES[panel] || panel;
    document.querySelectorAll('.appearance-sub-panel').forEach(p => p.style.display = 'none');
    if (panelMap[panel]) {
        panelMap[panel].forEach(sub => {
            const target = document.getElementById('appearance-panel-' + sub);
            if (target) target.style.display = 'block';
        });
    } else {
        const target = document.getElementById('appearance-panel-' + panel);
        if (target) target.style.display = 'block';
    }
    if (panel === 'bubble' || panel === 'bubble-css') { setTimeout(() => { if (typeof window.updateBubblePreviewFn === 'function') window.updateBubblePreviewFn(); }, 50); }
};
window.hideAppearancePanel = function() {
    document.getElementById('appearance-nav-grid').style.display = 'grid';
    document.getElementById('appearance-panel-container').style.display = 'none';
    document.querySelectorAll('.appearance-sub-panel').forEach(p => p.style.display = 'none');
    var unBtn = document.getElementById('update-notice-btn');
    if (unBtn) unBtn.style.display = 'flex';
};

window.openEnvelopeAndViewReply = function(replyId) {
    const popup = document.getElementById('envelope-reply-popup');
    if (popup) popup.remove();
    const envelopeModal = document.getElementById('envelope-modal');
    showModal(envelopeModal);
    setTimeout(() => {
        switchEnvTab('inbox');
        viewEnvLetter('inbox', replyId);
    }, 200);
};

function generateEnvelopeReplyText() {
    const sourcePool = [...customReplies, ...CONSTANTS.REPLY_MESSAGES.filter(t => !disabledDefaultReplies.includes(t))];
    const sentenceCount = Math.floor(Math.random() * (12 - 8 + 1)) + 8;
    let replyContent = "";
    for (let i = 0; i < sentenceCount; i++) {
        const randomSentence = sourcePool[Math.floor(Math.random() * sourcePool.length)];
        const punctuation = Math.random() < 0.2 ? "ï¼" : (Math.random() < 0.2 ? "..." : "ã€‚");
        replyContent += randomSentence + punctuation;
    }
    return replyContent;
}



window.switchEnvTab = function(tab) {
    currentEnvTab = tab;
    document.getElementById('env-tab-outbox').classList.toggle('active', tab === 'outbox');
    document.getElementById('env-tab-inbox').classList.toggle('active', tab === 'inbox');
    document.getElementById('env-outbox-section').style.display = tab === 'outbox' ? 'block' : 'none';
    document.getElementById('env-inbox-section').style.display = tab === 'inbox' ? 'block' : 'none';
    document.getElementById('env-compose-form').style.display = 'none';
    document.getElementById('env-main-close-btn').style.display = 'flex';
    renderEnvelopeLists();
};

function renderEnvelopeLists() {
    renderOutboxList();
    renderInboxList();
    const pendingCount = envelopeData.outbox.filter(l => l.status === 'pending').length;
    const newInboxCount = envelopeData.inbox.filter(l => l.isNew).length;
    const outboxBadge = document.getElementById('env-outbox-badge');
    const inboxBadge = document.getElementById('env-inbox-badge');
    if (outboxBadge) { outboxBadge.textContent = pendingCount; outboxBadge.style.display = pendingCount > 0 ? 'inline-block' : 'none'; }
    if (inboxBadge) { inboxBadge.textContent = newInboxCount; inboxBadge.style.display = newInboxCount > 0 ? 'inline-block' : 'none'; }
    const envelopeEntryBadge = document.getElementById('env-entry-badge');
    if (envelopeEntryBadge) { envelopeEntryBadge.style.display = newInboxCount > 0 ? 'inline-block' : 'none'; }
}

function renderOutboxList() {
    const list = document.getElementById('env-outbox-list');
    if (!list) return;
    if (envelopeData.outbox.length === 0) {
        list.innerHTML = `<div class="env-empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
            <div style="font-size:14px;font-weight:500;margin-top:4px;">è¿˜æ²¡æœ‰å¯„å‡ºä»»ä½•ä¿¡ä»¶</div>
            <div style="font-size:12px;margin-top:6px;opacity:0.6;">æç¬”å†™ä¸‹å¿ƒæ„ï¼Œå¯„é€ç»™Taå§~</div>
        </div>`;
        return;
    }
    list.innerHTML = envelopeData.outbox.slice().reverse().map(letter => {
        const date = new Date(letter.sentTime).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
        const isPending = letter.status === 'pending';
        const replyTime = isPending ? new Date(letter.replyTime).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '';
        const statusIcon = isPending
            ? `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`
            : `<svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
        const statusText = isPending ? `${statusIcon} é¢„è®¡ ${replyTime} å›žä¿¡` : `${statusIcon} å·²æ”¶åˆ°å›žä¿¡`;
        const preview = letter.content.length > 38 ? letter.content.substring(0, 38) + 'â€¦' : letter.content;
        return `
        <div class="env-letter-item" onclick="viewEnvLetter('outbox','${letter.id}')">
            <div class="env-letter-header">
                <div class="env-letter-header-from">
                    <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:3px;"><path d="M22 2L11 13"/><path d="M22 2L15 22 11 13 2 9l20-7z"/></svg>
                    å¯„å‡º Â· ${date}
                </div>
                <div class="env-stamp">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                </div>
            </div>
            <div class="env-letter-body">
                <div class="env-letter-preview">${preview}</div>
                <div class="env-letter-status">${statusText}</div>
            </div>
            <button class="env-letter-delete-btn" onclick="deleteEnvLetter(event,'outbox','${letter.id}')">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>`;
    }).join('');
}

function renderInboxList() {
    const list = document.getElementById('env-inbox-list');
    if (!list) return;
    if (envelopeData.inbox.length === 0) {
        list.innerHTML = `<div class="env-empty">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/><polyline points="22 13 12 13"/><path d="M19 16l-5-3-5 3"/></svg>
            <div style="font-size:14px;font-weight:500;margin-top:4px;">è¿˜æ²¡æœ‰æ”¶åˆ°å›žä¿¡</div>
            <div style="font-size:12px;margin-top:6px;opacity:0.6;">å¯¹æ–¹æ­£åœ¨è®¤çœŸå›žå¤ä¸­ï¼Œè¯·ç¨å€™~</div>
        </div>`;
        return;
    }
    list.innerHTML = envelopeData.inbox.slice().reverse().map(letter => {
        const date = new Date(letter.receivedTime).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
        const preview = letter.content.length > 50 ? letter.content.substring(0, 50) + 'â€¦' : letter.content;
        const isNew = letter.isNew;
        return `
        <div class="env-letter-item reply ${isNew ? 'env-letter-new' : ''}" onclick="viewEnvLetter('inbox','${letter.id}')">
            <div class="env-letter-header">
                <div class="env-letter-header-from">
                    <svg width="9" height="9" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-1px;margin-right:3px;"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 7l-10 7L2 7"/></svg>
                    æ”¶åˆ° Â· ${date}
                    ${isNew ? '<span style="background:rgba(255,255,255,0.3);color:#fff;font-size:9px;padding:1px 5px;border-radius:6px;margin-left:6px;">æ–°</span>' : ''}
                </div>
                <div class="env-stamp">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                </div>
            </div>
            <div class="env-letter-body">
                <div class="env-letter-preview">${preview}</div>
            </div>
            <button class="env-letter-delete-btn" onclick="deleteEnvLetter(event,'inbox','${letter.id}')">
                <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>`;
    }).join('');
}

window.viewEnvLetter = function(section, id) {
    const letters = section === 'outbox' ? envelopeData.outbox : envelopeData.inbox;
    const letter = letters.find(l => l.id === id);
    if (!letter) return;
    if (section === 'inbox' && letter.isNew) {
        letter.isNew = false;
        saveEnvelopeData();
        renderEnvelopeLists();
    }
    editingEnvId = id;
    editingEnvSection = section;

    document.getElementById('env-view-title').textContent = section === 'outbox' ? 'å¯„å‡ºçš„ä¿¡' : 'æ”¶åˆ°çš„å›žä¿¡';

    const dateObj = letter.timestamp ? new Date(letter.timestamp) : new Date();
    const y = dateObj.getFullYear();
    const mo = String(dateObj.getMonth()+1).padStart(2,'0');
    const d = String(dateObj.getDate()).padStart(2,'0');
    const dateStr = `${y}/${mo}/${d}`;
    const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    const fullDateStr = dateStr + ' æ˜ŸæœŸ' + weekdays[dateObj.getDay()];

    const stampEl = document.getElementById('env-view-stamp-date');
    if (stampEl) stampEl.textContent = `${mo}/${d}`;

    const dateLine = document.getElementById('env-view-date-line');
    if (dateLine) dateLine.textContent = fullDateStr;

    const toLine = document.getElementById('env-view-to-line');
    const greetingLine = document.getElementById('env-view-greeting-line');
    if (section === 'outbox') {
        const partnerName = (typeof settings !== 'undefined' && settings.partnerName) || 'äº²çˆ±çš„';
        if (toLine) toLine.textContent = `è‡´ ${partnerName}ï¼š`;
        if (greetingLine) greetingLine.textContent = 'è§å­—å¦‚é¢ï¼Œæœ›å›å®‰å¥½ã€‚';
    } else {
        const myName = (typeof settings !== 'undefined' && settings.myName) || 'ä½ ';
        if (toLine) toLine.textContent = `è‡´ ${myName}ï¼š`;
        if (greetingLine) greetingLine.textContent = 'è§å­—å¦‚é¢ï¼Œä¸€åˆ‡çš†å¥½ã€‚';
    }

    const textEl = document.getElementById('env-view-text');
    if (textEl) textEl.textContent = letter.content;

    const signDateEl = document.getElementById('env-view-sign-date');
    const signNameEl = document.getElementById('env-view-sign-name');
    if (signDateEl) signDateEl.textContent = fullDateStr;
    if (section === 'outbox') {
        const myName = (typeof settings !== 'undefined' && settings.myName) || 'ä½ ';
        if (signNameEl) signNameEl.textContent = myName;
    } else {
        const partnerName = (typeof settings !== 'undefined' && settings.partnerName) || 'å¯¹æ–¹';
        if (signNameEl) signNameEl.textContent = partnerName;
    }

    document.getElementById('env-edit-input').value = letter.content;
    document.getElementById('env-view-content').style.display = 'block';
    document.getElementById('env-view-edit').style.display = 'none';
    document.getElementById('env-view-edit-btn').style.display = 'inline-flex';
    document.getElementById('env-view-save-btn').style.display = 'none';
    showModal(document.getElementById('envelope-view-modal'));
};

window.toggleEnvEdit = function() {
    const contentEl = document.getElementById('env-view-content');
    const editEl = document.getElementById('env-view-edit');
    const editBtn = document.getElementById('env-view-edit-btn');
    const saveBtn = document.getElementById('env-view-save-btn');
    const isEditing = editEl.style.display !== 'none';
    if (isEditing) {
        contentEl.style.display = 'block';
        editEl.style.display = 'none';
        editBtn.textContent = 'ç¼–è¾‘';
        saveBtn.style.display = 'none';
    } else {
        contentEl.style.display = 'none';
        editEl.style.display = 'block';
        editBtn.textContent = 'å–æ¶ˆ';
        saveBtn.style.display = 'inline-flex';
    }
};

window.saveEnvEdit = function() {
    const newContent = document.getElementById('env-edit-input').value.trim();
    if (!newContent) { showNotification('å†…å®¹ä¸èƒ½ä¸ºç©º', 'warning'); return; }
    const letters = editingEnvSection === 'outbox' ? envelopeData.outbox : envelopeData.inbox;
    const letter = letters.find(l => l.id === editingEnvId);
    if (letter) {
        letter.content = newContent;
        saveEnvelopeData();
        const textEl = document.getElementById('env-view-text');
        if (textEl) textEl.textContent = newContent;
        showNotification('å·²ä¿å­˜ä¿®æ”¹', 'success');
        toggleEnvEdit();
    }
};

window.closeEnvViewModal = function() {
    hideModal(document.getElementById('envelope-view-modal'));
};

window.deleteEnvLetter = function(event, section, id) {
    event.stopPropagation();
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å°ä¿¡å—ï¼Ÿ')) return;
    if (section === 'outbox') {
        envelopeData.outbox = envelopeData.outbox.filter(l => l.id !== id);
    } else {
        envelopeData.inbox = envelopeData.inbox.filter(l => l.id !== id);
    }
    saveEnvelopeData();
    renderEnvelopeLists();
    showNotification('å·²åˆ é™¤', 'success');
};

window.openNewEnvelopeForm = function() {
    document.getElementById('env-outbox-section').style.display = 'none';
    document.getElementById('env-inbox-section').style.display = 'none';
    document.getElementById('env-main-close-btn').style.display = 'none';
    document.getElementById('env-compose-title').textContent = 'å†™ä¸€å°ä¿¡';
    document.getElementById('envelope-input').value = '';
    document.getElementById('env-send-to-chat').checked = false;
    document.getElementById('env-compose-form').style.display = 'block';
};

window.cancelEnvelopeCompose = function() {
    document.getElementById('env-compose-form').style.display = 'none';
    document.getElementById('env-main-close-btn').style.display = 'flex';
    if (currentEnvTab === 'outbox') {
        document.getElementById('env-outbox-section').style.display = 'block';
    } else {
        document.getElementById('env-inbox-section').style.display = 'block';
    }
};

function handleSendEnvelope() {
    const text = document.getElementById('envelope-input').value.trim();
    if (!text) { showNotification('ä¿¡ä»¶å†…å®¹ä¸èƒ½ä¸ºç©º', 'warning'); return; }

    const sendToChat = document.getElementById('env-send-to-chat').checked;
    if (sendToChat) {
        addMessage({ id: Date.now(), sender: 'user', text: `ã€å¯„å‡ºçš„ä¿¡ã€‘\n${text}`, timestamp: new Date(), status: 'sent', type: 'normal' });
    }

    const minHours = 10, maxHours = 24;
    const randomHours = Math.random() * (maxHours - minHours) + minHours;
    const replyTime = Date.now() + randomHours * 60 * 60 * 1000;
    const newId = 'env_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);
    envelopeData.outbox.push({
        id: newId, content: text,
        sentTime: Date.now(), replyTime,
        status: 'pending'
    });
    saveEnvelopeData();

    cancelEnvelopeCompose();
    switchEnvTab('outbox');
    showNotification(`ä¿¡ä»¶å·²å¯„å‡ºï¼Œé¢„è®¡ ${Math.floor(randomHours)} å°æ—¶åŽæ”¶åˆ°å›žä¿¡ âœ‰ï¸`, 'success');
}

function setupEventListeners() {
    console.log("æ­£åœ¨åˆå§‹åŒ–äº‹ä»¶ç›‘å¬..."); 
    
    try {
        initCoreListeners();
        initModalListeners();
        initChatActionListeners();
        initHeaderAndSettingsListeners();
        initDataManagementListeners();
        initNewFeatureListeners();
        setupTutorialListeners();
        initMoodListeners();
        initDecisionModule(); 
        initAnniversaryModule(); 
        initThemeEditor(); 
        initThemeSchemes();
        
        initComboMenu(); 
        
    } catch (e) {
        console.error("äº‹ä»¶ç»‘å®šè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:", e);
    }
}
let wheelOptions = ["æ˜¯", "å¦", "å†æƒ³ä¸€æƒ³", "å¬ä½ çš„"];
let wheelResultText = "";

function initDecisionModule() {
    const entryBtn = document.getElementById('decision-function'); 
    if(entryBtn) {
        const newBtn = entryBtn.cloneNode(true);
        entryBtn.parentNode.replaceChild(newBtn, entryBtn);
        newBtn.addEventListener('click', () => {
            hideModal(document.getElementById('advanced-modal'));
            showModal(document.getElementById('decision-menu-modal'));
        });
    }

    const openCoinBtn = document.getElementById('open-coin-toss');
    const openWheelBtn = document.getElementById('open-wheel');
    const closeMenuBtn = document.getElementById('close-decision-menu');
    const closeWheelBtn = document.getElementById('close-wheel');
    const addOptionBtn = document.getElementById('add-wheel-option');
    const spinBtn = document.getElementById('spin-wheel-btn');
    const sendResultBtn = document.getElementById('send-wheel-result');

    if (openCoinBtn && !openCoinBtn.dataset.initialized) {
        openCoinBtn.addEventListener('click', () => {
            hideModal(document.getElementById('decision-menu-modal'));
            handleCoinToss();
        });
        openCoinBtn.dataset.initialized = 'true';
    }

    if (openWheelBtn && !openWheelBtn.dataset.initialized) {
        openWheelBtn.addEventListener('click', () => {
            hideModal(document.getElementById('decision-menu-modal'));
            initPicker();
            showModal(document.getElementById('wheel-modal'));
        });
        openWheelBtn.dataset.initialized = 'true';
    }
    
    if (closeMenuBtn && !closeMenuBtn.dataset.initialized) {
        closeMenuBtn.addEventListener('click', () => hideModal(document.getElementById('decision-menu-modal')));
        closeMenuBtn.dataset.initialized = 'true';
    }

    if (closeWheelBtn && !closeWheelBtn.dataset.initialized) {
        closeWheelBtn.addEventListener('click', () => hideModal(document.getElementById('wheel-modal')));
        closeWheelBtn.dataset.initialized = 'true';
    }

    if (addOptionBtn && !addOptionBtn.dataset.initialized) {
        addOptionBtn.addEventListener('click', () => {
            wheelOptions.push(`é€‰é¡¹ ${wheelOptions.length + 1}`);
            renderPickerOptions();
            renderPickerCards();
        });
        addOptionBtn.dataset.initialized = 'true';
    }

    if (spinBtn && !spinBtn.dataset.initialized) {
        spinBtn.addEventListener('click', doPick);
        spinBtn.dataset.initialized = 'true';
    }
    
    if (sendResultBtn && !sendResultBtn.dataset.initialized) {
        sendResultBtn.addEventListener('click', () => {
            if(wheelResultText) {
                sendMessage(`âœ¨ éšæœºæŠ½ç­¾ç»“æžœï¼š${wheelResultText}`, 'normal');
                hideModal(document.getElementById('wheel-modal'));
                wheelResultText = "";
                sendResultBtn.style.display = 'none';
                const resultEl = document.getElementById('wheel-result');
                if (resultEl) { resultEl.textContent = ""; resultEl.classList.remove('show'); }
                spinBtn.disabled = false;
            }
        });
        sendResultBtn.dataset.initialized = 'true';
    }
}

function initPicker() {
    renderPickerOptions();
    renderPickerCards();
    const result = document.getElementById('wheel-result');
    const sendBtn = document.getElementById('send-wheel-result');
    const spinBtn = document.getElementById('spin-wheel-btn');
    if (result) { result.textContent = ""; result.classList.remove('show'); }
    if (sendBtn) sendBtn.style.display = 'none';
    if (spinBtn) spinBtn.disabled = false;
    wheelResultText = "";
}

function renderPickerOptions() {
    const list = document.getElementById('wheel-options-list');
    if (!list) return;
    list.innerHTML = '';
    const colors = ['#FFD93D','#FF6B6B','#6BCB77','#4D96FF','#E0C3FC','#FF9A8B','#A8D8EA','#C44569'];
    wheelOptions.forEach((opt, index) => {
        const item = document.createElement('div');
        item.className = 'picker-option-item';
        item.innerHTML = `
            <div class="picker-option-color-dot" style="background:${colors[index % colors.length]}"></div>
            <input type="text" class="picker-option-input" value="${opt}" placeholder="è¾“å…¥é€‰é¡¹...">
            <span class="picker-option-remove"><i class="fas fa-times"></i></span>
        `;
        item.querySelector('input').addEventListener('input', (e) => {
            wheelOptions[index] = e.target.value;
            renderPickerCards();
        });
        item.querySelector('.picker-option-remove').addEventListener('click', () => {
            if(wheelOptions.length <= 2) {
                showNotification('è‡³å°‘ä¿ç•™ä¸¤ä¸ªé€‰é¡¹', 'warning');
                return;
            }
            wheelOptions.splice(index, 1);
            renderPickerOptions();
            renderPickerCards();
        });
        list.appendChild(item);
    });
}

function renderPickerCards(selectedIndex = -1) {
    const row = document.getElementById('picker-cards-row');
    if (!row) return;
    const colors = ['#FFD93D','#FF6B6B','#6BCB77','#4D96FF','#E0C3FC','#FF9A8B','#A8D8EA','#C44569'];
    row.innerHTML = '';
    wheelOptions.forEach((opt, i) => {
        const card = document.createElement('div');
        card.className = 'picker-card';
        if (selectedIndex >= 0) {
            if (i === selectedIndex) card.classList.add('selected');
            else card.classList.add('unselected');
        }
        if (selectedIndex >= 0 && i === selectedIndex) {
            card.style.background = `linear-gradient(135deg, ${colors[i % colors.length]}, ${colors[(i+2) % colors.length]})`;
        } else {
            card.style.borderTop = `3px solid ${colors[i % colors.length]}`;
        }
        card.style.animationDelay = (i * 0.06) + 's';
        const label = opt || `é€‰é¡¹${i+1}`;
        card.textContent = label.length > 6 ? label.slice(0,5) + 'â€¦' : label;
        row.appendChild(card);
    });
}

function doPick() {
    if (wheelOptions.length < 2) {
        showNotification("è¯·è‡³å°‘æ·»åŠ ä¸¤ä¸ªé€‰é¡¹", "warning");
        return;
    }
    const spinBtn = document.getElementById('spin-wheel-btn');
    const resultDisplay = document.getElementById('wheel-result');
    const sendBtn = document.getElementById('send-wheel-result');
    
    spinBtn.disabled = true;
    sendBtn.style.display = 'none';
    resultDisplay.classList.remove('show');
    resultDisplay.textContent = "";

    let flashCount = 0;
    const totalFlashes = 16 + Math.floor(Math.random() * 8);
    const finalIndex = Math.floor(Math.random() * wheelOptions.length);
    
    function flash() {
        const row = document.getElementById('picker-cards-row');
        if (!row) return;
        const cards = row.querySelectorAll('.picker-card');
        cards.forEach(c => c.style.transform = '');
        
        let showIdx;
        if (flashCount < totalFlashes - 3) {
            showIdx = Math.floor(Math.random() * wheelOptions.length);
        } else {
            showIdx = finalIndex;
        }
        
        cards.forEach((c, i) => {
            if (i === showIdx) {
                c.style.transform = 'translateY(-4px) scale(1.06)';
                c.style.background = `linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb),0.7))`;
                c.style.borderColor = 'transparent';
                c.style.color = '#fff';
            } else {
                c.style.transform = '';
                c.style.background = '';
                c.style.borderColor = '';
                c.style.color = '';
            }
        });
        
        flashCount++;
        const delay = flashCount < 8 ? 80 : flashCount < 14 ? 130 : 250;
        if (flashCount < totalFlashes) {
            setTimeout(flash, delay);
        } else {
            setTimeout(() => {
                renderPickerCards(finalIndex);
                wheelResultText = wheelOptions[finalIndex];
                resultDisplay.innerHTML = `<i class="fas fa-star" style="font-size:14px; margin-right:6px;"></i>${wheelResultText}`;
                resultDisplay.classList.add('show');
                spinBtn.disabled = false;
                sendBtn.style.display = 'inline-block';
                playSound('favorite');
            }, 300);
        }
    }
    
    flash();
}function initComboMenu() {
    const comboBtn = document.getElementById('combo-btn');
    const picker = document.getElementById('user-sticker-picker');
    const contentArea = document.getElementById('combo-content-area');
    
    if (!comboBtn || !picker) return;
    
    if (comboBtn.dataset.initialized) return;
    
    comboBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = picker.classList.contains('active');
        
        if (isActive) {
            picker.classList.remove('active');
        } else {
            switchTab('my-sticker');
            picker.classList.add('active');
        }
    });
    
    comboBtn.dataset.initialized = 'true';

    document.addEventListener('click', (e) => {
        if (!picker.contains(e.target) && !comboBtn.contains(e.target)) {
            picker.classList.remove('active');
        }
    });

    const tabs = picker.querySelectorAll('.combo-tab-btn');
    tabs.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const tabId = btn.dataset.tab;
            switchTab(tabId);
        });
    });

    function updateAddBtnVisibility(tabId) {
        const addBtn = document.getElementById('sticker-add-btn');
        if (addBtn) addBtn.style.display = (tabId === 'my-sticker') ? 'flex' : 'none';
    }

    function switchTab(tabId) {
        tabs.forEach(b => b.classList.remove('active'));
        const activeBtn = Array.from(tabs).find(b => b.dataset.tab === tabId);
        if (activeBtn) activeBtn.classList.add('active');
        updateAddBtnVisibility(tabId);

        if (tabId === 'my-sticker') {
            renderMyStickerLibrary();
        } else if (tabId === 'partner-sticker') {
            renderPartnerStickerLibrary();
        } else {
            renderUserPokeMenu();
        }
    }

    function makeStickerItem(src, onClick) {
        const item = document.createElement('div');
        item.className = 'sticker-grid-item';
        item.innerHTML = `<img src="${src}" loading="lazy">`;
        item.onclick = (e) => { e.stopPropagation(); onClick(); };
        return item;
    }

    function renderMyStickerLibrary() {
        contentArea.innerHTML = '';
        if (!myStickerLibrary || myStickerLibrary.length === 0) {
            contentArea.innerHTML = `
                <div class="empty-sticker-tip">
                    <i class="fas fa-user-circle"></i>
                    è¿˜æ²¡æœ‰æˆ‘çš„ä¸“å±žè¡¨æƒ…å“¦<br>
                    ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æŒ‰é’®ä¸Šä¼ å›¾ç‰‡~
                </div>
            `;
            return;
        }
        const grid = document.createElement('div');
        grid.className = 'sticker-grid-view';
        myStickerLibrary.forEach(src => {
            const item = makeStickerItem(src, () => {
                addMessage({ id: Date.now(), sender: 'user', text: '', timestamp: new Date(), image: src, status: 'sent', type: 'normal' });
                playSound('send');
                picker.classList.remove('active');
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                setTimeout(simulateReply, settings.replyDelayMin + Math.random() * delayRange);
            });
            grid.appendChild(item);
        });
        contentArea.appendChild(grid);
    }

    function renderPartnerStickerLibrary() {
        contentArea.innerHTML = '';
        if (!stickerLibrary || stickerLibrary.length === 0) {
            contentArea.innerHTML = `
                <div class="empty-sticker-tip">
                    <i class="far fa-images"></i>
                    å¯¹æ–¹è¡¨æƒ…åº“è¿˜æ˜¯ç©ºçš„å“¦<br>
                    è¯·åŽ»"é«˜çº§åŠŸèƒ½"->"è‡ªå®šä¹‰å›žå¤"->"è¡¨æƒ…åº“"ä¸­æ·»åŠ å›¾ç‰‡~
                </div>
            `;
            return;
        }
        const grid = document.createElement('div');
        grid.className = 'sticker-grid-view';
        stickerLibrary.forEach(src => {
            const item = makeStickerItem(src, () => {
                addMessage({ id: Date.now(), sender: 'user', text: '', timestamp: new Date(), image: src, status: 'sent', type: 'normal' });
                playSound('send');
                picker.classList.remove('active');
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                setTimeout(simulateReply, settings.replyDelayMin + Math.random() * delayRange);
            });
            grid.appendChild(item);
        });
        contentArea.appendChild(grid);
    }

    function renderStickerLibrary() { renderMyStickerLibrary(); }
    function renderUserPokeMenu() {
        contentArea.innerHTML = '';

        const wrapper = document.createElement('div');
        wrapper.className = 'poke-list-view';

        const customBtn = document.createElement('button');
        customBtn.className = 'custom-poke-btn';
        customBtn.innerHTML = '<i class="fas fa-pen"></i> è‡ªå®šä¹‰åŠ¨ä½œ';
        customBtn.onclick = (e) => {
            e.stopPropagation();
            picker.classList.remove('active');
            showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input);
        };
        wrapper.appendChild(customBtn);

        const userPresets = [
            "æ‹äº†æ‹å¯¹æ–¹çš„å¤´",
            "æˆ³äº†æˆ³å¯¹æ–¹çš„è„¸é¢Š",
            "æŠ±ä½äº†å¯¹æ–¹",
            "ç»™å¯¹æ–¹æ¯”äº†ä¸ªå¿ƒ",
            "ç‰µèµ·äº†å¯¹æ–¹çš„æ‰‹",
            "çœ‹ç€å¯¹æ–¹å‘å‘†"
        ];

        const title = document.createElement('div');
        title.style.fontSize = '12px';
        title.style.color = 'var(--text-secondary)';
        title.style.marginBottom = '5px';
        title.innerText = 'å¿«æ·åŠ¨ä½œ';
        wrapper.appendChild(title);

        userPresets.forEach(text => {
            const item = document.createElement('div');
            item.className = 'poke-quick-item';
            item.innerText = text;
            item.onclick = (e) => {
                e.stopPropagation();
                addMessage({
                    id: Date.now(),
                    text: `âœ¦ ${settings.myName} ${text} âœ¦`, 
                    timestamp: new Date(),
                    type: 'system' 
                });
                picker.classList.remove('active');
                
                setTimeout(simulateReply, 1500);
            };
            wrapper.appendChild(item);
        });

        contentArea.appendChild(wrapper);
    }
}
function renderComboMenu() {
    const content = document.getElementById('user-sticker-content');
    content.innerHTML = '';
    
    const tabBar = document.createElement('div');
    tabBar.style.cssText = 'display:flex; gap:8px; padding:8px; border-bottom:1px solid var(--border-color);';
    tabBar.innerHTML = `
        <button class="combo-tab active" data-tab="emoji" style="flex:1; padding:8px; border:none; background:var(--accent-color); color:#fff; border-radius:8px; cursor:pointer;">
            ðŸ˜Š è¡¨æƒ…
        </button>
        <button class="combo-tab" data-tab="poke" style="flex:1; padding:8px; border:none; background:var(--secondary-bg); color:var(--text-primary); border-radius:8px; cursor:pointer;">
            âœ¨ æ‹ä¸€æ‹
        </button>
    `;
    
    const contentArea = document.createElement('div');
    contentArea.id = 'combo-content-area';
    contentArea.style.cssText = 'padding:10px; max-height:240px; overflow-y:auto;';
    
    content.appendChild(tabBar);
    content.appendChild(contentArea);
    
    showEmojiTab();
    
    tabBar.querySelectorAll('.combo-tab').forEach(btn => {
        btn.addEventListener('click', () => {
            tabBar.querySelectorAll('.combo-tab').forEach(b => {
                b.style.background = 'var(--secondary-bg)';
                b.style.color = 'var(--text-primary)';
                b.classList.remove('active');
            });
            btn.style.background = 'var(--accent-color)';
            btn.style.color = '#fff';
            btn.classList.add('active');
            
            if (btn.dataset.tab === 'emoji') {
                showEmojiTab();
            } else {
                showPokeTab();
            }
        });
    });
}

function showEmojiTab() {
    const area = document.getElementById('combo-content-area');
    area.innerHTML = '';
    area.style.display = 'grid';
    area.style.gridTemplateColumns = 'repeat(5, 1fr)';
    area.style.gap = '8px';
    
    CONSTANTS.REPLY_EMOJIS.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'picker-item';
        item.innerHTML = `<span style="font-size:24px;">${emoji}</span>`;
        item.onclick = () => {
            const input = document.getElementById('message-input');
            input.value += emoji;
            document.getElementById('user-sticker-picker').classList.remove('active');
            input.focus();
        };
        area.appendChild(item);
    });
    // Also show custom emojis in the picker
    customEmojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'picker-item';
        item.innerHTML = `<span style="font-size:24px;">${emoji}</span>`;
        item.onclick = () => {
            const input = document.getElementById('message-input');
            input.value += emoji;
            document.getElementById('user-sticker-picker').classList.remove('active');
            input.focus();
        };
        area.appendChild(item);
    });

    stickerLibrary.forEach(src => {
        const item = document.createElement('div');
        item.className = 'picker-item';
        item.innerHTML = `<img src="${src}" style="width:100%; height:100%; object-fit:cover; border-radius:6px;">`;
        item.onclick = () => {
            addMessage({
                id: Date.now(),
                sender: 'user',
                text: '',
                timestamp: new Date(),
                image: src,
                status: 'sent',
                type: 'normal'
            });
            playSound('send');
            document.getElementById('user-sticker-picker').classList.remove('active');
            
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, randomDelay);
        };
        area.appendChild(item);
    });
}

function showPokeTab() {
    const area = document.getElementById('combo-content-area');
    area.innerHTML = '';
    area.style.display = 'flex';
    area.style.flexDirection = 'column';
    area.style.gap = '8px';
    
    const quickPokes = customPokes.slice(0, 6);
    
    quickPokes.forEach(pokeText => {
        const btn = document.createElement('button');
        btn.textContent = pokeText;
        btn.style.cssText = `
            padding: 10px 14px;
            background: linear-gradient(135deg, var(--secondary-bg), rgba(var(--accent-color-rgb),0.04));
            border: 1px solid rgba(var(--accent-color-rgb),0.15);
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            font-size: 13px;
            transition: all 0.22s cubic-bezier(0.4,0,0.2,1);
            color: var(--text-primary);
            font-family: var(--font-family);
            width: 100%;
        `;
        btn.addEventListener('mouseover', () => {
            btn.style.background = 'linear-gradient(135deg, rgba(var(--accent-color-rgb),0.12), rgba(var(--accent-color-rgb),0.06))';
            btn.style.borderColor = 'var(--accent-color)';
            btn.style.transform = 'translateX(4px)';
        });
        btn.addEventListener('mouseout', () => {
            btn.style.background = 'linear-gradient(135deg, var(--secondary-bg), rgba(var(--accent-color-rgb),0.04))';
            btn.style.borderColor = 'rgba(var(--accent-color-rgb),0.15)';
            btn.style.transform = '';
        });
        btn.onclick = () => {
            addMessage({
                id: Date.now(), 
                text: `âœ¦ ${settings.myName} ${pokeText} âœ¦`, 
                timestamp: new Date(), 
                type: 'system'
            });
            document.getElementById('user-sticker-picker').classList.remove('active');
            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
            setTimeout(simulateReply, randomDelay);
        };
        area.appendChild(btn);
    });
    
    const customBtn = document.createElement('button');
    customBtn.innerHTML = '<i class="fas fa-edit"></i> è‡ªå®šä¹‰æ‹ä¸€æ‹';
    customBtn.style.cssText = `
        padding: 11px 14px;
        background: linear-gradient(135deg, var(--accent-color), rgba(var(--accent-color-rgb),0.8));
        color: #fff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        width: 100%;
        letter-spacing: 0.3px;
        margin-top: 4px;
        box-shadow: 0 4px 14px rgba(var(--accent-color-rgb), 0.25);
    `;
    customBtn.onclick = () => {
        document.getElementById('user-sticker-picker').classList.remove('active');
        showModal(DOMElements.pokeModal.modal, DOMElements.pokeModal.input);
    };
    area.appendChild(customBtn);
}
        function initCoreListeners() {


            DOMElements.chatContainer.addEventListener('scroll', () => {
                const container = DOMElements.chatContainer;


                if (container.scrollTop < 50 && !isLoadingHistory && messages.length > displayedMessageCount) {
                    isLoadingHistory = true;


                    const loader = document.getElementById('history-loader');
                    if (loader) loader.classList.add('visible');


                    setTimeout(() => {

                        displayedMessageCount += HISTORY_BATCH_SIZE;


                        renderMessages(true);


                        if (loader) loader.classList.remove('visible');
                        isLoadingHistory = false;
                    },
                        600);
                }
            });

            DOMElements.sendBtn.addEventListener('click', () => isBatchMode ? addToBatch(): sendMessage());
            DOMElements.messageInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); isBatchMode ? addToBatch(): sendMessage();
                }
            });
            DOMElements.messageInput.addEventListener('input', () => {
                DOMElements.messageInput.style.height = 'auto'; DOMElements.messageInput.style.height = `${Math.min(DOMElements.messageInput.scrollHeight, 120)}px`;
            });


            DOMElements.attachmentBtn.addEventListener('click', () => {

                const modal = document.createElement('div');
                modal.className = 'modal image-upload-modal';
                modal.style.cssText = `
            display: flex !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: opacity 0.3s ease;
            `;

                modal.innerHTML = `
            <div class="modal-content" style="
            z-index: 10000;
            position: relative;
            background-color: var(--secondary-bg);
            border-radius: var(--radius);
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
            ">
            <div class="modal-title"><i class="fas fa-image"></i><span>å‘é€å›¾ç‰‡</span></div>
            <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="modal-btn modal-btn-secondary upload-mode-btn active" id="upload-image-file-btn" style="flex: 1;">é€‰æ‹©æ–‡ä»¶</button>
            <button class="modal-btn modal-btn-secondary upload-mode-btn" id="paste-image-url-btn" style="flex: 1;">ç²˜è´´URL</button>
            </div>
            <input type="file" class="modal-input" id="image-file-input" accept="image/*">
            <input type="text" class="modal-input" id="image-url-input" placeholder="è¾“å…¥å›¾ç‰‡URLåœ°å€" style="display: none;">
            <div id="image-preview" style="text-align: center; margin-top: 10px; display: none;">
            <img id="preview-chat-image" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid var(--border-color);">
            </div>
            </div>
            <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-image">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" id="send-image" disabled>å‘é€</button>
            </div>
            </div>
            `;

                document.body.appendChild(modal);


                setTimeout(() => {
                    modal.style.opacity = '1';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                }, 10);

                const fileInput = document.getElementById('image-file-input');
                const urlInput = document.getElementById('image-url-input');
                const uploadBtn = document.getElementById('upload-image-file-btn');
                const pasteUrlBtn = document.getElementById('paste-image-url-btn');
                const previewDiv = document.getElementById('image-preview');
                const previewImg = document.getElementById('preview-chat-image');
                const sendBtn = document.getElementById('send-image');
                const cancelBtn = document.getElementById('cancel-image');
                const uploadModeBtns = document.querySelectorAll('.upload-mode-btn');

                let currentImageData = null;


                function switchUploadMode(isFileMode) {
                    uploadModeBtns.forEach(btn => btn.classList.remove('active'));
                    if (isFileMode) {
                        uploadBtn.classList.add('active');
                        fileInput.style.display = 'block';
                        urlInput.style.display = 'none';
                    } else {
                        pasteUrlBtn.classList.add('active');
                        fileInput.style.display = 'none';
                        urlInput.style.display = 'block';
                        urlInput.focus();
                    }

                    previewDiv.style.display = 'none';
                    sendBtn.disabled = true;
                    currentImageData = null;
                }


                uploadBtn.addEventListener('click', () => switchUploadMode(true));


                pasteUrlBtn.addEventListener('click', () => switchUploadMode(false));


                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > MAX_IMAGE_SIZE) {
                            showNotification('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB', 'error');
                            return;
                        }
                        showNotification('æ­£åœ¨ä¼˜åŒ–å›¾ç‰‡...', 'info', 1500);
                        optimizeImage(file).then(optimizedData => {
                            currentImageData = optimizedData;
                            previewImg.src = currentImageData;
                            previewDiv.style.display = 'block';
                            sendBtn.disabled = false;
                        }).catch(() => {
                            showNotification('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error');
                        });
                    }
                });


                urlInput.addEventListener('input',
                    function() {
                        const url = urlInput.value.trim();
                        if (url) {

                            if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp|bmp))$/i.test(url)) {
                                previewImg.src = url;
                                previewDiv.style.display = 'block';
                                currentImageData = url;
                                sendBtn.disabled = false;


                                const img = new Image();
                                img.onload = function() {

                                    previewImg.src = url;
                                    showNotification('å›¾ç‰‡URLæœ‰æ•ˆ', 'success', 1000);
                                };
                                img.onerror = function() {
                                    showNotification('å›¾ç‰‡URLæ— æ•ˆæˆ–æ— æ³•è®¿é—®', 'error');
                                    sendBtn.disabled = true;
                                    previewDiv.style.display = 'none';
                                };
                                img.src = url;
                            } else {
                                sendBtn.disabled = true;
                                previewDiv.style.display = 'none';
                            }
                        } else {
                            sendBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    });


                sendBtn.addEventListener('click',
                    () => {
                        if (currentImageData) {

                            addMessage({
                                id: Date.now(),
                                sender: 'user',
                                text: '',
                                timestamp: new Date(),
                                image: currentImageData,
                                status: 'sent',
                                favorited: false,
                                note: null,
                                replyTo: currentReplyTo,
                                type: 'normal'
                            });
                            playSound('send');
                            currentReplyTo = null;
                            updateReplyPreview();
                            const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                            const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                            setTimeout(simulateReply, randomDelay);


                            closeModal();
                        }
                    });


                cancelBtn.addEventListener('click',
                    closeModal);


                function closeModal() {
                    modal.style.opacity = '0';
                    const content = modal.querySelector('.modal-content');
                    content.style.opacity = '0';
                    content.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                    },
                        300);
                }


                modal.addEventListener('click',
                    (e) => {
                        if (e.target === modal) {
                            closeModal();
                        }
                    });


                modal.querySelector('.modal-content').addEventListener('click',
                    (e) => {
                        e.stopPropagation();
                    });


                const handleEscKey = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscKey);
                    }
                };
                document.addEventListener('keydown', handleEscKey);


                modal.addEventListener('close', () => {
                    document.removeEventListener('keydown', handleEscKey);
                });
            });


            DOMElements.imageInput.addEventListener('change', () => {
                if (DOMElements.imageInput.files[0]) {
                    if (isBatchMode) {
                        showNotification('æ‰¹é‡æ¨¡å¼ä¸æ”¯æŒå›¾ç‰‡', 'warning');
                        DOMElements.imageInput.value = '';
                    } else {
                        sendMessage();
                    }
                }
            });

            DOMElements.continueBtn.addEventListener('click', simulateReply);
            DOMElements.batchBtn.addEventListener('click', toggleBatchMode);
        }

function initChatActionListeners() {
            DOMElements.chatContainer.addEventListener('click', (e) => {

                if (isBatchFavoriteMode) {
                    const wrapper = e.target.closest('.message-wrapper');
                    if (wrapper && !e.target.closest('.message-meta-actions')) {
                        const messageId = Number(wrapper.dataset.id);
                        const index = selectedMessages.indexOf(messageId);

                        if (index > -1) {
                            selectedMessages.splice(index, 1);
                            wrapper.classList.remove('selected');
                        } else {
                            selectedMessages.push(messageId);
                            wrapper.classList.add('selected');
                        }

                        const confirmBtn = document.getElementById('confirm-batch-favorite');
                        if (confirmBtn) {
                            confirmBtn.textContent = `ç¡®è®¤æ”¶è— (${selectedMessages.length})`;
                        }
                        return;
                    }
                }

                const favoriteBtn = e.target.closest('.favorite-action-btn'); 
                if (favoriteBtn) {
                    const wrapper = e.target.closest('.message-wrapper');
                    const messageId = Number(wrapper.dataset.id);
                    const message = messages.find(m => m.id === messageId);
                    
                    if (message) {
                        message.favorited = !message.favorited;
                        
                        showNotification(message.favorited ? 'å·²æ”¶è—': 'å·²å–æ¶ˆæ”¶è—', 'success', 1500);
                        playSound('favorite');
                        
                        throttledSaveData();
                        
                        renderMessages(true);
                    }
                    return;
                }

                const target = e.target.closest('.meta-action-btn');
                if (!target) return;
                
                const wrapper = e.target.closest('.message-wrapper');
                if (!wrapper) return; 
                
                const messageId = Number(wrapper.dataset.id);
                const message = messages.find(m => m.id === messageId);
                if (!message) return;

if (target.classList.contains('delete-btn')) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
        const index = messages.findIndex(m => m.id === messageId);
        if (index > -1) {
            const savedScrollTop = DOMElements.chatContainer.scrollTop;
            messages.splice(index, 1); 
            throttledSaveData(); 
            renderMessages(true);
            requestAnimationFrame(() => {
                DOMElements.chatContainer.scrollTop = savedScrollTop;
            });
            showNotification('æ¶ˆæ¯å·²åˆ é™¤', 'success');
        }
    }
    return;
}
                if (target.classList.contains('reply-btn')) {
                    currentReplyTo = {
                        id: message.id,
                        sender: message.sender,
                        text: message.text
                    };
                    updateReplyPreview();
                    DOMElements.messageInput.focus();
                    const targetMessageElement = DOMElements.chatContainer.querySelector(`[data-id="${message.id}"]`);
                    if (targetMessageElement) targetMessageElement.scrollIntoView({
                        behavior: 'smooth', block: 'center'
                    });
                    return;
                } 
                else if (target.classList.contains('note-btn')) {
                    currentNoteMessageId = messageId;
                    DOMElements.noteModal.input.value = message.note || '';
                    showModal(DOMElements.noteModal.modal, DOMElements.noteModal.input);
                    return;
                }

                throttledSaveData();
            });

            DOMElements.batchPreview.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.batch-preview-remove');
                if (removeBtn) {
                    const index = removeBtn.closest('.batch-preview-item').dataset.index;
                    batchMessages.splice(index, 1); updateBatchPreview();
                }
                const sendBtn = e.target.closest('.batch-send-btn');
                if (sendBtn && !sendBtn.disabled) sendBatchMessages();
                if (e.target.matches('.batch-cancel-btn')) {
                    isBatchMode = false; DOMElements.batchBtn.classList.remove('active');
                    DOMElements.batchPreview.style.display = 'none';
                    const placeholder = "";
                    DOMElements.messageInput.placeholder = placeholder.length > 20 ? placeholder.substring(0, 20) + "...": placeholder;
                    batchMessages = [];
                }
            });
        }
        function initModalListeners() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                const cancelBtns = modal.querySelectorAll('.modal-buttons .modal-btn-secondary');
                cancelBtns.forEach(cancelBtn => {
                    if (!cancelBtn.getAttribute('onclick') && !cancelBtn.dataset.noAutoClose) {
                        cancelBtn.addEventListener('click', () => hideModal(modal));
                    }
                });
            });

            DOMElements.editModal.input.addEventListener('input', () => {
                DOMElements.editModal.save.disabled = !DOMElements.editModal.input.value.trim();
            });
            DOMElements.noteModal.save.addEventListener('click', () => {
                const message = messages.find(m => m.id === currentNoteMessageId);
                if (message) {
                    message.note = DOMElements.noteModal.input.value.trim() || null;
                    throttledSaveData();
                    renderMessages(true);
                    showNotification('æ³¨é‡Šå·²ä¿å­˜', 'success');
                }
                hideModal(DOMElements.noteModal.modal);
            });

            DOMElements.pokeModal.save.addEventListener('click', () => {
                let pokeText = DOMElements.pokeModal.input.value.trim() || `${settings.myName} æ‹äº†æ‹ ${settings.partnerName}`;
                addMessage({
                    id: Date.now(), text: `âœ¦ ${pokeText} âœ¦`, timestamp: new Date(), type: 'system'
                });
                hideModal(DOMElements.pokeModal.modal);
                DOMElements.pokeModal.input.value = '';
                const delayRange = settings.replyDelayMax - settings.replyDelayMin;
                const randomDelay = settings.replyDelayMin + Math.random() * delayRange;
                setTimeout(simulateReply, randomDelay);
            });


            DOMElements.cancelCoinResult.addEventListener('click', () => {
                DOMElements.coinTossOverlay.classList.remove('visible', 'finished');
                lastCoinResult = null;
            });


            DOMElements.sendCoinResult.addEventListener('click', () => {
                if (lastCoinResult) {
                    sendMessage(`ðŸŽ² æŠ›ç¡¬å¸ç»“æžœï¼š${lastCoinResult}`, 'normal');
                    DOMElements.coinTossOverlay.classList.remove('visible', 'finished');
                    lastCoinResult = null;
                }
            });


            const retryBtn = document.getElementById('retry-coin-toss');

            if (retryBtn) {
                retryBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();

                    startCoinFlipAnimation();
                });
            }
        }

        function initHeaderAndSettingsListeners() {

            const openNameModal = (isPartner) => {
                const modal = DOMElements.editModal;
                showModal(modal.modal, modal.input);
                modal.title.textContent = `ä¿®æ”¹${isPartner ? (settings.partnerName || 'å¯¹æ–¹'): 'æˆ‘'}çš„æ˜µç§°`;
                modal.input.value = isPartner ? settings.partnerName: settings.myName;
                modal.save.disabled = !modal.input.value.trim();
                modal.save.onclick = () => {
                    const newName = modal.input.value.trim();
                    if (newName) {
                        isPartner ? settings.partnerName = newName: settings.myName = newName;
                        throttledSaveData();
                        updateUI();
                        showNotification('æ˜µç§°å·²æ›´æ–°', 'success');
                    }
                    hideModal(modal.modal);
                };
            };

            const openAvatarModal = (isPartner) => {
                const modal = DOMElements.avatarModal;

                modal.modal.querySelector('.modal-content').innerHTML = `
            <div class="modal-title"><i class="fas fa-portrait"></i><span>ä¸Šä¼ ${isPartner ? 'å¯¹æ–¹': 'æˆ‘'}çš„å¤´åƒ</span></div>
            <div style="margin-bottom: 16px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="modal-btn modal-btn-secondary" id="upload-file-btn" style="flex: 1;">é€‰æ‹©æ–‡ä»¶</button>
            <button class="modal-btn modal-btn-secondary" id="paste-url-btn" style="flex: 1;">ç²˜è´´URL</button>
            </div>
            <input type="file" class="modal-input" id="avatar-file-input" accept="image/*" style="display: none;">
            <input type="text" class="modal-input" id="avatar-url-input" placeholder="è¾“å…¥å›¾ç‰‡URLåœ°å€" style="display: none;">
            <div id="avatar-preview" style="text-align: center; margin-top: 10px; display: none;">
            <img id="preview-image" style="max-width: 100px; max-height: 100px; border-radius: 50%; border: 2px solid var(--border-color);">
            </div>
            </div>
            <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" id="cancel-avatar">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-primary" id="save-avatar" disabled>ä¿å­˜</button>
            </div>
            `;

                showModal(modal.modal);

                const fileInput = document.getElementById('avatar-file-input');
                const urlInput = document.getElementById('avatar-url-input');
                const uploadBtn = document.getElementById('upload-file-btn');
                const pasteUrlBtn = document.getElementById('paste-url-btn');
                const previewDiv = document.getElementById('avatar-preview');
                const previewImg = document.getElementById('preview-image');
                const saveBtn = document.getElementById('save-avatar');
                const cancelBtn = document.getElementById('cancel-avatar');

                let currentAvatarData = null;


                uploadBtn.addEventListener('click', () => {
                    fileInput.click();
                    urlInput.style.display = 'none';
                    uploadBtn.classList.add('active');
                    pasteUrlBtn.classList.remove('active');
                });


                pasteUrlBtn.addEventListener('click', () => {
                    urlInput.style.display = 'block';
                    fileInput.style.display = 'none';
                    pasteUrlBtn.classList.add('active');
                    uploadBtn.classList.remove('active');
                    urlInput.focus();
                });



fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (file.size > MAX_AVATAR_SIZE) {
            showNotification('å¤´åƒå›¾ç‰‡ä¸èƒ½è¶…è¿‡2MB', 'error');
            return;
        }

        showNotification('æ­£åœ¨è£å‰ªå¤„ç†...', 'info', 1000);
        
        cropImageToSquare(file, 300).then(base64Data => {
            currentAvatarData = base64Data;
            previewImg.src = currentAvatarData;
            previewDiv.style.display = 'block';
            saveBtn.disabled = false;
        }).catch(err => {
            console.error(err);
            showNotification('å›¾ç‰‡å¤„ç†å¤±è´¥', 'error');
        });
    }
});


                urlInput.addEventListener('input',
                    function() {
                        const url = urlInput.value.trim();
                        if (url) {

                            if (/^(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))$/i.test(url)) {
                                previewImg.src = url;
                                previewDiv.style.display = 'block';
                                currentAvatarData = url;
                                saveBtn.disabled = false;


                                const img = new Image();
                                img.onload = function() {

                                    previewImg.src = url;
                                };
                                img.onerror = function() {
                                    showNotification('å›¾ç‰‡URLæ— æ•ˆæˆ–æ— æ³•è®¿é—®', 'error');
                                    saveBtn.disabled = true;
                                };
                                img.src = url;
                            } else {
                                saveBtn.disabled = true;
                            }
                        } else {
                            saveBtn.disabled = true;
                            previewDiv.style.display = 'none';
                        }
                    });


                saveBtn.addEventListener('click',
                    () => {
                        if (currentAvatarData) {
                            updateAvatar(isPartner ? DOMElements.partner.avatar: DOMElements.me.avatar, currentAvatarData);
                            throttledSaveData();
                            showNotification('å¤´åƒå·²æ›´æ–°', 'success');
                            hideModal(modal.modal);
                        }
                    });


                cancelBtn.addEventListener('click',
                    () => {
                        hideModal(modal.modal);
                    });
            };

            DOMElements.partner.name.addEventListener('click', () => openNameModal(true));
            DOMElements.me.name.addEventListener('click', () => openNameModal(false));
            DOMElements.partner.avatar.addEventListener('click', () => openAvatarModal(true));
            DOMElements.me.avatar.addEventListener('click', () => openAvatarModal(false));

            DOMElements.me.statusContainer.addEventListener('click', () => {
                const statusTextElement = DOMElements.me.statusText; const statusContainer = DOMElements.me.statusContainer;
                if (statusContainer.querySelector('input')) return;
                const input = document.createElement('input'); input.type = 'text'; input.id = 'my-status-input'; input.value = statusTextElement.textContent;
                const saveStatus = () => {
                    const newStatus = input.value.trim();
                    if (newStatus) {
                        settings.myStatus = newStatus; showNotification('çŠ¶æ€å·²æ›´æ–°', 'success');
                    } else {
                        settings.myStatus = "åœ¨çº¿";
                    }
                    statusTextElement.textContent = settings.myStatus;
                    statusContainer.innerHTML = '';
                    statusContainer.appendChild(statusTextElement);
                    throttledSaveData();
                };
                input.addEventListener('blur', saveStatus);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') input.blur();
                });
                statusContainer.innerHTML = ''; statusContainer.appendChild(input); input.focus();
            });

            DOMElements.themeToggle.addEventListener('click', () => {
                settings.isDarkMode = !settings.isDarkMode; throttledSaveData(); updateUI(); showNotification(`å·²åˆ‡æ¢åˆ°${settings.isDarkMode ? 'å¤œ': 'æ˜¼'}æ¨¡å¼`,
                    'success');
            });
            DOMElements.settingsModal.settingsBtn.addEventListener('click', () => {
                showModal(DOMElements.settingsModal.modal);
            });
            DOMElements.favoritesModal.favoritesBtn.addEventListener('click', () => {
                showModal(document.getElementById('group-chat-modal'));
            });


document.getElementById('chat-settings').addEventListener('click', () => {
    hideModal(DOMElements.settingsModal.modal);
    
    const toggleSyncMap = {
        '#reply-toggle': { prop: 'replyEnabled', name: 'å¼•ç”¨å›žå¤' },
        '#sound-toggle': { prop: 'soundEnabled', name: 'éŸ³æ•ˆ' },
        '#read-receipts-toggle': { prop: 'readReceiptsEnabled', name: 'å·²è¯»å›žæ‰§' },
        '#typing-indicator-toggle': { prop: 'typingIndicatorEnabled', name: 'æ­£åœ¨è¾“å…¥' },
        '#read-no-reply-toggle': { prop: 'allowReadNoReply', name: 'å·²è¯»ä¸å›ž' }
    };
    for (const [selector, { prop }] of Object.entries(toggleSyncMap)) {
        const el = document.querySelector(selector);
        if (el) el.classList.toggle('active', !!settings[prop]);
    }
    const svSlider = document.getElementById('sound-volume-slider');
    const svVal = document.getElementById('sound-volume-value');
    if (svSlider) { svSlider.value = Math.round((settings.soundVolume || 0.15) * 100); if (svVal) svVal.textContent = svSlider.value + '%'; }
    const csi = document.getElementById('custom-sound-url-input');
    if (csi) csi.value = settings.customSoundUrl || '';
    document.querySelectorAll('.time-fmt-opt').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.fmt === (settings.timeFormat || 'HH:mm'));
    });
    const autoToggle = document.getElementById('auto-send-toggle');
    if (autoToggle) autoToggle.classList.toggle('active', !!settings.autoSendEnabled);
    updateAutoSendUI();
    updateDelayUI();
    const immToggle = document.getElementById('immersive-toggle');
    if (immToggle) immToggle.classList.toggle('active', document.body.classList.contains('immersive-mode'));
    
    showModal(DOMElements.chatModal.modal);
    setupAvatarFrameSettings();
});
            document.getElementById('advanced-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.advancedModal.modal);
            });

            document.getElementById('data-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                showModal(DOMElements.dataModal.modal);
            });


            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.addEventListener('click',
                    () => {
                        settings.colorTheme = btn.dataset.theme;
                        throttledSaveData();
                        updateUI();
                        showNotification(`ä¸»é¢˜é¢œè‰²å·²åˆ‡æ¢`, 'success');
                    });
            });


            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.addEventListener('click',
                    () => {
                        settings.bubbleStyle = item.dataset.bubbleStyle;
                        throttledSaveData();
                        updateUI();
                        showNotification(`æ°”æ³¡æ ·å¼å·²åˆ‡æ¢ä¸º${getBubbleStyleName(settings.bubbleStyle)}`, 'success');
                    });
            });

            const fontUrlInput = document.getElementById('custom-font-url');
            const applyFontBtn = document.getElementById('apply-font-btn');
            
            if (fontUrlInput) fontUrlInput.value = settings.customFontUrl || "";

            if (applyFontBtn) {
                applyFontBtn.addEventListener('click', () => {
                    const url = fontUrlInput.value.trim();
                    settings.customFontUrl = url;
                    
                    showNotification('æ­£åœ¨å°è¯•åŠ è½½å­—ä½“...', 'info', 1000);
                    applyCustomFont(url).then(() => {
                        throttledSaveData();
                        if(url) showNotification('å­—ä½“å·²åº”ç”¨', 'success');
                        else showNotification('å·²æ¢å¤é»˜è®¤å­—ä½“', 'success');
                    });
                });
            }

            
            const followSystemBtn = document.getElementById('follow-system-font-btn');
            if (followSystemBtn) {
                followSystemBtn.addEventListener('click', () => {
                    
                    const systemFontStack = 'system-ui, -apple-system, sans-serif';
                    
                    
                    if (fontUrlInput) fontUrlInput.value = "";
                    
                    
                    settings.customFontUrl = "";
                    
                    
                    settings.messageFontFamily = systemFontStack;
                    
                    
                    document.documentElement.style.setProperty('--font-family', systemFontStack);
                    document.documentElement.style.setProperty('--message-font-family', systemFontStack);
                    
                    
                    throttledSaveData();
                    
                    
                    renderMessages(true);
                    
                    showNotification('å·²åº”ç”¨è·Ÿéšç³»ç»Ÿå­—ä½“', 'success');
                });
            }
            
            const cssTextarea = document.getElementById('custom-bubble-css');
            const applyCssBtn = document.getElementById('apply-css-btn');
            const resetCssBtn = document.getElementById('reset-css-btn');

            if (cssTextarea) cssTextarea.value = settings.customBubbleCss || "";

            function updateCssLivePreview() {
                const previewStyle = document.getElementById('css-live-preview-style');
                if (!previewStyle) return;
                const raw = (cssTextarea ? cssTextarea.value : '') || '';
                const scoped = raw.replace(/([^{}]+)\{/g, (match, selector) => {
                    const parts = selector.split(',').map(s => `#css-live-preview ${s.trim()}`);
                    return parts.join(', ') + ' {';
                });
                previewStyle.textContent = scoped;
            }

            if (cssTextarea) {
                cssTextarea.addEventListener('input', updateCssLivePreview);
                updateCssLivePreview();
            }

            if (applyCssBtn) {
                applyCssBtn.addEventListener('click', () => {
                    const css = cssTextarea.value;
                    settings.customBubbleCss = css;
                    applyCustomBubbleCss(css);
                    throttledSaveData();
                    showNotification('è‡ªå®šä¹‰æ ·å¼å·²åº”ç”¨', 'success');
                });
            }

            if (resetCssBtn) {
                resetCssBtn.addEventListener('click', () => {
                    cssTextarea.value = "";
                    settings.customBubbleCss = "";
                    applyCustomBubbleCss("");
                    if (document.getElementById('css-live-preview-style')) document.getElementById('css-live-preview-style').textContent = '';
                    throttledSaveData();
                    showNotification('è‡ªå®šä¹‰æ ·å¼å·²æ¸…é™¤', 'success');
                });
            }

            const fontSizeSlider = document.getElementById('font-size-slider');
            const fontSizeValue = document.getElementById('font-size-value');

            fontSizeSlider.value = settings.fontSize;
            fontSizeValue.textContent = `${settings.fontSize}px`;

            fontSizeSlider.addEventListener('input', (e) => {
                settings.fontSize = parseInt(e.target.value);
                document.documentElement.style.setProperty('--font-size',
                    `${settings.fontSize}px`);
                fontSizeValue.textContent = `${settings.fontSize}px`;
            });

            fontSizeSlider.addEventListener('change', throttledSaveData);

            const avatarToggle = document.getElementById('in-chat-avatar-toggle-2');
            const avatarSizeControl = document.getElementById('in-chat-avatar-size-control-2');
            const avatarPositionControl = document.getElementById('in-chat-avatar-position-control-2');
            const avatarPreview = document.getElementById('avatar-bubble-preview');
            const avatarSizeSlider = document.getElementById('in-chat-avatar-size-slider-2');
            const avatarSizeValue = document.getElementById('in-chat-avatar-size-value-2');

            if (!settings.inChatAvatarPosition) settings.inChatAvatarPosition = 'center';

            // updateAvatarPreview is defined below (handles both size and shape updates)

            function updateBubblePreview() {
                const receivedBubble = document.getElementById('preview-bubble-received');
                const sentBubble = document.getElementById('preview-bubble-sent');
                if (!receivedBubble || !sentBubble) return;
                const style = settings.bubbleStyle || 'standard';
                const accentRgb = getComputedStyle(document.documentElement).getPropertyValue('--accent-color-rgb').trim() || '100,150,255';
                const styleMap = {
                    'standard':      { recv: '16px 16px 16px 4px',  sent: '16px 16px 4px 16px',  recvShadow: '0 2px 10px rgba(0,0,0,0.08)', sentShadow: `0 3px 12px rgba(${accentRgb},0.22)` },
                    'rounded':       { recv: '18px 18px 18px 6px',  sent: '18px 18px 6px 18px',  recvShadow: '0 2px 10px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.04)', sentShadow: `0 3px 12px rgba(${accentRgb},0.25), 0 1px 3px rgba(${accentRgb},0.1)` },
                    'rounded-large': { recv: '24px 24px 24px 4px',  sent: '24px 24px 4px 24px',  recvShadow: '0 4px 16px rgba(0,0,0,0.1), 0 2px 4px rgba(0,0,0,0.05)', sentShadow: `0 4px 16px rgba(${accentRgb},0.28), 0 2px 4px rgba(${accentRgb},0.12)` },
                    'square':        { recv: '4px 4px 4px 0',       sent: '4px 4px 0 4px',       recvShadow: '0 3px 10px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04)', sentShadow: `0 3px 10px rgba(${accentRgb},0.2), 0 1px 2px rgba(${accentRgb},0.08)` }
                };
                const radii = styleMap[style] || styleMap['standard'];
                receivedBubble.style.borderRadius = radii.recv;
                receivedBubble.style.boxShadow = radii.recvShadow;
                sentBubble.style.borderRadius = radii.sent;
                sentBubble.style.boxShadow = radii.sentShadow;
                const recvBg = getComputedStyle(document.documentElement).getPropertyValue('--message-received-bg').trim();
                const recvText = getComputedStyle(document.documentElement).getPropertyValue('--message-received-text').trim();
                const sentBg = getComputedStyle(document.documentElement).getPropertyValue('--message-sent-bg').trim();
                const sentText = getComputedStyle(document.documentElement).getPropertyValue('--message-sent-text').trim();
                if (recvBg) receivedBubble.style.background = recvBg;
                if (recvText) receivedBubble.style.color = recvText;
                if (sentBg) sentBubble.style.background = sentBg;
                if (sentText) sentBubble.style.color = sentText;
                receivedBubble.style.fontFamily = settings.messageFontFamily || '';
                sentBubble.style.fontFamily = settings.messageFontFamily || '';
                receivedBubble.style.fontSize = (settings.fontSize || 16) + 'px';
                sentBubble.style.fontSize = (settings.fontSize || 16) + 'px';
                const customCss = (document.getElementById('custom-bubble-css') || {}).value || '';
                let previewStyle = document.getElementById('bubble-preview-custom-style');
                if (!previewStyle) {
                    previewStyle = document.createElement('style');
                    previewStyle.id = 'bubble-preview-custom-style';
                    document.head.appendChild(previewStyle);
                }
                previewStyle.textContent = customCss;
            }

            function updateAvatarSettingsUI() {
                const enabled = settings.inChatAvatarEnabled;
                const pill = document.getElementById('avatar-toggle-pill-2');
                const knob = document.getElementById('avatar-toggle-knob-2');
                const statusText = document.getElementById('avatar-toggle-status-2');
                if (pill) pill.style.background = enabled ? 'var(--accent-color)' : 'var(--border-color)';
                if (knob) knob.style.right = enabled ? '3px' : '23px';
                if (statusText) statusText.textContent = enabled ? 'å·²å¼€å¯ â€” æ¶ˆæ¯æ—æ˜¾ç¤ºå¤´åƒ' : 'å·²å…³é—­';

                if (avatarSizeControl) avatarSizeControl.style.display = enabled ? 'flex' : 'none';
                if (avatarPositionControl) avatarPositionControl.style.display = enabled ? 'block' : 'none';
                if (avatarPreview) avatarPreview.style.display = enabled ? 'block' : 'none';

                if (avatarSizeSlider) avatarSizeSlider.value = settings.inChatAvatarSize;
                if (avatarSizeValue) avatarSizeValue.textContent = `${settings.inChatAvatarSize}px`;
                document.documentElement.style.setProperty('--in-chat-avatar-size', `${settings.inChatAvatarSize}px`);

                const pos = settings.inChatAvatarPosition || 'center';
                const alignMap = { 'top': 'flex-start', 'center': 'center', 'bottom': 'flex-end' };
                document.documentElement.style.setProperty('--avatar-align', alignMap[pos] || 'flex-start');
                document.querySelectorAll('.preview-msg-row').forEach(row => {
                    row.style.alignItems = alignMap[pos] || 'flex-start';
                });
                const topBtn = document.getElementById('avatar-pos-top-2');
                const centerBtn = document.getElementById('avatar-pos-center-2');
                const bottomBtn = document.getElementById('avatar-pos-bottom-2');
                [topBtn, centerBtn, bottomBtn].forEach(btn => {
                    if (!btn) return;
                    btn.className = btn.dataset.pos === pos ? 'modal-btn modal-btn-primary' : 'modal-btn modal-btn-secondary';
                    btn.style.flex = '1'; btn.style.fontSize = '12px'; btn.style.padding = '7px 0';
                });

                updateAvatarPreview();
            }
            updateAvatarSettingsUI();

            if (avatarToggle) {
                avatarToggle.addEventListener('click', () => {
                    settings.inChatAvatarEnabled = !settings.inChatAvatarEnabled;
                    updateAvatarSettingsUI();
                    renderMessages(true);
                    throttledSaveData();
                });
            }

            if (avatarSizeSlider) {
                avatarSizeSlider.addEventListener('input', (e) => {
                    settings.inChatAvatarSize = parseInt(e.target.value, 10);
                    updateAvatarSettingsUI();
                    renderMessages(true); 
                });
                avatarSizeSlider.addEventListener('change', throttledSaveData);
            }

            ['avatar-pos-top-2','avatar-pos-center-2','avatar-pos-bottom-2'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.addEventListener('click', () => {
                        settings.inChatAvatarPosition = btn.dataset.pos;
                        updateAvatarSettingsUI();
                        renderMessages(true);
                        throttledSaveData();
                    });
                }
            });

            // Avatar shape buttons
            function updateAvatarPreview(shape, cornerRadius) {
                const previewPartner = document.getElementById('preview-partner-avatar');
                const previewMy = document.getElementById('preview-my-avatar');
                if (!previewPartner || !previewMy) return;
                // If called with no args (original use), just update sizes and images
                const sz = `${settings.inChatAvatarSize || 36}px`;
                previewPartner.style.width = sz;
                previewPartner.style.height = sz;
                previewMy.style.width = sz;
                previewMy.style.height = sz;
                // Get actual avatar images
                const partnerImg = DOMElements.partner && DOMElements.partner.avatar ? DOMElements.partner.avatar.querySelector('img') : null;
                const myImg = DOMElements.me && DOMElements.me.avatar ? DOMElements.me.avatar.querySelector('img') : null;
                const currentShape = shape || settings.myAvatarShape || 'circle';
                
                function applyToPreviewEl(el, img, shp, cr) {
                    if (img && img.src) {
                        el.innerHTML = `<img src="${img.src}" style="width:100%;height:100%;object-fit:cover;">`;
                    }
                    if (shp === 'circle') {
                        el.style.borderRadius = '50%';
                    } else if (shp === 'square') {
                        el.style.borderRadius = (cr || 8) + 'px';
                    }
                }
                const cr = cornerRadius !== undefined ? cornerRadius : parseInt(getComputedStyle(document.documentElement).getPropertyValue('--avatar-corner-radius') || '8') || 8;
                applyToPreviewEl(previewPartner, partnerImg, currentShape, cr);
                applyToPreviewEl(previewMy, myImg, currentShape, cr);
                if (typeof updateBubblePreview === 'function') updateBubblePreview();
            }

            function updateAvatarShapeBtns() {
                const shape = settings.myAvatarShape || 'circle';
                document.querySelectorAll('.avatar-shape-btn-2').forEach(b => {
                    b.classList.toggle('modal-btn-primary', b.dataset.shape === shape);
                    b.classList.toggle('modal-btn-secondary', b.dataset.shape !== shape);
                });
                const radiusCtrl = document.getElementById('avatar-corner-radius-control-2');
                if (radiusCtrl) radiusCtrl.style.display = shape === 'square' ? '' : 'none';
                updateAvatarPreview(shape);
            }
            document.querySelectorAll('.avatar-shape-btn-2').forEach(btn => {
                btn.addEventListener('click', () => {
                    const shape = btn.dataset.shape;
                    settings.myAvatarShape = shape;
                    settings.partnerAvatarShape = shape;
                    applyAvatarShapeToDOM && applyAvatarShapeToDOM('my', shape);
                    applyAvatarShapeToDOM && applyAvatarShapeToDOM('partner', shape);
                    updateAvatarShapeBtns();
                    updateAvatarPreview(shape);
                    renderMessages(true);
                    throttledSaveData();
                });
            });
            const cornerSlider = document.getElementById('avatar-corner-radius-slider-2');
            const cornerVal = document.getElementById('avatar-corner-radius-value-2');
            if (cornerSlider) {
                cornerSlider.value = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--avatar-corner-radius') || '8') || 8;
                if (cornerVal) cornerVal.textContent = cornerSlider.value + 'px';
                cornerSlider.addEventListener('input', () => {
                    const r = cornerSlider.value;
                    if (cornerVal) cornerVal.textContent = r + 'px';
                    document.documentElement.style.setProperty('--avatar-corner-radius', r + 'px');
                    updateAvatarPreview(settings.myAvatarShape || 'circle', parseInt(r));
                    renderMessages(true);
                });
                cornerSlider.addEventListener('change', () => {
                    settings.avatarCornerRadius = cornerSlider.value;
                    throttledSaveData();
                });
            }
            updateAvatarShapeBtns();

            document.querySelectorAll('[data-bubble-style]').forEach(item => {
                item.addEventListener('click', () => {
                    setTimeout(updateBubblePreview, 100);
                });
            });
            
            const minDelaySlider = document.getElementById('reply-delay-min-slider');
            const minDelayValue = document.getElementById('reply-delay-min-value');
            const maxDelaySlider = document.getElementById('reply-delay-max-slider');
            const maxDelayValue = document.getElementById('reply-delay-max-value');

            function updateDelayUI() {
                minDelaySlider.value = settings.replyDelayMin;
                const minSec = settings.replyDelayMin / 1000;
                minDelayValue.textContent = minSec >= 60 ? `${(minSec/60).toFixed(1)}åˆ†é’Ÿ` : `${minSec.toFixed(0)}s`;
                maxDelaySlider.value = settings.replyDelayMax;
                const maxSec = settings.replyDelayMax / 1000;
                maxDelayValue.textContent = maxSec >= 60 ? `${(maxSec/60).toFixed(1)}åˆ†é’Ÿ` : `${maxSec.toFixed(0)}s`;
                maxDelaySlider.min = settings.replyDelayMin; 
            }
            updateDelayUI();

            minDelaySlider.addEventListener('input', (e) => {
                settings.replyDelayMin = parseInt(e.target.value, 10);
                if (settings.replyDelayMin > settings.replyDelayMax) {
                    settings.replyDelayMax = settings.replyDelayMin;
                }
                updateDelayUI();
            });
            minDelaySlider.addEventListener('change', throttledSaveData);

            maxDelaySlider.addEventListener('input', (e) => {
                settings.replyDelayMax = parseInt(e.target.value, 10);
                 if (settings.replyDelayMax < settings.replyDelayMin) {
                    settings.replyDelayMin = settings.replyDelayMax;
                }
                updateDelayUI();
            });
            maxDelaySlider.addEventListener('change', throttledSaveData);

            const settingToggles = {
                '#reply-toggle': {
                    prop: 'replyEnabled', name: 'å¼•ç”¨å›žå¤'
                },
                '#sound-toggle': {
                    prop: 'soundEnabled', name: 'éŸ³æ•ˆ'
                },
                '#read-receipts-toggle': {
                    prop: 'readReceiptsEnabled', name: 'å·²è¯»å›žæ‰§'
                },
                '#typing-indicator-toggle': {
                    prop: 'typingIndicatorEnabled', name: 'æ­£åœ¨è¾“å…¥'},
                    '#read-no-reply-toggle': { prop: 'allowReadNoReply', name: 'å·²è¯»ä¸å›ž' }
};

            for (const [selector, {
                prop, name
            }] of Object.entries(settingToggles)) {
                const element = document.querySelector(selector);
                if (!element) continue;

                element.classList.toggle('active', !!settings[prop]);

                element.addEventListener('click', () => {
                    settings[prop] = !settings[prop];
                    throttledSaveData();
                    updateUI();
                    element.classList.toggle('active', !!settings[prop]);
                    if (prop !== 'soundEnabled') renderMessages(true);
                    showNotification(`${name}å·²${settings[prop] ? 'å¼€å¯': 'å…³é—­'}`, 'success');
                });
            }

            const soundVolSlider = document.getElementById('sound-volume-slider');
            const soundVolVal = document.getElementById('sound-volume-value');
            if (soundVolSlider) {
                soundVolSlider.value = Math.round((settings.soundVolume || 0.15) * 100);
                if (soundVolVal) soundVolVal.textContent = soundVolSlider.value + '%';
                soundVolSlider.addEventListener('input', (e) => {
                    settings.soundVolume = parseInt(e.target.value) / 100;
                    if (soundVolVal) soundVolVal.textContent = e.target.value + '%';
                });
                soundVolSlider.addEventListener('change', throttledSaveData);
            }
            const customSoundInput = document.getElementById('custom-sound-url-input');
            if (customSoundInput) {
                customSoundInput.value = settings.customSoundUrl || '';
                customSoundInput.addEventListener('change', () => {
                    settings.customSoundUrl = customSoundInput.value.trim();
                    throttledSaveData();
                });
            }
            const testSoundBtn = document.getElementById('test-sound-btn');
            if (testSoundBtn) {
                testSoundBtn.addEventListener('click', () => { playSound('message'); });
            }
            document.querySelectorAll('.time-fmt-opt').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.fmt === (settings.timeFormat || 'HH:mm'));
                opt.addEventListener('click', () => {
                    document.querySelectorAll('.time-fmt-opt').forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    settings.timeFormat = opt.dataset.fmt;
                    throttledSaveData();
                    renderMessages(true);
                    showNotification('æ—¶é—´æ ¼å¼å·²æ›´æ–°', 'success');
                });
            });


            document.getElementById('appearance-settings').addEventListener('click', () => {
                hideModal(DOMElements.settingsModal.modal);
                window.hideAppearancePanel && window.hideAppearancePanel();
                renderBackgroundGallery();
                renderThemeSchemesList();
                
                const fontSizeSliderEl = document.getElementById('font-size-slider');
                const fontSizeValueEl = document.getElementById('font-size-value');
                if (fontSizeSliderEl) {
                    fontSizeSliderEl.value = settings.fontSize;
                    if (fontSizeValueEl) fontSizeValueEl.textContent = `${settings.fontSize}px`;
                }
                const fontUrlInputEl = document.getElementById('custom-font-url');
                if (fontUrlInputEl) fontUrlInputEl.value = settings.customFontUrl || '';
                const cssTextareaEl = document.getElementById('custom-bubble-css');
                if (cssTextareaEl) cssTextareaEl.value = settings.customBubbleCss || '';
                
                document.querySelectorAll('[data-bubble-style]').forEach(item => {
                    item.classList.toggle('active', item.dataset.bubbleStyle === settings.bubbleStyle);
                });
                
                document.querySelectorAll('.theme-color-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === settings.colorTheme);
                });
                
                showModal(DOMElements.appearanceModal.modal);
                setTimeout(() => { 
                    updateAvatarSettingsUI && updateAvatarSettingsUI(); 
                    setupAppearancePanelFrameSettings && setupAppearancePanelFrameSettings();
                }, 100);
            });
            DOMElements.appearanceModal.closeBtn.addEventListener('click', () => {
                    hideModal(DOMElements.appearanceModal.modal);
                });

            const bgInput = document.getElementById('bg-gallery-input');
            if (bgInput) {
                bgInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.size > 10 * 1024 * 1024) {
                        showNotification('èƒŒæ™¯å›¾ç‰‡ä¸èƒ½è¶…è¿‡10MB', 'error');
                        return;
                    }
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('æ–‡ä»¶è¾ƒå¤§ï¼Œæ­£åœ¨å¤„ç†ä¸­...', 'info', 2000);
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64 = event.target.result;
                        savedBackgrounds.push({
                            id: `user-${Date.now()}`,
                            type: file.type === 'image/gif' ? 'gif' : 'image',
                            value: base64
                        });
                        saveBackgroundGallery();
                        renderBackgroundGallery();
                        applyBackground(base64);
                        localforage.setItem(getStorageKey('chatBackground'), base64);
                        showNotification('æ–°èƒŒæ™¯å·²æ·»åŠ å¹¶åº”ç”¨', 'success');
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                });
            }

const autoSendToggle = document.getElementById('auto-send-toggle');
const autoSendControl = document.getElementById('auto-send-control');
const autoSendSlider = document.getElementById('auto-send-slider');
const autoSendValue = document.getElementById('auto-send-value');

const updateAutoSendUI = () => {
    autoSendToggle.classList.toggle('active', !!settings.autoSendEnabled);
    autoSendControl.style.display = settings.autoSendEnabled ? "flex" : "none";
    const currentVal = settings.autoSendInterval || 5;
    autoSendSlider.value = currentVal;
    autoSendValue.textContent = `${currentVal}åˆ†é’Ÿ`;
};

updateAutoSendUI();

autoSendToggle.addEventListener('click', () => {
    settings.autoSendEnabled = !settings.autoSendEnabled;
    updateAutoSendUI();
    manageAutoSendTimer(); 
    throttledSaveData();
    showNotification(`ä¸»åŠ¨å‘é€å·²${settings.autoSendEnabled ? 'å¼€å¯' : 'å…³é—­'}`, 'success');
});

autoSendSlider.value = settings.autoSendInterval || 5;
autoSendValue.textContent = `${settings.autoSendInterval || 5}åˆ†é’Ÿ`;

autoSendSlider.addEventListener('input', (e) => {
    const val = parseInt(e.target.value);
    settings.autoSendInterval = val;
    autoSendValue.textContent = `${val}åˆ†é’Ÿ`;
});

autoSendSlider.addEventListener('change', () => {
    manageAutoSendTimer(); 
    throttledSaveData();
});

            const resetBgBtn = document.getElementById('reset-default-bg');
            if (resetBgBtn) {
                resetBgBtn.addEventListener('click', () => {
                    removeBackground();
                    renderBackgroundGallery();
                    showNotification('å·²ç§»é™¤èƒŒæ™¯å›¾', 'success');
                });
            }
        }


        function initNewFeatureListeners() {
            const flEntry = document.getElementById('fortune-lenormand-function');
            if (flEntry) {
                flEntry.addEventListener('click', () => {
                    hideModal(DOMElements.advancedModal.modal);
                    generateFortune();
                    switchFLTab('fortune');
                    showModal(document.getElementById('fortune-lenormand-modal'));
                });
            }

            document.getElementById('close-lenormand').addEventListener('click', () => {
                hideModal(document.getElementById('fortune-lenormand-modal'));
            });
    const envelopeEntryBtn = document.getElementById('envelope-function');
    if (envelopeEntryBtn) {
        envelopeEntryBtn.addEventListener('click', async () => {
            hideModal(DOMElements.advancedModal.modal);
            await loadEnvelopeData();
            await checkEnvelopeStatus();
            currentEnvTab = 'outbox';
            document.getElementById('env-tab-outbox').classList.add('active');
            document.getElementById('env-tab-inbox').classList.remove('active');
            document.getElementById('env-outbox-section').style.display = 'block';
            document.getElementById('env-inbox-section').style.display = 'none';
            document.getElementById('env-compose-form').style.display = 'none';
            document.getElementById('env-main-close-btn').style.display = 'flex';
            renderEnvelopeLists();
            showModal(document.getElementById('envelope-modal'));
        });
    }
    const resourceEntryBtn = document.getElementById('resource-share-function');
    if (resourceEntryBtn) {
        resourceEntryBtn.addEventListener('click', () => {
            hideModal(DOMElements.advancedModal.modal);
            window.open('https://aielin17.github.io/-/', '_blank');
        });
    }
document.getElementById('send-envelope').addEventListener('click', handleSendEnvelope);

document.getElementById('cancel-envelope').addEventListener('click', () => {
    hideModal(document.getElementById('envelope-modal'));
});
            const shareFortuneBtnEl = document.getElementById('share-fortune');
            if (shareFortuneBtnEl) {
                shareFortuneBtnEl.addEventListener('click', () => {
                    const fortuneDescEl = document.querySelector('.fortune-desc');
                    if (!fortuneDescEl) return;
                    const fortuneText = fortuneDescEl.textContent;
                    const shareText = `æˆ‘çš„ä»Šæ—¥è¿åŠ¿ï¼š${fortuneText}`;

                    if (navigator.share) {
                        navigator.share({
                            title: 'ä»Šæ—¥è¿åŠ¿',
                            text: shareText
                        });
                    } else {
                        navigator.clipboard.writeText(shareText).then(() => {
                            showNotification('è¿åŠ¿å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                        });
                    }
                });
            }

            const closeFortune = document.getElementById('close-fortune');
            if (closeFortune) {
                closeFortune.addEventListener('click', () => {
                    hideModal(document.getElementById('fortune-lenormand-modal'));
                });
            }


            document.getElementById('batch-favorite-function').addEventListener('click', () => {
                hideModal(DOMElements.favoritesModal.modal);
                toggleBatchFavoriteMode();
            });

            initReplyLibraryListeners();


            
            DOMElements.anniversaryAnimation.closeBtn.addEventListener('click', () => {
                DOMElements.anniversaryAnimation.modal.classList.remove('active');
            });


            document.getElementById('stats-function').addEventListener('click', () => {
                hideModal(DOMElements.advancedModal.modal);
                renderStatsContent();
                showModal(DOMElements.statsModal.modal);
            });

            const coinFunctionBtn = document.getElementById('coin-function');
            if (coinFunctionBtn) {
                coinFunctionBtn.addEventListener('click', () => {
                    hideModal(DOMElements.advancedModal.modal);
                    handleCoinToss();
                });
            }
            const musicToggle = document.getElementById('music-player-toggle');
            musicToggle.addEventListener('click', () => {
                settings.musicPlayerEnabled = !settings.musicPlayerEnabled;
                throttledSaveData();

                const player = document.getElementById('player');
                if (settings.musicPlayerEnabled) {
                    player.classList.add('visible');
                    showNotification('éŸ³ä¹æ’­æ”¾å™¨å·²å¼€å¯', 'success');
                } else {
                    player.classList.remove('visible');
                    document.getElementById('playlist').classList.remove('active');
                    const audio = document.getElementById('audio');
                    if (audio) audio.pause();
                    showNotification('éŸ³ä¹æ’­æ”¾å™¨å·²å…³é—­', 'info');
                }
                hideModal(DOMElements.advancedModal.modal);
            });
        }
    const annToggleBtn = document.getElementById('ann-toggle-btn');
    const annFormWrapper = document.getElementById('ann-form-wrapper');

    if (annToggleBtn && annFormWrapper) {
        annToggleBtn.addEventListener('click', () => {
            const isActive = annFormWrapper.classList.contains('active');
            
            if (isActive) {
                annFormWrapper.classList.remove('active');
                annToggleBtn.classList.remove('active');
            } else {
                annFormWrapper.classList.add('active');
                annToggleBtn.classList.add('active');
                
                setTimeout(() => {
                    annFormWrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
        });
    }

        function getBubbleStyleName(style) {
            const names = {
                'standard': 'æ ‡å‡†',
                'rounded': 'åœ†è§’',
                'rounded-large': 'å¤§åœ†è§’',
                'square': 'æ–¹å½¢'
            };
            return names[style] || 'æ ‡å‡†';
        }

        function initDataManagementListeners() {

            document.getElementById('export-chat').addEventListener('click', exportChatHistory);
            document.getElementById('import-chat').addEventListener('click', () => DOMElements.importInput.click());
            DOMElements.importInput.addEventListener('change', (e) => {
                if (e.target.files[0]) {
                    importChatHistory(e.target.files[0]); e.target.value = '';
                }
            });

            document.getElementById('clear-storage').addEventListener('click', clearAllAppData);
            const creditsBtn = document.getElementById('open-credits-btn');
            if (creditsBtn) {
                creditsBtn.addEventListener('click', () => {

                    hideModal(DOMElements.dataModal.modal);


                    const disclaimerModal = document.getElementById('disclaimer-modal');


                    if (disclaimerModal) {
                        showModal(disclaimerModal);
                    }
                });
            }

        }


        DOMElements.sessionModal.managerBtn.addEventListener('click', () => {
            renderSessionList(); showModal(DOMElements.sessionModal.modal);
        });
        DOMElements.sessionModal.createBtn.addEventListener('click', () => {
            const newId = createNewSession(false);

            renderSessionList();
            showNotification('æ–°ä¼šè¯å·²åˆ›å»º', 'success');
        });

        DOMElements.sessionModal.list.addEventListener('click', (e) => {
            const item = e.target.closest('.session-item');
            if (!item) return;
            const sessionId = item.dataset.id;

            if (e.target.closest('.rename')) {
                const session = sessionList.find(s => s.id === sessionId);
                const newName = prompt('è¾“å…¥æ–°çš„ä¼šè¯åç§°:', session.name);
                if (newName && newName.trim()) {
                    session.name = newName.trim();
                    localforage.setItem(`${APP_PREFIX}sessionList`, sessionList); 
                    renderSessionList();
                    showNotification('ä¼šè¯å·²é‡å‘½å', 'success');
                }
            } else if (e.target.closest('.delete')) {
                if (sessionList.length <= 1) {
                    showNotification('æ— æ³•åˆ é™¤æœ€åŽä¸€ä¸ªä¼šè¯', 'warning');
                    return;
                }
                if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¼šè¯åŠå…¶æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤')) {

                    const currentSessionId = SESSION_ID;

                    sessionList = sessionList.filter(s => s.id !== sessionId);
localforage.setItem(`${APP_PREFIX}sessionList`, sessionList);

Object.keys(localStorage).forEach(key => {
    if (key.startsWith(`${APP_PREFIX}${sessionId}_`)) safeRemoveItem(key);
});

if (sessionId === currentSessionId) {
    const newCurrentId = sessionList[0].id;
    localforage.setItem(`${APP_PREFIX}customThemes`, customThemes);
    window.location.hash = newCurrentId;
    window.location.reload();
} else {
    renderSessionList();
    showNotification('ä¼šè¯å·²åˆ é™¤', 'success');
}
                }
            } else {

                if (sessionId !== SESSION_ID) {
                    if (confirm('åˆ‡æ¢ä¼šè¯å°†åˆ·æ–°é¡µé¢ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        window.location.hash = sessionId;
                        window.location.reload();
                    }
                }
            }
        });

        const initMusicPlayer = () => {
    const latestSystemSongs = [{
                title: "è™šæ‹Ÿ", sub: "ä½ æ˜¯æˆ‘æœå¤•ç›¸ä¼´è§¦æ‰‹å¯åŠçš„è™šæ‹Ÿ", url: "https://files.catbox.moe/6s65mp.mp3"
            },
                {
                    title: "å¤šè¿œéƒ½è¦åœ¨ä¸€èµ·", sub: "çˆ±èƒ½å…‹æœè¿œè·ç¦»", url: "https://files.catbox.moe/06k9ra.mp3"
                },
                {
                    title: "æ°¸ä¸å¤±è”çš„çˆ±", sub: "è¿™ä¸€è¾ˆå­éƒ½ä¸æƒ³å¤±è”çš„çˆ±", url: "https://files.catbox.moe/uvucav.mp3"
                },
                {
                    title: "ç¨³ç¨³çš„å¹¸ç¦", sub: "è¿™æ˜¯æˆ‘æƒ³è¦çš„å¹¸ç¦", url: "https://files.catbox.moe/inb22a.mp3"
                },
                {
                    title: "æœ‰æˆ‘å‘¢", sub: "æˆ‘ä¼šè®©ä½ ä¹ æƒ¯ å¤šä¸€ä¸ªäººé™ªä¼´", url: "https://files.catbox.moe/hrazjt"
                },
                {
                    title: "ä¸€åƒé›¶ä¸€å¤œ", sub: "æ¢¦é‡Œèƒ½åˆ°è¾¾çš„åœ°æ–¹å•Š æœ‰ä¸€å¤©è„šæ­¥ä¹Ÿèƒ½åˆ°è¾¾", url: "https://files.catbox.moe/syfuon.mp3"
                },
                {
                    title: "æœˆäº®ä¸Žå…­ä¾¿å£«", sub: "æˆ‘çš„ä¸–ç•Œç”±ä½ å»ºç«‹ å› ä½ å´©å¡Œ", url: "https://files.catbox.moe/98quqc.mp3"
                },
                {
                    title: "æ¬¡å…ƒæ‹äºº", sub: "çº¦å¥½äº†éš”ç€æ¬¡å…ƒä¹Ÿå»ä½æ³ªçœ¼", url: "https://files.catbox.moe/5u5dy0.mp3"
                },
                {
                    title: "é˜³å…‰ä¸‹çš„æ˜Ÿæ˜Ÿ", sub: "å¦‚æžœçˆ±ä¸Šä½ åªæ˜¯ä¸€ä¸ªæ¢¦å¢ƒ", url: "https://files.catbox.moe/dxgqsk.mp3"
                },
                {
                    title: "å‘¨è¾¹", sub: "çµé­‚é‡Œç©ºç¼ºçš„é‚£æ®µ", url: "https://files.catbox.moe/a7k5wd.mp3"
                },
                {
                    title: "æ‹çˆ±ing", sub: "è®©æˆ‘é‡æ–°è®¤è¯†L O V E", url: "https://files.catbox.moe/94slcd.mp3"
                },
                {
                    title: "ä¸€ç‚¹ä¸€æ»´", sub: "ä½ è®©çˆ±ä¸€ç‚¹ä¸€æ»´æ±‡æˆæ²³", url: "https://files.catbox.moe/958qzg.mp3"
                },
                {
                    title: "å…³é”®è¯", sub: "è®©æˆ‘è§è¯†çˆ±æƒ…å¯ä»¥æ…·æ…¨åˆè‡ªç§", url: "https://files.catbox.moe/9yl5ic.mp3"
                },
                {
                    title: "æƒ³è§ä½ æƒ³è§ä½ æƒ³è§ä½ ", sub: "ç©¿è¶Šäº†åƒä¸ªä¸‡ä¸ªæ—¶é—´çº¿é‡Œäººæµ·é‡Œç›¸ä¾", url: "https://files.catbox.moe/co58d7.mp3"
                },
                {
                    title: "star crossing night", sub: "è¿™é‡Œæ²¡æœ‰ä½ ", url: "https://files.catbox.moe/i3f86b.mp3"
                },
                {
                    title: "sea temple", sub: "If we have each other", url: "https://files.catbox.moe/c57gxs.mp3"
                },
                {
                    title: "æˆ‘æƒ³è¦å æ®ä½ ", sub: "å æ®ä½ çš„â¼€åˆ‡ä¸”æ— å¯åŽšéž", url: "https://files.catbox.moe/1fp6eg.mp3"
                },
                {
                    title: "ç‰¹åˆ«çš„äºº", sub: "æˆ‘ä»¬æ˜¯å¯¹æ–¹ç‰¹åˆ«çš„äºº", url: "https://files.catbox.moe/a0n0l7.mp3"
                },
                {
                    title: "éº¦æ©èŽ‰", sub: "åœ¨å¹¿é˜”å¯‚å¯žæ¼©æ¶¡è§£è„±", url: "https://files.catbox.moe/2inae2.mp3"
                },
                {
                    title: "ä¼šå‘¼å¸çš„ç—›", sub: "æƒ³å¿µæ˜¯ä¼šå‘¼å¸çš„ç—›", url: "https://files.catbox.moe/0uhmxr.mp3"
                },
                {
                    title: "ä¸€ç”Ÿçš„çˆ±", sub: "æˆ‘åªæƒ³è¦ç»™ä½ æˆ‘ä¸€ç”Ÿçš„çˆ±", url: "https://files.catbox.moe/f0e93c.mp3"
                },
                {
                    title: "èº«éª‘ç™½é©¬", sub: "è¿½èµ¶è¦æˆ‘çˆ±çš„ä¸ä¿ç•™", url: "https://files.catbox.moe/iywfe2.mp3"
                },
                {
                    title: "çˆ±æƒ…è®¯æ¯", sub: "æƒ³å¿µå˜æˆç©ºæ°”åœ¨å¹æ¯", url: "https://files.catbox.moe/4dl0t2.mp3"
                },
                {
                    title: "ä½ åœ¨ ä¸åœ¨", sub: "ä½ åœ¨æˆ‘å¿ƒé‡Œé¢ é™ªæˆ‘å¤±çœ ", url: "https://files.catbox.moe/povyqa.mp3"
                },
                {
                    title: "ä½ æ˜¯æˆ‘çš„é£Žæ™¯", sub: "çˆ±è®©æ‚¬å´–å˜å¹³åœ°", url: "https://files.catbox.moe/fnwtf8.mp3"
                },
                {
                    title: "life with u", sub: "Now I know that you're the one", url: "https://files.catbox.moe/zqfxvd.mp3"
                },
                {
                    title: "å‹¾æŒ‡èµ·èª“", sub: "ä½ æ˜¯ç†æ‰€å½“ç„¶çš„å¥‡è¿¹", url: "https://files.catbox.moe/4spgo5.mp3"
                },
                {
                    title: "ç‰µä¸€åŠ", sub: "ä½ çš„å­˜åœ¨æ˜¯æˆ‘å”¯ä¸€ä¾èµ–", url: "https://files.catbox.moe/bk21gu.mp3"
                },
                {
                    title: "rove", sub: "Oh we are in the War of Love on Rove", url: "https://files.catbox.moe/sfwsuk.mp3"
                },
                {
                    title: "å”¯ä¸€", sub: "æˆ‘çœŸçš„çˆ±ä½  å¥å¥ä¸è½»æ˜“", url: "https://files.catbox.moe/69g4fe.mp3"
                },
            { title: "è‡´çˆ± Your Song", sub: "æˆ‘åªæƒ³æ¯ä¸ªè½æ—¥ èº«è¾¹éƒ½æœ‰ä½ ", url: "https://files.catbox.moe/01bmnf.mp3" },
            { title: "ä¸€é¦–æƒ³ä¸é€šçš„å¤é£Ž", sub: "ç”»åœ°ä¸ºç‰¢ ç”»å‘½ä¸ºç¬¦ é“¸æˆä¸‹ä¸€ä¸–åšå®ˆ", url: "https://files.catbox.moe/9b4lh7.mp3" },
            { title: "èŒ‰èŽ‰é›¨", sub: "ç´å£°é‡Œæ„å‡ è®¸å…³äºŽä½ ", url: "https://files.catbox.moe/7ml83u.mp3" },
            { title: "æ€Žä¹ˆå”±æƒ…æ­Œ", sub: "æµ· å˜çš„è‹¦æ¶© ç¼ä¼¤ä¸€ç‰‡æ¸©æŸ”", url: "https://files.catbox.moe/isqax9.mp3" },
            { title: "å²¸è¾¹å®¢", sub: "ä½ å›žæ¥æˆ‘å¿ƒæœªæ”¹ ä½ ä¸åœ¨æˆ‘è¿˜ç­‰å¾…", url: "https://files.catbox.moe/9oud6s.mp3" },
            { title: "æ±Ÿå—é›ª", sub: "ç›¸æ€å†æ— è¯è§£ ä»Žæ­¤ä¸‡èˆ¬é£Žæœˆéƒ½æ˜¯æˆ‘å¿ƒç»“", url: "https://files.catbox.moe/hhjwek.mp3" },
            { title: "ä¸æ­»ä¹‹èº«", sub: "æˆ‘ä»çˆ±ä½ çˆ±å¾—ä¸çŸ¥å¤©é«˜åœ°åŽš", url: "https://files.catbox.moe/g960ev.mp3" },
            { title: "æˆ‘ä»¬çš„æ˜Žå¤©", sub: "çˆ±ä»Žä¸æ›¾ä¿ç•™ æ‰å‹‡æ•¢äº†æˆ‘", url: "https://files.catbox.moe/a3yjvv.mp3" },
            { title: "éš¾è§£", sub: "ç‚¹ç‚·é«˜é¦™æ•¬äºˆç¥žæ˜Ž è¢«äººå˜²ç¬‘çŸ¢å¿—ä¸æ¸", url: "https://files.catbox.moe/1u8m3r.mp3" },
            { title: "æœ€å¥½çš„æˆ‘ & 50 Feet", sub: "è¯•ç€ä¼¸æ‰‹ å´è¿žä½ çš„å½±å­æˆ‘éƒ½æ— æ³•é è¿‘", url: "https://files.catbox.moe/clsiyi.mp3" },
            { title: "åŒæ‰‹åŒè„š", sub: "ä¹Ÿæ˜¯å­˜åœ¨åœ¨è¿™ä¸ªä¸–ç•Œ å”¯ä¸€çš„å”¯ä¸€", url: "https://files.catbox.moe/b8hss3.mp3" },
            { title: "åŒèŠ±é¡º", sub: "åªè¦è‚¯çˆ±å¾—æ·± æ˜¯ä¸æ˜¯å°±æœ‰è¿™å¯èƒ½", url: "https://files.catbox.moe/28mw5d.mp3" },
            { title: "è½»èˆž", sub: "è½»èˆžå§ è¿‡å¾€å¦‚è£™çº±", url: "https://files.catbox.moe/8n9lhi.mp3" },
            { title: "ç»å¯¹å æœ‰ ç›¸å¯¹è‡ªç”±", sub: "èµžç¾Žä½ åŒ…å®¹ä½ éƒ½æ˜¯æˆ‘çš„ä½¿å‘½", url: "https://files.catbox.moe/zi4gxo.mp3" },
            { title: "åƒä¸‡æ¬¡æƒ³è±¡", sub: "æˆ‘åƒä¸‡æ¬¡æƒ³è±¡ åƒä¸‡æ¬¡æ¨¡ä»¿ æ€å¿µçš„å½¢çŠ¶", url: "https://files.catbox.moe/4jtex8.mp3" },
            { title: "è¾žå®¶åƒé‡Œ", sub: "ç©¿è¿‡æ— äººé—®æ´¥åŽ»è§å±±æµ·ä¸‡é¡·", url: "https://files.catbox.moe/2quy44.mp3" },
            { title: "Ryukyuvania", sub: "----", url: "https://files.catbox.moe/utmbqp.mp3" },
            { title: "æ²¦é™·", sub: "åœˆå®ƒåœ¨é»‘æš—ä¸­é€ƒä¸å‡ºçš„æ¢¦é­‡", url: "https://files.catbox.moe/0bhl3i.mp3" },
            { title: "æ™šæž«æ­Œ", sub: "ä½ åˆæ€ŽçŸ¥æˆ‘ä»Žæœªæ”¾æ‰‹", url: "https://files.catbox.moe/xhwrwy.mp3" },
            { title: "I Need U", sub: "I need you girl", url: "https://files.catbox.moe/v1k4h8.mp3" },
            { title: "è‹¥æ¢¦", sub: "æ—¥å‡æœˆè½ æ­¤ç”Ÿä¾æ—§éš¾èˆ", url: "https://files.catbox.moe/6uysqy.mp3" },
            { title: "çˆ±äºº", sub: "å¯æ˜¯æ¨çš„äººæ²¡æ­»æˆ çˆ±çš„äººæ²¡å¯èƒ½", url: "https://files.catbox.moe/wtbdxe.mp3" },
            { title: "æ˜Ÿæ²³å¹", sub: "æˆ‘ç›¼å­¤èº«çºµé©¬ ç¬›å£°æ¼«å¤© å››æµ·ä»»æˆ‘æ¸¸", url: "https://files.catbox.moe/de7g2m.mp3" },
            { title: "çˆ±æ®‡", sub: "å‡æ¬¢ç•… åˆä½•å¦¨ æ— äººå…±äº«", url: "https://files.catbox.moe/or2hm7.mp3" },
            { title: "Una mattina", sub: "----", url: "https://files.catbox.moe/nf8o90.mp3" },
            { title: "é¡ºå…¶è‡ªç„¶", sub: "You light up my heart", url: "https://files.catbox.moe/na01cn.mp3" },
            { title: "åˆè§", sub: "è‹¥å¦‚åˆè§ ä¸ºè°è€Œå½’", url: "https://files.catbox.moe/bumolx.mp3" },
            { title: "æˆ‘å¥½åƒåœ¨å“ªè§è¿‡ä½ ", sub: "äººä»¬æŠŠéš¾è¨€çš„çˆ±éƒ½åŸ‹å…¥åœŸå£¤é‡Œ", url: "https://files.catbox.moe/vcidpc.mp3" },
            { title: "åˆ«å›žå¤´", sub: "çˆ±æ˜¯å¹´å°‘æ—¶ä¸å ªå…¶é‡ æ¸—é€çµé­‚çš„ä¸€é˜µå‰§ç—›", url: "https://files.catbox.moe/h1hwo5.mp3" },
            { title: "å¤§é±¼", sub: "æ€•ä½ é£žè¿œåŽ» æ€•ä½ ç¦»æˆ‘è€ŒåŽ»", url: "https://files.catbox.moe/jlcvkg.mp3" },
            { title: "äººé±¼çš„çœ¼æ³ª", sub: "Baby Don't cry", url: "https://files.catbox.moe/40fm4j.mp3" },
            { title: "ä¹å¼ æœº", sub: "æˆ‘æ„¿åŒ–ä½œæœ›æ–­å¤©æ¶¯é‚£ä¸€æ–¹é’çŸ³", url: "https://files.catbox.moe/hql6w5.mp3" },
            { title: "æ¢¦å¹»è¯›ä»™", sub: "æ¥ä¸–è‹¥å†ä¼šè¿˜ä¸Žä½ åŒåŒå¯¹å¯¹", url: "https://files.catbox.moe/r6btwp.mp3" },
            { title: "å¯»å¸¸æ­Œ", sub: "æ‰€å¹¸ä¸è¿‡æ˜¯ å¯»å¸¸äººé—´äº‹", url: "https://files.catbox.moe/ntcqvr.mp3" },
{ title: "å…¬ç¤ºæƒ…ä¹¦", sub: "æœ‰ç§å¾®å¦™ç¡®å®šçš„å¹¸ç¦ å«å¯¹æ–¹æ­£åœ¨è¾“å…¥", url: "https://files.catbox.moe/rptwer.mp3" },
{ title: "çŽ°åœ¨é‚£è¾¹æ˜¯å‡ ç‚¹", sub: "è¯·é—®ä½ çŽ°åœ¨é‚£è¾¹æ˜¯å‡ ç‚¹ ä¼šä¸ä¼šè¿˜æ”¾æœ‰æˆ‘çš„ç…§ç‰‡", url: "https://files.catbox.moe/icv2aa.mp3" },
{ title: "æƒ…äºº", sub: "æ°”æ°›å¼€å§‹å‡æ¸© å±é™©åˆè¿·äºº", url: "https://files.catbox.moe/iqairg.mp3" },
{ title: "æ€œæ‚¯", sub: "æˆ‘è¦å¸¦ç€çˆ±æ„ç€æ¨ä½ ", url: "https://files.catbox.moe/242a1h.mp3" },
{ title: "ç–‘å¿ƒç—…", sub: "ä½ ç»ˆäºŽè¯´å‡ºå£ä½ å¯¹æˆ‘æ„Ÿæƒ…ä¹Ÿå¾ˆé‡", url: "https://files.catbox.moe/jc1umm.mp3" },
{ title: "è¯€çˆ±", sub: "è‹¥çµé­‚ç›¸ç»“åœ¨å¤©åœ°ä¹‹é—´", url: "https://files.catbox.moe/quqaws.mp3" },
{ title: "å½¼å²¸", sub: "å¥¹æ§èµ·é•œèŠ±æ°´æœˆ ä¸€åˆ¹é‚£æ¹®ç­", url: "https://files.catbox.moe/zxepep.mp3" },
{ title: "é—®æƒ…", sub: "å½“çˆ±æ¨å¦‚æ½®ç”Ÿå¤šæ®‹å¿", url: "https://files.catbox.moe/erds0n.mp3" },
{ title: "åŒè¿›é€€", sub: "æˆ‘ä¼šç‰µç€ä½ æ‰‹åŒè¿›é€€ ä½›å‰ç«‹èª“ä¸åŽæ‚”", url: "https://files.catbox.moe/vb6chf.mp3" },
{ title: "æ‹›æ‘‡", sub: "ä¸€å¥æ­¤ç”Ÿä¸æ¢", url: "https://files.catbox.moe/oc86ih.mp3" },
{ title: "ä½ è¦çš„å…¨æ‹¿èµ°", sub: "å¥½èšå¥½æ•£å¬ç€ä¹Ÿæ¥šæ¥šå¯æ€œ", url: "https://files.catbox.moe/ok2e3s.mp3" },
{ title: "äº‘è£³ç¾½è¡£æ›²", sub: "æ•…äº‹é²œè‰³è€Œç¼˜åˆ†å´å¤ªæµ…", url: "https://files.catbox.moe/njnbhv.mp3" },
{ title: "å¤§æ¢¦å½’ç¦»", sub: "ç»ˆäºŽå¬é£Žå„¿è¯´ çŸ¥é“ä½ åœ¨å“ªé‡Œ", url: "https://files.catbox.moe/5z67vs.mp3" },
{ title: "åå‘", sub: "ä¸ºä½•ä¼šä¸¤è´¥ä¿±ä¼¤", url: "https://files.catbox.moe/i37f39.mp3" },
{ title: "Love me like you do", sub: "You're the only thing I wanna touch", url: "https://files.catbox.moe/arym0i.mp3" },
{ title: "Not snow,but U", sub: "æˆ‘æœŸå¾…çš„ä¸æ˜¯é›ªè€Œæ˜¯æœ‰ä½ çš„å†¬å¤©", url: "https://files.catbox.moe/6rk4gw.mp3" },
{ title: "The Evergreen", sub: "æˆ‘æç„¶æ˜Žäº†æˆ‘æ‰€éœ€çš„ä¸€åˆ‡å·²å°½æ•°æ‘†åœ¨çœ¼å‰", url: "https://files.catbox.moe/ca3rim.mp3" },
{ title: "å†¥æ²³èžºæ—‹", sub: "æˆ‘å¦‚æ­¤å¸Œæœ› æˆ‘ä¼´ä½ å·¦å³", url: "https://files.catbox.moe/xtj8db.mp3" },
{ title: "ç†„ç­", sub: "ä½ æ€»é—®æˆ‘åœ¨ä¸€èµ·ä¼šä¸ä¼šæ„Ÿåˆ°åŽŒå€¦", url: "https://files.catbox.moe/wnzxou.mp3" },
{ title: "çˆ±äººé”™è¿‡", sub: "æˆ‘è‚¯å®šåœ¨å‡ ç™¾å¹´å‰å°±è¯´è¿‡çˆ±ä½ ", url: "https://files.catbox.moe/q2nx16.mp3" },
{ title: "æˆ‘æƒ³å¿µ", sub: "æˆ‘æƒ³å¿µä½ è¯´è¿‡çš„é‚£ç§æ°¸è¿œ", url: "https://files.catbox.moe/3qxads.mp3" },
{ title: "æ­¤ç”Ÿä¸æ¢", sub: "å†æœ‰ä¸€ä¸‡å¹´æ·±æƒ…ä¹Ÿä¸å˜", url: "https://files.catbox.moe/72ik88.mp3" },
{ title: "é³¥ã®è©©", sub: "----", url: "https://files.catbox.moe/966u00.mp3" }

    ];

    const uploadCoverBtn = document.getElementById('upload-cover-btn');
    const coverInput = document.getElementById('cover-input');
    const vinylRecord = document.getElementById('vinyl-record-visual');

    const applyPlayerCover = (base64Data) => {
        if (base64Data) {
            vinylRecord.style.backgroundImage = `url(${base64Data})`;
            vinylRecord.classList.add('has-cover');
            vinylRecord.style.borderWidth = '1px';
        } else {
            vinylRecord.style.backgroundImage = '';
            vinylRecord.classList.remove('has-cover');
            vinylRecord.style.borderWidth = '2px';
        }
    };

const savedCover = safeGetItem(APP_PREFIX + 'playerCover');

    localforage.getItem(APP_PREFIX + 'playerCover').then(cover => { if(cover) applyPlayerCover(cover); });
    if (savedCover) applyPlayerCover(savedCover);

    uploadCoverBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (vinylRecord.classList.contains('has-cover')) {
            if (confirm('æƒ³è¦é‡ç½®å›žé»˜è®¤çš„ã€ä¸»é¢˜è‰²é»‘èƒ¶ã€‘æ ·å¼å—ï¼Ÿ\n\nâ€¢ ç‚¹å‡»ã€ç¡®å®šã€‘æ¢å¤é»˜è®¤\nâ€¢ ç‚¹å‡»ã€å–æ¶ˆã€‘é€‰æ‹©æ–°å›¾ç‰‡')) {
                localforage.removeItem(APP_PREFIX + 'playerCover');
                applyPlayerCover(null);
                showNotification('å·²æ¢å¤é»˜è®¤é»‘èƒ¶æ ·å¼', 'success');
                return;
            }
        }
        coverInput.click();
    });

    coverInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
            showNotification('å›¾ç‰‡å¤ªå¤§äº†ï¼Œè¯·ä¸Šä¼  2MB ä»¥å†…çš„å›¾ç‰‡', 'error');
            return;
        }
        const reader = new FileReader();
        reader.onload = (event) => {
            const base64Data = event.target.result;
            try {
                localforage.setItem(APP_PREFIX + 'playerCover', base64Data);
                applyPlayerCover(base64Data);
                showNotification('ä¸“è¾‘å°é¢è®¾ç½®æˆåŠŸï¼', 'success');
            } catch (err) {
                console.error(err);
                showNotification('å›¾ç‰‡å­˜å‚¨å¤±è´¥ï¼ˆå¯èƒ½è¶…å‡ºäº†æµè§ˆå™¨é™åˆ¶ï¼‰', 'error');
            }
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    });

    const savedSongsStr = safeGetItem(APP_PREFIX + 'customSongs');
    let songs = [];
if (savedSongsStr) {
        songs = JSON.parse(savedSongsStr);
    } else {
        songs = [...latestSystemSongs];
    }

    const player = document.getElementById('player');
    const miniView = document.getElementById('mini-view');
    const playlist = document.getElementById('playlist');
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('play-btn');
    const progressArea = document.getElementById('progress-area');

    const addSongModal = document.getElementById('add-song-modal');
    const newSongTitle = document.getElementById('new-song-title');
    const newSongSub = document.getElementById('new-song-sub');
    const newSongUrl = document.getElementById('new-song-url');
    const confirmAddSongBtn = document.getElementById('confirm-add-song');
    const cancelAddSongBtn = document.getElementById('cancel-add-song');
    const modalTitleElem = addSongModal.querySelector('.modal-title span');

    let currentIndex = 0;
    let isPlaying = false;
    let isRandom = false;
    let editModeIndex = -1;
    let searchTerm = '';
    let isSearchVisible = false;

    function loadSong(index) {
        if (songs.length === 0) return;
        if (index >= songs.length) index = 0;
        if (index < 0) index = songs.length - 1;

        const song = songs[index];
        document.getElementById('music-title').innerText = song.title;
        document.getElementById('music-subtitle').innerText = song.sub;
        
        if (song.url) audio.src = song.url;
        updatePlaylistHighlight();
    }

    function togglePlay() {
        if (songs.length === 0) {
            showNotification('æ’­æ”¾åˆ—è¡¨ä¸ºç©º', 'warning');
            return;
        }
        if (isPlaying) {
            audio.pause();
            isPlaying = false;
            document.getElementById('icon-play').style.display = 'block';
            document.getElementById('icon-pause').style.display = 'none';
            player.classList.remove('playing');
        } else {
            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    isPlaying = true;
                    document.getElementById('icon-play').style.display = 'none';
                    document.getElementById('icon-pause').style.display = 'block';
                    player.classList.add('playing');
                }).catch(error => {
                    console.error(error);
                    showNotification('æ’­æ”¾å¤±è´¥ï¼Œè¯·æŒ‚vpnï¼Œå…·ä½“æ–¹æ³•è‡ªè¡Œ', 'error');
                });
            }
        }
    }

    function nextSong() {
        if (songs.length === 0) return;
        if (isRandom) currentIndex = Math.floor(Math.random() * songs.length);
        else currentIndex = (currentIndex + 1) % songs.length;
        loadSong(currentIndex);
        if (isPlaying) audio.play();
    }

    function prevSong() {
        if (songs.length === 0) return;
        currentIndex = (currentIndex - 1 + songs.length) % songs.length;
        loadSong(currentIndex);
        if (isPlaying) audio.play();
    }

    function savePlaylist() {
        localforage.setItem(APP_PREFIX + 'customSongs', songs);
        renderPlaylist();
    }

    function syncSystemSongs() {
        if (confirm('æ›´æ–°æ­Œå•å°†ä¼šï¼š\n1. è¯»å–ä»£ç ä¸­æœ€æ–°çš„é¢„è®¾æ­Œå•\n2. ä¿ç•™ä½ æ‰‹åŠ¨æ·»åŠ çš„è‡ªå®šä¹‰æ­Œæ›²\n\nç¡®å®šè¦æ›´æ–°å—ï¼Ÿ')) {
            try {
                const userCustomSongs = songs.filter(s => s.isCustom === true);
                
                songs = [...latestSystemSongs, ...userCustomSongs];
                
                safeSetItem(APP_PREFIX + 'customSongs', JSON.stringify(songs));
                
                currentIndex = 0;
                loadSong(0);
                if (isPlaying) {
                    audio.pause();
                    audio.currentTime = 0;
                    isPlaying = false;
                    document.getElementById('icon-play').style.display = 'block';
                    document.getElementById('icon-pause').style.display = 'none';
                    player.classList.remove('playing');
                }

                renderPlaylist();
                
                showNotification('æ­Œå•å·²æˆåŠŸæ›´æ–°ï¼', 'success');
            } catch (e) {
                console.error(e);
                showNotification('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç æ ¼å¼', 'error');
            }
        }
    }

    function openEditModal(index) {
        const song = songs[index];
        if (!song) return;
        editModeIndex = index;
        newSongTitle.value = song.title;
        newSongSub.value = song.sub;
        newSongUrl.value = song.url;
        modalTitleElem.innerText = "ç¼–è¾‘æ­Œæ›²ä¿¡æ¯";
        confirmAddSongBtn.innerText = "ä¿å­˜ä¿®æ”¹";
        showModal(addSongModal);
    }

    function openAddModal() {
        editModeIndex = -1;
        newSongTitle.value = '';
        newSongSub.value = '';
        newSongUrl.value = '';
        modalTitleElem.innerText = "æ·»åŠ è‡ªå®šä¹‰æ­Œæ›²";
        confirmAddSongBtn.innerText = "æ·»åŠ æ’­æ”¾";
        showModal(addSongModal);
    }

    function renderPlaylist() {
        playlist.innerHTML = '';

        const header = document.createElement('div');
        header.className = 'playlist-header';
        header.innerHTML = `
            <div class="pl-header-title">Ë™Â°Êšá•±â‘…á•±ÉžÂ°Ë™</div>
            <div class="pl-header-actions">
                <button class="pl-icon-btn ${isSearchVisible ? 'active' : ''}" id="pl-search-toggle" title="æœç´¢"><i class="fas fa-search"></i></button>
                <button class="pl-icon-btn" id="pl-sync-btn" title="æ›´æ–°é¢„è®¾æ­Œå•"><i class="fas fa-sync-alt"></i></button>
                <button class="pl-icon-btn" id="pl-add-btn" title="æ·»åŠ æ­Œæ›²"><i class="fas fa-plus"></i></button>
            </div>
        `;
        playlist.appendChild(header);

        const searchWrapper = document.createElement('div');
        searchWrapper.className = `playlist-search-wrapper ${isSearchVisible ? 'active' : ''}`;
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.className = 'playlist-search-input';
        searchInput.placeholder = '';
        searchInput.value = searchTerm;
        
        searchInput.addEventListener('input', (e) => {
            searchTerm = e.target.value.toLowerCase();
            renderListContent(contentDiv);
        });
        
        searchWrapper.appendChild(searchInput);
        playlist.appendChild(searchWrapper);

        const contentDiv = document.createElement('div');
        contentDiv.className = 'playlist-content';
        playlist.appendChild(contentDiv);

        renderListContent(contentDiv);

        header.querySelector('#pl-add-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openAddModal();
            newSongTitle.focus();
        });
        
        header.querySelector('#pl-sync-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            syncSystemSongs();
        });

        header.querySelector('#pl-search-toggle').addEventListener('click', (e) => {
            e.stopPropagation();
            isSearchVisible = !isSearchVisible;
            searchWrapper.classList.toggle('active', isSearchVisible);
            e.currentTarget.classList.toggle('active', isSearchVisible);
            if (isSearchVisible) {
                setTimeout(() => searchInput.focus(), 100);
            }
        });
    }

    function renderListContent(container) {
        container.innerHTML = '';
        
        const filteredSongs = songs.map((s, i) => ({...s, originalIndex: i}))
                                   .filter(s => s.title.toLowerCase().includes(searchTerm) || 
                                                s.sub.toLowerCase().includes(searchTerm));

        if (filteredSongs.length === 0) {
            container.innerHTML = `<div class="empty-search-result">æœªæ‰¾åˆ° "${searchTerm}" ç›¸å…³æ­Œæ›²</div>`;
            return;
        }

        filteredSongs.forEach((song) => {
            const realIndex = song.originalIndex;

            const div = document.createElement('div');
            div.className = 'playlist-item';
            if (realIndex === currentIndex) div.classList.add('playing');

            const highlightText = (text, term) => {
                if (!term) return text;
                const regex = new RegExp(`(${term})`, 'gi');
                return text.replace(regex, '<span class="highlight">$1</span>');
            };

            const displayTitle = highlightText(song.title, searchTerm);
            const displaySub = highlightText(song.sub, searchTerm);

            div.innerHTML = `
                <div class="song-info">
                    <div class="song-title-row">${displayTitle}</div>
                    <div class="song-sub-row">${displaySub}</div>
                </div>
                <div class="item-actions">
                    ${song.isCustom ? '<span class="custom-tag" title="è‡ªå®šä¹‰æ­Œæ›²"></span>' : ''}
                    <span class="action-icon-btn delete" title="ç§»é™¤">&times;</span>
                </div>
            `;

            if (song.isCustom) {
                div.querySelector('.custom-tag').addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(realIndex);
                });
            }

            div.querySelector('.delete').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`ç¡®å®šç§»é™¤ã€Š${song.title}ã€‹å—ï¼Ÿ`)) {
                    songs.splice(realIndex, 1);
                    savePlaylist();
                    
                    if (realIndex === currentIndex) {
                        if (songs.length > 0) {
                            currentIndex = realIndex % songs.length;
                            loadSong(currentIndex);
                            if (isPlaying) audio.play();
                        } else {
                            audio.pause();
                            isPlaying = false;
                            loadSong(0);
                        }
                    } else if (realIndex < currentIndex) {
                        currentIndex--;
                    }
                }
            });

            div.addEventListener('click', (e) => {
                e.stopPropagation();
                currentIndex = realIndex;
                loadSong(currentIndex);
                if (!isPlaying) togglePlay();
                else audio.play();
            });

            container.appendChild(div);
        });
    }

    function updatePlaylistHighlight() {
        const contentDiv = playlist.querySelector('.playlist-content');
        if (contentDiv) renderListContent(contentDiv);
    }

    confirmAddSongBtn.addEventListener('click', () => {
        const title = newSongTitle.value.trim();
        const sub = newSongSub.value.trim();
        const url = newSongUrl.value.trim();

        if (!title || !url) {
            showNotification('æ­Œåå’Œé“¾æŽ¥ä¸èƒ½ä¸ºç©º', 'error');
            return;
        }

        const songData = {
            title,
            sub: sub || 'æœªçŸ¥è‰ºæœ¯å®¶',
            url,
            isCustom: true
        };

        if (editModeIndex >= 0) {
            songs[editModeIndex] = songData;
            showNotification('æ­Œæ›²ä¿¡æ¯å·²ä¿®æ”¹', 'success');
        } else {
            songs.unshift(songData);
            showNotification('æ­Œæ›²å·²æ·»åŠ ', 'success');
            if (songs.length === 1) loadSong(0);
        }

        searchTerm = '';
        savePlaylist();
        newSongTitle.value = '';
        newSongSub.value = '';
        newSongUrl.value = '';
        hideModal(addSongModal);
    });

    cancelAddSongBtn.addEventListener('click', () => {
        hideModal(addSongModal);
    });

    function setupDrag() {
        let isDragging = false, startX, startY, initialLeft, initialTop, hasMoved = false;
        const dragStart = (e) => {
            if (e.target.closest('.btn') || e.target.closest('.progress-wrapper') || e.target.closest('.playlist-popup')) return;
            const event = e.type === 'touchstart' ? e.touches[0] : e;
            isDragging = true; hasMoved = false;
            startX = event.clientX; startY = event.clientY;
            const rect = player.getBoundingClientRect();
            initialLeft = rect.left; initialTop = rect.top;
            player.style.transition = 'none';
            playlist.style.transition = 'none';
        };
        const dragMove = (e) => {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault();
            const event = e.type === 'touchmove' ? e.touches[0] : e;
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            if (Math.abs(dx) > 3 || Math.abs(dy) > 3) hasMoved = true;

            let newLeft = initialLeft + dx;
            let newTop = initialTop + dy;
            const maxLeft = window.innerWidth - player.offsetWidth;
            const maxTop = window.innerHeight - player.offsetHeight;
            player.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + 'px';
            player.style.top = Math.max(0, Math.min(newTop, maxTop)) + 'px';
            const rect = player.getBoundingClientRect();
            playlist.style.left = rect.left + 'px';
playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 65 : 155)) + 'px';
};
        const dragEnd = () => {
            if (!isDragging) return;
            isDragging = false;
            player.style.transition = '';
            playlist.style.transition = '';
        };
        player.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
        player.addEventListener('touchstart', dragStart, { passive: false });
        document.addEventListener('touchmove', dragMove, { passive: false });
        document.addEventListener('touchend', dragEnd);

        miniView.addEventListener('click', () => {
            if (!hasMoved && player.classList.contains('collapsed')) {
                player.classList.remove('collapsed');
                setTimeout(() => {
                    const rect = player.getBoundingClientRect();
                    playlist.style.top = (rect.top + 150) + 'px';
                }, 300);
            }
        });
    }

    playBtn.addEventListener('click', togglePlay);
    document.getElementById('next-btn').addEventListener('click', nextSong);
    document.getElementById('prev-btn').addEventListener('click', prevSong);
    document.getElementById('minimize-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        player.classList.add('collapsed');
        playlist.classList.remove('active');
    });

    progressArea.addEventListener('click', (e) => {
        const width = progressArea.clientWidth;
        const clickX = e.offsetX;
        const duration = audio.duration;
        if (duration) audio.currentTime = (clickX / width) * duration;
    });

    audio.addEventListener('timeupdate', (e) => {
        const { duration, currentTime } = e.target;
        if (duration) document.getElementById('progress-bar').style.width = `${(currentTime / duration) * 100}%`;
    });
    audio.addEventListener('ended', nextSong);

    document.getElementById('mode-btn').addEventListener('click', () => {
        isRandom = !isRandom;
        document.getElementById('icon-loop').style.display = isRandom ? 'none' : 'block';
        document.getElementById('icon-shuffle').style.display = isRandom ? 'block' : 'none';
        showNotification(isRandom ? 'éšæœºæ’­æ”¾' : 'é¡ºåºæ’­æ”¾', 'info', 1000);
    });

    const listBtn = document.getElementById('list-btn');
    listBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const rect = player.getBoundingClientRect();
        playlist.style.left = rect.left + 'px';
        playlist.style.top = (rect.top + (player.classList.contains('collapsed') ? 62 : 150)) + 'px';
        playlist.classList.toggle('active');
    });

    document.addEventListener('click', (e) => {
        if (!playlist.contains(e.target) && !listBtn.contains(e.target) && !player.contains(e.target) && !e.target.closest('#add-song-modal')) {
            playlist.classList.remove('active');
        }
    });

    loadSong(0);
    renderPlaylist();
    setupDrag();

    if (settings.musicPlayerEnabled) {
        player.classList.add('visible');
    }
};

        const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];



function renderReplyLibrary() {
    const list = document.getElementById('custom-replies-list');
    const searchInput = document.getElementById('reply-search-input');
    const addButton = document.getElementById('add-custom-reply');
    const subTabsContainer = document.getElementById('cr-sub-tabs');
    const titleEl = document.getElementById('cr-modal-title');

    const currentConfig = LIBRARY_CONFIG[currentMajorTab];
    titleEl.textContent = currentConfig.title;

    subTabsContainer.innerHTML = currentConfig.tabs.map(tab => `
        <button class="reply-tab-btn ${currentSubTab === tab.id ? 'active' : ''}" 
                data-id="${tab.id}" data-mode="${tab.mode}">
            ${tab.name}
        </button>
    `).join('');

    subTabsContainer.querySelectorAll('.reply-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentSubTab = btn.dataset.id;
            renderReplyLibrary();
        });
    });

    list.innerHTML = '';
    list.className = 'content-list-area'; 
    
    const activeTabConfig = currentConfig.tabs.find(t => t.id === currentSubTab);
    list.classList.add(activeTabConfig.mode + '-mode');

    const filterText = searchInput ? searchInput.value.toLowerCase().trim() : '';
    let itemsToRender = [];
    let renderType = 'text'; 
    if (currentMajorTab === 'reply') {
        if (currentSubTab === 'custom') {
            itemsToRender = customReplies;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žå›žå¤';
            addButton.style.display = 'flex';
        } else if (currentSubTab === 'default') {
            itemsToRender = CONSTANTS.REPLY_MESSAGES;
            addButton.style.display = 'none';
        } else if (currentSubTab === 'emojis') {
            itemsToRender = CONSTANTS.REPLY_EMOJIS;
            renderType = 'emoji';
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ·»åŠ Emoji';
            addButton.style.display = 'flex';
        } else if (currentSubTab === 'stickers') {
            itemsToRender = stickerLibrary;
            renderType = 'image';
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ·»åŠ è¡¨æƒ…';
            addButton.style.display = 'flex';
        }
    } else if (currentMajorTab === 'atmosphere') {
        addButton.style.display = 'flex';
        if (currentSubTab === 'pokes') {
            itemsToRender = customPokes;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žæ‹ä¸€æ‹';
        } else if (currentSubTab === 'statuses') {
            itemsToRender = customStatuses;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žçŠ¶æ€';
        } else if (currentSubTab === 'mottos') {
            itemsToRender = customMottos;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žæ ¼è¨€';
        } else if (currentSubTab === 'intros') {
            itemsToRender = customIntros;
            addButton.innerHTML = '<i class="fas fa-plus"></i> æ–°å¢žå¼€åœºè¯­';
        }
    }

    if (itemsToRender.length === 0 && renderType !== 'emoji') {
        list.innerHTML = renderEmptyState("åˆ—è¡¨ç©ºç©ºå¦‚ä¹Ÿ");
        return;
    }

    // Handle emoji rendering separately (includes custom emojis)
    if (renderType === 'emoji') {
        if (itemsToRender.length === 0 && customEmojis.length === 0) {
            list.innerHTML = renderEmptyState("åˆ—è¡¨ç©ºç©ºå¦‚ä¹Ÿ");
            return;
        }
        // Render default emojis
        itemsToRender.forEach(item => {
            const isDisabled = disabledDefaultReplies.includes(item);
            const div = document.createElement('div');
            div.className = `emoji-item ${isDisabled ? 'disabled' : ''}`;
            div.textContent = item;
            div.onclick = () => { toggleEmoji(item); };
            list.appendChild(div);
        });
        // Render custom emojis with delete button
        if (customEmojis.length > 0) {
            const sep = document.createElement('div');
            sep.style.cssText = 'grid-column:1/-1;font-size:11px;color:var(--text-secondary);padding:4px 2px 2px;border-top:1px dashed var(--border-color);margin-top:4px;';
            sep.textContent = 'â€” è‡ªå®šä¹‰ â€”';
            list.appendChild(sep);
            customEmojis.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'emoji-item';
                div.style.position = 'relative';
                div.innerHTML = `<span style="pointer-events:none;">${item}</span><span class="emoji-custom-del" style="position:absolute;top:-4px;right:-4px;font-size:10px;background:var(--text-secondary);color:#fff;border-radius:50%;width:14px;height:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity 0.2s;">Ã—</span>`;
                div.addEventListener('mouseenter', () => div.querySelector('.emoji-custom-del').style.opacity = '1');
                div.addEventListener('mouseleave', () => div.querySelector('.emoji-custom-del').style.opacity = '0');
                div.querySelector('.emoji-custom-del').addEventListener('click', (e) => {
                    e.stopPropagation();
                    customEmojis.splice(idx, 1);
                    throttledSaveData();
                    renderReplyLibrary();
                });
                list.appendChild(div);
            });
        }
        return;
    }

    itemsToRender.forEach((item, index) => {
        if (renderType === 'text' && filterText && !item.toLowerCase().includes(filterText)) return;
        
        if (renderType === 'image') {
            const div = document.createElement('div');
            div.className = 'sticker-item';
            div.innerHTML = `
                <img src="${item}" loading="lazy">
                <div class="sticker-delete-btn"><i class="fas fa-times"></i></div>
            `;
            div.querySelector('.sticker-delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                if(confirm("åˆ é™¤æ­¤è¡¨æƒ…ï¼Ÿ")) {
                    stickerLibrary.splice(index, 1);
                    throttledSaveData();
                    renderReplyLibrary();
                }
            });
            list.appendChild(div);
            return;
        }

        const isDefaultReply = (currentMajorTab === 'reply' && currentSubTab === 'default');
        const isDisabled = isDefaultReply && disabledDefaultReplies.includes(item);
        
        const div = document.createElement('div');
        div.className = `custom-reply-item ${isDisabled ? 'disabled' : ''}`;
        
        let displayHTML = `<span class="custom-reply-text">${item.replace('|', '<br><small style="opacity:0.7">')}</span>`; 

        let buttonsHTML = '';
        if (isDefaultReply) {
             const icon = isDisabled ? 'fa-eye' : 'fa-eye-slash';
             buttonsHTML = `
                <button class="reply-action-mini copy-btn" title="å¤åˆ¶ä¸ºè‡ªå®šä¹‰"><i class="fas fa-copy"></i></button>
                <button class="reply-action-mini toggle-btn"><i class="fas ${icon}"></i></button>
             `;
        } else {
            buttonsHTML = `
                <button class="reply-action-mini edit-btn"><i class="fas fa-pen"></i></button>
                <button class="reply-action-mini delete-btn"><i class="fas fa-trash-alt"></i></button>
            `;
        }

        div.innerHTML = `${displayHTML}<div class="custom-reply-actions">${buttonsHTML}</div>`;

        if (isDefaultReply) {
            div.querySelector('.toggle-btn').onclick = () => toggleDefaultReply(item);
            div.querySelector('.copy-btn').onclick = () => copyToCustom(item);
        } else {
            div.querySelector('.delete-btn').onclick = () => deleteItem(index);
            div.querySelector('.edit-btn').onclick = () => editItem(index, item);
        }

        list.appendChild(div);
    });
}
function toggleEmoji(emoji) {
    const idx = disabledDefaultReplies.indexOf(emoji);
    if (idx > -1) disabledDefaultReplies.splice(idx, 1);
    else disabledDefaultReplies.push(emoji);
    throttledSaveData();
    renderReplyLibrary();
}

function toggleDefaultReply(text) {
    const idx = disabledDefaultReplies.indexOf(text);
    if (idx > -1) disabledDefaultReplies.splice(idx, 1);
    else disabledDefaultReplies.push(text);
    throttledSaveData();
    renderReplyLibrary();
}

function copyToCustom(text) {
    customReplies.push(text);
    currentSubTab = 'custom';
    throttledSaveData();
    renderReplyLibrary();
    showNotification('å·²å¤åˆ¶åˆ°è‡ªå®šä¹‰å›žå¤', 'success');
}

function deleteItem(index) {
    if (!confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) return;
    
    if (currentMajorTab === 'reply' && currentSubTab === 'custom') customReplies.splice(index, 1);
    else if (currentSubTab === 'pokes') customPokes.splice(index, 1);
    else if (currentSubTab === 'statuses') customStatuses.splice(index, 1);
    else if (currentSubTab === 'mottos') customMottos.splice(index, 1);
    else if (currentSubTab === 'intros') customIntros.splice(index, 1);

    throttledSaveData();
    renderReplyLibrary();
}

function editItem(index, oldText) {
    let newText;
    if (currentSubTab === 'intros') {
        const parts = oldText.split('|');
        const l1 = prompt("ä¿®æ”¹ä¸»æ ‡é¢˜:", parts[0]);
        if(l1 === null) return;
        const l2 = prompt("ä¿®æ”¹å‰¯æ ‡é¢˜:", parts[1] || "");
        if(l2 === null) return;
        newText = `${l1}|${l2}`;
    } else {
        newText = prompt("ä¿®æ”¹å†…å®¹:", oldText);
    }

    if (newText === null || newText.trim() === "") return;

    if (currentMajorTab === 'reply' && currentSubTab === 'custom') customReplies[index] = newText;
    else if (currentSubTab === 'pokes') customPokes[index] = newText;
    else if (currentSubTab === 'statuses') customStatuses[index] = newText;
    else if (currentSubTab === 'mottos') customMottos[index] = newText;
    else if (currentSubTab === 'intros') customIntros[index] = newText;

    throttledSaveData();
    renderReplyLibrary();
}
function renderEmptyState(text) {
    return `
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 0; color: var(--text-secondary); opacity: 0.6; grid-column: 1 / -1;">
        <div style="width: 60px; height: 60px; background: var(--secondary-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; box-shadow: var(--shadow);">
            <i class="fas fa-search" style="font-size: 24px; color: var(--accent-color);"></i>
        </div>
        <p style="font-size:15px; font-weight: 500; text-align:center; line-height:1.5;">${text}</p>
    </div>`;
}

function initReplyLibraryListeners() {
    const entryBtn = document.getElementById('custom-replies-function');
    if (entryBtn) {
        entryBtn.addEventListener('click', () => {
            hideModal(DOMElements.advancedModal.modal);
            currentMajorTab = 'reply';
            currentSubTab = 'custom';
            document.querySelectorAll('.sidebar-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.major === 'reply');
            });
            renderReplyLibrary();
            showModal(DOMElements.customRepliesModal.modal);
        });
    }

    document.querySelectorAll('.sidebar-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            currentMajorTab = btn.dataset.major;

            if (currentMajorTab === 'announcement') {
                return;
            }

            var listArea = document.getElementById('custom-replies-list');
            var annPanel = document.getElementById('announcement-panel');
            var toolbar = document.getElementById('cr-toolbar');
            var subTabs = document.getElementById('cr-sub-tabs');
            var addBtn = document.getElementById('add-custom-reply');
            var titleEl = document.getElementById('cr-modal-title');
            if (listArea) listArea.style.display = '';
            if (annPanel) annPanel.style.display = 'none';
            if (toolbar) toolbar.style.display = '';
            if (subTabs) subTabs.style.display = '';
            if (addBtn) addBtn.style.display = '';
            if (titleEl) titleEl.textContent = 'å†…å®¹ç®¡ç†';
            
            currentSubTab = LIBRARY_CONFIG[currentMajorTab].tabs[0].id;
            
            renderReplyLibrary();
        });
    });

    const searchInput = document.getElementById('reply-search-input');
    if (searchInput) searchInput.addEventListener('input', renderReplyLibrary);

    const exportBtn = document.getElementById('export-replies-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', () => {
            const libraryData = {
                customReplies,
                customPokes,
                customStatuses,
                customMottos,
                customIntros,
                disabledDefaultReplies,
                customEmojis,
                exportDate: new Date().toISOString()
            };
            const fileName = `reply-library-backup-${new Date().toISOString().slice(0, 10)}.json`;
            const dataStr = JSON.stringify(libraryData, null, 2);
            exportDataToMobileOrPC(dataStr, fileName);
            showNotification('å·²å¯¼å‡ºï¼ˆè¡¨æƒ…åŒ…å› æ–‡ä»¶è¿‡å¤§å·²æŽ’é™¤ï¼Œè¯·å•ç‹¬ç®¡ç†ï¼‰', 'info', 4000);
        });
    }

    const importBtn = document.getElementById('import-replies-btn');
    const importInput = document.getElementById('import-replies-input');
    
    if (importBtn && importInput) {
        importBtn.addEventListener('click', () => {
            importInput.click();
        });

        importInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    const choice = confirm('é€‰æ‹©å¯¼å…¥æ–¹å¼ï¼š\n\nç‚¹å‡»ã€ç¡®å®šã€‘= è¦†ç›–ï¼ˆæ›¿æ¢å½“å‰å†…å®¹ï¼‰\nç‚¹å‡»ã€å–æ¶ˆã€‘= è¿½åŠ ï¼ˆä¿ç•™çŽ°æœ‰å†…å®¹å¹¶åˆå¹¶ï¼‰');
                    
                    let count = 0;
                    if (choice) {
                        if (data.customReplies) { customReplies = data.customReplies; count++; }
                        if (data.customPokes) { customPokes = data.customPokes; count++; }
                        if (data.customStatuses) { customStatuses = data.customStatuses; count++; }
                        if (data.customMottos) { customMottos = data.customMottos; count++; }
                        if (data.customIntros) { customIntros = data.customIntros; count++; }
                        if (data.stickerLibrary) { stickerLibrary = data.stickerLibrary; count++; }
                        if (data.disabledDefaultReplies) { disabledDefaultReplies = data.disabledDefaultReplies; count++; }
                        if (data.customEmojis) { customEmojis = data.customEmojis; count++; }
                    } else {
                        if (data.customReplies) { customReplies = [...new Set([...customReplies, ...data.customReplies])]; count++; }
                        if (data.customPokes) { customPokes = [...new Set([...customPokes, ...data.customPokes])]; count++; }
                        if (data.customStatuses) { customStatuses = [...new Set([...customStatuses, ...data.customStatuses])]; count++; }
                        if (data.customMottos) { customMottos = [...new Set([...customMottos, ...data.customMottos])]; count++; }
                        if (data.customIntros) { customIntros = [...new Set([...customIntros, ...data.customIntros])]; count++; }
                        if (data.stickerLibrary) { stickerLibrary = [...new Set([...stickerLibrary, ...data.stickerLibrary])]; count++; }
                        if (data.disabledDefaultReplies) { 
                            disabledDefaultReplies = [...new Set([...disabledDefaultReplies, ...data.disabledDefaultReplies])]; 
                            count++; 
                        }
                        if (data.customEmojis) {
                            customEmojis = [...new Set([...customEmojis, ...data.customEmojis])];
                            count++;
                        }
                    }
                    
                    throttledSaveData();
                    renderReplyLibrary();
                    showNotification(choice ? 'è¦†ç›–å¯¼å…¥æˆåŠŸï¼' : 'è¿½åŠ å¯¼å…¥æˆåŠŸï¼', 'success');
                } catch (err) {
                    console.error(err);
                    showNotification('æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = ''; 
        });
    }
    const addBtn = document.getElementById('add-custom-reply');
    if (addBtn) {
        addBtn.addEventListener('click', () => {
            if (currentSubTab === 'stickers') {
                document.getElementById('sticker-file-input').click();
                return;
            }

            if (currentSubTab === 'emojis') {
                const input = prompt('è¯·è¾“å…¥è¦æ·»åŠ çš„ Emojiï¼ˆæ”¯æŒç»„åˆè¡¨æƒ…ï¼‰:');
                if (input && input.trim()) {
                    customEmojis.push(input.trim());
                    throttledSaveData();
                    renderReplyLibrary();
                    showNotification('Emoji å·²æ·»åŠ ', 'success');
                }
                return;
            }

            let input;
            if (currentSubTab === 'intros') {
                 const l1 = prompt("è¯·è¾“å…¥ä¸»æ ‡é¢˜ (å¦‚: ð‘³ð’ð’—ð’†):");
                 if(!l1) return;
                 const l2 = prompt("è¯·è¾“å…¥å‰¯æ ‡é¢˜ (å¦‚: è‹¥è¦ç”±æˆ‘æ¥è°ˆè®ºçˆ±çš„è¯):");
                 input = `${l1}|${l2}`;
            } else {
                 input = prompt(`è¯·è¾“å…¥æ–°çš„${getCategoryName(currentSubTab)}:`);
            }

if (input && input.trim()) {
                const val = input.trim();
                let isDuplicate = false;
                const normalizeStr = s => s.trim().toLowerCase().replace(/\s+/g, ' ');
                const valNorm = normalizeStr(val);

                if (currentSubTab === 'custom' && (customReplies.some(r => normalizeStr(r) === valNorm) || CONSTANTS.REPLY_MESSAGES.some(r => normalizeStr(r) === valNorm))) isDuplicate = true;
                else if (currentSubTab === 'pokes' && customPokes.some(r => normalizeStr(r) === valNorm)) isDuplicate = true;
                else if (currentSubTab === 'statuses' && customStatuses.some(r => normalizeStr(r) === valNorm)) isDuplicate = true;
                else if (currentSubTab === 'mottos' && customMottos.some(r => normalizeStr(r) === valNorm)) isDuplicate = true;
                else if (currentSubTab === 'intros' && customIntros.some(r => normalizeStr(r) === valNorm)) isDuplicate = true;

                if (isDuplicate) {
                    showNotification('è¯¥å†…å®¹å·²å­˜åœ¨ï¼ˆåŒ…å«ç³»ç»Ÿé¢„è®¾ä¸­ï¼‰', 'warning');
                    return;
                }

                if (currentSubTab === 'custom') customReplies.unshift(val);
                else if (currentSubTab === 'pokes') customPokes.unshift(val);
                else if (currentSubTab === 'statuses') customStatuses.unshift(val);
                else if (currentSubTab === 'mottos') customMottos.unshift(val);
                else if (currentSubTab === 'intros') customIntros.unshift(val);
                
                throttledSaveData();
                renderReplyLibrary();
                showNotification('æ·»åŠ æˆåŠŸ', 'success');
            }        });
    }
}
function getCategoryName(tabId) {
    const map = {
        'custom': 'å›žå¤', 'pokes': 'æ‹ä¸€æ‹', 'statuses': 'çŠ¶æ€', 
        'mottos': 'æ ¼è¨€', 'intros': 'å¼€åœºè¯­'
    };
    return map[tabId] || 'å†…å®¹';
}
        function updateTabUI() {
            document.querySelectorAll('.reply-tab-btn').forEach(btn => {
                if (btn.dataset.tab === currentReplyTab) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const searchInput = document.getElementById('reply-search-input');
            if (searchInput) searchInput.value = '';
        }


        function initRippleFeedback() {

            const rippleTargets = [
                '.input-btn',
                '.action-btn',
                '.modal-btn',
                '.settings-item',
                '.batch-action-btn',
                '.coin-btn-action',
                '.import-export-btn',
                '.reply-tab-btn',
                '.anniversary-type-btn',
                '.reply-tool-btn',
                '.session-action-btn',
                '.fav-action-btn'
            ];


            document.addEventListener('mousedown', function(e) {

                const target = e.target.closest(rippleTargets.join(','));

                if (target) {
                    createRipple(e, target);
                }
            });

            function createRipple(event, button) {

                if (!button.classList.contains('ripple-effect')) {
                    button.classList.add('ripple-effect');
                }


                const circle = document.createElement('span');
                const diameter = Math.max(button.clientWidth, button.clientHeight);
                const radius = diameter / 2;


                const rect = button.getBoundingClientRect();


                const clientX = event.clientX || (event.touches ? event.touches[0].clientX: 0);
                const clientY = event.clientY || (event.touches ? event.touches[0].clientY: 0);

                circle.style.width = circle.style.height = `${diameter}px`;
                circle.style.left = `${clientX - rect.left - radius}px`;
                circle.style.top = `${clientY - rect.top - radius}px`;
                circle.classList.add('ripple-wave');


                const ripple = button.getElementsByClassName('ripple-wave')[0];
                if (ripple) {
                    ripple.remove();
                }


                button.appendChild(circle);


                setTimeout(() => {
                    circle.remove();
                }, 600);
            }
        }
        function applyAvatarFrame(avatarContainer, frameSettings) {
            let frameElement = avatarContainer.querySelector('.avatar-frame');
            
            if (frameSettings && frameSettings.src) {
                if (!frameElement) {
                    frameElement = document.createElement('img');
                    frameElement.className = 'avatar-frame';
                    avatarContainer.appendChild(frameElement);
                }
                frameElement.src = frameSettings.src;
                frameElement.style.width = `${frameSettings.size || 100}%`;
                frameElement.style.height = `${frameSettings.size || 100}%`;
                
                const offsetX = frameSettings.offsetX || 0;
                const offsetY = frameSettings.offsetY || 0;
                frameElement.style.transform = `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;
            } else {
                if (frameElement) {
                    frameElement.remove();
                }
            }
        }

        function setupAvatarFrameSettings() {
            const setupControlsFor = (type) => {
                const preview = document.getElementById(`${type}-frame-preview`);
                const uploadBtn = document.getElementById(`${type}-frame-upload-btn`);
                const removeBtn = document.getElementById(`${type}-frame-remove-btn`);
                const fileInput = document.getElementById(`${type}-frame-file-input`);
                const sizeSlider = document.getElementById(`${type}-frame-size`);
                const sizeValue = document.getElementById(`${type}-frame-size-value`);
                const xSlider = document.getElementById(`${type}-frame-offset-x`);
                const xValue = document.getElementById(`${type}-frame-offset-x-value`);
                const ySlider = document.getElementById(`${type}-frame-offset-y`);
                const yValue = document.getElementById(`${type}-frame-offset-y-value`);
                
                if (!preview || !uploadBtn || !sizeSlider) return;

                const settingsKey = type === 'my' ? 'myAvatarFrame' : 'partnerAvatarFrame';
                const avatarContainer = type === 'my' ? DOMElements.me.avatarContainer : DOMElements.partner.avatarContainer;
                const avatarElement = type === 'my' ? DOMElements.me.avatar : DOMElements.partner.avatar;


const updatePreview = () => {
    let avatarContent = avatarElement.innerHTML;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = avatarContent;
    const img = tempDiv.querySelector('img');
    if (img) {
        avatarContent = `<img src="${img.src}" alt="preview">`;
    }

    const frameSettings = settings[settingsKey];

    let frameHtml = '';
    if (frameSettings && frameSettings.src) {
        const size = frameSettings.size || 100;
        const offsetX = frameSettings.offsetX || 0;
        const offsetY = frameSettings.offsetY || 0;
        
        frameHtml = `<img src="${frameSettings.src}" class="preview-frame" 
            style="width: ${size}%; height: ${size}%; transform: translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px));">`;
    }

    preview.innerHTML = `
        <div class="preview-bg-layer">
            ${avatarContent}
        </div>
        ${frameHtml}
    `;
};
                
                const updateControls = () => {
                    const frame = settings[settingsKey];
                    sizeSlider.value = frame?.size || 100;
                    sizeValue.textContent = `${sizeSlider.value}%`;
                    xSlider.value = frame?.offsetX || 0;
                    xValue.textContent = `${xSlider.value}px`;
                    ySlider.value = frame?.offsetY || 0;
                    yValue.textContent = `${ySlider.value}px`;
                    updatePreview();
                };
                
                uploadBtn.addEventListener('click', () => fileInput.click());
                
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.size > 1024 * 1024) {
                        showNotification('å¤´åƒæ¡†å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡1MB', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        if (!settings[settingsKey]) {
                            settings[settingsKey] = { size: 100, offsetX: 0, offsetY: 0 };
                        }
                        settings[settingsKey].src = event.target.result;
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls();
                        throttledSaveData();
                    };
                    reader.readAsDataURL(file);
                });
                
                removeBtn.addEventListener('click', () => {
                    settings[settingsKey] = null;
                    applyAvatarFrame(avatarContainer, null);
                    updateControls();
                    throttledSaveData();
                });

                [sizeSlider, xSlider, ySlider].forEach(slider => {
                    slider.addEventListener('input', () => {
                        if (!settings[settingsKey]) return;
                        settings[settingsKey].size = parseInt(sizeSlider.value);
                        settings[settingsKey].offsetX = parseInt(xSlider.value);
                        settings[settingsKey].offsetY = parseInt(ySlider.value);
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls();
                        renderMessages(true); 
                    });
                     slider.addEventListener('change', throttledSaveData);
                });

                updateControls();
            };
            
            setupControlsFor('my');
            setupControlsFor('partner');
        }

        function applyAllAvatarFrames() {
            applyAvatarFrame(DOMElements.me.avatarContainer, settings.myAvatarFrame);
            applyAvatarFrame(DOMElements.partner.avatarContainer, settings.partnerAvatarFrame);
            applyAvatarShapeToDOM('my', settings.myAvatarShape || 'circle');
            applyAvatarShapeToDOM('partner', settings.partnerAvatarShape || 'circle');
            if (settings.avatarCornerRadius) {
                document.documentElement.style.setProperty('--avatar-corner-radius', settings.avatarCornerRadius + 'px');
            }
        }

function applyAvatarShapeToDOM(type, shape) {
            const SHAPES = ['circle','square'];
            const avatarContainer = type === 'my' ? DOMElements.me.avatarContainer : DOMElements.partner.avatarContainer;
            if (!avatarContainer) return;
            SHAPES.forEach(s => avatarContainer.classList.remove('avatar-shape-' + s));
            if (shape && shape !== 'none') avatarContainer.classList.add('avatar-shape-' + shape);
            
            document.querySelectorAll('.message-wrapper').forEach(wrapper => {
                const isUser = wrapper.classList.contains('sent');
                if ((type === 'my' && isUser) || (type === 'partner' && !isUser)) {
                    const avatarDiv = wrapper.querySelector('.message-avatar');
                    if (avatarDiv) {
                        SHAPES.forEach(s => avatarDiv.classList.remove('shape-' + s));
                        if (shape && shape !== 'none') avatarDiv.classList.add('shape-' + shape);
                    }
                }
            });
        }
        function setupAppearancePanelFrameSettings() {
            const setupFor = (type) => {
                const suffix = '-2';
                const preview = document.getElementById(`${type}-frame-preview${suffix}`);
                const uploadBtn = document.getElementById(`${type}-frame-upload-btn${suffix}`);
                const removeBtn = document.getElementById(`${type}-frame-remove-btn${suffix}`);
                const fileInput = document.getElementById(`${type}-frame-file-input${suffix}`);
                const sizeSlider = document.getElementById(`${type}-frame-size${suffix}`);
                const sizeValue = document.getElementById(`${type}-frame-size-value${suffix}`);
                const xSlider = document.getElementById(`${type}-frame-offset-x${suffix}`);
                const xValue = document.getElementById(`${type}-frame-offset-x-value${suffix}`);
                const ySlider = document.getElementById(`${type}-frame-offset-y${suffix}`);
                const yValue = document.getElementById(`${type}-frame-offset-y-value${suffix}`);
                if (!preview || !uploadBtn) return;

                const settingsKey = type === 'my' ? 'myAvatarFrame' : 'partnerAvatarFrame';
                const avatarContainer = type === 'my' ? DOMElements.me.avatarContainer : DOMElements.partner.avatarContainer;
                const avatarElement = type === 'my' ? DOMElements.me.avatar : DOMElements.partner.avatar;

                const updatePreview2 = () => {
                    let avatarContent = avatarElement.innerHTML;
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = avatarContent;
                    const img = tempDiv.querySelector('img');
                    if (img) avatarContent = `<img src="${img.src}" alt="preview">`;
                    const frameSettings = settings[settingsKey];
                    let frameHtml = '';
                    if (frameSettings && frameSettings.src) {
                        const size = frameSettings.size || 100;
                        const ox = frameSettings.offsetX || 0;
                        const oy = frameSettings.offsetY || 0;
                        frameHtml = `<img src="${frameSettings.src}" class="preview-frame" style="width:${size}%;height:${size}%;transform:translate(calc(-50% + ${ox}px),calc(-50% + ${oy}px));">`;
                    }
                    preview.innerHTML = `<div class="preview-bg-layer">${avatarContent}</div>${frameHtml}`;
                };

                const updateControls2 = () => {
                    const frame = settings[settingsKey];
                    if (sizeSlider) { sizeSlider.value = frame?.size || 100; sizeValue.textContent = `${sizeSlider.value}%`; }
                    if (xSlider) { xSlider.value = frame?.offsetX || 0; xValue.textContent = `${xSlider.value}px`; }
                    if (ySlider) { ySlider.value = frame?.offsetY || 0; yValue.textContent = `${ySlider.value}px`; }
                    updatePreview2();
                };

                uploadBtn.addEventListener('click', () => fileInput && fileInput.click());
                if (fileInput) fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0]; if (!file) return;
                    if (file.size > 1024 * 1024) { showNotification('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡1MB', 'error'); return; }
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        if (!settings[settingsKey]) settings[settingsKey] = { size: 100, offsetX: 0, offsetY: 0 };
                        settings[settingsKey].src = ev.target.result;
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls2(); throttledSaveData();
                    };
                    reader.readAsDataURL(file);
                });
                if (removeBtn) removeBtn.addEventListener('click', () => {
                    settings[settingsKey] = null;
                    applyAvatarFrame(avatarContainer, null);
                    updateControls2(); throttledSaveData();
                });
                [sizeSlider, xSlider, ySlider].forEach(s => {
                    if (!s) return;
                    s.addEventListener('input', () => {
                        if (!settings[settingsKey]) return;
                        settings[settingsKey].size = parseInt(sizeSlider.value);
                        settings[settingsKey].offsetX = parseInt(xSlider.value);
                        settings[settingsKey].offsetY = parseInt(ySlider.value);
                        applyAvatarFrame(avatarContainer, settings[settingsKey]);
                        updateControls2(); renderMessages(true);
                    });
                    s.addEventListener('change', throttledSaveData);
                });
                updateControls2();
            };
            setupFor('my');
            setupFor('partner');
        }
        const themeColorMappings = {
            '--primary-bg': 'ä¸»èƒŒæ™¯è‰²',
            '--secondary-bg': 'å¡ç‰‡ / å¼¹çª—èƒŒæ™¯',
            '--header-bg': 'é¡¶æ èƒŒæ™¯',
            '--input-area-bg': 'è¾“å…¥åŒºèƒŒæ™¯',
            '--text-primary': 'ä¸»è¦æ–‡å­—',
            '--text-secondary': 'æ¬¡è¦æ–‡å­— / å ä½ç¬¦',
            '--border-color': 'è¾¹æ¡† / åˆ†å‰²çº¿',
            '--accent-color': 'ä¸»å¼ºè°ƒè‰²ï¼ˆæŒ‰é’® / å›¾æ ‡ï¼‰',
            '--accent-color-dark': 'å¼ºè°ƒè‰²æ·±è‰²å˜ä½“',
            '--message-sent-bg': 'æˆ‘æ–¹æ°”æ³¡èƒŒæ™¯',
            '--message-sent-text': 'æˆ‘æ–¹æ°”æ³¡æ–‡å­—',
            '--message-received-bg': 'å¯¹æ–¹æ°”æ³¡èƒŒæ™¯',
            '--message-received-text': 'å¯¹æ–¹æ°”æ³¡æ–‡å­—',
            '--favorite-color': 'æ”¶è—æ˜Ÿæ ‡é¢œè‰²',
        };

        const themeExtraMappings = {
            '--radius': { label: 'åœ†è§’åŠå¾„', type: 'range', min: 0, max: 32, unit: 'px', default: '16px' },
            '--message-font-weight': { label: 'æ¶ˆæ¯ç²—ç»†', type: 'select', options: ['300','400','500','600','700'], default: '400' },
            '--message-line-height': { label: 'æ¶ˆæ¯è¡Œé«˜', type: 'range', min: 1.0, max: 2.5, step: 0.05, unit: '', default: '1.5' },
        };


function initThemeEditor() {
    const openEditorBtn = document.getElementById('open-theme-editor');
    
    if (openEditorBtn) {
        const newBtn = openEditorBtn.cloneNode(true);
        openEditorBtn.parentNode.replaceChild(newBtn, openEditorBtn);

        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log("è‡ªå®šä¹‰ä¸»é¢˜ç¼–è¾‘å™¨æŒ‰é’®è¢«ç‚¹å‡»ï¼");
            
            const appearanceModal = document.getElementById('appearance-modal');
            const editorModal = document.getElementById('theme-editor-modal');

            if (appearanceModal) hideModal(appearanceModal);
            
            populateThemeEditor();
            populateThemeSelector();
            
            if (editorModal) showModal(editorModal);
        });
    }

    const closeBtn = document.getElementById('close-theme-editor');
    if (closeBtn) {
        closeBtn.onclick = () => {
            updateUI();
            hideModal(document.getElementById('theme-editor-modal'));
        };
    }
    
    const applyCloseBtn = document.getElementById('apply-close-theme-editor');
    if (applyCloseBtn) {
        applyCloseBtn.onclick = () => {
            const root = document.documentElement;
            const customColors = {};
            for (const variable of Object.keys(themeColorMappings)) {
                const val = root.style.getPropertyValue(variable);
                if (val) customColors[variable] = val.trim();
            }
            for (const variable of Object.keys(themeExtraMappings)) {
                const val = root.style.getPropertyValue(variable);
                if (val) customColors[variable] = val.trim();
            }
            settings.customThemeColors = customColors;
            throttledSaveData && throttledSaveData();
            updateUI();
            hideModal(document.getElementById('theme-editor-modal'));
            showNotification('ä¸»é¢˜å·²åº”ç”¨', 'success');
        };
    }
    
    const saveBtn = document.getElementById('save-theme-preset-btn');
    if(saveBtn) saveBtn.onclick = saveCurrentThemeAsPreset;

    const overwriteBtn = document.getElementById('overwrite-theme-preset-btn');
    if(overwriteBtn) overwriteBtn.onclick = function() {
        const selector = document.getElementById('theme-preset-selector');
        const selectedId = selector && selector.value;
        if (!selectedId || !selectedId.startsWith('custom-')) {
            showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè‡ªå®šä¹‰æ–¹æ¡ˆå†è¦†ç›–', 'warning');
            return;
        }
        const theme = customThemes.find(t => t.id === selectedId);
        if (!theme) return;
        if (!confirm(`ç¡®å®šè¦ç”¨å½“å‰ç¼–è¾‘å†…å®¹è¦†ç›–ã€Œ${theme.name}ã€å—ï¼Ÿ`)) return;
        const root = document.documentElement;
        theme.colors = {};
        for (const variable of Object.keys(themeColorMappings)) {
            const val = root.style.getPropertyValue(variable) || getComputedStyle(root).getPropertyValue(variable).trim();
            if (val) theme.colors[variable] = val.trim();
        }
        for (const variable of Object.keys(themeExtraMappings)) {
            const val = root.style.getPropertyValue(variable) || getComputedStyle(root).getPropertyValue(variable).trim();
            if (val) theme.colors[variable] = val.trim();
        }
        saveCustomThemes();
        showNotification(`å·²è¦†ç›–ã€Œ${theme.name}ã€`, 'success');
    };
    
    const renameBtn = document.getElementById('rename-theme-preset-btn');
    if(renameBtn) renameBtn.onclick = () => {
        const selector = document.getElementById('theme-preset-selector');
        const selectedId = selector && selector.value;
        if (!selectedId || !selectedId.startsWith('custom-')) {
            showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè‡ªå®šä¹‰æ–¹æ¡ˆå†é‡å‘½å', 'warning');
            return;
        }
        const theme = customThemes.find(t => t.id === selectedId);
        if (!theme) return;
        const newName = prompt('è¾“å…¥æ–°åç§°ï¼š', theme.name);
        if (!newName || !newName.trim()) return;
        theme.name = newName.trim();
        saveCustomThemes();
        populateThemeSelector();
        showNotification(`å·²é‡å‘½åä¸ºã€Œ${newName}ã€`, 'success');
    };

    const delBtn = document.getElementById('delete-theme-preset-btn');
    if(delBtn) delBtn.onclick = deleteCurrentPreset;

    const selector = document.getElementById('theme-preset-selector');
    if(selector) {
        selector.onchange = (e) => {
            const selectedValue = e.target.value;
            const owBtn = document.getElementById('overwrite-theme-preset-btn');
            if (owBtn) owBtn.style.display = selectedValue.startsWith('custom-') ? '' : 'none';
            if (selectedValue === "current-editing") return;
            
            if (selectedValue.startsWith('custom-')) {
                const theme = customThemes.find(t => t.id === selectedValue);
                if (theme) {
                    settings.colorTheme = theme.id;
                    applyTheme(theme.colors);
                    populateThemeEditor(theme.colors);
                    throttledSaveData();
                }
            }
        };
    }
}
        function populateThemeEditor(currentColors = null) {
            const grid = document.getElementById('theme-editor-grid');
            grid.innerHTML = '';
            const rootStyle = getComputedStyle(document.documentElement);

            const colorHeading = document.createElement('div');
            colorHeading.style.cssText = 'grid-column:1/-1;font-size:11px;font-weight:700;color:var(--text-secondary);letter-spacing:2px;text-transform:uppercase;padding:4px 0 2px;border-bottom:1px solid var(--border-color);margin-bottom:4px;';
            colorHeading.textContent = 'ðŸŽ¨ é¢œè‰²';
            grid.appendChild(colorHeading);

            for (const [variable, label] of Object.entries(themeColorMappings)) {
                const rawVal = currentColors ? currentColors[variable] : rootStyle.getPropertyValue(variable).trim();
                let colorValue = rawVal;
                if (!colorValue || colorValue.includes('var(')) {
                    colorValue = '#888888';
                } else if (colorValue.startsWith('rgb')) {
                    try {
                        const m = colorValue.match(/\d+/g);
                        if (m && m.length >= 3) {
                            colorValue = '#' + [m[0],m[1],m[2]].map(n => parseInt(n).toString(16).padStart(2,'0')).join('');
                        }
                    } catch(e) { colorValue = '#888888'; }
                }
                const item = document.createElement('div');
                item.className = 'color-picker-item';
                item.innerHTML = `<label for="color-${variable.replace(/--/g,'')}">${label}</label><input type="color" id="color-${variable.replace(/--/g,'')}" data-variable="${variable}" value="${colorValue}">`;
                grid.appendChild(item);
                item.querySelector('input[type="color"]').addEventListener('input', (e) => {
                    document.documentElement.style.setProperty(e.target.dataset.variable, e.target.value);
                });
            }

            const extraHeading = document.createElement('div');
            extraHeading.style.cssText = 'grid-column:1/-1;font-size:11px;font-weight:700;color:var(--text-secondary);letter-spacing:2px;text-transform:uppercase;padding:8px 0 2px;border-bottom:1px solid var(--border-color);margin-bottom:4px;margin-top:8px;';
            extraHeading.textContent = 'âš™ï¸ æ•°å€¼ & å­—é‡';
            grid.appendChild(extraHeading);

            for (const [variable, cfg] of Object.entries(themeExtraMappings)) {
                const rawVal = rootStyle.getPropertyValue(variable).trim() || cfg.default;
                const numVal = parseFloat(rawVal);
                const item = document.createElement('div');
                item.style.cssText = 'grid-column:1/-1;display:flex;align-items:center;gap:10px;background:var(--primary-bg);padding:8px;border-radius:8px;';
                if (cfg.type === 'range') {
                    item.innerHTML = `
                        <label style="font-size:13px;flex:1;">${cfg.label}</label>
                        <input type="range" min="${cfg.min}" max="${cfg.max}" step="${cfg.step||1}" value="${numVal||parseFloat(cfg.default)}"
                            data-variable="${variable}" data-unit="${cfg.unit}"
                            style="flex:2;max-width:140px;accent-color:var(--accent-color);">
                        <span style="width:44px;text-align:right;font-size:12px;color:var(--text-secondary);">${numVal||parseFloat(cfg.default)}${cfg.unit}</span>`;
                    const rangeInput = item.querySelector('input[type="range"]');
                    const valLabel = item.querySelector('span');
                    rangeInput.addEventListener('input', () => {
                        const v = rangeInput.value + cfg.unit;
                        document.documentElement.style.setProperty(variable, v);
                        valLabel.textContent = rangeInput.value + cfg.unit;
                        if (variable === '--radius') { settings.borderRadius = rangeInput.value; throttledSaveData && throttledSaveData(); }
                        if (variable === '--message-line-height') { settings.messageLineHeight = parseFloat(rangeInput.value); throttledSaveData && throttledSaveData(); }
                    });
                } else if (cfg.type === 'select') {
                    const opts = cfg.options.map(o => `<option value="${o}" ${String(numVal||cfg.default)===o?'selected':''}>${o}</option>`).join('');
                    item.innerHTML = `<label style="font-size:13px;flex:1;">${cfg.label}</label><select data-variable="${variable}" style="padding:5px 10px;border-radius:8px;border:1px solid var(--border-color);background:var(--secondary-bg);color:var(--text-primary);font-size:13px;cursor:pointer;">${opts}</select>`;
                    item.querySelector('select').addEventListener('change', (e) => {
                        const newVal = e.target.value;
                        document.documentElement.style.setProperty(variable, newVal);
                        if (variable === '--message-font-weight') { settings.messageFontWeight = newVal; throttledSaveData && throttledSaveData(); }
                        if (variable === '--message-line-height') { settings.messageLineHeight = parseFloat(newVal); throttledSaveData && throttledSaveData(); }
                    });
                }
                grid.appendChild(item);
            }

            const previewHeading = document.createElement('div');
            previewHeading.style.cssText = 'grid-column:1/-1;font-size:11px;font-weight:700;color:var(--text-secondary);letter-spacing:2px;text-transform:uppercase;padding:8px 0 2px;border-bottom:1px solid var(--border-color);margin-bottom:4px;margin-top:8px;';
            previewHeading.textContent = 'ðŸ‘ å®žæ—¶é¢„è§ˆ';
            grid.appendChild(previewHeading);

            const previewBox = document.createElement('div');
            previewBox.style.cssText = 'grid-column:1/-1;background:var(--chat-bg,var(--primary-bg));border-radius:14px;padding:14px 12px;border:1px solid var(--border-color);';
            previewBox.innerHTML = `
                <div style="display:flex;align-items:flex-end;gap:8px;margin-bottom:10px;">
                    <div style="width:32px;height:32px;border-radius:50%;background:var(--accent-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user" style="font-size:12px;color:#fff;"></i>
                    </div>
                    <div class="message message-received" style="max-width:180px;font-size:var(--font-size);">ä½ æ˜¯æˆ‘æœå¤•ç›¸ä¼´è§¦æ‰‹å¯åŠçš„è™šæ‹Ÿ</div>
                </div>
                <div style="display:flex;align-items:flex-end;gap:8px;justify-content:flex-end;">
                    <div class="message message-sent" style="max-width:180px;font-size:var(--font-size);">ä½ æ˜¯æˆ‘æœªæ›¾æ‹¥æœ‰æ— æ³•æ•æ‰çš„äº²æ˜µ</div>
                    <div style="width:32px;height:32px;border-radius:50%;background:var(--border-color);flex-shrink:0;display:flex;align-items:center;justify-content:center;">
                        <i class="fas fa-user" style="font-size:12px;color:var(--text-secondary);"></i>
                    </div>
                </div>`;
            grid.appendChild(previewBox);
        }

        function applyTheme(colors, isReset = false) {
            if (isReset) {
                for (const variable of Object.keys(themeColorMappings)) {
                    document.documentElement.style.removeProperty(variable);
                }
                return;
            }
            if (!colors) return;
            for (const [variable, color] of Object.entries(colors)) {
                document.documentElement.style.setProperty(variable, color);
            }
        }
        
        function saveCurrentThemeAsPreset() {
            const presetName = prompt("è¯·è¾“å…¥æ–°ä¸»é¢˜æ–¹æ¡ˆçš„åç§°ï¼š");
            if (!presetName || !presetName.trim()) return;

            const newTheme = {
                id: `custom-${Date.now()}`,
                name: presetName.trim(),
                colors: {}
            };
            const root = document.documentElement;
            for (const variable of Object.keys(themeColorMappings)) {
                const val = root.style.getPropertyValue(variable) || getComputedStyle(root).getPropertyValue(variable).trim();
                if (val) newTheme.colors[variable] = val.trim();
            }
            for (const variable of Object.keys(themeExtraMappings)) {
                const val = root.style.getPropertyValue(variable) || getComputedStyle(root).getPropertyValue(variable).trim();
                if (val) newTheme.colors[variable] = val.trim();
            }
            customThemes.push(newTheme);
            settings.colorTheme = newTheme.id;
            saveCustomThemes();
            populateThemeSelector();
            showNotification(`ä¸»é¢˜ "${presetName}" å·²ä¿å­˜`, "success");
        }

        function deleteCurrentPreset() {
            const selector = document.getElementById('theme-preset-selector');
            const selectedId = selector.value;
            if (!selectedId.startsWith('custom-')) {
                showNotification('æ— æ³•åˆ é™¤é¢„è®¾ä¸»é¢˜', 'warning');
                return;
            }
            if (confirm(`ç¡®å®šè¦åˆ é™¤ä¸»é¢˜ "${selector.options[selector.selectedIndex].text}" å—ï¼Ÿ`)) {
                customThemes = customThemes.filter(t => t.id !== selectedId);
                settings.colorTheme = 'gold'; 
                saveCustomThemes();
                updateUI();
                populateThemeSelector();
                populateThemeEditor(); 
                showNotification('ä¸»é¢˜å·²åˆ é™¤', 'success');
            }
        }

function populateThemeSelector() {
    const selector = document.getElementById('theme-preset-selector');
    selector.innerHTML = '';

    const defaultOption = document.createElement('option');
    defaultOption.value = "current-editing";
    defaultOption.textContent = "å½“å‰ç¼–è¾‘ä¸­...";
    selector.appendChild(defaultOption);

    if (customThemes.length > 0) {
        const customGroup = document.createElement('optgroup');
        customGroup.label = "æˆ‘çš„è‡ªå®šä¹‰ä¸»é¢˜";
        customThemes.forEach(theme => {
            const option = document.createElement('option');
            option.value = theme.id;
            option.textContent = theme.name;
            customGroup.appendChild(option);
        });
        selector.appendChild(customGroup);
    }

    if (settings.colorTheme.startsWith('custom-')) {
        selector.value = settings.colorTheme;
    } else {
        selector.value = "current-editing";
    }
    const overwriteBtn = document.getElementById('overwrite-theme-preset-btn');
    if (overwriteBtn) overwriteBtn.style.display = selector.value.startsWith('custom-') ? '' : 'none';
}
        
        function saveCustomThemes() {
             safeSetItem(`${APP_PREFIX}customThemes`, JSON.stringify(customThemes));
        }

        const THEME_COLOR_NAMES = {
            'gold': 'é‡‘è‰²', 'blue': 'è“è‰²', 'purple': 'ç´«è‰²', 'green': 'ç»¿è‰²',
            'pink': 'ç²‰è‰²', 'black-white': 'é»‘ç™½', 'pastel': 'æŸ”è“', 
            'sunset': 'å¤•é˜³', 'forest': 'æ£®æž—', 'ocean': 'æ·±è“'
        };
        const BUBBLE_STYLE_NAMES_SCM = { standard: 'æ ‡å‡†', rounded: 'åœ†è§’', 'rounded-large': 'å¤§åœ†è§’', square: 'æ–¹å½¢' };

        async function captureCurrentSchemeAsync() {
            const root = document.documentElement;
            let chatBg = '';
            try {
                chatBg = await localforage.getItem(getStorageKey('chatBackground')) || '';
            } catch(e) {
                chatBg = safeGetItem(getStorageKey('chatBackground')) || '';
            }
            return {
                colorTheme: settings.colorTheme,
                isDarkMode: settings.isDarkMode,
                bubbleStyle: settings.bubbleStyle,
                fontSize: settings.fontSize,
                messageFontFamily: settings.messageFontFamily,
                messageFontWeight: settings.messageFontWeight,
                messageLineHeight: settings.messageLineHeight,
                customFontUrl: settings.customFontUrl || '',
                customBubbleCss: settings.customBubbleCss || '',
                inChatAvatarEnabled: settings.inChatAvatarEnabled,
                inChatAvatarSize: settings.inChatAvatarSize,
                chatBackground: chatBg,
                customColors: (() => {
                    const colors = {};
                    const mapped = Object.keys(themeColorMappings || {});
                    mapped.forEach(v => {
                        const val = root.style.getPropertyValue(v);
                        if (val) colors[v] = val.trim();
                    });
                    return colors;
                })()
            };
        }

        function captureCurrentScheme() {
            const root = document.documentElement;
            const chatBg = safeGetItem(getStorageKey('chatBackground')) || '';
            
            return {
                colorTheme: settings.colorTheme,
                isDarkMode: settings.isDarkMode,
                bubbleStyle: settings.bubbleStyle,
                fontSize: settings.fontSize,
                messageFontFamily: settings.messageFontFamily,
                messageFontWeight: settings.messageFontWeight,
                messageLineHeight: settings.messageLineHeight,
                customFontUrl: settings.customFontUrl || '',
                customBubbleCss: settings.customBubbleCss || '',
                inChatAvatarEnabled: settings.inChatAvatarEnabled,
                inChatAvatarSize: settings.inChatAvatarSize,
                chatBackground: chatBg,
                customColors: (() => {
                    const colors = {};
                    const mapped = Object.keys(themeColorMappings || {});
                    mapped.forEach(v => {
                        const val = root.style.getPropertyValue(v);
                        if (val) colors[v] = val.trim();
                    });
                    return colors;
                })()
            };
        }

        function applyScheme(scheme) {
            settings.colorTheme = scheme.colorTheme;
            settings.isDarkMode = scheme.isDarkMode;
            settings.bubbleStyle = scheme.bubbleStyle;
            settings.fontSize = scheme.fontSize;
            settings.messageFontFamily = scheme.messageFontFamily;
            settings.messageFontWeight = scheme.messageFontWeight;
            settings.messageLineHeight = scheme.messageLineHeight;
            settings.customFontUrl = scheme.customFontUrl || '';
            settings.customBubbleCss = scheme.customBubbleCss || '';
            settings.inChatAvatarEnabled = scheme.inChatAvatarEnabled;
            settings.inChatAvatarSize = scheme.inChatAvatarSize;
            
            const root = document.documentElement;
            if (scheme.customColors && Object.keys(scheme.customColors).length > 0) {
                Object.entries(scheme.customColors).forEach(([v, c]) => {
                    root.style.setProperty(v, c);
                });
            } else {
                if (themeColorMappings) {
                    Object.keys(themeColorMappings).forEach(v => root.style.removeProperty(v));
                }
            }
            
            if (scheme.customFontUrl) {
                try { applyCustomFont(scheme.customFontUrl); } catch(e) {}
            } else {
                document.documentElement.style.setProperty('--message-font-family', scheme.messageFontFamily || "'Noto Serif SC', serif");
                document.documentElement.style.setProperty('--font-family', scheme.messageFontFamily || "'Noto Serif SC', serif");
            }
            
            if (scheme.customBubbleCss) {
                try { applyCustomBubbleCss(scheme.customBubbleCss); } catch(e) {}
            }
            
            if (scheme.chatBackground) {
                applyBackground(scheme.chatBackground);
                safeSetItem(getStorageKey('chatBackground'), scheme.chatBackground);
            }

            updateUI();
            throttledSaveData();
            renderThemeSchemesList();
        }

        function getSchemePreviewColors(scheme) {
            const colorMap = {
                gold: ['#c5a47e', '#f5f5f5', '#333333'],
                blue: ['#7FA6CD', '#e8f0f8', '#333333'],
                purple: ['#BB9EC7', '#f3eef7', '#333333'],
                green: ['#7BC8A4', '#edf8f3', '#333333'],
                pink: ['#F4A6B3', '#fef0f3', '#333333'],
                'black-white': ['#333333', '#f9f9f9', '#666666'],
                pastel: ['#A8D8EA', '#edf7fc', '#333333'],
                sunset: ['#FF9A8B', '#fff0ee', '#333333'],
                forest: ['#7BA05B', '#eef5e8', '#333333'],
                ocean: ['#4A90E2', '#e8f1fc', '#333333'],
            };
            const theme = scheme.colorTheme;
            if (theme && theme.startsWith('custom-')) {
                const c = scheme.customColors && scheme.customColors['--accent-color'];
                return [c || '#aaa', scheme.isDarkMode ? '#222' : '#f5f5f5', '#888'];
            }
            return colorMap[theme] || ['#aaa', '#f5f5f5', '#888'];
        }

        function renderThemeSchemesList() {
            const list = document.getElementById('theme-schemes-list');
            const empty = document.getElementById('theme-schemes-empty');
            if (!list) return;
            
            list.querySelectorAll('.theme-scheme-item').forEach(el => el.remove());
            
            if (themeSchemes.length === 0) {
                if (empty) empty.style.display = 'flex';
                return;
            }
            if (empty) empty.style.display = 'none';
            
            themeSchemes.forEach(scheme => {
                const dots = getSchemePreviewColors(scheme);
                const bubbleName = BUBBLE_STYLE_NAMES_SCM[scheme.bubbleStyle] || 'æ ‡å‡†';
                const darkLabel = scheme.isDarkMode ? 'å¤œ' : 'æ˜¼';
                const themeName = THEME_COLOR_NAMES[scheme.colorTheme] || scheme.colorTheme;
                const meta = `${darkLabel} Â· ${themeName} Â· ${bubbleName} Â· ${scheme.fontSize}px`;
                
                const item = document.createElement('div');
                item.className = 'theme-scheme-item';
                item.dataset.schemeId = scheme.id;
                item.innerHTML = `
                    <div class="scheme-preview-dots">
                        ${dots.map(c => `<div class="scheme-dot" style="background:${c};"></div>`).join('')}
                    </div>
                    <div class="scheme-info">
                        <div class="scheme-name">${scheme.name}</div>
                        <div class="scheme-meta">${meta}</div>
                    </div>
                    <div class="scheme-actions">
                        <button class="scheme-action-btn" title="åº”ç”¨æ–¹æ¡ˆ" onclick="applyThemeScheme('${scheme.id}')">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="scheme-action-btn" title="åœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘" onclick="editThemeScheme('${scheme.id}', event)" style="color:var(--accent-color);">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="scheme-action-btn delete" title="åˆ é™¤æ–¹æ¡ˆ" onclick="deleteThemeScheme('${scheme.id}', event)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        window.applyThemeScheme = function(id) {
            const scheme = themeSchemes.find(s => s.id === id);
            if (!scheme) return;
            applyScheme(scheme);
            showNotification(`âœ¨ å·²åº”ç”¨æ–¹æ¡ˆã€Œ${scheme.name}ã€`, 'success');
        };

        window.deleteThemeScheme = function(id, event) {
            if (event) event.stopPropagation();
            const scheme = themeSchemes.find(s => s.id === id);
            if (!scheme) return;
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ–¹æ¡ˆã€Œ${scheme.name}ã€å—ï¼Ÿ`)) {
                themeSchemes = themeSchemes.filter(s => s.id !== id);
                localforage.setItem(`${APP_PREFIX}themeSchemes`, themeSchemes);
                renderThemeSchemesList();
                showNotification('æ–¹æ¡ˆå·²åˆ é™¤', 'success');
            }
        };

        window.editThemeScheme = function(id, event) {
            if (event) event.stopPropagation();
            const scheme = themeSchemes.find(s => s.id === id);
            if (!scheme) return;
            applyScheme(scheme);
            const appearanceModal = document.getElementById('appearance-modal');
            const editorModal = document.getElementById('theme-editor-modal');
            if (appearanceModal) hideModal(appearanceModal);
            populateThemeEditor(scheme.customColors && Object.keys(scheme.customColors).length > 0 ? scheme.customColors : null);
            populateThemeSelector();
            if (editorModal) showModal(editorModal);
            const selector = document.getElementById('theme-preset-selector');
            if (selector && scheme.id.startsWith('custom-')) selector.value = scheme.id;
            showNotification(`æ­£åœ¨ç¼–è¾‘æ–¹æ¡ˆã€Œ${scheme.name}ã€ï¼Œä¿®æ”¹åŽç‚¹å‡»ðŸ’¾ä¿å­˜`, 'info');
        };

        function initThemeSchemes() {
            const saveBtn = document.getElementById('save-theme-scheme-btn');
            if (saveBtn) {
                saveBtn.onclick = async () => {
                    const name = prompt('è¯·ä¸ºå½“å‰ä¸»é¢˜æ–¹æ¡ˆå‘½åï¼š', `æ–¹æ¡ˆ ${themeSchemes.length + 1}`);
                    if (!name || !name.trim()) return;
                    const scheme = await captureCurrentSchemeAsync();
                    scheme.id = `scheme-${Date.now()}`;
                    scheme.name = name.trim();
                    scheme.savedAt = Date.now();
                    themeSchemes.push(scheme);
                    localforage.setItem(`${APP_PREFIX}themeSchemes`, themeSchemes);
                    renderThemeSchemesList();
                    showNotification(`âœ¨ æ–¹æ¡ˆã€Œ${name}ã€å·²ä¿å­˜ï¼ˆå«èƒŒæ™¯å›¾ï¼‰ï¼`, 'success');
                };
            }
            renderThemeSchemesList();
        }

document.addEventListener('DOMContentLoaded', async () => {
    const loaderBar = document.getElementById('loader-tech-bar');
    const welcomeSubtitle = document.querySelector('.welcome-subtitle-scramble');
    const welcomeScreen = document.getElementById('welcome-animation');
    const disclaimerModal = document.getElementById('disclaimer-modal');
    const acceptDisclaimerBtn = document.getElementById('accept-disclaimer');

    const updateLoader = (text, width) => {
        if (welcomeSubtitle) welcomeSubtitle.textContent = text;
        if (loaderBar) loaderBar.style.width = width;
    };

    const hideWelcomeScreen = () => {
        if (!welcomeScreen) return;
        welcomeScreen.classList.add('hidden');
        setTimeout(() => {
            welcomeScreen.style.display = 'none';
        }, 800);
    };

    const safeAwait = async (promise, fallback = null) => {
        try {
            return await promise;
        } catch (error) {
            console.error('æ“ä½œå¤±è´¥:', error);
            return fallback;
        }
    };

    try {
        safeAwait(Promise.all([
            setupEventListeners?.(),
            initThemeEditor?.(),
            initAnniversaryModule?.(),
            initMoodListeners?.(),
            initDecisionModule?.(),
            initComboMenu?.()
        ]));

        if (typeof localforage === 'undefined') {
            console.warn('LocalForage æœªåŠ è½½ï¼Œå°†ä½¿ç”¨ localStorage é™çº§æ–¹æ¡ˆ');
        }

        updateLoader('æ­£åœ¨å»ºç«‹å®‰å…¨è¿žæŽ¥...', '10%');
        await safeAwait(initializeSession());

        updateLoader('æ­£åœ¨è¯»å–è®°å¿†å­˜æ¡£...', '40%');
        await safeAwait(loadData());

        updateLoader('æ­£åœ¨æ¸²æŸ“æˆ‘ä»¬çš„ä¸–ç•Œ...', '70%');
        
        await Promise.allSettled([
            safeAwait(initializeRandomUI?.()),
            safeAwait(initMusicPlayer?.())
        ]);

        setInterval(checkStatusChange, 60000);

        if (disclaimerModal) {
            const tourSeen = await safeAwait(localforage?.getItem(APP_PREFIX + 'tour_seen'), false);
            
            if (!tourSeen) {
                showModal(disclaimerModal);
                
                if (acceptDisclaimerBtn) {
                    acceptDisclaimerBtn.addEventListener('click', () => {
                        hideModal(disclaimerModal);
                        startTour?.();
                    }, { once: true }); 
                }
            }
        }
        
        if (acceptDisclaimerBtn && !acceptDisclaimerBtn._closeFixed) {
            acceptDisclaimerBtn._closeFixed = true;
            acceptDisclaimerBtn.addEventListener('click', () => {
                if (disclaimerModal && disclaimerModal.style.display !== 'none') {
                    hideModal(disclaimerModal);
                }
            });
        }

        updateLoader('è¿žæŽ¥æˆåŠŸï¼Œæ¬¢è¿Žå›žæ¥ã€‚', '100%');
        setTimeout(hideWelcomeScreen, 3500);

        setTimeout(async () => {
            if ('Notification' in window && Notification.permission === 'default') {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        showNotification('å·²å¼€å¯ç³»ç»Ÿé€šçŸ¥ï¼Œæ”¶åˆ°æ¶ˆæ¯æ—¶ä¼šæé†’ä½  âœ¨', 'success', 3000);
                    }
                } catch(e) {
                    console.warn('é€šçŸ¥æƒé™è¯·æ±‚å¤±è´¥:', e);
                }
            }
        }, 3000);

    } catch (err) {
        console.error('ä¸¥é‡åˆå§‹åŒ–é”™è¯¯:', err);
        updateLoader('åŠ è½½é‡åˆ°é—®é¢˜ï¼Œå·²å¼ºåˆ¶è¿›å…¥...', '100%');
        setTimeout(hideWelcomeScreen, 3500);
    }
});
const stickerInput = document.getElementById('sticker-file-input');
            if (stickerInput) {
                stickerInput.addEventListener('change', async (e) => {
                    const files = Array.from(e.target.files);
                    if (!files.length) return;

                    const oversized = files.filter(f => f.size > 2 * 1024 * 1024);
                    if (oversized.length > 0) {
                        showNotification(oversized.length + ' å¼ å›¾ç‰‡è¶…è¿‡ 2MB é™åˆ¶ï¼Œå·²è·³è¿‡', 'warning');
                    }

                    const validFiles = files.filter(f => f.size <= 2 * 1024 * 1024);
                    if (!validFiles.length) return;

                    showNotification('æ­£åœ¨æ‰¹é‡å¤„ç† ' + validFiles.length + ' å¼ å›¾ç‰‡...', 'info');

                    let successCount = 0;
                    let failCount = 0;

                    for (const file of validFiles) {
                        try {
                            const base64 = await optimizeImage(file, 300, 0.8);
                            stickerLibrary.push(base64);
                            successCount++;
                        } catch (err) {
                            console.error(err);
                            failCount++;
                        }
                    }

                    throttledSaveData();
                    renderReplyLibrary();

                    if (failCount > 0) {
                        showNotification('ä¸Šä¼ å®Œæˆï¼š' + successCount + ' å¼ æˆåŠŸï¼Œ' + failCount + ' å¼ å¤±è´¥', 'warning');
                    } else {
                        showNotification('ä¸Šä¼ æˆåŠŸï¼Œå…± ' + successCount + ' å¼ ', 'success');
                    }

                    e.target.value = '';
                });
            }
const myStickerQuickUpload = document.getElementById('my-sticker-quick-upload');
if (myStickerQuickUpload) {
    myStickerQuickUpload.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (!files.length) return;
        const oversized = files.filter(f => f.size > 2 * 1024 * 1024);
        if (oversized.length > 0) showNotification(oversized.length + ' å¼ å›¾ç‰‡è¶…è¿‡ 2MBï¼Œå·²è·³è¿‡', 'warning');
        const validFiles = files.filter(f => f.size <= 2 * 1024 * 1024);
        if (!validFiles.length) return;
        showNotification('æ­£åœ¨å¤„ç† ' + validFiles.length + ' å¼ ...', 'info');
        let ok = 0, fail = 0;
        for (const file of validFiles) {
            try {
                const base64 = await optimizeImage(file, 300, 0.8);
                myStickerLibrary.push(base64);
                ok++;
            } catch(err) { fail++; }
        }
        throttledSaveData();
        if (typeof renderComboContent === 'function') renderComboContent('my-sticker');
        showNotification(fail > 0 ? `ä¸Šä¼ å®Œæˆï¼š${ok} æˆåŠŸ ${fail} å¤±è´¥` : `âœ“ å·²æ·»åŠ  ${ok} å¼ åˆ°æˆ‘çš„è¡¨æƒ…åº“`, fail > 0 ? 'warning' : 'success');
        e.target.value = '';
    });
}
const tourOverlay = document.getElementById('tour-overlay');
const tourPopover = document.getElementById('tour-popover');
const tourHighlightBox = document.getElementById('tour-highlight-box');
const tourTitle = document.getElementById('tour-title');
const tourContent = document.getElementById('tour-content');
const tourStepCounter = document.getElementById('tour-step-counter');
const tourNextBtn = document.getElementById('tour-next-btn');
const tourPrevBtn = document.getElementById('tour-prev-btn');
const tourSkipBtn = document.getElementById('tour-skip-btn');

let currentTourStep = 0;
let isTourActive = false;

const tourSteps = [
    {
        title: "âœ¨ æ¬¢è¿Žæ¥åˆ°ã€Œä¼ è®¯ã€",
        content: "è¿™é‡Œæ˜¯ä½ ä»¬ä¸“å±žçš„ç§å¯†ç©ºé—´ã€‚<br><br>è¿™ä¸ªæ•™ç¨‹å…± <b>20 æ­¥</b>ï¼Œå¸¦ä½ ä»Žå¤´åˆ°å°¾è®¤è¯†æ¯ä¸€ä¸ªåŠŸèƒ½ï¼Œå»ºè®®å®Œæ•´çœ‹å®Œå“¦ðŸ¥º<br><br>ç‚¹å‡»ã€Œä¸‹ä¸€æ­¥ã€å¼€å§‹å§ï¼",
        position: 'center'
    },
    {
        element: '#my-avatar',
        title: "ðŸ“· ä½ çš„å¤´åƒ",
        content: "è¿™æ˜¯<b>ä½ çš„å¤´åƒ</b>ã€‚<br><br>ç‚¹å‡»å®ƒå¯ä»¥ä¸Šä¼ å›¾ç‰‡ä½œä¸ºä½ çš„å¤´åƒã€‚",
        position: 'bottom'
    },
    {
        element: '#my-name',
        title: "âœï¸ ä½ çš„æ˜µç§°",
        content: "è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯<b>ä½ çš„åå­—</b>ã€‚<br><br>ç‚¹å‡»åå­—å¯ä»¥ç›´æŽ¥ä¿®æ”¹ã€‚",
        position: 'bottom'
    },
    {
        element: '#my-status-container',
        title: "ðŸ’¬ ä½ çš„çŠ¶æ€ç­¾å",
        content: "è¿™é‡Œæ˜¯ä½ çš„<b>çŠ¶æ€ç­¾å</b>ã€‚<br><br>ç‚¹å‡»å¯ä»¥ç¼–è¾‘ï¼Œä¸€èˆ¬è€Œè¨€å¯¹æ–¹æ˜¯èƒ½çœ‹è§çš„å“¦ï½ž",
        position: 'bottom'
    },
    {
        element: '#partner-avatar',
        title: "Ta çš„å¤´åƒ",
        content: "è¿™é‡Œæ˜¯<b>æ¢¦è§’çš„å¤´åƒ</b>ï¼ŒåŒæ ·ç‚¹å‡»å¯ä»¥ä¸Šä¼ æ›´æ¢ã€‚",
        position: 'bottom'
    },
    {
        element: '#partner-name',
        title: "Ta çš„æ˜µç§°",
        content: "è¿™æ˜¯<b>æ¢¦è§’çš„æ˜µç§°</b>ï¼ŒåŒæ ·ç‚¹å‡»å¯ä»¥ä¿®æ”¹ã€‚",
        position: 'bottom'
    },
    {
        element: '.header-motto',
        title: "ðŸŒ¸ é¡¶éƒ¨æ ¼è¨€",
        content: "è¿™é‡Œæ˜¾ç¤ºç€æ ¼è¨€ï½žè‡ªå®šä¹‰å›žå¤é‡Œå¯ä¿®æ”¹ã€‚",
        position: 'bottom'
    },
    {
        element: '#message-input',
        title: "âŒ¨ï¸ æ¶ˆæ¯è¾“å…¥æ¡†",
        content: "åœ¨è¿™é‡Œ<b>è¾“å…¥ä½ æƒ³è¯´çš„è¯</b>ï¼ŒæŒ‰å›žè½¦é”®æˆ–ç‚¹å‡»å³è¾¹çš„å‘é€æŒ‰é’®å°±èƒ½å‘å‡ºåŽ»ã€‚",
        position: 'top'
    },
    {
        element: '#send-btn',
        title: "ðŸš€ å‘é€æ¶ˆæ¯",
        content: "ç‚¹å‡»è¿™ä¸ª<b>çº¸é£žæœºæŒ‰é’®</b>å°±èƒ½å‘é€æ¶ˆæ¯ã€‚<br><br>å‘é€åŽå¯¹æ–¹ä¼šåœ¨å‡ ç§’å†…ç»™ä½ å›žå¤ï¼Œä½ å¯ä»¥åœ¨ã€ŒèŠå¤©è®¾ç½®ã€é‡Œè°ƒæ•´å›žå¤çš„é€Ÿåº¦å¿«æ…¢å“¦ã€‚",
        position: 'top'
    },
    {
        element: '#attachment-btn',
        title: "ðŸ–¼ï¸ å‘é€å›¾ç‰‡ / è¡¨æƒ…åŒ…",
        content: "ç‚¹å‡»è¿™é‡Œå¯ä»¥<b>å‘é€å›¾ç‰‡</b>ï¼Œæ”¯æŒç›¸å†Œå›¾ç‰‡å’Œè¡¨æƒ…åŒ…ã€‚<br><br>ä½ è¿˜å¯ä»¥åœ¨ã€Œé«˜çº§åŠŸèƒ½ â†’ å›žå¤åº“ã€ä¸­ä¸Šä¼ è‡ªå®šä¹‰çš„è¡¨æƒ…ï¼Œåˆ°æ—¶å€™å¯¹æ–¹ä¹Ÿä¼šå‘ç»™ä½ ï¼",
        position: 'top'
    },
    {
        element: '#poke-btn',
        title: "ðŸ‘‹ æ‹ä¸€æ‹äº’åŠ¨",
        content: "è¿™æ˜¯ã€Œ<b>æ‹ä¸€æ‹</b>ã€åŠŸèƒ½ï¼Œå‘å‡ºåŽä¼šæ˜¾ç¤ºä¸€æ¡äº’åŠ¨æ¶ˆæ¯ï¼Œæ¯”å¦‚ã€Œè½»æ‹äº†ä½ ä¸€ä¸‹ã€ã€‚<br><br>å¯ä»¥åœ¨ã€Œé«˜çº§åŠŸèƒ½ â†’ è‡ªå®šä¹‰æ‹ä¸€æ‹ã€é‡Œæ·»åŠ æ›´å¤šçš„åŠ¨ä½œï¼",
        position: 'top'
    },
    {
        element: '#continue-btn',
        title: "è®© Ta ç»§ç»­è¯´",
        content: "ä¸çŸ¥é“è¯´ä»€ä¹ˆäº†ï¼Ÿæˆ–è€…æƒ³è®© Ta å¤šè¯´å‡ å¥ï¼Ÿ<br><br>ç‚¹å‡»è¿™ä¸ªæŒ‰é’®ï¼Œ<b>æ¢¦è§’ä¼šä¸»åŠ¨æ‰¾ä½ è¯´è¯ã€‚",
        position: 'top'
    },
    {
        element: '#batch-btn',
        title: "ðŸ“¦ æ‰¹é‡å‘é€æ¨¡å¼",
        content: "å¼€å¯<b>æ‰¹é‡æ¨¡å¼</b>åŽï¼Œä½ å¯ä»¥å…ˆå†™å¥½å¤šæ¡æ¶ˆæ¯ï¼Œå†ä¸€æ¬¡æ€§å…¨éƒ¨å‘å‡ºåŽ»<br><br>ç‚¹å‡»æŒ‰é’®å¼€å¯ï¼Œç¼–è¾‘å®ŒæˆåŽå†æ¬¡ç‚¹å‡»ã€Œå‘é€å…¨éƒ¨ã€å³å¯ã€‚",
        position: 'top'
    },
    {
        element: '#settings-btn',
        title: "âš™ï¸ è®¾ç½®ä¸­å¿ƒ",
        content: "æ‰€æœ‰ä¸ªæ€§åŒ–é…ç½®éƒ½åœ¨è¿™ä¸ª<b>è®¾ç½®æŒ‰é’®</b>é‡Œï¼Œæˆ‘ä»¬ç‚¹è¿›åŽ»çœ‹ä¸€ä¸‹ï¼<br>",
        position: 'bottom',
        onBefore: () => { if (isTourActive) document.querySelectorAll('.modal').forEach(m => hideModal(m)); }
    },
    {
        element: '#appearance-settings',
        title: "ðŸŽ¨ å¤–è§‚è®¾ç½®",
        content: "<b>å¤–è§‚è®¾ç½®</b>é‡Œå¯ä»¥ï¼š<br>â€¢ åˆ‡æ¢ 10 æ¬¾ä¸»é¢˜é…è‰²ï¼ˆé‡‘/è“/ç²‰â€¦ï¼‰<br>â€¢ è°ƒæ•´å­—ä½“å¤§å°<br>â€¢ æ›´æ¢èŠå¤©èƒŒæ™¯å›¾<br>â€¢ è‡ªå®šä¹‰æ°”æ³¡æ ·å¼ CSS<br>",
        position: 'bottom',
        onBefore: () => { if (isTourActive) showModal(DOMElements.settingsModal.modal); }
    },
    {
        element: '#chat-settings',
        title: "ðŸ’¬ èŠå¤©è®¾ç½®",
        content: "<b>èŠå¤©è®¾ç½®</b>é‡Œå¯ä»¥è°ƒæ•´ï¼š<br>â€¢ æ¶ˆæ¯éŸ³æ•ˆå¼€å…³<br>â€¢ å·²è¯»å›žæ‰§æ˜¾ç¤º<br>â€¢ å¯¹æ–¹å›žå¤é€Ÿåº¦ï¼ˆå¿«/æ…¢ï¼‰<br>â€¢ æ¶ˆæ¯æ°”æ³¡æ ·å¼ï¼ˆåœ†è§’/æ–¹å½¢ï¼‰",
        position: 'bottom'
    },
    {
        element: '#advanced-settings',
        title: "ðŸš€ é«˜çº§åŠŸèƒ½ â€” å¿…çœ‹ï¼",
        content: "<b>é«˜çº§åŠŸèƒ½</b>æ˜¯æ•´ä¸ªåº”ç”¨æœ€å¼ºå¤§çš„æ¿å—ï¼Œé‡Œé¢æœ‰ï¼š<br>â€¢ <b>å¿ƒæ™´æ‰‹è´¦</b>ï¼šè®°å½•æ¯å¤©çš„å¿ƒæƒ…<br>â€¢ <b>ä¿¡å°æŠ•é€’</b>ï¼šç»™æ¢¦è§’å†™ä¸€å°ä¿¡<br>â€¢ <b>çºªå¿µæ—¥</b>ï¼šå€’è®¡æ—¶ / çºªå¿µå¤©æ•°<br>â€¢ <b>è¿åŠ¿å åœ</b>ï¼šæ¯æ—¥è¿åŠ¿<br>â€¢ <b>è‡ªå®šä¹‰å›žå¤</b>ï¼šè®©æ¢¦è§’è¯´ä½ æƒ³å¬çš„è¯<br>â€¢ <b>éŸ³ä¹æ’­æ”¾å™¨</b>ï¼šèƒŒæ™¯éŸ³ä¹",
        position: 'bottom'
    },
    {
        element: '#data-settings',
        title: "ðŸ’¾ æ•°æ®ç®¡ç†",
        content: "<b>æ•°æ®ç®¡ç†</b>é‡Œå¯ä»¥ï¼š<br>â€¢ å¯¼å‡ºèŠå¤©è®°å½•ï¼ˆå¤‡ä»½åˆ°æœ¬åœ°ï¼‰<br>â€¢ å¯¼å…¥ä¹‹å‰å¤‡ä»½çš„è®°å½•<br>â€¢ æŸ¥çœ‹å­˜å‚¨ç©ºé—´å ç”¨<br>â€¢ å¼€å¯åŽå°æ¶ˆæ¯é€šçŸ¥æŽ¨é€<br>â€¢ é‡ç½®æ‰€æœ‰æ•°æ®<br>â€¢ é‡æ”¾æœ¬æ•™ç¨‹",
        position: 'top'
    },
    {
        element: '#theme-toggle',
        title: "ðŸŒ™ æ—¥ / å¤œæ¨¡å¼åˆ‡æ¢",
        content: "è¿™ä¸ªæŒ‰é’®å¯ä»¥å¿«é€Ÿ<b>åˆ‡æ¢ç™½å¤© / å¤œæ™š</b>æ¨¡å¼ã€‚<br><br>å¤œæ™šæ¨¡å¼ä¸‹æ•´ä½“å˜æˆæ·±è‰²èƒŒæ™¯ï¼Œå¯¹çœ¼ç›æ›´å‹å¥½ï¼Œç¡å‰èŠå¤©å¿…å¤‡ï¼âœ¨",
        position: 'bottom',
        onBefore: () => { if (isTourActive) hideModal(DOMElements.settingsModal.modal); }
    },
    {
        element: '#favorites-btn',
        title: "â­ æ”¶è—å¤¹",
        content: "é•¿æŒ‰æˆ–ç‚¹å‡»ä¸€æ¡æ¶ˆæ¯ï¼Œä¼šå¼¹å‡ºæ“ä½œèœå•ï¼Œå¯ä»¥æŠŠæ¶ˆæ¯<b>æ”¶è—</b>èµ·æ¥ã€‚<br><br>æ‰€æœ‰æ”¶è—çš„æ¶ˆæ¯éƒ½ä¼šä¿å­˜åœ¨è¿™ä¸ªæ”¶è—å¤¹é‡Œï¼Œéšæ—¶å¯ä»¥ç¿»é˜…å›žå‘³ï½ž",
        position: 'bottom'
    },
    {
        element: '#session-manager-btn',
        title: "ðŸ“‚ ä¼šè¯ç®¡ç†",
        content: "ä½ å¯ä»¥åˆ›å»º<b>å¤šä¸ªç‹¬ç«‹çš„èŠå¤©ä¼šè¯</b>ï¼Œæ¯ä¸ªä¼šè¯éƒ½æœ‰ç‹¬ç«‹çš„èŠå¤©è®°å½•ã€‚<br>",
        position: 'bottom'
    },
    {
        title: "âœ‹ æ¶ˆæ¯æ“ä½œæç¤º",
        content: "ç‚¹å‡»ä»»æ„ä¸€æ¡æ¶ˆæ¯ï¼Œä¼šå‡ºçŽ°æ“ä½œèœå•ï¼š<br>â€¢ â­ <b>æ”¶è—</b>ï¼šä¿å­˜åˆ°æ”¶è—å¤¹<br>â€¢ â†©ï¸ <b>å›žå¤</b>ï¼šå¼•ç”¨è¿™æ¡æ¶ˆæ¯å›žå¤<br>â€¢ ðŸ“ <b>æ³¨é‡Š</b>ï¼šç»™æ¶ˆæ¯æ·»åŠ å¤‡æ³¨<br>â€¢ ðŸ—‘ï¸ <b>åˆ é™¤</b>ï¼šåˆ é™¤è¿™æ¡æ¶ˆæ¯",
        position: 'center'
    },
    {
        title: "ðŸŽ‰ ä½ å·²æŽŒæ¡æ‰€æœ‰åŠŸèƒ½ï¼",
        content: "æ­å–œä½ å®Œæˆäº†æ–°æ‰‹å¼•å¯¼ï¼çŽ°åœ¨ä½ å·²ç»äº†è§£äº†ã€Œä¼ è®¯ã€çš„å…¨éƒ¨åŠŸèƒ½ã€‚<br><br>å¸Œæœ›ä½ ä»¬åœ¨è¿™é‡Œæ”¶èŽ·æ»¡æ»¡çš„çˆ±ä¸Žå¹¸ç¦ ðŸ¥ºðŸ’•",
        position: 'center'
    }
];

function startTour() {
    isTourActive = true;
    tourOverlay.style.display = 'block';
    setTimeout(() => tourOverlay.classList.add('active'), 10);
    currentTourStep = 0;
    showTourStep(currentTourStep);
}

function endTour() {
    isTourActive = false;
    tourOverlay.classList.remove('active');
    tourPopover.classList.remove('visible');
    setTimeout(() => {
        tourOverlay.style.display = 'none';
        tourHighlightBox.style.width = '0px';
        tourHighlightBox.style.height = '0px';
        tourHighlightBox.style.opacity = '0';
    }, 300);
    localforage.setItem(APP_PREFIX + 'tour_seen', 'true');
    document.querySelectorAll('.modal').forEach(m => hideModal(m));
    setTimeout(function() {
        if (typeof window.tryShowDailyGreeting === 'function') {
            window.tryShowDailyGreeting();
        }
    }, 900);
}

function showTourStep(index) {
    if (index < 0 || index >= tourSteps.length) {
        endTour();
        return;
    }
    const step = tourSteps[index];
    if (step.onBefore) {
        step.onBefore();
    }
    setTimeout(() => {
        tourTitle.textContent = step.title;
        tourContent.innerHTML = step.content;
        tourStepCounter.textContent = `${index + 1} / ${tourSteps.length}`;
        tourPopover.classList.remove('visible');
        tourPrevBtn.style.visibility = (index === 0) ? 'hidden' : 'visible';
        if (index === tourSteps.length - 1) {
            tourNextBtn.innerHTML = 'å®Œæˆ <i class="fas fa-check"></i>';
        } else {
            tourNextBtn.innerHTML = 'ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i>';
        }
        const targetElement = step.element ? document.querySelector(step.element) : null;
        if (targetElement) {
            const rect = targetElement.getBoundingClientRect();
            tourHighlightBox.style.width = `${rect.width + 10}px`;
            tourHighlightBox.style.height = `${rect.height + 10}px`;
            tourHighlightBox.style.top = `${rect.top - 5}px`;
            tourHighlightBox.style.left = `${rect.left - 5}px`;
            tourHighlightBox.style.opacity = '1';
            positionPopover(rect, step.position);
        } else {
            tourHighlightBox.style.opacity = '0';
            tourHighlightBox.style.width = '0px';
            tourHighlightBox.style.height = '0px';
            tourPopover.style.top = '50%';
            tourPopover.style.left = '50%';
            tourPopover.style.transform = 'translate(-50%, -50%)';
        }
        setTimeout(() => tourPopover.classList.add('visible'), 50);
    }, (step.onBefore ? 400 : 0));
}

function positionPopover(rect, position) {
    const popoverRect = tourPopover.getBoundingClientRect();
    const spacing = 15;
    let top, left;
    switch (position) {
        case 'top':
            top = rect.top - popoverRect.height - spacing;
            left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
            break;
        case 'bottom':
            top = rect.bottom + spacing;
            left = rect.left + (rect.width / 2) - (popoverRect.width / 2);
            break;
        case 'left':
            top = rect.top + (rect.height / 2) - (popoverRect.height / 2);
            left = rect.left - popoverRect.width - spacing;
            break;
        case 'right':
            top = rect.top + (rect.height / 2) - (popoverRect.height / 2);
            left = rect.right + spacing;
            break;
        default:
            top = '50%';
            left = '50%';
            tourPopover.style.transform = 'translate(-50%, -50%)';
            tourPopover.style.top = top;
            tourPopover.style.left = left;
            return;
    }
    if (top < 10) top = 10;
    if (left < 10) left = 10;
    if (left + popoverRect.width > window.innerWidth - 10) {
        left = window.innerWidth - popoverRect.width - 10;
    }
    if (top + popoverRect.height > window.innerHeight - 10) {
        top = window.innerHeight - popoverRect.height - 10;
    }
    tourPopover.style.top = `${top}px`;
    tourPopover.style.left = `${left}px`;
    tourPopover.style.transform = 'none';
}

function nextTourStep() {
    currentTourStep++;
    showTourStep(currentTourStep);
}

async function createNewSession(switchToIt = true) {
    const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
    const newSession = {
        id: newId,
        name: `ä¼šè¯ ${new Date().toLocaleDateString()}`,
        createdAt: Date.now()
    };

    sessionList.push(newSession);
    await localforage.setItem(`${APP_PREFIX}sessionList`, sessionList);

    if (switchToIt) {
        window.location.hash = newId;
        window.location.reload();
    }
    
    return newId;
}

window.selectAnnType = function(type) {
    currentAnniversaryType = type;
    currentAnnType = type; 
    document.querySelectorAll('.anniversary-type-btn').forEach(btn => {
        if(btn.dataset.type === type) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    const hint = document.getElementById('ann-type-desc');
    if(hint) {
        hint.textContent = type === 'anniversary' 
            ? 'è®¡ç®—ä»Žè¿‡åŽ»æŸä¸€å¤©åˆ°çŽ°åœ¨å·²ç»è¿‡äº†å¤šå°‘å¤© (ä¾‹å¦‚: æ‹çˆ±çºªå¿µæ—¥)' 
            : 'è®¡ç®—ä»ŽçŽ°åœ¨åˆ°æœªæ¥æŸä¸€å¤©è¿˜å‰©ä¸‹å¤šå°‘å¤© (ä¾‹å¦‚: å¯¹æ–¹ç”Ÿæ—¥)';
    }
};

window.deleteAnniversary = function(id, event) {
    if(event) event.stopPropagation();
    
    if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ')) {
        anniversaries = anniversaries.filter(a => a.id !== id);
        throttledSaveData();
        renderAnniversariesList();
        showNotification('çºªå¿µæ—¥å·²åˆ é™¤', 'success');
    }
};

let activeAnnId = null;

async function fillAnnHeaderCard(ann) {
    const headerCard = document.getElementById('ann-header-card');
    const toolbar = document.getElementById('ann-card-toolbar');
    if (!ann || !headerCard) return;

    activeAnnId = ann.id;
    headerCard.style.display = 'block';
    if (toolbar) toolbar.style.display = 'flex';

    const now = new Date();
    const isCountdown = ann.type === 'countdown';
    const targetDate = new Date(ann.date);
    let diffDays;
    if (isCountdown) {
        diffDays = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) diffDays = 0;
    } else {
        diffDays = Math.floor((now - targetDate) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) diffDays = 0;
    }

    const iconEl = document.getElementById('ann-header-icon');
    const labelEl = document.getElementById('ann-header-label');
    if (iconEl) iconEl.textContent = isCountdown ? 'â™¡' : 'â™¥';
    if (labelEl) labelEl.textContent = isCountdown ? 'COUNTDOWN' : 'ANNIVERSARY';
    document.getElementById('ann-header-title').textContent = ann.name;
    document.getElementById('ann-header-date').textContent = ann.date;
    const daysEl = document.getElementById('ann-header-days');
    daysEl.innerHTML = `${diffDays.toLocaleString('zh-CN')}<span class="ann-header-days-unit">${isCountdown ? 'å¤©åŽ' : 'å¤©'}</span>`;

    const milestonesEl = document.getElementById('ann-header-milestones');
    if (milestonesEl) {
        milestonesEl.innerHTML = '';
        if (!isCountdown) {
            const milestones = [];
            if (diffDays >= 100) { const n = Math.floor(diffDays / 100); milestones.push(`ðŸŽ‰ ç¬¬ ${n * 100} å¤©`); }
            if (diffDays >= 365) { const n = Math.floor(diffDays / 365); milestones.push(`ðŸŽŠ ${n} å‘¨å¹´`); }
            if (diffDays > 0 && diffDays < 100) { milestones.push(`ðŸ’« è· 100 å¤©è¿˜æœ‰ ${100 - diffDays} å¤©`); }
            milestones.forEach(m => milestonesEl.insertAdjacentHTML('beforeend', `<span class="ann-milestone-chip">${m}</span>`));
        }
    }

    const bgEl = document.getElementById('ann-header-card-bg');
    if (bgEl) {
        const savedBg = await localforage.getItem(getStorageKey(`annHeaderBg_${ann.id}`));
        bgEl.style.backgroundImage = savedBg ? `url(${savedBg})` : '';
    }

    document.querySelectorAll('.ann-item-card').forEach(el => el.classList.remove('ann-item-active'));
    const activeEl = document.querySelector(`.ann-item-card[data-ann-id="${ann.id}"]`);
    if (activeEl) activeEl.classList.add('ann-item-active');
}

function renderAnniversariesList() {
    const listContainer = document.getElementById('ann-list-container');
    const headerCard = document.getElementById('ann-header-card');
    const toolbar = document.getElementById('ann-card-toolbar');
    
    if (!listContainer) return;
    listContainer.innerHTML = '';

    anniversaries.sort((a, b) => new Date(a.date) - new Date(b.date));

    if (anniversaries.length === 0) {
        if (headerCard) headerCard.style.display = 'none';
        if (toolbar) toolbar.style.display = 'none';
        listContainer.innerHTML = `
            <div class="ann-empty">
                <div class="ann-empty-icon">ðŸ’</div>
                <p>è¿˜æ²¡æœ‰çºªå¿µæ—¥<br>åŽ»æ·»åŠ ä¸€ä¸ªå±žäºŽä½ ä»¬çš„æ—¥å­å§~</p>
            </div>`;
        return;
    }

    const now = new Date();
    const defaultAnn = anniversaries.find(a => a.type === 'anniversary') || anniversaries[0];
    fillAnnHeaderCard(defaultAnn);

    anniversaries.forEach(ann => {
        const targetDate = new Date(ann.date);
        let diffDays = 0;
        let typeClass = '';
        let typeLabel = '';
        let dayLabel = '';

        if (ann.type === 'countdown') {
            typeClass = 'type-future';
            typeLabel = 'å€’æ•°';
            dayLabel = 'å¤©åŽ';
            diffDays = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
            if(diffDays < 0) diffDays = 0;
        } else {
            typeClass = 'type-past';
            typeLabel = 'å·²è¿‡';
            dayLabel = 'å¤©';
            diffDays = Math.floor((now - targetDate) / (1000 * 60 * 60 * 24));
        }

        const formattedDays = diffDays.toLocaleString('zh-CN');

        const html = `
            <div class="ann-item-card ${typeClass}" data-ann-id="${ann.id}" onclick="selectAnnCard(${ann.id})" style="cursor:pointer;">
                <div class="ann-item-left">
                    <div class="ann-item-name">${ann.name}</div>
                    <div class="ann-item-date">
                        <span class="ann-tag">${typeLabel}</span>
                        ${ann.date}
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <div class="ann-item-right">
                        <div class="ann-item-days">${formattedDays}</div>
                        <div class="ann-item-days-unit">${dayLabel}</div>
                    </div>
                    <div class="ann-delete-btn" onclick="event.stopPropagation(); deleteAnniversaryItem(${ann.id})">
                        <i class="fas fa-times"></i>
                    </div>
                </div>
            </div>
        `;
        listContainer.insertAdjacentHTML('beforeend', html);
    });
}

window.selectAnnCard = function(id) {
    const ann = anniversaries.find(a => a.id === id);
    if (ann) fillAnnHeaderCard(ann);
};

window.clearAnnCardBg = async function() {
    if (!activeAnnId) return;
    await localforage.removeItem(getStorageKey(`annHeaderBg_${activeAnnId}`));
    const bgEl = document.getElementById('ann-header-card-bg');
    if (bgEl) bgEl.style.backgroundImage = '';
    showNotification('å°é¢å›¾å·²æ¸…é™¤', 'success');
};


function initAnniversaryModule() {
    const entryBtn = document.getElementById('anniversary-function');
    
    if (entryBtn) {
        const newBtn = entryBtn.cloneNode(true);
        entryBtn.parentNode.replaceChild(newBtn, entryBtn);
        
        newBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('é‡è¦æ—¥æŒ‰é’®è¢«ç‚¹å‡»');
            
            const advancedModal = document.getElementById('advanced-modal');
            const annModal = document.getElementById('anniversary-modal');
            
            if (advancedModal) hideModal(advancedModal);
            renderAnniversariesList();
            if (annModal) showModal(annModal);
        });
    }

    const closeBtn = document.getElementById('close-anniversary-modal');
    if (closeBtn) {
        const newClose = closeBtn.cloneNode(true);
        closeBtn.parentNode.replaceChild(newClose, closeBtn);
        newClose.addEventListener('click', () => hideModal(document.getElementById('anniversary-modal')));
    }

    const openAddBtn = document.getElementById('open-ann-add-btn');
    const editorSlide = document.getElementById('ann-editor-slide');
    if (openAddBtn) {
        openAddBtn.onclick = () => {
            document.getElementById('ann-input-name').value = '';
            document.getElementById('ann-input-date').value = '';
            window.selectAnnType('anniversary');
            if (editorSlide) editorSlide.classList.add('active');
        };
    }

    const closeEditorBtn = document.getElementById('close-ann-editor');
    if (closeEditorBtn) {
        closeEditorBtn.onclick = () => {
            if (editorSlide) editorSlide.classList.remove('active');
        };
    }

    const saveBtn = document.getElementById('save-ann-btn');
    if (saveBtn) {
        const newSave = saveBtn.cloneNode(true);
        saveBtn.parentNode.replaceChild(newSave, saveBtn);
        
        newSave.addEventListener('click', () => {
            addAnniversary(); 
            if (editorSlide) editorSlide.classList.remove('active');
        });
    }

    const annBgInput = document.getElementById('ann-header-bg-input');
    if (annBgInput) {
        annBgInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!activeAnnId) { showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçºªå¿µæ—¥', 'warning'); return; }
            const reader = new FileReader();
            reader.onload = async (ev) => {
                const dataUrl = ev.target.result;
                const bgEl = document.getElementById('ann-header-card-bg');
                if (bgEl) bgEl.style.backgroundImage = `url(${dataUrl})`;
                await localforage.setItem(getStorageKey(`annHeaderBg_${activeAnnId}`), dataUrl);
                showNotification('å°é¢å›¾å·²æ›´æ–° ', 'success');
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });
    }
}
function prevTourStep() {
    currentTourStep--;
    showTourStep(currentTourStep);
}

function setupTutorialListeners() {
    tourNextBtn.addEventListener('click', nextTourStep);
    tourPrevBtn.addEventListener('click', prevTourStep);
    tourSkipBtn.addEventListener('click', endTour);

    const replayBtn = document.getElementById('replay-tutorial-btn');
    if(replayBtn) {
        replayBtn.addEventListener('click', () => {
            hideModal(DOMElements.dataModal.modal);
            setTimeout(() => {
                if (confirm('ç¡®å®šè¦é‡æ–°å¼€å§‹æ–°æ‰‹å¼•å¯¼æ•™ç¨‹å—ï¼Ÿ')) {
                    startTour();
                }
            }, 300);
        });
    }
}

    </script>

<div id="daily-greeting-modal" class="hidden">
    <div class="daily-greeting-card" id="daily-greeting-card">
        <div class="dg-header-band" id="dg-header-band">
            <div class="dg-header-band-bg" id="dg-header-band-bg"></div>
            <div class="dg-header-band-overlay" id="dg-header-band-overlay"></div>
            <div class="dg-header-band-shimmer"></div>
            <input type="file" id="dg-header-img-input" accept="image/*" style="display:none">
            <div class="dg-header-top">
                <div class="dg-emoji-circle" id="dg-emoji">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="1.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </div>
                <div class="dg-header-text">
                    <div class="dg-festival-label" id="dg-festival">GOOD MORNING</div>
                    <div class="dg-main-title" id="dg-title">æ—©ä¸Šå¥½</div>
                </div>
            </div>
            <div class="dg-date-stamp" id="dg-date-stamp">â€” ä»Šæ—¥å…¬å‘Šå·²é€è¾¾ â€”</div>
        </div>
        <div class="dg-body">
            <div class="dg-section-label" id="dg-section-label-partner">æ¢¦è§’ä»Šæ—¥çŠ¶æ€</div>
            <div class="dg-mood-panel" id="dg-mood-panel">
                <div class="dg-mood-icon-big" id="dg-partner-mood-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                </div>
                <div class="dg-mood-info">
                    <div class="dg-mood-name" id="dg-partner-mood">è¿˜æ²¡æœ‰è®°å½•ä»Šæ—¥å¿ƒæƒ…</div>
                    <div class="dg-mood-sub" id="dg-partner-mood-note"></div>
                </div>
            </div>
            <div class="dg-info-grid">
                <div class="dg-info-cell">
                    <div class="dg-info-cell-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                    </div>
                    <div class="dg-info-cell-label" id="dg-weather-label"</>æ¢¦è§’çš„å¤©æ°”</div>
                    <div class="dg-info-cell-val" id="dg-weather" onclick="startEditDgWeather(this)" style="cursor:pointer;text-decoration:underline dotted;text-underline-offset:3px;" title="ç‚¹å‡»ç¼–è¾‘">æ™´æœ—</div>
                </div>
                <div class="dg-info-cell">
                    <div class="dg-info-cell-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="1.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                    </div>
                    <div class="dg-info-cell-label" id="dg-status-label">æ¢¦è§’çš„çŠ¶æ€</div>
                    <div class="dg-info-cell-val" id="dg-status">ä¸€åˆ‡éƒ½å¥½</div>
                </div>
            </div>
            <div id="dg-deco-img-wrap" style="display:none; margin-bottom:12px; border-radius:12px; overflow:hidden;">
                <img id="dg-deco-img" src="" alt="" style="width:100%; max-height:160px; object-fit:cover; display:block; border-radius:12px;">
            </div>
            <div class="dg-note-box" id="dg-note">
                <div class="dg-note-inner">
                    <div class="dg-note-weather-badge" id="dg-note-weather-badge" style="display:none;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9z"/></svg>
                        <span id="dg-note-weather-text"></span>
                    </div>
                    <div id="dg-note-text">ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡ï¼Œæˆ‘åœ¨è¿™é‡Œé™ªç€ä½  âœ¦</div>
                </div>
            </div>
            <div class="dg-footer">
                <button class="daily-greeting-close-btn" onclick="closeDailyGreeting()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align:-2px;margin-right:6px"><polyline points="20 6 9 17 4 12"/></svg>
                    çŸ¥é“äº†ï¼Œå¼€å§‹ä»Šå¤©
                </button>
            </div>
        </div>

    </div>
</div>

<div id="dg-editor-modal" style="display:none;"></div>

<script>
window._dailyGreetingReady = false;

function _getDailyGreetingData() {
    var now = new Date();
    var month = now.getMonth() + 1;
    var day = now.getDate();
    var hour = now.getHours();

    var timeLabel = 'æ—©ä¸Šå¥½', timeEmoji = 'ðŸŒ…';
    if (hour >= 12 && hour < 18) { timeLabel = 'ä¸‹åˆå¥½'; timeEmoji = 'â˜€ï¸'; }
    else if (hour >= 18 && hour < 22) { timeLabel = 'å‚æ™šå¥½'; timeEmoji = 'ðŸŒ‡'; }
    else if (hour >= 22 || hour < 6) { timeLabel = 'æ™šä¸Šå¥½'; timeEmoji = 'ðŸŒ™'; }

var festivals = [
    { m:1, d:1, name:'å…ƒæ—¦', emoji:'ðŸŽ†', label:'NEW YEAR', note:'æ–°å¹´å¿«ä¹ï¼æ„¿æ–°çš„ä¸€å¹´é‡Œï¼Œä½ ä»¬çš„çˆ±æƒ…è¶Šæ¥è¶Šç”œèœœï¼Œæ¯ä¸€å¤©éƒ½å……æ»¡å¹¸ç¦ä¸ŽæƒŠå–œï½ž' },
    { m:1, d:5, name:'å°å¯’', emoji:'â„ï¸', label:'MINOR COLD', note:'å°å¯’è‡³ï¼Œæ˜¥ä¸è¿œã€‚æœ‰ä½ åœ¨èº«è¾¹ï¼Œå¿ƒé‡Œæ€»æ˜¯æš–æš–çš„ã€‚' },
    { m:1, d:20, name:'å¤§å¯’', emoji:'ðŸ§Š', label:'MAJOR COLD', note:'å¤§å¯’å¿«ä¹ï¼Œè®°å¾—æ·»è¡£ä¿æš–ã€‚ä½ çš„æ‹¥æŠ±å°±æ˜¯æœ€æš–çš„ç‚‰ç«ã€‚' },

    { m:2, d:4, name:'ç«‹æ˜¥', emoji:'ðŸŒ±', label:'START OF SPRING', note:'ç«‹æ˜¥å¿«ä¹ï¼æ˜¥å¤©æ¥äº†ï¼Œæˆ‘ä»¬çš„çˆ±ä¹Ÿåƒæ–°èŠ½ä¸€æ ·è“¬å‹ƒç”Ÿé•¿ã€‚' },
    { m:2, d:14, name:'æƒ…äººèŠ‚', emoji:'ðŸ’', label:'VALENTINES DAY', note:'æƒ…äººèŠ‚å¿«ä¹ï¼Œäº²çˆ±çš„ï¼ä½ æ˜¯æˆ‘æœ€ç¾Žå¥½çš„ç¤¼ç‰©ï¼Œçˆ±ä½ å“¦ï½ž' },
    { m:2, d:16, name:'é™¤å¤•', emoji:'ðŸ§§', label:'CHINESE NEW YEAR EVE', note:'é™¤å¤•å¿«ä¹ï¼è¾žæ—§è¿Žæ–°ï¼Œæ„¿ä½ ä»¬æºæ‰‹è·¨å…¥å¹¸ç¦çš„æ–°ä¸€å¹´ï¼Œä¸‡äº‹å¦‚æ„ï¼' },
    { m:2, d:17, name:'æ˜¥èŠ‚', emoji:'ðŸŽŠ', label:'SPRING FESTIVAL', note:'æ–°å¹´å¿«ä¹ï¼æ–°çš„ä¸€å¹´ï¼Œæ„¿ä½ ä»¬ç›¸çˆ±å¦‚åˆï¼Œç”œèœœé•¿ä¹…ã€‚' },
    { m:2, d:18, name:'é›¨æ°´', emoji:'â˜”', label:'RAIN WATER', note:'é›¨æ°´èŠ‚æ°”ï¼Œæ„¿å¹¸ç¦åƒæ˜¥é›¨ä¸€æ ·æ»‹æ¶¦ä½ çš„æ¯ä¸€å¤©ã€‚' },

    { m:3, d:3, name:'å…ƒå®µèŠ‚', emoji:'ðŸ®', label:'LANTERN FESTIVAL', note:'å…ƒå®µèŠ‚å¿«ä¹ï¼èŠ±ç¯æ˜ æœˆï¼Œä½ æ˜¯æˆ‘å¿ƒé‡Œæœ€äº®çš„é‚£ç›ç¯ã€‚' },
    { m:3, d:5, name:'æƒŠè›°', emoji:'âš¡', label:'AWAKENING OF INSECTS', note:'æƒŠè›°æ˜¥é›·å“ï¼Œä¸‡ç‰©å¤è‹ï¼Œä½ æ˜¯æˆ‘æœ€ç¾Žçš„æ˜¥å¤©ã€‚' },
    { m:3, d:8, name:'å¦‡å¥³èŠ‚', emoji:'ðŸŒ¹', label:'WOMENS DAY', note:'ä»Šå¤©æ˜¯å±žäºŽä½ çš„èŠ‚æ—¥ï¼Œæ„¿ä½ æ°¸è¿œè¢«æ¸©æŸ”ç›¸å¾…ï¼Œè¢«çˆ±å®ˆæŠ¤ã€‚' },
    { m:3, d:12, name:'æ¤æ ‘èŠ‚', emoji:'ðŸŒ³', label:'TREE PLANTING DAY', note:'ä»Šå¤©ç§ä¸‹ä¸€æ£µæ ‘ï¼Œä¹Ÿåœ¨å¿ƒé‡Œç§ä¸‹å¯¹ä½ ä¸å˜çš„çˆ±ã€‚' },
    { m:3, d:20, name:'æ˜¥åˆ†', emoji:'ðŸŒ¸', label:'SPRING EQUINOX', note:'æ˜¥åˆ†æ˜¼å¤œå¹³åˆ†ï¼Œæˆ‘çš„çˆ±å¯¹ä½ ä»Žä¸åå¿ƒâ€”â€”æ°¸è¿œæ»¡åˆ†ã€‚' },

    { m:4, d:1, name:'æ„šäººèŠ‚', emoji:'ðŸ¤¡', label:'APRIL FOOLS', note:'ä»Šå¤©å¯ä»¥éª—ä½ è¯´â€œæˆ‘ä¸çˆ±ä½ äº†â€ï¼Œä½†æˆ‘çš„å¿ƒéª—ä¸äº†è‡ªå·±ï½ž' },
    { m:4, d:5, name:'æ¸…æ˜ŽèŠ‚', emoji:'ðŸŒ§', label:'QINGMING FESTIVAL', note:'æ…Žç»ˆè¿½è¿œï¼Œçæƒœçœ¼å‰ã€‚æœ‰ä½ åœ¨ï¼Œæ¯ä¸€å¤©éƒ½æ ¼å¤–æ¸©æš–ã€‚' },
    { m:4, d:20, name:'è°·é›¨', emoji:'ðŸŒ¾', label:'GRAIN RAIN', note:'è°·é›¨ç”Ÿç™¾è°·ï¼Œä½ æ˜¯æˆ‘ç”Ÿå‘½é‡Œæœ€é¥±æ»¡çš„é‚£é¢—ã€‚' },

    { m:5, d:1, name:'åŠ³åŠ¨èŠ‚', emoji:'ðŸ› ï¸', label:'LABOR DAY', note:'åŠ³åŠ¨æœ€å…‰è£ï¼Œä½†æˆ‘æ›´å…‰è£çš„æ˜¯èƒ½æ‹¥æœ‰ä½ ã€‚' },
    { m:5, d:4, name:'é’å¹´èŠ‚', emoji:'âœ¨', label:'YOUTH DAY', note:'é’æ˜¥æ­£å¥½ï¼Œä¸Žä½ å…±åº¦ã€‚æ„¿æˆ‘ä»¬æ°¸è¿œå¹´è½»ï¼Œæ°¸è¿œçƒ­æ³ªç›ˆçœ¶ã€‚' },
    { m:5, d:5, name:'ç«‹å¤', emoji:'â˜€ï¸', label:'START OF SUMMER', note:'ç«‹å¤å¿«ä¹ï¼æ„¿æˆ‘ä»¬çš„çˆ±åƒå¤å¤©ä¸€æ ·çƒ­æƒ…ã€‚' },
    { m:5, d:20, name:'520', emoji:'ðŸ’•', label:'I LOVE YOU', note:'520ï¼Œæˆ‘çˆ±ä½ ï¼æ„Ÿè°¢ä½ å‡ºçŽ°åœ¨æˆ‘çš„ç”Ÿå‘½é‡Œï¼Œä½ æ˜¯æˆ‘æœ€å¥½çš„é€‰æ‹©ã€‚' },
    { m:5, d:21, name:'å°æ»¡', emoji:'ðŸŒ¾', label:'GRAIN BUDS', note:'å°æ»¡æœªæ»¡ï¼Œä¸‡ç‰©å¯æœŸã€‚æˆ‘å¯¹ä½ çš„çˆ±æ°¸è¿œåœ¨å¢žé•¿çš„å­£èŠ‚ã€‚' },

    { m:6, d:1, name:'å„¿ç«¥èŠ‚', emoji:'ðŸŽˆ', label:'CHILDRENS DAY', note:'æ„¿ä½ æ°¸è¿œä¿æŒé‚£é¢—ç«¥å¿ƒï¼Œå’Œæˆ‘ä¸€èµ·åšä¸ªå¿«ä¹çš„å¤§å°å­©ã€‚' },
    { m:6, d:5, name:'èŠ’ç§', emoji:'ðŸŒ½', label:'GRAIN IN EAR', note:'èŠ’ç§å¿™ç§ï¼Œæœ‰ä½ åœ¨çš„æ—¥å­ï¼Œæ¯å¤©éƒ½æ˜¯æ”¶èŽ·ã€‚' },
    { m:6, d:19, name:'ç«¯åˆèŠ‚', emoji:'ðŸ›¶', label:'DRAGON BOAT FESTIVAL', note:'ç²½å­è½¯ç³¯ï¼Œä½ æ›´ç”œï½žç«¯åˆå®‰åº·ï¼' },
    { m:6, d:21, name:'å¤è‡³', emoji:'ðŸ‰', label:'SUMMER SOLSTICE', note:'å¤è‡³æœ€é•¿çš„ä¸€å¤©ï¼Œæˆ‘çš„æ€å¿µæ¯”å®ƒè¿˜é•¿ã€‚' },

    { m:7, d:6, name:'å°æš‘', emoji:'ðŸŒ¡ï¸', label:'MINOR HEAT', note:'å°æš‘å…¥ä¼å¤©ï¼Œä½ çš„æ€€æŠ±æ˜¯æœ€æ¸…å‡‰çš„é£Žã€‚' },
    { m:7, d:23, name:'å¤§æš‘', emoji:'ðŸ”¥', label:'MAJOR HEAT', note:'å¤§æš‘ç‚Žç‚Žï¼Œä½ æ˜¯æˆ‘å¿ƒé‡Œçš„å†°é•‡è¥¿ç“œã€‚' },

    { m:8, d:7, name:'ç«‹ç§‹', emoji:'ðŸ', label:'START OF AUTUMN', note:'ç«‹ç§‹å¿«ä¹ï¼Œæ„¿ä¸Žä½ å…±èµæ¯ä¸€ç‰‡ç§‹å¶ã€‚' },
    { m:8, d:19, name:'ä¸ƒå¤•èŠ‚', emoji:'ðŸŒŒ', label:'QIXI FESTIVAL', note:'ä¸ƒå¤•å¿«ä¹ï¼ç‰›éƒŽç»‡å¥³ä¸€å¹´åªè§ä¸€æ¬¡ï¼Œè€Œæˆ‘ä»¬æ¯å¤©éƒ½åœ¨ä¸€èµ·ï¼ŒçœŸå¹¸è¿ã€‚' },
    { m:8, d:23, name:'å¤„æš‘', emoji:'ðŸŒ¬ï¸', label:'END OF HEAT', note:'å¤„æš‘å‡ºæš‘ï¼Œç‚Žçƒ­æ¸æ¶ˆï¼Œçˆ±æ„ä¸å‡ã€‚' },

    { m:9, d:7, name:'ç™½éœ²', emoji:'ðŸ’§', label:'WHITE DEW', note:'ç™½éœ²ä¸ºéœœï¼Œæ‰€è°“ä¼Šäººï¼Œåœ¨æˆ‘èº«æ—ã€‚' },
    { m:9, d:10, name:'æ•™å¸ˆèŠ‚', emoji:'ðŸ“š', label:'TEACHERS DAY', note:'ä½ æ˜¯æˆ‘äººç”Ÿä¸­æœ€ç‰¹åˆ«çš„è€å¸ˆï¼Œæ•™ä¼šäº†æˆ‘ä»€ä¹ˆæ˜¯çˆ±ã€‚' },
    { m:9, d:23, name:'ç§‹åˆ†', emoji:'ðŸ‚', label:'AUTUMN EQUINOX', note:'ç§‹åˆ†æ˜¼å¤œå‡ï¼Œä½ æ˜¯æˆ‘å¿ƒé‡Œçš„å¤©å¹³ã€‚' },
    { m:9, d:25, name:'ä¸­ç§‹èŠ‚', emoji:'ðŸŒ•', label:'MID AUTUMN FESTIVAL', note:'æœˆåœ†äººå›¢åœ†ï¼Œæœ‰ä½ æ‰å«å›¢åœ†ã€‚ä¸­ç§‹å¿«ä¹ï¼' },

    { m:10, d:1, name:'å›½åº†èŠ‚', emoji:'ðŸŽ‘', label:'NATIONAL DAY', note:'å›½åº†å¿«ä¹ï¼å’Œä½ åœ¨ä¸€èµ·çš„æ¯ä¸€å¤©éƒ½åƒèŠ‚æ—¥ï¼Œçˆ±ä½ ã€‚' },
    { m:10, d:8, name:'å¯’éœ²', emoji:'ðŸƒ', label:'COLD DEW', note:'å¯’éœ²å‡éœœï¼Œæœ‰ä½ åœ¨å¿ƒé‡Œæ€»æ˜¯æš–çš„ã€‚' },
    { m:10, d:23, name:'éœœé™', emoji:'â„ï¸', label:'FROST DESCENT', note:'éœœé™å¶è½ï¼Œæˆ‘çš„çˆ±å´å¸¸é’ã€‚' },
    { m:10, d:31, name:'ä¸‡åœ£å¤œ', emoji:'ðŸŽƒ', label:'HALLOWEEN', note:'ä¸ç»™ç³–å°±æ£è›‹ï¼Œä½†ä½ ç»™äº†æˆ‘å…¨ä¸–ç•Œæœ€ç”œçš„ç³–â€”â€”ä½ çš„çˆ±ã€‚' },

    { m:11, d:7, name:'ç«‹å†¬', emoji:'ðŸ§£', label:'START OF WINTER', note:'ç«‹å†¬å¿«ä¹ï¼Œä½ çš„æ‹¥æŠ±æ˜¯å†¬å¤©é‡Œæœ€æš–çš„é˜³å…‰ã€‚' },
    { m:11, d:11, name:'å…‰æ£èŠ‚', emoji:'ðŸ‘«', label:'SINGLES DAY', note:'å¹¸å¥½æˆ‘ä»¬ä¸ç”¨è¿‡è¿™ä¸ªèŠ‚ï¼Œå› ä¸ºæˆ‘æœ‰ä½ ã€‚' },
    { m:11, d:22, name:'å°é›ª', emoji:'â›„', label:'MINOR SNOW', note:'å°é›ªé£˜é£˜ï¼Œä½ æ˜¯æˆ‘å¿ƒé‡Œæœ€æš–çš„é‚£å›¢ç«ã€‚' },
    { m:11, d:26, name:'æ„Ÿæ©èŠ‚', emoji:'ðŸ™', label:'THANKSGIVING', note:'æ„Ÿè°¢ç”Ÿå‘½ä¸­æœ‰ä½ ï¼Œæ¯ä¸€å¤©éƒ½æ˜¯æ©èµã€‚' },

    { m:12, d:7, name:'å¤§é›ª', emoji:'â˜ƒï¸', label:'MAJOR SNOW', note:'å¤§é›ªå°é—¨ï¼Œå°ä¸ä½æˆ‘å¯¹ä½ çš„æƒ³å¿µã€‚' },
    { m:12, d:22, name:'å†¬è‡³', emoji:'ðŸ¥Ÿ', label:'WINTER SOLSTICE', note:'å†¬è‡³å¿«ä¹ï¼Œè®°å¾—åƒé¥ºå­ï¼Œä½†è®°å¾—æƒ³æˆ‘ã€‚' },
    { m:12, d:24, name:'å¹³å®‰å¤œ', emoji:'ðŸŽ„', label:'CHRISTMAS EVE', note:'å¹³å®‰å¤œå¿«ä¹ï¼æ„¿ä½ å¹³å¹³å®‰å®‰ï¼Œæˆ‘ä»¬çš„çˆ±æƒ…ä¹Ÿå²å²å¸¸å®‰ã€‚' },
    { m:12, d:25, name:'åœ£è¯žèŠ‚', emoji:'ðŸŽ…', label:'MERRY CHRISTMAS', note:'åœ£è¯žå¿«ä¹ï¼ä½ å°±æ˜¯æˆ‘æ”¶åˆ°çš„æœ€å¥½çš„ç¤¼ç‰©ï¼Œæ°¸è¿œçˆ±ä½ ã€‚' },
    { m:12, d:31, name:'è·¨å¹´å¤œ', emoji:'ðŸŽ†', label:'NEW YEAR EVE', note:'å†è§è¿™ä¸€å¹´ï¼Œä½ æ˜¯æˆ‘æœ€å¥½çš„æ”¶èŽ·ã€‚æ–°çš„ä¸€å¹´ï¼Œç»§ç»­çˆ±ä½ ã€‚' }
];
var festival = null;
    for (var fi = 0; fi < festivals.length; fi++) {
        if (festivals[fi].m === month && festivals[fi].d === day) { festival = festivals[fi]; break; }
    }

  var weathers = [
    'æ™´ç©ºä¸‡é‡Œ',
    'å¤šäº‘è½¬æ™´',
    'é˜´å¤©æœ‰äº‘',
    'ç»†é›¨è’™è’™',
    'æ˜¥é£Žå’Œç…¦',
    'å¾®å¾®å¯’å†·',
    'æ¸…é£Žå¾å¾',
    'é›¨åŽåˆæ™´',
    'å¤œè‰²å®é™',
    'æœˆå…‰çšŽæ´',
    'æ™´é—´å¤šäº‘',
    'å¤§é›¨æ»‚æ²±',
    'é›·é›¨äº¤åŠ ',
    'å°é›ªçº·é£ž',
    'å¾®é£Žæ‹‚é¢',
    'å¤šäº‘å¤©æ°”',
    'é›¾æ°”æœ¦èƒ§',
    'æ˜Ÿå…‰ç’€ç’¨',
    'æœéœžæ»¡å¤©',
    'å¤•é˜³è¥¿ä¸‹',
    'æµ·é£Žè½»æ‹‚',
    'å±±é—´æ¸…çˆ½',
    'ç§‹å¶é£˜è½',
    'èŠ±é¦™å››æº¢',
    'ç»¿æ„ç›Žç„¶',
    'é›¨åŽæ¸…æ–°',
    'é›ªèŠ±é£žèˆž',
    'é˜³å…‰æ˜Žåªš'
];

var statusPool = [
    'æ­£åœ¨æƒ³ä½  ðŸ’­',
    'å¿™ç¢Œä¸­ï¼Œä½†å¿ƒé‡Œæœ‰ä½ ',
    'å¥½å¥½çš„ï¼Œåˆ«æ‹…å¿ƒ âœ¨',
    'æœŸå¾…è§åˆ°ä½ ',
    'æœ‰ç‚¹æƒ³ä½ äº†',
    'åœ¨åŠªåŠ›å˜æ›´å¥½',
    'ä»Šå¤©æŒºå®‰é™çš„',
    'å¿ƒæƒ…ä¸é”™å“¦ ðŸŒ±',
    'ä¸€åˆ‡éƒ½å¥½ï¼Œä½ å‘¢ï¼Ÿ',
    'çœ‹æœˆäº®ï¼Œæƒ³åˆ°ä½  ðŸŒ™',
    'ä»Šå¤©æœ‰ç‚¹æƒ³ä½ ',
    'åˆšåˆšçœ‹åˆ°ä¸€æœµäº‘åƒä½  â˜ï¸',
    'å·¥ä½œå†å¿™ä¹Ÿä¼šæƒ³ä½ çš„',
    'ä»Šå¤©ä½ å¼€å¿ƒå—ï¼Ÿ',
    'æ¢¦é‡Œè§ ðŸ’¤',
    'å¥½å¥½åƒé¥­äº†å—ï¼Ÿ',
    'è®°å¾—å¤šå–æ°´å“¦ ðŸ’§',
    'ä»Šå¤©æœ‰æ²¡æœ‰ç…§é¡¾å¥½è‡ªå·±',
    'æƒ³ä½ ï¼Œä½†ä¸è¯´ ðŸ¤«',
    'å…¨ä¸–ç•Œä½ æœ€å¯çˆ±',
    'ä»Šå¤©å¤©æ°”ä¸é”™ï¼Œé€‚åˆæƒ³ä½ ',
    'åƒé¥±å–è¶³ï¼Œå¼€å§‹æƒ³ä½ ',
    'ä»Šå¤©ä¹Ÿæƒ³ç‰µä½ çš„æ‰‹',
    'ä½ æœ‰æ²¡æœ‰æƒ³æˆ‘',
    'ä»Šå¤©æ¯”æ˜¨å¤©æ›´æƒ³ä½ ',
    'çœ‹åˆ°å¥½åƒçš„æƒ³åˆ†äº«ç»™ä½  ðŸœ',
    'å¬åˆ°ä¸€é¦–æ­Œæƒ³åˆ°ä½  ðŸŽµ',
    'ä»Šå¤©ä¹Ÿè¦åŠ æ²¹é¸­',
    'æ™šå®‰ï¼Œæˆ‘çš„å…¨ä¸–ç•Œ ðŸŒ™',
    'æ—©å®‰ï¼Œåˆæ˜¯æƒ³ä½ çš„ä¸€å¤©'
];
    var todayKey = String(now.getFullYear()) + String(month) + String(day);
    var seed = 0;
    for (var si = 0; si < todayKey.length; si++) seed += todayKey.charCodeAt(si) * (si + 1);
    function seededRandDg(s, offset) {
        var x = Math.sin(s * 9301 + offset * 49297 + 233) * 1000003;
        return x - Math.floor(x);
    }
    var defaultWeather = weathers[Math.floor(seededRandDg(seed, 0) * weathers.length)];
    var customWeatherKey = 'customWeather_' + now.getFullYear() + '_' + month + '_' + day;
    var weather = localStorage.getItem(customWeatherKey) || defaultWeather;
    var status = statusPool[Math.floor(seededRandDg(seed, 1) * statusPool.length)];

    return { timeLabel: timeLabel, timeEmoji: timeEmoji, festival: festival, weather: weather, status: status };
}

function _buildDailyGreeting() {
    try {
        var data = _getDailyGreetingData();
        var festival = data.festival;
        var timeLabel = data.timeLabel;
        var timeEmoji = data.timeEmoji;
        var weather = data.weather;
        var status = data.status;

        var now = new Date();
        var todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');

        var moodDataRaw = window.moodData || {};
        var todayMood = moodDataRaw[todayStr];
        var allMoods = (typeof getAllMoodOptions === 'function') ? getAllMoodOptions() : [];

        var pName = (typeof settings !== 'undefined' && settings.partnerName) ? settings.partnerName : 'æ¢¦è§’';
        var mName = (typeof settings !== 'undefined' && settings.myName) ? settings.myName : 'æˆ‘';

        var partnerMoodText = pName + ' ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•';
        var partnerMoodIcon = null; 
        var partnerMoodNote = '';

        if (todayMood && todayMood.partner) {
            for (var pi = 0; pi < allMoods.length; pi++) {
                if (allMoods[pi].key === todayMood.partner) {
                    partnerMoodText = allMoods[pi].kaomoji + '  ' + allMoods[pi].label;
                    partnerMoodIcon = allMoods[pi].kaomoji;
                    break;
                }
            }
            partnerMoodNote = todayMood.partnerNote || '';
        }

        var h = now.getHours();
        var mainTitle = festival ? (festival.name + 'å¿«ä¹') : timeLabel;
        var festLabel = festival ? festival.label : ('GOOD ' + (h < 12 ? 'MORNING' : h < 18 ? 'AFTERNOON' : 'EVENING'));
        var noteText = festival ? festival.note : 'ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡ï¼Œæˆ‘åœ¨è¿™é‡Œé™ªç€ä½  âœ¦';

        var customData = {};
        try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e2) {}
        
        var now2 = new Date();
        var dailySeed = now2.getFullYear() * 10000 + (now2.getMonth()+1) * 100 + now2.getDate();
        function seededRandom(seed) { return (Math.abs(Math.sin(seed * 9301 + 49297) * 233280) % 233280) / 233280; }
        var todaySeedForText = dailySeed;

        var defaultTitles = festival ? [(festival.name + 'å¿«ä¹')] : [timeLabel, 'ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå“¦', 'ä½ åœ¨æˆ‘å¿ƒé‡Œå‘€', 'æƒ³ä½ '];
        var defaultNotes = festival ? [festival.note] : ['ä»Šå¤©ä¹Ÿè¦å…ƒæ°”æ»¡æ»¡ï¼Œæˆ‘åœ¨è¿™é‡Œé™ªç€ä½  âœ¦', 'æ¯ä¸€å¤©éƒ½å› ä¸ºæœ‰ä½ è€Œç‰¹åˆ« âœ¦', 'æƒ³åˆ°ä½ å°±è§‰å¾—å¾ˆå®‰å¿ƒ âœ¦', 'ä½ æ˜¯æˆ‘æœ€å–œæ¬¢çš„äºº âœ¦'];

        var mixedTitles = (customData.titles && customData.titles.length > 0) ? [...customData.titles, ...defaultTitles] : 
                          (customData.title ? [customData.title, ...defaultTitles] : defaultTitles);
        var mixedNotes = (customData.notes && customData.notes.length > 0) ? [...customData.notes, ...defaultNotes] :
                         (customData.note ? [customData.note, ...defaultNotes] : defaultNotes);

        mainTitle = mixedTitles[Math.floor(seededRandom(todaySeedForText) * mixedTitles.length)];
        noteText = mixedNotes[Math.floor(seededRandom(todaySeedForText + 1) * mixedNotes.length)];

        function setEl(id, val) { var el = document.getElementById(id); if (el) el.textContent = val; }
        function setElHTML(id, val) { var el = document.getElementById(id); if (el) el.innerHTML = val; }

        var emojiEl = document.getElementById('dg-emoji');
        if (emojiEl) {
            if (festival) {
                emojiEl.textContent = festival.emoji;
            }
        }

        var moodIconEl = document.getElementById('dg-partner-mood-icon');
        if (moodIconEl) {
            if (partnerMoodIcon) {
                moodIconEl.textContent = partnerMoodIcon;
                moodIconEl.style.fontSize = '32px';
            }
        }

        setEl('dg-festival', festLabel);
        setEl('dg-title', mainTitle);
        setEl('dg-partner-mood', partnerMoodText);
        setEl('dg-partner-mood-note', partnerMoodNote || (todayMood && todayMood.partner ? pName + ' è®°å½•äº†ä»Šå¤©çš„å¿ƒæƒ… â˜†' : ''));

        var statusPoolData = [];
        try { statusPoolData = JSON.parse(localStorage.getItem('dg_status_pool') || '[]'); } catch(e2) {}
        if (statusPoolData.length > 0) {
            var poolItem = statusPoolData[Math.floor(seededRandom(todaySeedForText + 2) * statusPoolData.length)];
            if (poolItem) {
                setEl('dg-festival', poolItem.label || festLabel);
                setEl('dg-status', poolItem.status || status);
                var emojiEl2 = document.getElementById('dg-emoji');
                if (emojiEl2) {
                    if (poolItem.iconImg) {
                        emojiEl2.textContent = '';
                        emojiEl2.style.backgroundImage = 'url(' + poolItem.iconImg + ')';
                        emojiEl2.style.backgroundSize = 'cover';
                        emojiEl2.style.backgroundPosition = 'center';
                    } else if (poolItem.icon) {
                        emojiEl2.style.backgroundImage = '';
                        emojiEl2.textContent = poolItem.icon;
                    }
                }
            }
        } else {
            setEl('dg-weather', weather);
            setEl('dg-status', status);
        }
        if (statusPoolData.length === 0) {
            setEl('dg-weather', weather);
            setEl('dg-status', status);
        } else {
            setEl('dg-weather', weather);
        }

        var noteTextEl = document.getElementById('dg-note-text');
        if (noteTextEl) noteTextEl.textContent = noteText;
        var wBadge = document.getElementById('dg-note-weather-badge');
        if (wBadge) wBadge.style.display = 'none';

        setEl('dg-section-label-partner', pName + ' ä»Šæ—¥çŠ¶æ€');
        setEl('dg-weather-label', pName + ' çš„å¤©æ°”');
        setEl('dg-status-label', pName + ' çš„çŠ¶æ€');

        var months = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹','å','åä¸€','åäºŒ'];
        setEl('dg-date-stamp', now.getFullYear() + ' Â· ' + months[now.getMonth()] + 'æœˆ' + now.getDate() + 'æ—¥');

        var headerBg = localStorage.getItem('dg_header_bg');
        var bgEl = document.getElementById('dg-header-band-bg');
        if (bgEl && headerBg) {
            bgEl.style.backgroundImage = 'url(' + headerBg + ')';
            bgEl.classList.add('has-img');
        }

        var decoImg = customData.decoImg;
        var decoWrap2 = document.getElementById('dg-deco-img-wrap');
        var decoImgEl2 = document.getElementById('dg-deco-img');
        if (decoWrap2 && decoImgEl2) {
            if (decoImg) {
                decoImgEl2.src = decoImg;
                decoWrap2.style.display = 'block';
            } else {
                decoWrap2.style.display = 'none';
            }
        }
    } catch(e) { console.warn('Daily greeting build error:', e); }
}

window.toggleImmersiveMode = function(force) {
    var isOn = (force !== undefined) ? force : !document.body.classList.contains('immersive-mode');
    document.body.classList.toggle('immersive-mode', isOn);
    var toggle = document.getElementById('immersive-toggle');
    if (toggle) toggle.classList.toggle('active', isOn);
    try { localStorage.setItem('immersive_mode', isOn ? '1' : '0'); } catch(e) {}
    if (!isOn && typeof showNotification === 'function') showNotification('å·²é€€å‡ºæ²‰æµ¸å¼æ¨¡å¼', 'info');
};

(function() {
    var btn = document.getElementById('immersive-exit-btn');
    if (!btn) return;
    var isDragging = false, hasMoved = false;
    var startX, startY, origRight, origBottom;
    
    function getRight() { return parseInt(btn.style.right) || 20; }
    function getBottom() { return parseInt(btn.style.bottom) || 100; }
    
    function onStart(e) {
        isDragging = true; hasMoved = false;
        btn.classList.add('dragging');
        var touch = e.touches ? e.touches[0] : e;
        startX = touch.clientX;
        startY = touch.clientY;
        origRight = getRight();
        origBottom = getBottom();
        e.preventDefault();
    }
    function onMove(e) {
        if (!isDragging) return;
        var touch = e.touches ? e.touches[0] : e;
        var dx = touch.clientX - startX;
        var dy = touch.clientY - startY;
        if (Math.abs(dx) > 3 || Math.abs(dy) > 3) hasMoved = true;
        var newRight = Math.max(10, Math.min(window.innerWidth - 54, origRight - dx));
        var newBottom = Math.max(10, Math.min(window.innerHeight - 54, origBottom - dy));
        btn.style.right = newRight + 'px';
        btn.style.bottom = newBottom + 'px';
        btn.style.left = 'auto';
        btn.style.top = 'auto';
        e.preventDefault();
    }
    function onEnd(e) {
        if (!isDragging) return;
        isDragging = false;
        btn.classList.remove('dragging');
        if (!hasMoved) {
            window.toggleImmersiveMode(false);
        }
    }
    btn.addEventListener('mousedown', onStart, {passive: false});
    btn.addEventListener('touchstart', onStart, {passive: false});
    document.addEventListener('mousemove', onMove, {passive: false});
    document.addEventListener('touchmove', onMove, {passive: false});
    document.addEventListener('mouseup', onEnd);
    document.addEventListener('touchend', onEnd);
    
    btn.removeAttribute('onclick');
})();
(function() {
    try {
        if (localStorage.getItem('immersive_mode') === '1') {
            document.body.classList.add('immersive-mode');
            var t = document.getElementById('immersive-toggle');
            if (t) t.classList.add('active');
        }
    } catch(e) {}
})();

window.openDailyGreetingEditor = function() {
    var modal = document.getElementById('dg-editor-modal');
    if (!modal) return;
    var customData = {};
    try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e) {}
    var titleEl = document.getElementById('dg-edit-title');
    var noteEl = document.getElementById('dg-edit-note');
    if (titleEl) titleEl.value = (customData.titles && customData.titles.length) ? customData.titles.join('\n') : (customData.title || '');
    if (noteEl) noteEl.value = (customData.notes && customData.notes.length) ? customData.notes.join('\n') : (customData.note || '');

    if (customData.decoImg) {
        var prev = document.getElementById('dg-deco-preview');
        var prevImg = document.getElementById('dg-deco-preview-img');
        if (prev && prevImg) { prevImg.src = customData.decoImg; prev.style.display = 'block'; }
    }

    modal.style.display = 'flex';
    modal.classList.add('active');
};
window.closeDailyGreetingEditor = function() {
    var modal = document.getElementById('dg-editor-modal');
    if (modal) { modal.style.display = 'none'; modal.classList.remove('active'); }
};
window.saveDailyGreetingCustom = function() {
    var customData = {};
    try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e) {}
    var titleEl = document.getElementById('dg-edit-title');
    var noteEl = document.getElementById('dg-edit-note');
    if (titleEl && titleEl.value.trim()) {
        var titles = titleEl.value.split('\n').map(function(s){ return s.trim(); }).filter(Boolean);
        customData.titles = titles;
        customData.title = titles[0];
    } else { delete customData.titles; delete customData.title; }
    if (noteEl && noteEl.value.trim()) {
        var notes = noteEl.value.split('\n').map(function(s){ return s.trim(); }).filter(Boolean);
        customData.notes = notes;
        customData.note = notes[0]; 
    } else { delete customData.notes; delete customData.note; }
    localStorage.setItem('dg_custom_data', JSON.stringify(customData));
    closeDailyGreetingEditor();
    if (typeof _buildDailyGreeting === 'function') _buildDailyGreeting();
    if (typeof showNotification === 'function') showNotification('å…¬å‘Šå·²ä¿å­˜ âœ¦', 'success');
};
window.clearDgDecoImg = function() {
    var customData = {};
    try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e) {}
    delete customData.decoImg;
    localStorage.setItem('dg_custom_data', JSON.stringify(customData));
    var prev = document.getElementById('dg-deco-preview');
    if (prev) prev.style.display = 'none';
    var wrap = document.getElementById('dg-deco-img-wrap');
    if (wrap) wrap.style.display = 'none';
};
window.clearDgHeaderBg = function() {
    localStorage.removeItem('dg_header_bg');
    var bgEl = document.getElementById('dg-header-band-bg');
    if (bgEl) { bgEl.style.backgroundImage = ''; bgEl.classList.remove('has-img'); }
};

window.switchToAnnouncementPanel = function() {
    var listArea = document.getElementById('custom-replies-list');
    var annPanel = document.getElementById('announcement-panel');
    var toolbar = document.getElementById('cr-toolbar');
    var subTabs = document.getElementById('cr-sub-tabs');
    var addBtn = document.getElementById('add-custom-reply');
    var titleEl = document.getElementById('cr-modal-title');
    if (listArea) listArea.style.display = 'none';
    if (annPanel) { annPanel.style.display = 'block'; annPanel.scrollTop = 0; }
    if (toolbar) toolbar.style.display = 'none';
    if (subTabs) subTabs.style.display = 'none';
    if (addBtn) addBtn.style.display = 'none';
    if (titleEl) titleEl.textContent = 'ä»Šæ—¥å…¬å‘Šé…ç½®';
    var customData = {};
    try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(e2) {}
    var titleInput = document.getElementById('dg-edit-title');
    var noteInput = document.getElementById('dg-edit-note');
    if (titleInput) titleInput.value = (customData.titles && customData.titles.length) ? customData.titles.join('\n') : (customData.title || '');
    if (noteInput) noteInput.value = (customData.notes && customData.notes.length) ? customData.notes.join('\n') : (customData.note || '');
    if (customData.decoImg) {
        var prev = document.getElementById('dg-deco-preview');
        var prevImg = document.getElementById('dg-deco-preview-img');
        if (prev && prevImg) { prevImg.src = customData.decoImg; prev.style.display = 'block'; }
    }
    renderAnnStatusPool();
};

window.renderAnnStatusPool = function() {
    var listEl = document.getElementById('ann-status-pool-list');
    if (!listEl) return;
    var pool = [];
    try { pool = JSON.parse(localStorage.getItem('dg_status_pool') || '[]'); } catch(e2) {}
    listEl.innerHTML = '';
    if (pool.length === 0) {
        listEl.innerHTML = '<div style="font-size:12px;color:var(--text-secondary);text-align:center;padding:10px 0;opacity:0.6;">æš‚æ— æ¡ç›®ï¼Œæ·»åŠ åŽå°†éšæœºæŠ½å–</div>';
        return;
    }
    pool.forEach(function(item, idx) {
        var row = document.createElement('div');
        row.style.cssText = 'display:flex;align-items:center;gap:10px;padding:9px 12px;background:linear-gradient(135deg,rgba(var(--accent-color-rgb),0.05),rgba(var(--accent-color-rgb),0.02));border-radius:12px;border:1px solid rgba(var(--accent-color-rgb),0.15);font-size:13px;transition:box-shadow 0.2s;';
        var iconHtml = item.iconImg
            ? '<img src="' + item.iconImg + '" style="width:26px;height:26px;border-radius:50%;object-fit:cover;flex-shrink:0;">'
            : '<span style="font-size:18px;min-width:26px;text-align:center;flex-shrink:0;">' + (item.icon || 'âœ¦') + '</span>';
        row.innerHTML = iconHtml
            + '<div style="flex:1;min-width:0;">'
            + '<div style="color:var(--text-primary);font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + (item.status || 'â€”') + '</div>'
            + (item.label ? '<div style="color:var(--accent-color);font-size:10px;letter-spacing:1.5px;margin-top:2px;opacity:0.8;">' + item.label + '</div>' : '')
            + '</div>'
            + '<button onclick="removeAnnStatusPoolItem(' + idx + ')" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;font-size:14px;padding:3px 5px;border-radius:6px;opacity:0.6;transition:opacity 0.2s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6">âœ•</button>';
        listEl.appendChild(row);
    });
};

window.addAnnStatusPoolItem = function() {
    var statusInput = document.getElementById('ann-status-pool-input');
    var labelInput = document.getElementById('ann-status-label-input');
    var iconInput = document.getElementById('ann-status-icon-input');
    var status = statusInput ? statusInput.value.trim() : '';
    var label = labelInput ? labelInput.value.trim() : '';
    var icon = iconInput ? iconInput.value.trim() : '';
    var iconImg = iconInput ? (iconInput.dataset.imgSrc || '') : '';
    if (!status && !label) { if (typeof showNotification === 'function') showNotification('è¯·è‡³å°‘å¡«å†™çŠ¶æ€æˆ–æ ‡ç­¾', 'warning'); return; }
    var pool = [];
    try { pool = JSON.parse(localStorage.getItem('dg_status_pool') || '[]'); } catch(e2) {}
    var entry = { status: status, label: label, icon: icon || 'âœ¦' };
    if (iconImg) entry.iconImg = iconImg;
    pool.push(entry);
    localStorage.setItem('dg_status_pool', JSON.stringify(pool));
    if (statusInput) statusInput.value = '';
    if (labelInput) labelInput.value = '';
    if (iconInput) { iconInput.value = ''; delete iconInput.dataset.imgSrc; }
    renderAnnStatusPool();
    if (typeof showNotification === 'function') showNotification('å·²æ·»åŠ åˆ°éšæœºåº“', 'success');
};

window.handleAnnStatusIconUpload = function(input) {
    var file = input.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        var iconInput = document.getElementById('ann-status-icon-input');
        if (iconInput) {
            iconInput.dataset.imgSrc = ev.target.result;
            iconInput.value = '[å›¾ç‰‡]';
            iconInput.style.fontSize = '10px';
        }
    };
    reader.readAsDataURL(file);
};

window.removeAnnStatusPoolItem = function(idx) {
    var pool = [];
    try { pool = JSON.parse(localStorage.getItem('dg_status_pool') || '[]'); } catch(e2) {}
    pool.splice(idx, 1);
    localStorage.setItem('dg_status_pool', JSON.stringify(pool));
    renderAnnStatusPool();
};

document.addEventListener('DOMContentLoaded', function() {
    var headerInput = document.getElementById('dg-header-img-input');
    if (headerInput) {
        headerInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(ev) {
                var data = ev.target.result;
                localStorage.setItem('dg_header_bg', data);
                var bgEl = document.getElementById('dg-header-band-bg');
                if (bgEl) { bgEl.style.backgroundImage = 'url(' + data + ')'; bgEl.classList.add('has-img'); }
            };
            reader.readAsDataURL(file);
        });
    }
    var decoInput = document.getElementById('dg-deco-img-input');
    if (decoInput) {
        decoInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(ev) {
                var data = ev.target.result;
                var customData = {};
                try { customData = JSON.parse(localStorage.getItem('dg_custom_data') || '{}'); } catch(ex) {}
                customData.decoImg = data;
                localStorage.setItem('dg_custom_data', JSON.stringify(customData));
                var prev = document.getElementById('dg-deco-preview');
                var prevImg = document.getElementById('dg-deco-preview-img');
                if (prev && prevImg) { prevImg.src = data; prev.style.display = 'block'; }
            };
            reader.readAsDataURL(file);
        });
    }
});

window.updateDynamicNames = function() {
    try {
        var pName = (typeof settings !== 'undefined' && settings.partnerName) ? settings.partnerName : 'æ¢¦è§’';
        var mName = (typeof settings !== 'undefined' && settings.myName) ? settings.myName : 'æˆ‘';

        var tabPartner = document.getElementById('mood-tab-partner');
        if (tabPartner) tabPartner.textContent = pName + 'çš„è®°å½•';
        var tabMe = document.getElementById('mood-tab-me');
        if (tabMe) tabMe.textContent = mName + 'çš„è®°å½•';

        var detailPartnerTitle = document.getElementById('detail-partner-title');
        if (detailPartnerTitle) detailPartnerTitle.textContent = pName + 'çš„';

        var partnerNoRec = document.getElementById('detail-partner-no-record');
        if (partnerNoRec) {
            var msgEl = partnerNoRec;
            if (!msgEl.querySelector('span')) msgEl.textContent = pName + ' è¿™å¤©è¿˜æ²¡æœ‰ç•™ä¸‹è®°å½•';
        }

        var editPartnerBtn = document.getElementById('edit-partner-mood');
        if (editPartnerBtn) editPartnerBtn.textContent = 'ä¿®æ”¹' + pName;
        var deletePartnerBtn = document.getElementById('delete-partner-mood');
        if (deletePartnerBtn) deletePartnerBtn.textContent = 'åˆ é™¤' + pName;

        var continueBtn = document.getElementById('continue-btn');
        if (continueBtn) continueBtn.title = 'è®©' + pName + 'ç»§ç»­è¯´';

        var envInfo = document.querySelector('.env-send-info');
        if (envInfo) {
            var textNodes = Array.from(envInfo.childNodes).filter(n => n.nodeType === 3);
            textNodes.forEach(function(n) {
                if (n.textContent.includes('å¯¹æ–¹å°†åœ¨') || n.textContent.includes('å°æ—¶å†…å›žä¿¡')) {
                    n.textContent = pName + ' å°†åœ¨ 10-24 å°æ—¶å†…å›žä¿¡ï¼ˆ8-12 å¥è¯ï¼‰';
                }
            });
        }

        setDgLabel('dg-section-label-partner', pName + ' ä»Šæ—¥çŠ¶æ€');
        setDgLabel('dg-weather-label', pName + ' çš„å¤©æ°”');
        setDgLabel('dg-status-label', pName + ' çš„çŠ¶æ€');

        var envInfoSpan = document.getElementById('env-reply-time-info');
        if (envInfoSpan) envInfoSpan.textContent = pName + ' å°†åœ¨ 10-24 å°æ—¶å†…å›žä¿¡ï¼ˆ8-12 å¥è¯ï¼‰';

        var pokeInput = document.getElementById('poke-input');
        if (pokeInput) pokeInput.placeholder = 'ä¾‹å¦‚ï¼šæ‹äº†æ‹"' + pName + '"çš„è‚©è†€';

        document.querySelectorAll('[data-name-partner]').forEach(function(el) {
            el.textContent = pName + 'çš„è®°å½•';
        });
        document.querySelectorAll('[data-name-me]').forEach(function(el) {
            el.textContent = mName + 'çš„è®°å½•';
        });
        document.querySelectorAll('[data-delete-partner]').forEach(function(el) {
            el.textContent = 'åˆ é™¤' + pName;
        });
        document.querySelectorAll('[data-edit-partner]').forEach(function(el) {
            el.textContent = 'ä¿®æ”¹' + pName;
        });
    } catch(e) { console.warn('updateDynamicNames error:', e); }
};
function setDgLabel(id, txt) {
    var el = document.getElementById(id);
    if (el && el.tagName !== 'INPUT') el.textContent = txt;
}

window.closeDailyGreeting = function() {
    try {
        var modal = document.getElementById('daily-greeting-modal');
        if (modal) {
            modal.style.opacity = '0';
            modal.style.transition = 'opacity 0.3s ease';
            setTimeout(function() {
                modal.classList.add('hidden');
                modal.style.opacity = '';
                modal.style.transition = '';
            }, 320);
        }
        localStorage.setItem('dailyGreetingShown', new Date().toDateString());
    } catch(e) {}
};

window.reopenDailyGreeting = function() {
    try {
        if (typeof _buildDailyGreeting === 'function') _buildDailyGreeting();
        var modal = document.getElementById('daily-greeting-modal');
        if (modal) {
            modal.style.opacity = '0';
            modal.classList.remove('hidden');
            requestAnimationFrame(function() {
                modal.style.transition = 'opacity 0.3s ease';
                modal.style.opacity = '1';
            });
        }
    } catch(e) {}
};

window.tryShowDailyGreeting = function() {
    try {
        if (localStorage.getItem('dailyGreetingShown') === new Date().toDateString()) return;

        var now = new Date();
        var todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
        var moodDataRaw = window.moodData || {};
        var todayMood = moodDataRaw[todayStr];

        if (!todayMood || !todayMood.partner) {
            setTimeout(function() {
                var refreshedMood = (window.moodData || {})[todayStr];
                _buildDailyGreeting(); 
                var modal = document.getElementById('daily-greeting-modal');
                if (modal) modal.classList.remove('hidden');
                localStorage.setItem('dailyGreetingShown', new Date().toDateString());
            }, 45000);
            return;
        }

        _buildDailyGreeting();
        var modal = document.getElementById('daily-greeting-modal');
        if (modal) modal.classList.remove('hidden');
    } catch(e) { console.warn('Daily greeting show error:', e); }
};

function updateStorageUsageBar() {
    var fill = document.getElementById('storage-usage-fill');
    var text = document.getElementById('storage-usage-text');
    if (!fill || !text) return;

    try {
        var total = 0;
        if (window.localforage && window.APP_PREFIX) {
            localforage.keys().then(function(keys) {
                var promises = keys.map(function(k) {
                    return localforage.getItem(k).then(function(v) {
                        if (v === null || v === undefined) return 0;
                        var str = typeof v === 'string' ? v : JSON.stringify(v);
                        return k.length + str.length;
                    });
                });
                Promise.all(promises).then(function(sizes) {
                    var total = sizes.reduce(function(a,b){return a+b;}, 0);
                    var usedKB = (total * 2 / 1024).toFixed(1);
                    var maxKB = 10240;
                    var pct = Math.min(total * 2 / 1024 / maxKB * 100, 100).toFixed(1);
                    fill.style.width = pct + '%';
                    if (parseFloat(pct) > 80) fill.style.background = 'linear-gradient(90deg,#ff4757,#ff6b8a)';
                    else if (parseFloat(pct) > 50) fill.style.background = 'linear-gradient(90deg,#ffa502,rgba(255,165,2,0.6))';
                    else fill.style.background = 'linear-gradient(90deg,var(--accent-color),rgba(var(--accent-color-rgb),0.6))';
                    text.textContent = usedKB + ' KB / ~10 MB (' + pct + '%)';
                });
            }).catch(function() {
                var ls = 0;
                for (var i = 0; i < localStorage.length; i++) {
                    var k = localStorage.key(i) || '';
                    var v = localStorage.getItem(k) || '';
                    ls += k.length + v.length;
                }
                var kb = (ls * 2 / 1024).toFixed(1);
                fill.style.width = Math.min(ls * 2 / 1024 / 5120 * 100, 100).toFixed(1) + '%';
                text.textContent = kb + ' KB (localStorage)';
            });
        } else {
            text.textContent = 'æš‚æ— æ•°æ®';
            fill.style.width = '0%';
        }
    } catch(e) {
        if (text) text.textContent = 'æ— æ³•è¯»å–';
    }
}

(function() {
    var orig = window.showModal;
    if (typeof orig === 'function') {
        window.showModal = function(el) {
            orig.apply(this, arguments);
            if (el && el.id === 'data-modal') {
                setTimeout(updateStorageUsageBar, 200);
            }
        };
    }
})();

document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('data-settings');
    if (btn) {
        btn.addEventListener('click', function() { setTimeout(updateStorageUsageBar, 300); });
    }
});

window._sendPartnerNotification = function(title, body) {
    try {
        var enabled = localStorage.getItem('notifEnabled') === '1';
        if (!enabled) return;
        if (!('Notification' in window)) return;
        if (Notification.permission !== 'granted') return;
        if (!document.hidden) return; 
        new Notification(title || 'ä¼ è®¯', {
            body: body || 'å¯¹æ–¹å‘æ¥äº†æ¶ˆæ¯',
            icon: document.querySelector('#partner-avatar img') ? document.querySelector('#partner-avatar img').src : undefined,
            tag: 'partner-msg',
            renotify: true
        });
    } catch(e) {}
};

window.handleNotifToggle = function(checkbox) {
    var statusEl = document.getElementById('notif-status-text');
    if (!('Notification' in window)) {
        checkbox.checked = false;
        if (statusEl) statusEl.textContent = 'âš ï¸ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½ï¼Œè¯·æ›´æ¢æµè§ˆå™¨';
        return;
    }
    if (checkbox.checked) {
        Notification.requestPermission().then(function(perm) {
            if (perm === 'granted') {
                if (statusEl) statusEl.textContent = 'âœ… å·²å¼€å¯ â€” å½“é¡µé¢åœ¨åŽå°æ—¶ï¼Œæ”¶åˆ°æ¶ˆæ¯ä¼šå¼¹å‡ºç³»ç»Ÿé€šçŸ¥';
                localStorage.setItem('notifEnabled', '1');
                try {
                    new Notification('ä¼ è®¯é€šçŸ¥å·²å¼€å¯ âœ¨', {
                        body: 'ä½ çŽ°åœ¨å¯ä»¥åœ¨åŽå°æ”¶åˆ°æ¶ˆæ¯æé†’äº†',
                        tag: 'notif-test'
                    });
                } catch(e) {}
            } else if (perm === 'denied') {
                checkbox.checked = false;
                if (statusEl) statusEl.textContent = 'âŒ æƒé™è¢«æ‹’ç»ï¼Œè¯·è‡ªè¡Œæœç´¢å¦‚ä½•å¼€å¯';
                localStorage.setItem('notifEnabled', '0');
            } else {
                checkbox.checked = false;
                if (statusEl) statusEl.textContent = 'âš ï¸ æœªåšå‡ºé€‰æ‹©ï¼Œè¯·é‡è¯•';
                localStorage.setItem('notifEnabled', '0');
            }
        }).catch(function() {
            checkbox.checked = false;
            if (statusEl) statusEl.textContent = 'âŒ è¯·æ±‚æƒé™å¤±è´¥ï¼Œè¯·è‡ªè¡Œæœç´¢å¦‚ä½•æ‰“å¼€';
            localStorage.setItem('notifEnabled', '0');
        });
    } else {
        if (statusEl) statusEl.textContent = 'å·²å…³é—­ â€” åŽå°å°†ä¸å†å¼¹å‡ºæ¶ˆæ¯æé†’';
        localStorage.setItem('notifEnabled', '0');
    }
};

document.addEventListener('DOMContentLoaded', function() {
    var toggle = document.getElementById('notif-permission-toggle');
    var statusEl = document.getElementById('notif-status-text');
    if (!toggle) return;
    var enabled = localStorage.getItem('notifEnabled') === '1';
    var granted = ('Notification' in window) && Notification.permission === 'granted';
    toggle.checked = enabled && granted;
    if (toggle.checked && statusEl) {
        statusEl.textContent = 'âœ… å·²å¼€å¯ â€” å½“é¡µé¢åœ¨åŽå°æ—¶ï¼Œæ”¶åˆ°æ¶ˆæ¯ä¼šå¼¹å‡ºç³»ç»Ÿé€šçŸ¥';
    } else if (statusEl) {
        if ('Notification' in window && Notification.permission === 'denied') {
            statusEl.textContent = 'âŒ é€šçŸ¥æƒé™å·²è¢«æµè§ˆå™¨å±è”½ï¼Œè¯·è‡ªè¡Œæœç´¢å¦‚ä½•å¼€å¯';
        } else {
            statusEl.textContent = 'å…³é—­çŠ¶æ€ â€” å¼€å¯åŽå¯åœ¨åŽå°æŽ¥æ”¶æ¶ˆæ¯æé†’';
        }
    }
});
</script>

<script>
window.switchStatsTab = function(tab) {
    var statsPanel = document.getElementById('stats-panel');
    var favoritesPanel = document.getElementById('favorites-panel');
    var statsBtn = document.getElementById('stats-tab-btn');
    var favBtn = document.getElementById('favorites-tab-btn');
    if (tab === 'stats') {
        statsPanel.style.display = 'block';
        favoritesPanel.style.display = 'none';
        statsBtn.className = 'modal-btn modal-btn-primary';
        favBtn.className = 'modal-btn modal-btn-secondary';
    } else {
        statsPanel.style.display = 'none';
        favoritesPanel.style.display = 'block';
        statsBtn.className = 'modal-btn modal-btn-secondary';
        favBtn.className = 'modal-btn modal-btn-primary';
        if (typeof renderFavorites === 'function') renderFavorites();
    }
};

var groupChatSettings = (function() {
    try {
        var saved = JSON.parse(localStorage.getItem('groupChatSettings') || 'null');
        if (!saved) return { enabled: false, showAvatar: true, showName: true, members: [] };
        if (!saved.members) saved.members = [];
        return saved;
    } catch(e) { return { enabled: false, showAvatar: true, showName: true, members: [] }; }
})();
(function loadGroupAvatars() {
    if (!window.localforage) return;
    var members = groupChatSettings.members || [];
    if (members.length === 0) return;
    var promises = members.map(function(m, i) {
        var ref = m.avatarRef || (m.id ? 'gca_' + m.id : 'gca_' + i);
        return localforage.getItem(ref).then(function(avatar) {
            m.avatar = avatar || null;
        }).catch(function() { m.avatar = null; });
    });
    Promise.all(promises).then(function() {
        if (typeof renderGroupMembersList === 'function') renderGroupMembersList();
    });
})();
var _groupMemberAvatarDataUrl = null;

function saveGroupChatSettings() {
    var members = groupChatSettings.members || [];
    var toSave = {
        enabled: groupChatSettings.enabled,
        showAvatar: groupChatSettings.showAvatar,
        showName: groupChatSettings.showName,
        members: members.map(function(m) {
            if (!m.id) m.id = 'gcm_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
            return { name: m.name, id: m.id, avatarRef: 'gca_' + m.id };
        })
    };
    try {
        localStorage.setItem('groupChatSettings', JSON.stringify(toSave));
    } catch(e) {
        console.warn('groupChatSettings localStorageä¿å­˜å¤±è´¥:', e);
    }
    if (window.localforage) {
        members.forEach(function(m) {
            if (!m.id) m.id = 'gcm_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
            localforage.setItem('gca_' + m.id, m.avatar || null).catch(function(e) {
                console.warn('å¤´åƒå­˜å‚¨å¤±è´¥ id=' + m.id, e);
            });
        });
    }
}

function renderGroupMembersList() {
    var list = document.getElementById('group-members-list');
    if (!list) return;
    if (!groupChatSettings.members || groupChatSettings.members.length === 0) {
        list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-secondary);font-size:13px;">æš‚æ— æˆå‘˜ï¼Œç‚¹å‡»æ·»åŠ æŒ‰é’®æ·»åŠ </div>';
        return;
    }
    list.innerHTML = groupChatSettings.members.map(function(m, i) {
        var avatarHtml = m.avatar
            ? '<img src="' + m.avatar + '" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">'
            : '<div style="width:36px;height:36px;border-radius:50%;background:rgba(var(--accent-color-rgb),0.15);display:flex;align-items:center;justify-content:center;"><i class="fas fa-user" style="font-size:14px;color:var(--accent-color);"></i></div>';
        return '<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--primary-bg);border:1px solid var(--border-color);border-radius:10px;">'
            + avatarHtml
            + '<span style="flex:1;font-size:13px;font-weight:500;">' + (m.name || 'æˆå‘˜' + (i+1)) + '</span>'
            + '<button onclick="openEditGroupMember(' + i + ')" style="background:none;border:none;cursor:pointer;color:var(--accent-color);font-size:14px;padding:4px 8px;"><i class="fas fa-edit"></i></button>'
            + '<button onclick="deleteGroupMember(' + i + ')" style="background:none;border:none;cursor:pointer;color:#ff4757;font-size:14px;padding:4px 8px;"><i class="fas fa-trash-alt"></i></button>'
            + '</div>';
    }).join('');
}

function updateGroupModeUI() {
    var pill = document.getElementById('group-mode-pill');
    var knob = document.getElementById('group-mode-knob');
    var status = document.getElementById('group-mode-status');
    var displaySection = document.getElementById('group-display-section');
    var membersSection = document.getElementById('group-members-section');
    if (!pill) return;
    if (groupChatSettings.enabled) {
        pill.style.background = 'var(--accent-color)';
        knob.style.left = '22px';
        status.textContent = 'å·²å¼€å¯ â€” æ”¶åˆ°çš„æ¶ˆæ¯éšæœºæ˜¾ç¤ºæˆå‘˜';
        displaySection.style.display = 'block';
        membersSection.style.display = 'block';
    } else {
        pill.style.background = 'var(--border-color)';
        knob.style.left = '3px';
        status.textContent = 'å·²å…³é—­ â€” ç‚¹å‡»å¼€å¯';
        displaySection.style.display = 'none';
        membersSection.style.display = 'none';
    }
    var avatarPill = document.getElementById('group-show-avatar-pill');
    var avatarKnob = document.getElementById('group-show-avatar-knob');
    if (avatarPill) {
        avatarPill.style.background = groupChatSettings.showAvatar ? 'var(--accent-color)' : 'var(--border-color)';
        avatarKnob.style.right = groupChatSettings.showAvatar ? '3px' : '19px';
    }
    var namePill = document.getElementById('group-show-name-pill');
    var nameKnob = document.getElementById('group-show-name-knob');
    if (namePill) {
        namePill.style.background = groupChatSettings.showName ? 'var(--accent-color)' : 'var(--border-color)';
        nameKnob.style.right = groupChatSettings.showName ? '3px' : '19px';
    }
    renderGroupMembersList();
}

document.addEventListener('DOMContentLoaded', function() {
    var groupModeToggle = document.getElementById('group-mode-toggle');
    if (groupModeToggle) {
        groupModeToggle.addEventListener('click', function() {
            groupChatSettings.enabled = !groupChatSettings.enabled;
            saveGroupChatSettings();
            updateGroupModeUI();
        });
    }
    var showAvatarToggle = document.getElementById('group-show-avatar-toggle');
    if (showAvatarToggle) {
        showAvatarToggle.addEventListener('click', function() {
            groupChatSettings.showAvatar = !groupChatSettings.showAvatar;
            saveGroupChatSettings();
            updateGroupModeUI();
        });
    }
    var showNameToggle = document.getElementById('group-show-name-toggle');
    if (showNameToggle) {
        showNameToggle.addEventListener('click', function() {
            groupChatSettings.showName = !groupChatSettings.showName;
            saveGroupChatSettings();
            updateGroupModeUI();
        });
    }
    var closeGroupChat = document.getElementById('close-group-chat');
    if (closeGroupChat) {
        closeGroupChat.addEventListener('click', function() {
            var m = document.getElementById('group-chat-modal');
            if (m && typeof hideModal === 'function') hideModal(m);
        });
    }
    setTimeout(updateGroupModeUI, 200);
});

window.openAddGroupMember = function() {
    _groupMemberAvatarDataUrl = null;
    document.getElementById('group-member-edit-title').textContent = 'æ·»åŠ æˆå‘˜';
    document.getElementById('group-member-name-input').value = '';
    document.getElementById('group-member-edit-index').value = '';
    var preview = document.getElementById('group-member-avatar-preview');
    preview.innerHTML = '<i class="fas fa-camera" style="font-size:20px;color:var(--text-secondary);"></i>';
    var m = document.getElementById('group-member-edit-modal');
    if (m && typeof showModal === 'function') showModal(m);
};

window.openEditGroupMember = function(idx) {
    var member = groupChatSettings.members[idx];
    if (!member) return;
    _groupMemberAvatarDataUrl = member.avatar || null;
    document.getElementById('group-member-edit-title').textContent = 'ç¼–è¾‘æˆå‘˜';
    document.getElementById('group-member-name-input').value = member.name || '';
    document.getElementById('group-member-edit-index').value = idx;
    var preview = document.getElementById('group-member-avatar-preview');
    if (member.avatar) {
        preview.innerHTML = '<img src="' + member.avatar + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    } else {
        preview.innerHTML = '<i class="fas fa-camera" style="font-size:20px;color:var(--text-secondary);"></i>';
    }
    var m = document.getElementById('group-member-edit-modal');
    if (m && typeof showModal === 'function') showModal(m);
};

window.closeGroupMemberEdit = function() {
    var m = document.getElementById('group-member-edit-modal');
    if (m && typeof hideModal === 'function') hideModal(m);
};

window.previewGroupMemberAvatar = function(input) {
    var file = input.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        _groupMemberAvatarDataUrl = e.target.result;
        var preview = document.getElementById('group-member-avatar-preview');
        preview.innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
    };
    reader.readAsDataURL(file);
};

window.saveGroupMember = function() {
    var name = (document.getElementById('group-member-name-input').value || '').trim();
    if (!name) { alert('è¯·è¾“å…¥æˆå‘˜åå­—'); return; }
    var idxVal = document.getElementById('group-member-edit-index').value;
    var member = { name: name, avatar: _groupMemberAvatarDataUrl };
    if (idxVal !== '') {
        groupChatSettings.members[parseInt(idxVal)] = member;
    } else {
        if (!groupChatSettings.members) groupChatSettings.members = [];
        groupChatSettings.members.push(member);
    }
    saveGroupChatSettings();
    renderGroupMembersList();
    window.closeGroupMemberEdit();
};

window.deleteGroupMember = function(idx) {
    if (!confirm('ç¡®å®šåˆ é™¤è¯¥æˆå‘˜å—ï¼Ÿ')) return;
    groupChatSettings.members.splice(idx, 1);
    saveGroupChatSettings();
    renderGroupMembersList();
};

window.getGroupMemberForMessage = function(msgId) {
    if (!groupChatSettings.enabled || !groupChatSettings.members || groupChatSettings.members.length === 0) return null;
    var seed = 0;
    var idStr = String(msgId);
    for (var i = 0; i < idStr.length; i++) seed += idStr.charCodeAt(i) * (i + 1);
    return groupChatSettings.members[seed % groupChatSettings.members.length];
};

document.addEventListener('DOMContentLoaded', function() {
    var exportAllBtn = document.getElementById('export-all-settings');
    var importAllBtn = document.getElementById('import-all-settings');
    if (exportAllBtn) {
        exportAllBtn.addEventListener('click', async function() {
            try {
                var backup = { version: 2, type: 'full-backup', timestamp: new Date().toISOString() };
                var lsData = {};
                for (var i = 0; i < localStorage.length; i++) {
                    var k = localStorage.key(i);
                    lsData[k] = localStorage.getItem(k);
                }
                backup.localStorage = lsData;
                if (window.localforage) {
                    if (typeof showNotification === 'function') showNotification('æ­£åœ¨å‡†å¤‡å¯¼å‡ºï¼Œè¯·ç¨å€™...', 'info');
                    var lfData = {};
                    var keys = await localforage.keys();

                    async function serializeValue(val) {
                        if (val === null || val === undefined) return { __type: 'null', value: null };
                        if (val instanceof Blob) {
                            return new Promise((res, rej) => {
                                const reader = new FileReader();
                                reader.onload = () => res({ __type: 'Blob', mimeType: val.type, value: reader.result });
                                reader.onerror = rej;
                                reader.readAsDataURL(val);
                            });
                        }
                        if (val instanceof ArrayBuffer) {
                            const uint8 = new Uint8Array(val);
                            let binary = '';
                            for (let b = 0; b < uint8.length; b++) binary += String.fromCharCode(uint8[b]);
                            return { __type: 'ArrayBuffer', value: btoa(binary) };
                        }
                        if (Array.isArray(val)) {
                            const arr = [];
                            for (const item of val) arr.push(await serializeValue(item));
                            return { __type: 'Array', value: arr };
                        }
                        if (val && typeof val === 'object' && !(val instanceof Date)) {
                            const obj = {};
                            for (const [k2, v2] of Object.entries(val)) obj[k2] = await serializeValue(v2);
                            return { __type: 'Object', value: obj };
                        }
                        return { __type: 'primitive', value: val };
                    }

                    for (var ki = 0; ki < keys.length; ki++) {
                        try {
                            const rawVal = await localforage.getItem(keys[ki]);
                            lfData[keys[ki]] = await serializeValue(rawVal);
                        } catch(e) { console.warn('åºåˆ—åŒ–é”®å¤±è´¥:', keys[ki], e); }
                    }
                    backup.localforage = lfData;
                    backup.lfSerialized = true;
                }
                var dataStr = JSON.stringify(backup);
                var blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.download = 'full-backup-' + new Date().toISOString().slice(0,10) + '.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 100);
                if (typeof showNotification === 'function') showNotification('å…¨é‡å¤‡ä»½å¯¼å‡ºæˆåŠŸ', 'success');
            } catch(e) {
                console.error('å…¨é‡å¤‡ä»½å¯¼å‡ºå¤±è´¥:', e);
                if (typeof showNotification === 'function') showNotification('å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        });
    }
    if (importAllBtn) {
        importAllBtn.addEventListener('click', function() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async function(e) {
                var file = e.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = async function(ev) {
                    try {
                        var backup = JSON.parse(ev.target.result);
                        if (backup.type !== 'full-backup') throw new Error('ä¸æ˜¯å…¨é‡å¤‡ä»½æ–‡ä»¶');
                        if (!confirm('å¯¼å…¥å…¨é‡å¤‡ä»½å°†è¦†ç›–æ‰€æœ‰å½“å‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) return;
                        if (backup.localStorage) {
                            for (var k in backup.localStorage) {
                                localStorage.setItem(k, backup.localStorage[k]);
                            }
                        }
                        if (window.localforage && backup.localforage) {
                            function deserializeValue(wrapped) {
                                if (!wrapped || typeof wrapped !== 'object') return wrapped;
                                const t = wrapped.__type;
                                if (t === 'null') return null;
                                if (t === 'primitive') return wrapped.value;
                                if (t === 'ArrayBuffer') {
                                    const binary = atob(wrapped.value);
                                    const buf = new ArrayBuffer(binary.length);
                                    const view = new Uint8Array(buf);
                                    for (let i2 = 0; i2 < binary.length; i2++) view[i2] = binary.charCodeAt(i2);
                                    return buf;
                                }
                                if (t === 'Blob') {
                                    const dataUrl = wrapped.value;
                                    const base64 = dataUrl.split(',')[1];
                                    const binary = atob(base64);
                                    const buf = new ArrayBuffer(binary.length);
                                    const view = new Uint8Array(buf);
                                    for (let i2 = 0; i2 < binary.length; i2++) view[i2] = binary.charCodeAt(i2);
                                    return new Blob([buf], { type: wrapped.mimeType || 'application/octet-stream' });
                                }
                                if (t === 'Array') return wrapped.value.map(deserializeValue);
                                if (t === 'Object') {
                                    const obj = {};
                                    for (const [k2, v2] of Object.entries(wrapped.value)) obj[k2] = deserializeValue(v2);
                                    return obj;
                                }
                                return wrapped.value !== undefined ? wrapped.value : wrapped;
                            }
                            for (var lk in backup.localforage) {
                                try {
                                    const val = backup.lfSerialized ? deserializeValue(backup.localforage[lk]) : backup.localforage[lk];
                                    await localforage.setItem(lk, val);
                                } catch(e) { console.warn('æ¢å¤é”®å¤±è´¥:', lk, e); }
                            }
                        }
                        if (typeof showNotification === 'function') showNotification('å…¨é‡å¤‡ä»½æ¢å¤æˆåŠŸï¼Œå³å°†åˆ·æ–°é¡µé¢', 'success');
                        setTimeout(function() { location.reload(); }, 1500);
                    } catch(e) {
                        if (typeof showNotification === 'function') showNotification('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + e.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        });
    }
});

window.startEditDgWeather = function(el) {
    var current = el.textContent.trim();
    var input = document.createElement('input');
    input.type = 'text';
    input.value = current;
    input.maxLength = 20;
    input.style.cssText = 'width:120px;padding:2px 6px;border:1px solid var(--accent-color);border-radius:6px;font-size:13px;background:var(--primary-bg);color:var(--text-primary);outline:none;';
    el.style.display = 'none';
    el.parentNode.insertBefore(input, el.nextSibling);
    input.focus();
    input.select();
    function saveWeather() {
        var val = input.value.trim() || current;
        el.textContent = val;
        el.style.display = '';
        input.remove();
        var now = new Date();
        var dateKey = 'customWeather_' + now.getFullYear() + '_' + (now.getMonth()+1) + '_' + now.getDate();
        localStorage.setItem(dateKey, val);
    }
    input.addEventListener('blur', saveWeather);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); saveWeather(); }
        if (e.key === 'Escape') { el.style.display = ''; input.remove(); }
    });
};

    document.addEventListener('focusin', function(e) {
        if (e.target && (e.target.classList.contains('message-input') || e.target.tagName === 'TEXTAREA')) {
            setTimeout(function() {
                var chat = document.querySelector('.chat-container');
                if (chat) chat.scrollTop = chat.scrollHeight;
            }, 100);
        }
    });

(function() {
    var TI_AVATAR_KEY = 'tiSettings_showAvatar';
    var TI_TEXT_KEY = 'tiSettings_customText';
    var tiShowAvatar = localStorage.getItem(TI_AVATAR_KEY) !== 'false';
    var tiCustomText = localStorage.getItem(TI_TEXT_KEY) || '';

    function applyTiAvatarVisibility() {
        var avatarEl = document.getElementById('typing-indicator-avatar');
        if (!avatarEl) return;
        avatarEl.style.display = tiShowAvatar ? '' : 'none';
    }

    function getTiLabel() {
        if (tiCustomText) return tiCustomText;
        var name = (window.settings && settings.partnerName) ? settings.partnerName : 'å¯¹æ–¹';
        return name + ' æ­£åœ¨è¾“å…¥';
    }

    function updatePreview() {
        var previewText = document.getElementById('ti-preview-text');
        var previewAvatar = document.getElementById('ti-preview-avatar');
        if (previewText) previewText.textContent = getTiLabel();
        if (previewAvatar) previewAvatar.style.display = tiShowAvatar ? '' : 'none';
        var label = document.getElementById('typing-indicator-label');
        if (label && label.textContent) label.textContent = getTiLabel();
        var actualAvatar = document.getElementById('typing-indicator-avatar');
        if (actualAvatar) actualAvatar.style.display = tiShowAvatar ? '' : 'none';
    }

    function syncPillUI() {
        var row = document.getElementById('ti-avatar-toggle');
        if (!row) return;
        if (tiShowAvatar) {
            row.classList.add('active');
        } else {
            row.classList.remove('active');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        applyTiAvatarVisibility();
    });

    var _origSetLabel = null;
    function patchTypingLabel() {
        var label = document.getElementById('typing-indicator-label');
        if (label && tiCustomText) {
            label.textContent = tiCustomText;
        }
    }
    var labelEl = null;
    function initLabelObserver() {
        labelEl = document.getElementById('typing-indicator-label');
        if (!labelEl || labelEl._tiObserved) return;
        labelEl._tiObserved = true;
        var obs = new MutationObserver(function() {
            if (tiCustomText && labelEl.textContent !== tiCustomText) {
                labelEl.textContent = tiCustomText;
            }
        });
        obs.observe(labelEl, { childList: true, characterData: true, subtree: true });
    }
    setTimeout(initLabelObserver, 1000);

    document.addEventListener('click', function(e) {
        var ti = e.target.closest('.typing-indicator');
        if (!ti) return;
        e.stopPropagation();
        initLabelObserver();
        var modal = document.getElementById('ti-settings-modal');
        if (!modal) return;
        var input = document.getElementById('ti-text-input');
        if (input) input.value = tiCustomText;
        syncPillUI();
        updatePreview();
        var partnerImg = document.querySelector('#partner-info .message-avatar img') ||
                         document.querySelector('.partner-avatar img') ||
                         document.querySelector('[id*="partner"] img');
        var previewAvatar = document.getElementById('ti-preview-avatar');
        if (previewAvatar && partnerImg) {
            previewAvatar.innerHTML = '<img src="' + partnerImg.src + '" style="width:100%;height:100%;object-fit:cover;">';
        }
        modal.classList.add('open');
    });

    document.addEventListener('click', function(e) {
        var modal = document.getElementById('ti-settings-modal');
        if (!modal || !modal.classList.contains('open')) return;
        if (e.target === modal) modal.classList.remove('open');
    });
    document.addEventListener('click', function(e) {
        if (e.target.id === 'ti-settings-close-btn') {
            var modal = document.getElementById('ti-settings-modal');
            if (modal) modal.classList.remove('open');
        }
    });

    document.addEventListener('click', function(e) {
        var row = e.target.closest('#ti-avatar-toggle');
        if (!row) return;
        tiShowAvatar = !tiShowAvatar;
        localStorage.setItem(TI_AVATAR_KEY, tiShowAvatar);
        syncPillUI();
        updatePreview();
        applyTiAvatarVisibility();
    });

    document.addEventListener('click', function(e) {
        if (e.target.id !== 'ti-text-save-btn') return;
        var input = document.getElementById('ti-text-input');
        if (!input) return;
        tiCustomText = input.value.trim();
        localStorage.setItem(TI_TEXT_KEY, tiCustomText);
        updatePreview();
        e.target.textContent = 'å·²ä¿å­˜ âœ“';
        setTimeout(function() { e.target.textContent = 'ä¿å­˜'; }, 1200);
    });

    document.addEventListener('click', function(e) {
        if (e.target.id !== 'ti-text-reset-btn') return;
        tiCustomText = '';
        localStorage.removeItem(TI_TEXT_KEY);
        var input = document.getElementById('ti-text-input');
        if (input) input.value = '';
        updatePreview();
    });

    document.addEventListener('DOMContentLoaded', function() { syncPillUI(); });
    setTimeout(syncPillUI, 800);
})();

window.addEventListener('load', function() {
    setTimeout(function() {
        try {
            if (localStorage.getItem('dailyGreetingShown') === new Date().toDateString()) return;
            try { if (typeof checkPartnerDailyMood === 'function') checkPartnerDailyMood(); } catch(e2) { console.warn('checkPartnerDailyMood error:', e2); }
            if (typeof _buildDailyGreeting === 'function') _buildDailyGreeting();
            if (window.localforage && window.APP_PREFIX) {
                localforage.getItem(window.APP_PREFIX + 'tour_seen').then(function(seen) {
                    if (seen) {
                        var modal = document.getElementById('daily-greeting-modal');
                        if (modal) modal.classList.remove('hidden');
                        localStorage.setItem('dailyGreetingShown', new Date().toDateString());
                    }
                }).catch(function() {
                    var modal = document.getElementById('daily-greeting-modal');
                    if (modal) modal.classList.remove('hidden');
                    localStorage.setItem('dailyGreetingShown', new Date().toDateString());
                });
            } else {
                var modal = document.getElementById('daily-greeting-modal');
                if (modal) modal.classList.remove('hidden');
                localStorage.setItem('dailyGreetingShown', new Date().toDateString());
            }
        } catch(e) { console.warn('Daily greeting timing error:', e); }
    }, 4500);
}, { once: true });
</script>
</body>
</html>